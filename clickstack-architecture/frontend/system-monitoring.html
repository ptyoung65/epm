<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitoring - AIRIS APM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-6">
        <div class="mb-6">
            <h1 class="text-3xl font-bold mb-2">시스템 모니터링</h1>
            <p class="text-gray-400">OpenTelemetry 기반 시스템 리소스 모니터링</p>
        </div>

        <!-- System Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-sm text-gray-400 mb-1">CPU 사용률</h3>
                <p class="text-2xl font-bold" id="cpuUsage">0%</p>
                <div class="w-full bg-gray-600 rounded-full h-2 mt-2">
                    <div id="cpuBar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-sm text-gray-400 mb-1">메모리 사용률</h3>
                <p class="text-2xl font-bold" id="memoryUsage">0%</p>
                <div class="w-full bg-gray-600 rounded-full h-2 mt-2">
                    <div id="memoryBar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-sm text-gray-400 mb-1">디스크 I/O</h3>
                <p class="text-2xl font-bold" id="diskIO">0 MB/s</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <h3 class="text-sm text-gray-400 mb-1">네트워크 I/O</h3>
                <p class="text-2xl font-bold" id="networkIO">0 MB/s</p>
            </div>
        </div>

        <!-- Resource Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">CPU 사용률 추이</h2>
                <div class="h-64">
                    <canvas id="cpuChart"></canvas>
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">메모리 사용률 추이</h2>
                <div class="h-64">
                    <canvas id="memoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Processes and Services -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">활성 컨테이너</h2>
                <div id="containerList" class="space-y-3">
                    <!-- Dynamic content -->
                </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">서비스 상태</h2>
                <div id="serviceStatus" class="space-y-3">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- System Logs -->
        <div class="bg-gray-800 p-6 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">시스템 로그</h2>
            <div class="bg-gray-900 p-4 rounded font-mono text-sm h-64 overflow-y-auto">
                <div id="systemLogs">
                    <!-- Dynamic log content -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3013/api';
        
        // Initialize charts
        const cpuChart = new Chart(document.getElementById('cpuChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU Usage (%)',
                    data: [],
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 2,
                plugins: {
                    legend: {
                        labels: {
                            color: 'white'
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'white'
                        }
                    },
                    y: {
                        min: 0,
                        max: 100,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'white'
                        }
                    }
                }
            }
        });

        const memoryChart = new Chart(document.getElementById('memoryChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Memory Usage (%)',
                    data: [],
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 2,
                plugins: {
                    legend: {
                        labels: {
                            color: 'white'
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'white'
                        }
                    },
                    y: {
                        min: 0,
                        max: 100,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: 'white'
                        }
                    }
                }
            }
        });
        
        // Load system metrics
        async function loadSystemMetrics() {
            try {
                const response = await axios.get(`${API_BASE}/system/metrics`);
                
                if (response.data && response.data.length > 0) {
                    const cpuMetrics = response.data.filter(m => m.metric_name === 'system_cpu_usage');
                    const memoryMetrics = response.data.filter(m => m.metric_name === 'system_memory_usage');
                    
                    if (cpuMetrics.length > 0) {
                        const cpuValue = cpuMetrics[0].avg_value;
                        document.getElementById('cpuUsage').textContent = cpuValue.toFixed(1) + '%';
                        document.getElementById('cpuBar').style.width = cpuValue + '%';
                        
                        // Update CPU chart
                        const now = new Date().toLocaleTimeString();
                        if (cpuChart.data.labels.length >= 20) {
                            cpuChart.data.labels.shift();
                            cpuChart.data.datasets[0].data.shift();
                        }
                        cpuChart.data.labels.push(now);
                        cpuChart.data.datasets[0].data.push(cpuValue);
                        cpuChart.update('none');
                    }
                    
                    if (memoryMetrics.length > 0) {
                        const memoryValue = memoryMetrics[0].avg_value;
                        document.getElementById('memoryUsage').textContent = memoryValue.toFixed(1) + '%';
                        document.getElementById('memoryBar').style.width = memoryValue + '%';
                        
                        // Update Memory chart
                        const now = new Date().toLocaleTimeString();
                        if (memoryChart.data.labels.length >= 20) {
                            memoryChart.data.labels.shift();
                            memoryChart.data.datasets[0].data.shift();
                        }
                        memoryChart.data.labels.push(now);
                        memoryChart.data.datasets[0].data.push(memoryValue);
                        memoryChart.update('none');
                    }
                }
                
                // Simulate other metrics
                document.getElementById('diskIO').textContent = (Math.random() * 50).toFixed(1) + ' MB/s';
                document.getElementById('networkIO').textContent = (Math.random() * 20).toFixed(1) + ' MB/s';
                
            } catch (error) {
                console.error('Error loading system metrics:', error);
            }
        }
        
        // Load services status
        async function loadServiceStatus() {
            try {
                const response = await axios.get(`${API_BASE}/services`);
                const serviceStatusDiv = document.getElementById('serviceStatus');
                
                serviceStatusDiv.innerHTML = '';
                
                response.data.forEach(service => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-gray-700 rounded';
                    div.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full bg-green-400 mr-3"></div>
                            <span>${service}</span>
                        </div>
                        <span class="text-green-400 text-sm">Running</span>
                    `;
                    serviceStatusDiv.appendChild(div);
                });
                
                // Add container information
                const containerDiv = document.getElementById('containerList');
                containerDiv.innerHTML = '';
                
                const containers = [
                    { name: 'otel-collector', status: 'running', cpu: '2.3%', memory: '128MB' },
                    { name: 'otel-gateway', status: 'running', cpu: '1.8%', memory: '96MB' },
                    { name: 'java-sample-app', status: 'running', cpu: '15.2%', memory: '512MB' },
                    { name: 'python-sample-app', status: 'running', cpu: '8.7%', memory: '256MB' },
                    { name: 'clickhouse', status: 'running', cpu: '12.1%', memory: '1.2GB' }
                ];
                
                containers.forEach(container => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-gray-700 rounded';
                    div.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold">${container.name}</span>
                            <span class="px-2 py-1 rounded text-xs ${
                                container.status === 'running' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'
                            }">
                                ${container.status}
                            </span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-400">
                            <span>CPU: ${container.cpu}</span>
                            <span>Memory: ${container.memory}</span>
                        </div>
                    `;
                    containerDiv.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error loading service status:', error);
            }
        }
        
        // Load system logs
        async function loadSystemLogs() {
            try {
                const response = await axios.get(`${API_BASE}/logs`, {
                    params: {
                        level: 'info',
                        limit: 50
                    }
                });
                
                const logsDiv = document.getElementById('systemLogs');
                logsDiv.innerHTML = '';
                
                response.data.slice(0, 20).forEach(log => {
                    const div = document.createElement('div');
                    div.className = 'mb-1 text-gray-300';
                    
                    const levelClass = {
                        'error': 'text-red-400',
                        'warn': 'text-yellow-400',
                        'info': 'text-blue-400',
                        'debug': 'text-gray-500'
                    };
                    
                    div.innerHTML = `
                        <span class="text-gray-500">${new Date(log.timestamp).toLocaleTimeString()}</span>
                        <span class="${levelClass[log.severity_text?.toLowerCase()] || 'text-gray-300'} ml-2">
                            [${log.severity_text?.toUpperCase() || 'INFO'}]
                        </span>
                        <span class="text-gray-400 ml-2">${log.service_name}:</span>
                        <span class="ml-1">${log.body}</span>
                    `;
                    
                    logsDiv.appendChild(div);
                });
                
                // Auto scroll to bottom
                logsDiv.scrollTop = logsDiv.scrollHeight;
                
            } catch (error) {
                console.error('Error loading system logs:', error);
            }
        }
        
        // Auto-refresh
        setInterval(() => {
            loadSystemMetrics();
            loadServiceStatus();
            loadSystemLogs();
        }, 5000);
        
        // Initial load
        loadSystemMetrics();
        loadServiceStatus();
        loadSystemLogs();
    </script>
</body>
</html>