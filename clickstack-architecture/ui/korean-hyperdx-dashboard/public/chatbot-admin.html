<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIRIS 챗봇 관리자 설정</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      font-family: 'Inter', sans-serif;
    }
    
    /* shadcn/ui CSS Variables */
    :root {
      --background: 0 0% 100%;
      --foreground: 222.2 84% 4.9%;
      --card: 0 0% 100%;
      --card-foreground: 222.2 84% 4.9%;
      --popover: 0 0% 100%;
      --popover-foreground: 222.2 84% 4.9%;
      --primary: 222.2 47.4% 11.2%;
      --primary-foreground: 210 40% 98%;
      --secondary: 210 40% 96%;
      --secondary-foreground: 222.2 47.4% 11.2%;
      --muted: 210 40% 96%;
      --muted-foreground: 215.4 16.3% 46.9%;
      --accent: 210 40% 96%;
      --accent-foreground: 222.2 47.4% 11.2%;
      --destructive: 0 84.2% 60.2%;
      --destructive-foreground: 210 40% 98%;
      --border: 214.3 31.8% 91.4%;
      --input: 214.3 31.8% 91.4%;
      --ring: 222.2 84% 4.9%;
      --radius: 0.5rem;
    }

    .dark {
      --background: 222.2 84% 4.9%;
      --foreground: 210 40% 98%;
      --card: 222.2 84% 4.9%;
      --card-foreground: 210 40% 98%;
      --popover: 222.2 84% 4.9%;
      --popover-foreground: 210 40% 98%;
      --primary: 210 40% 98%;
      --primary-foreground: 222.2 47.4% 11.2%;
      --secondary: 222.2 84% 4.9%;
      --secondary-foreground: 210 40% 98%;
      --muted: 222.2 84% 4.9%;
      --muted-foreground: 215.4 16.3% 46.9%;
      --accent: 222.2 84% 4.9%;
      --accent-foreground: 210 40% 98%;
      --destructive: 0 62.8% 30.6%;
      --destructive-foreground: 210 40% 98%;
      --border: 217.2 32.6% 17.5%;
      --input: 217.2 32.6% 17.5%;
      --ring: 212.7 26.8% 83.9%;
    }

    .bg-background { background-color: hsl(var(--background)); }
    .text-foreground { color: hsl(var(--foreground)); }
    .bg-card { background-color: hsl(var(--card)); }
    .text-card-foreground { color: hsl(var(--card-foreground)); }
    .bg-primary { background-color: hsl(var(--primary)); }
    .text-primary-foreground { color: hsl(var(--primary-foreground)); }
    .text-primary { color: hsl(var(--primary)); }
    .text-muted-foreground { color: hsl(var(--muted-foreground)); }
    .border-border { border-color: hsl(var(--border)); }
    .text-destructive { color: hsl(var(--destructive)); }
    .bg-muted { background-color: hsl(var(--muted)); }
    .text-accent-foreground { color: hsl(var(--accent-foreground)); }
    .bg-accent { background-color: hsl(var(--accent)); }
    .bg-destructive { background-color: hsl(var(--destructive)); }
  </style>
</head>
<body class="bg-background text-foreground">
  <!-- Header -->
  <header class="sticky top-0 z-50 w-full border-b border-border bg-background/95 backdrop-blur">
    <div class="container mx-auto flex h-14 items-center px-4">
      <div class="flex items-center space-x-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary">
          <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        <h1 class="font-bold text-xl">AIRIS 챗봇 관리자</h1>
      </div>
      
      <div class="ml-auto flex items-center space-x-4">
        <button onclick="testConnection()" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors border border-border bg-background hover:bg-accent h-9 px-3">
          연결 테스트
        </button>
        <button onclick="window.close()" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors border border-border bg-background hover:bg-accent h-9 px-3">
          닫기
        </button>
      </div>
    </div>
  </header>

  <div class="container mx-auto p-6 max-w-6xl">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-card rounded-lg border border-border p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted-foreground">활성 봇</p>
            <p class="text-2xl font-bold" id="activeBots">4</p>
          </div>
          <div class="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary">
              <path d="M12 8V4H8"></path>
              <rect width="16" height="12" x="4" y="8" rx="2"></rect>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="bg-card rounded-lg border border-border p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted-foreground">총 대화</p>
            <p class="text-2xl font-bold" id="totalChats">1,234</p>
          </div>
          <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="bg-card rounded-lg border border-border p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted-foreground">API 호출</p>
            <p class="text-2xl font-bold" id="apiCalls">5,678</p>
          </div>
          <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
              <path d="m22 2-7 20-4-9-9-4Z"></path>
              <path d="M22 2 11 13"></path>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="bg-card rounded-lg border border-border p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted-foreground">평균 응답시간</p>
            <p class="text-2xl font-bold" id="avgResponse">2.3s</p>
          </div>
          <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-600">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12,6 12,12 16,14"></polyline>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Chatbot Settings -->
      <div class="bg-card rounded-lg border border-border">
        <div class="p-6 border-b border-border">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold">챗봇 설정</h2>
            <button onclick="addNewBot()" class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/90 transition-colors text-sm">
              새 봇 추가
            </button>
          </div>
        </div>
        <div class="p-6">
          <div id="botList" class="space-y-4">
            <!-- Bot configurations will be loaded here -->
          </div>
        </div>
      </div>

      <!-- API Settings -->
      <div class="bg-card rounded-lg border border-border">
        <div class="p-6 border-b border-border">
          <h2 class="text-xl font-semibold">API 설정</h2>
        </div>
        <div class="p-6 space-y-6">
          <!-- OpenAI -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">OpenAI</h3>
              <div class="flex items-center space-x-2">
                <div id="openaiStatus" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                <span class="text-sm text-muted-foreground">미설정</span>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">API 키</label>
              <div class="flex space-x-2">
                <input type="password" id="openaiApiKey" class="flex-1 p-2 border border-border rounded-md bg-background" placeholder="sk-...">
                <button onclick="testAPIKey('openai')" class="px-4 py-2 border border-border rounded-md hover:bg-accent transition-colors">
                  테스트
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">기본 모델</label>
              <select id="openaiModel" class="w-full p-2 border border-border rounded-md bg-background">
                <option value="gpt-4o-mini">GPT-4o Mini</option>
                <option value="gpt-4o">GPT-4o</option>
                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
              </select>
            </div>
          </div>

          <!-- Anthropic Claude -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">Anthropic Claude</h3>
              <div class="flex items-center space-x-2">
                <div id="claudeStatus" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                <span class="text-sm text-muted-foreground">미설정</span>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">API 키</label>
              <div class="flex space-x-2">
                <input type="password" id="claudeApiKey" class="flex-1 p-2 border border-border rounded-md bg-background" placeholder="sk-ant-...">
                <button onclick="testAPIKey('claude')" class="px-4 py-2 border border-border rounded-md hover:bg-accent transition-colors">
                  테스트
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">기본 모델</label>
              <select id="claudeModel" class="w-full p-2 border border-border rounded-md bg-background">
                <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                <option value="claude-3-opus-20240229">Claude 3 Opus</option>
              </select>
            </div>
          </div>

          <!-- Google Gemini -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">Google Gemini</h3>
              <div class="flex items-center space-x-2">
                <div id="geminiStatus" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                <span class="text-sm text-muted-foreground">미설정</span>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">API 키</label>
              <div class="flex space-x-2">
                <input type="password" id="geminiApiKey" class="flex-1 p-2 border border-border rounded-md bg-background" placeholder="AI...">
                <button onclick="testAPIKey('gemini')" class="px-4 py-2 border border-border rounded-md hover:bg-accent transition-colors">
                  테스트
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">기본 모델</label>
              <select id="geminiModel" class="w-full p-2 border border-border rounded-md bg-background">
                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                <option value="gemini-pro">Gemini Pro</option>
              </select>
            </div>
          </div>

          <!-- Ollama (Local) -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">Ollama (로컬)</h3>
              <div class="flex items-center space-x-2">
                <div id="ollamaStatus" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                <span class="text-sm text-muted-foreground">미설정</span>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">서버 URL</label>
              <input type="text" id="ollamaUrl" class="w-full p-2 border border-border rounded-md bg-background" value="http://localhost:11434">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">모델</label>
              <div class="flex space-x-2">
                <input type="text" id="ollamaModel" class="flex-1 p-2 border border-border rounded-md bg-background" placeholder="llama2, mistral, codellama...">
                <button onclick="testAPIKey('ollama')" class="px-4 py-2 border border-border rounded-md hover:bg-accent transition-colors">
                  테스트
                </button>
              </div>
            </div>
          </div>

          <div class="flex justify-end">
            <button onclick="saveAllSettings()" class="bg-primary text-primary-foreground px-6 py-2 rounded-md hover:bg-primary/90 transition-colors">
              모든 설정 저장
            </button>
          </div>
        </div>
      </div>

      <!-- Chat History & Analytics -->
      <div class="lg:col-span-2 bg-card rounded-lg border border-border">
        <div class="p-6 border-b border-border">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold">대화 히스토리 & 분석</h2>
            <div class="flex items-center space-x-2">
              <button onclick="exportHistory()" class="border border-border px-4 py-2 rounded-md hover:bg-accent transition-colors text-sm">
                내보내기
              </button>
              <button onclick="clearHistory()" class="border border-border px-4 py-2 rounded-md hover:bg-accent transition-colors text-sm text-destructive">
                히스토리 삭제
              </button>
            </div>
          </div>
        </div>
        <div class="p-6">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-border">
                  <th class="text-left py-3 px-4 font-medium">시간</th>
                  <th class="text-left py-3 px-4 font-medium">사용자</th>
                  <th class="text-left py-3 px-4 font-medium">봇</th>
                  <th class="text-left py-3 px-4 font-medium">질문</th>
                  <th class="text-left py-3 px-4 font-medium">응답 시간</th>
                  <th class="text-left py-3 px-4 font-medium">토큰</th>
                  <th class="text-left py-3 px-4 font-medium">작업</th>
                </tr>
              </thead>
              <tbody id="historyTable">
                <!-- History will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Bot Modal -->
  <div id="botModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center p-4 h-full">
      <div class="bg-background border border-border rounded-lg shadow-lg w-[600px] max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between p-4 border-b border-border">
          <h3 class="font-semibold text-lg" id="modalTitle">새 봇 추가</h3>
          <button onclick="closeBotModal()" class="p-2 hover:bg-accent rounded-md transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m18 6-12 12"></path>
              <path d="m6 6 12 12"></path>
            </svg>
          </button>
        </div>
        <div class="p-6 space-y-4">
          <input type="hidden" id="editBotId">
          <div>
            <label class="block text-sm font-medium mb-1">봇 ID</label>
            <input type="text" id="botId" class="w-full p-2 border border-border rounded-md bg-background" placeholder="performance, monitoring, etc.">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">봇 이름</label>
            <input type="text" id="botName" class="w-full p-2 border border-border rounded-md bg-background" placeholder="성능 분석 봇">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">설명</label>
            <input type="text" id="botDescription" class="w-full p-2 border border-border rounded-md bg-background" placeholder="실시간 시스템 성능 분석 및 최적화 권장">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">API 제공업체</label>
            <select id="botApiProvider" class="w-full p-2 border border-border rounded-md bg-background">
              <option value="openai">OpenAI</option>
              <option value="claude">Anthropic Claude</option>
              <option value="gemini">Google Gemini</option>
              <option value="ollama">Ollama (로컬)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">모델</label>
            <input type="text" id="botModel" class="w-full p-2 border border-border rounded-md bg-background" placeholder="gpt-4o-mini">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">시스템 프롬프트</label>
            <textarea id="botSystemPrompt" rows="4" class="w-full p-2 border border-border rounded-md bg-background resize-none" placeholder="당신은 시스템 성능 분석 전문가입니다..."></textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">최대 토큰</label>
              <input type="number" id="botMaxTokens" class="w-full p-2 border border-border rounded-md bg-background" value="2000">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">온도</label>
              <input type="number" id="botTemperature" step="0.1" min="0" max="2" class="w-full p-2 border border-border rounded-md bg-background" value="0.7">
            </div>
          </div>
          <div class="flex items-center space-x-2">
            <input type="checkbox" id="botEnabled" class="rounded">
            <label for="botEnabled" class="text-sm font-medium">봇 활성화</label>
          </div>
        </div>
        <div class="flex justify-end space-x-3 p-6 border-t border-border">
          <button onclick="closeBotModal()" class="px-4 py-2 border border-border rounded-md hover:bg-accent transition-colors">
            취소
          </button>
          <button onclick="saveBotConfig()" class="px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors">
            저장
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let botConfigs = {};
    let apiSettings = {};
    let chatHistory = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadAllSettings();
      loadBotConfigs();
      loadChatHistory();
      updateStats();
    });

    function loadAllSettings() {
      // Load API settings
      const storedApiSettings = localStorage.getItem('airis_admin_api_settings');
      if (storedApiSettings) {
        apiSettings = JSON.parse(storedApiSettings);
        updateAPISettingsUI();
      }
    }

    function loadBotConfigs() {
      // Load bot configurations
      const stored = localStorage.getItem('airis_bot_configs');
      if (stored) {
        botConfigs = JSON.parse(stored);
      } else {
        // Default bot configurations
        botConfigs = {
          performance: {
            id: 'performance',
            name: '성능 분석 봇',
            description: '실시간 시스템 성능 분석 및 최적화 권장',
            apiProvider: 'openai',
            model: 'gpt-4o-mini',
            systemPrompt: '당신은 시스템 성능 분석 전문가입니다. 사용자의 질문에 대해 정확하고 실용적인 성능 최적화 방안을 제시해주세요.',
            maxTokens: 2000,
            temperature: 0.7,
            enabled: true
          },
          monitoring: {
            id: 'monitoring',
            name: '모니터링 봇',
            description: '시스템 모니터링 및 알림 설정 전문가',
            apiProvider: 'openai',
            model: 'gpt-4o-mini',
            systemPrompt: '당신은 시스템 모니터링 전문가입니다. 모니터링 설정, 알림 규칙, 대시보드 구성에 대한 전문적인 조언을 제공해주세요.',
            maxTokens: 2000,
            temperature: 0.7,
            enabled: true
          },
          troubleshoot: {
            id: 'troubleshoot',
            name: '장애 분석 봇',
            description: '장애 원인 분석 및 해결 방안 제시',
            apiProvider: 'openai',
            model: 'gpt-4o-mini',
            systemPrompt: '당신은 시스템 장애 분석 및 문제 해결 전문가입니다. 장애 원인을 분석하고 체계적인 해결 방안을 제시해주세요.',
            maxTokens: 2000,
            temperature: 0.7,
            enabled: true
          },
          optimization: {
            id: 'optimization',
            name: '최적화 봇',
            description: '시스템 최적화 및 효율성 개선 전문가',
            apiProvider: 'openai',
            model: 'gpt-4o-mini',
            systemPrompt: '당신은 시스템 최적화 전문가입니다. 성능 향상, 비용 절감, 효율성 개선에 대한 구체적인 방안을 제시해주세요.',
            maxTokens: 2000,
            temperature: 0.7,
            enabled: true
          }
        };
        saveBotConfigs();
      }
      updateBotList();
    }

    function updateBotList() {
      const container = document.getElementById('botList');
      container.innerHTML = Object.values(botConfigs).map(bot => `
        <div class="border border-border rounded-lg p-4">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 ${bot.enabled ? 'bg-green-100 dark:bg-green-900' : 'bg-gray-100 dark:bg-gray-800'} rounded-full flex items-center justify-center">
                <div class="w-2 h-2 ${bot.enabled ? 'bg-green-500' : 'bg-gray-400'} rounded-full"></div>
              </div>
              <div>
                <h3 class="font-medium">${bot.name}</h3>
                <p class="text-sm text-muted-foreground">${bot.description}</p>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="editBot('${bot.id}')" class="text-sm text-primary hover:underline">편집</button>
              <button onclick="deleteBot('${bot.id}')" class="text-sm text-destructive hover:underline">삭제</button>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 text-sm text-muted-foreground">
            <div>API: ${bot.apiProvider}</div>
            <div>모델: ${bot.model}</div>
            <div>토큰: ${bot.maxTokens}</div>
            <div>온도: ${bot.temperature}</div>
          </div>
        </div>
      `).join('');
    }

    function updateAPISettingsUI() {
      Object.keys(apiSettings).forEach(provider => {
        const setting = apiSettings[provider];
        if (document.getElementById(`${provider}ApiKey`)) {
          document.getElementById(`${provider}ApiKey`).value = setting.apiKey || '';
        }
        if (document.getElementById(`${provider}Model`)) {
          document.getElementById(`${provider}Model`).value = setting.model || '';
        }
        if (document.getElementById(`${provider}Url`)) {
          document.getElementById(`${provider}Url`).value = setting.url || '';
        }
        
        // Update status indicators
        updateConnectionStatus(provider, setting.apiKey ? 'configured' : 'not-configured');
      });
    }

    function updateConnectionStatus(provider, status) {
      const statusEl = document.getElementById(`${provider}Status`);
      const statusText = statusEl.nextElementSibling;
      
      if (status === 'connected') {
        statusEl.className = 'w-2 h-2 bg-green-500 rounded-full';
        statusText.textContent = '연결됨';
      } else if (status === 'configured') {
        statusEl.className = 'w-2 h-2 bg-yellow-500 rounded-full';
        statusText.textContent = '설정됨';
      } else if (status === 'error') {
        statusEl.className = 'w-2 h-2 bg-red-500 rounded-full';
        statusText.textContent = '오류';
      } else {
        statusEl.className = 'w-2 h-2 bg-gray-400 rounded-full';
        statusText.textContent = '미설정';
      }
    }

    async function testAPIKey(provider) {
      const apiKey = document.getElementById(`${provider}ApiKey`).value;
      const model = document.getElementById(`${provider}Model`)?.value;
      const url = document.getElementById(`${provider}Url`)?.value;
      
      if (!apiKey && provider !== 'ollama') {
        alert('API 키를 입력해주세요.');
        return;
      }

      updateConnectionStatus(provider, 'testing');
      
      try {
        // First save the API configuration to the backend
        const saveResponse = await fetch('http://localhost:3013/api/chatbot/api-configs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            provider: provider,
            apiKey: apiKey,
            baseUrl: url || undefined
          })
        });

        if (!saveResponse.ok) {
          throw new Error(`Failed to save API config: ${saveResponse.status}`);
        }

        // Now test the connection
        const testResponse = await fetch('http://localhost:3013/api/chatbot/test-connection', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            provider: provider,
            model: model || getDefaultModel(provider)
          })
        });

        const testResult = await testResponse.json();

        if (testResult.success) {
          updateConnectionStatus(provider, 'connected');
          alert(`${provider.toUpperCase()} API 연결 성공!\n응답 시간: ${testResult.responseTime}ms`);
        } else {
          updateConnectionStatus(provider, 'error');
          alert(`${provider.toUpperCase()} API 연결 실패: ${testResult.error}`);
        }

      } catch (error) {
        updateConnectionStatus(provider, 'error');
        console.error('API test error:', error);
        
        let errorMessage = `연결 테스트 중 오류가 발생했습니다: ${error.message}`;
        
        if (error.message.includes('fetch')) {
          errorMessage += '\n\n• 챗봇 API 서비스가 실행 중인지 확인해주세요 (포트 3013)\n• 브라우저 콘솔에서 상세 오류를 확인해주세요';
        }
        
        alert(errorMessage);
      }
    }

    function getDefaultModel(provider) {
      const defaults = {
        'openai': 'gpt-4o-mini',
        'claude': 'claude-3-haiku-20240307',
        'gemini': 'gemini-1.5-flash',
        'ollama': 'llama2'
      };
      return defaults[provider] || '';
    }

    function saveAllSettings() {
      // Save API settings
      apiSettings = {
        openai: {
          apiKey: document.getElementById('openaiApiKey').value,
          model: document.getElementById('openaiModel').value
        },
        claude: {
          apiKey: document.getElementById('claudeApiKey').value,
          model: document.getElementById('claudeModel').value
        },
        gemini: {
          apiKey: document.getElementById('geminiApiKey').value,
          model: document.getElementById('geminiModel').value
        },
        ollama: {
          url: document.getElementById('ollamaUrl').value,
          model: document.getElementById('ollamaModel').value
        }
      };
      
      localStorage.setItem('airis_admin_api_settings', JSON.stringify(apiSettings));
      alert('모든 설정이 저장되었습니다!');
    }

    function addNewBot() {
      // Clear form
      document.getElementById('editBotId').value = '';
      document.getElementById('botId').value = '';
      document.getElementById('botName').value = '';
      document.getElementById('botDescription').value = '';
      document.getElementById('botApiProvider').value = 'openai';
      document.getElementById('botModel').value = 'gpt-4o-mini';
      document.getElementById('botSystemPrompt').value = '';
      document.getElementById('botMaxTokens').value = 2000;
      document.getElementById('botTemperature').value = 0.7;
      document.getElementById('botEnabled').checked = true;
      
      document.getElementById('modalTitle').textContent = '새 봇 추가';
      document.getElementById('botModal').classList.remove('hidden');
    }

    function editBot(botId) {
      const bot = botConfigs[botId];
      if (!bot) return;

      // Fill form
      document.getElementById('editBotId').value = botId;
      document.getElementById('botId').value = bot.id;
      document.getElementById('botName').value = bot.name;
      document.getElementById('botDescription').value = bot.description;
      document.getElementById('botApiProvider').value = bot.apiProvider;
      document.getElementById('botModel').value = bot.model;
      document.getElementById('botSystemPrompt').value = bot.systemPrompt;
      document.getElementById('botMaxTokens').value = bot.maxTokens;
      document.getElementById('botTemperature').value = bot.temperature;
      document.getElementById('botEnabled').checked = bot.enabled;
      
      document.getElementById('modalTitle').textContent = '봇 설정 편집';
      document.getElementById('botModal').classList.remove('hidden');
    }

    function deleteBot(botId) {
      if (confirm('정말로 이 봇을 삭제하시겠습니까?')) {
        delete botConfigs[botId];
        saveBotConfigs();
        updateBotList();
        updateStats();
      }
    }

    function saveBotConfig() {
      const editId = document.getElementById('editBotId').value;
      const botId = document.getElementById('botId').value;
      const botData = {
        id: botId,
        name: document.getElementById('botName').value,
        description: document.getElementById('botDescription').value,
        apiProvider: document.getElementById('botApiProvider').value,
        model: document.getElementById('botModel').value,
        systemPrompt: document.getElementById('botSystemPrompt').value,
        maxTokens: parseInt(document.getElementById('botMaxTokens').value),
        temperature: parseFloat(document.getElementById('botTemperature').value),
        enabled: document.getElementById('botEnabled').checked
      };

      if (!botId || !botData.name) {
        alert('봇 ID와 이름은 필수입니다.');
        return;
      }

      // If editing and ID changed, remove old entry
      if (editId && editId !== botId) {
        delete botConfigs[editId];
      }

      botConfigs[botId] = botData;
      saveBotConfigs();
      updateBotList();
      updateStats();
      closeBotModal();
    }

    function saveBotConfigs() {
      localStorage.setItem('airis_bot_configs', JSON.stringify(botConfigs));
    }

    function closeBotModal() {
      document.getElementById('botModal').classList.add('hidden');
    }

    function loadChatHistory() {
      const stored = localStorage.getItem('airis_chat_history');
      if (stored) {
        chatHistory = JSON.parse(stored);
      }
      updateHistoryTable();
    }

    function updateHistoryTable() {
      const tbody = document.getElementById('historyTable');
      
      if (chatHistory.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-8 text-muted-foreground">
              대화 히스토리가 없습니다.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = chatHistory.slice(-20).reverse().map(item => `
        <tr class="border-b border-border hover:bg-muted/50">
          <td class="py-3 px-4 text-sm">${new Date(item.timestamp).toLocaleString('ko-KR')}</td>
          <td class="py-3 px-4 text-sm">${item.userId || 'admin'}</td>
          <td class="py-3 px-4 text-sm">
            <span class="bg-primary/10 text-primary px-2 py-1 rounded text-xs">
              ${botConfigs[item.bot]?.name || item.bot}
            </span>
          </td>
          <td class="py-3 px-4 text-sm max-w-xs truncate" title="${item.question}">${item.question}</td>
          <td class="py-3 px-4 text-sm">${item.responseTime || '2.1s'}</td>
          <td class="py-3 px-4 text-sm">${item.tokens || '1,234'}</td>
          <td class="py-3 px-4 text-sm">
            <button onclick="viewChatDetail(${item.id})" class="text-primary hover:underline text-xs">
              상세보기
            </button>
          </td>
        </tr>
      `).join('');
    }

    function updateStats() {
      document.getElementById('activeBots').textContent = Object.values(botConfigs).filter(bot => bot.enabled).length;
      document.getElementById('totalChats').textContent = chatHistory.length.toLocaleString();
      document.getElementById('apiCalls').textContent = (chatHistory.length * 1.2).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function exportHistory() {
      const data = {
        botConfigs,
        apiSettings,
        chatHistory,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `airis-chatbot-data-${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearHistory() {
      if (confirm('정말로 모든 대화 히스토리를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        localStorage.removeItem('airis_chat_history');
        chatHistory = [];
        updateHistoryTable();
        updateStats();
        alert('대화 히스토리가 삭제되었습니다.');
      }
    }

    function testConnection() {
      // Test all configured APIs
      const providers = ['openai', 'claude', 'gemini', 'ollama'];
      providers.forEach(provider => {
        const apiKey = document.getElementById(`${provider}ApiKey`)?.value;
        if (apiKey || provider === 'ollama') {
          testAPIKey(provider);
        }
      });
    }

    function viewChatDetail(chatId) {
      const chat = chatHistory.find(item => item.id === chatId);
      if (!chat) return;

      alert(`대화 상세정보:\n\n질문: ${chat.question}\n\n답변: ${chat.answer.substring(0, 200)}...`);
    }
  </script>
</body>
</html>