<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autoencoder 이상탐지 모델 학습 - AIRIS EPM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* shadcn/ui CSS Variables */
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
        }
        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 210 40% 98%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 212.7 26.8% 83.9%;
        }
        
        /* Chart Container Fixed Height */
        .ml-chart-container {
            width: 100% !important;
            height: 256px !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .ml-chart-container canvas {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body class="bg-background text-foreground">
    <!-- Header Navigation -->
    <header class="border-b bg-card">
        <div class="container mx-auto px-4 py-4">
            <nav class="flex items-center justify-between">
                <div class="flex items-center space-x-8">
                    <a href="/portal.html" class="text-xl font-bold text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors cursor-pointer">
                        🚀 AIRIS EPM
                    </a>
                    <div class="flex space-x-6 text-sm">
                        <button onclick="window.location.href='/'" class="text-foreground/60 hover:text-foreground/80 transition-colors bg-transparent border-none cursor-pointer">
                            대시보드
                        </button>
                        <button onclick="window.location.href='/aiops-management.html'" class="text-foreground/60 hover:text-foreground/80 transition-colors bg-transparent border-none cursor-pointer">
                            AIOPS 관리
                        </button>
                        <button class="text-primary font-semibold bg-transparent border-none cursor-pointer">
                            모델 학습
                        </button>
                    </div>
                </div>
                <div class="text-sm text-muted-foreground">
                    <span id="currentTime"></span>
                </div>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Page Title -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">🔬 Autoencoder 이상탐지 모델 학습</h1>
            <p class="text-muted-foreground">딥러닝 기반 비정상 패턴 감지 모델의 학습 및 최적화</p>
        </div>

        <!-- Model Architecture & Current Status -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Model Architecture Card -->
            <div class="lg:col-span-2 bg-card rounded-lg border p-6">
                <h2 class="text-xl font-semibold mb-4">모델 아키텍처</h2>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <h3 class="text-sm font-medium text-muted-foreground mb-2">인코더 (Encoder)</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>입력층</span>
                                <span class="font-mono">100 neurons</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>은닉층 1</span>
                                <span class="font-mono">64 neurons (ReLU)</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>은닉층 2</span>
                                <span class="font-mono">32 neurons (ReLU)</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>잠재층</span>
                                <span class="font-mono">16 neurons</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-muted-foreground mb-2">디코더 (Decoder)</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>잠재층</span>
                                <span class="font-mono">16 neurons</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>은닉층 3</span>
                                <span class="font-mono">32 neurons (ReLU)</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>은닉층 4</span>
                                <span class="font-mono">64 neurons (ReLU)</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>출력층</span>
                                <span class="font-mono">100 neurons (Sigmoid)</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-muted rounded p-3 text-sm">
                    <p><strong>Loss Function:</strong> Mean Squared Error (MSE)</p>
                    <p><strong>Optimizer:</strong> Adam (learning rate: 0.001)</p>
                    <p><strong>Anomaly Threshold:</strong> Reconstruction error > 0.95</p>
                </div>
            </div>

            <!-- Current Model Status -->
            <div class="bg-card rounded-lg border p-6">
                <h2 class="text-xl font-semibold mb-4">현재 모델 상태</h2>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-sm text-muted-foreground">마지막 학습</span>
                        <span class="text-sm font-medium">2024-08-27 14:30</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-muted-foreground">정확도</span>
                        <span class="text-sm font-medium text-green-600">94.2%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-muted-foreground">총 에포크</span>
                        <span class="text-sm font-medium">500</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-muted-foreground">모델 크기</span>
                        <span class="text-sm font-medium">2.4 MB</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-muted-foreground">체크포인트</span>
                        <span class="text-sm font-medium">5개 저장됨</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Configuration -->
        <div class="bg-card rounded-lg border p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">학습 설정</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Dataset Selection -->
                <div>
                    <label class="block text-sm font-medium mb-2">데이터셋 선택</label>
                    <select id="datasetSelect" class="w-full px-3 py-2 bg-background border rounded-md focus:ring-2 focus:ring-primary">
                        <option value="recent">최근 7일 데이터</option>
                        <option value="month">최근 30일 데이터</option>
                        <option value="quarter">최근 3개월 데이터</option>
                        <option value="custom">사용자 정의</option>
                        <option value="benchmark">벤치마크 데이터셋</option>
                    </select>
                </div>

                <!-- Learning Rate -->
                <div>
                    <label class="block text-sm font-medium mb-2">학습률 (Learning Rate)</label>
                    <input type="number" id="learningRate" value="0.001" step="0.0001" min="0.00001" max="1" 
                           class="w-full px-3 py-2 bg-background border rounded-md focus:ring-2 focus:ring-primary">
                </div>

                <!-- Batch Size -->
                <div>
                    <label class="block text-sm font-medium mb-2">배치 크기 (Batch Size)</label>
                    <input type="number" id="batchSize" value="32" min="1" max="512" 
                           class="w-full px-3 py-2 bg-background border rounded-md focus:ring-2 focus:ring-primary">
                </div>

                <!-- Epochs -->
                <div>
                    <label class="block text-sm font-medium mb-2">에포크 수 (Epochs)</label>
                    <input type="number" id="epochs" value="100" min="1" max="1000" 
                           class="w-full px-3 py-2 bg-background border rounded-md focus:ring-2 focus:ring-primary">
                </div>
            </div>

            <!-- Advanced Settings -->
            <div class="mt-6 pt-6 border-t">
                <h3 class="font-medium mb-4">고급 설정</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Dropout Rate</label>
                        <input type="number" id="dropoutRate" value="0.2" step="0.1" min="0" max="0.9" 
                               class="w-full px-3 py-2 bg-background border rounded-md focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Validation Split</label>
                        <input type="number" id="validationSplit" value="0.2" step="0.1" min="0.1" max="0.5" 
                               class="w-full px-3 py-2 bg-background border rounded-md focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Anomaly Threshold</label>
                        <input type="number" id="anomalyThreshold" value="0.95" step="0.01" min="0.5" max="1" 
                               class="w-full px-3 py-2 bg-background border rounded-md focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Early Stopping Patience</label>
                        <input type="number" id="earlyStoppingPatience" value="10" min="1" max="50" 
                               class="w-full px-3 py-2 bg-background border rounded-md focus:ring-2 focus:ring-primary">
                    </div>
                </div>
            </div>

            <!-- Training Controls -->
            <div class="mt-6 flex gap-4">
                <button id="startTrainingBtn" onclick="startTraining()" 
                        class="px-6 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors">
                    🚀 학습 시작
                </button>
                <button id="stopTrainingBtn" onclick="stopTraining()" disabled
                        class="px-6 py-2 bg-destructive text-destructive-foreground rounded-md hover:bg-destructive/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    ⏹️ 학습 중단
                </button>
                <button onclick="saveCheckpoint()"
                        class="px-6 py-2 bg-secondary text-secondary-foreground rounded-md hover:bg-secondary/90 transition-colors">
                    💾 체크포인트 저장
                </button>
                <button onclick="loadCheckpoint()"
                        class="px-6 py-2 bg-secondary text-secondary-foreground rounded-md hover:bg-secondary/90 transition-colors">
                    📂 체크포인트 불러오기
                </button>
            </div>
        </div>

        <!-- Training Progress -->
        <div class="bg-card rounded-lg border p-6 mb-8" id="trainingProgress" style="display: none;">
            <h2 class="text-xl font-semibold mb-4">학습 진행 상황</h2>
            
            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-sm text-muted-foreground">진행률</span>
                    <span class="text-sm font-medium" id="progressText">0 / 100 epochs</span>
                </div>
                <div class="w-full bg-muted rounded-full h-3">
                    <div id="progressBar" class="bg-primary h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Real-time Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-muted rounded p-3">
                    <p class="text-sm text-muted-foreground mb-1">현재 에포크</p>
                    <p class="text-2xl font-bold" id="currentEpoch">0</p>
                </div>
                <div class="bg-muted rounded p-3">
                    <p class="text-sm text-muted-foreground mb-1">학습 손실</p>
                    <p class="text-2xl font-bold" id="trainingLoss">0.0000</p>
                </div>
                <div class="bg-muted rounded p-3">
                    <p class="text-sm text-muted-foreground mb-1">검증 손실</p>
                    <p class="text-2xl font-bold" id="validationLoss">0.0000</p>
                </div>
                <div class="bg-muted rounded p-3">
                    <p class="text-sm text-muted-foreground mb-1">남은 시간</p>
                    <p class="text-2xl font-bold" id="remainingTime">--:--</p>
                </div>
            </div>

            <!-- Training Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-medium mb-3">손실 함수 추이</h3>
                    <div class="ml-chart-container">
                        <canvas id="lossChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="font-medium mb-3">재구성 오류 분포</h3>
                    <div class="ml-chart-container">
                        <canvas id="reconstructionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Results -->
        <div class="bg-card rounded-lg border p-6" id="trainingResults" style="display: none;">
            <h2 class="text-xl font-semibold mb-4">학습 결과</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Final Metrics -->
                <div>
                    <h3 class="font-medium mb-3">최종 성능 지표</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-muted-foreground">최종 학습 손실</span>
                            <span class="font-medium" id="finalTrainLoss">0.0234</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-muted-foreground">최종 검증 손실</span>
                            <span class="font-medium" id="finalValidLoss">0.0267</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-muted-foreground">이상탐지 정확도</span>
                            <span class="font-medium text-green-600" id="finalAccuracy">95.3%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-muted-foreground">False Positive Rate</span>
                            <span class="font-medium" id="falsePositiveRate">2.1%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-muted-foreground">False Negative Rate</span>
                            <span class="font-medium" id="falseNegativeRate">4.7%</span>
                        </div>
                    </div>
                </div>

                <!-- Training Summary -->
                <div>
                    <h3 class="font-medium mb-3">학습 요약</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-muted-foreground">총 학습 시간</span>
                            <span class="font-medium" id="totalTrainingTime">45분 23초</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-muted-foreground">에포크당 평균 시간</span>
                            <span class="font-medium" id="avgTimePerEpoch">27.14초</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-muted-foreground">학습 데이터 수</span>
                            <span class="font-medium" id="trainingDataSize">50,000</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-muted-foreground">검증 데이터 수</span>
                            <span class="font-medium" id="validationDataSize">10,000</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-muted-foreground">최적 에포크</span>
                            <span class="font-medium" id="bestEpoch">87</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <button onclick="deployModel()" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    🚀 모델 배포
                </button>
                <button onclick="exportModel()" class="px-6 py-2 bg-secondary text-secondary-foreground rounded-md hover:bg-secondary/90 transition-colors">
                    📥 모델 내보내기
                </button>
                <button onclick="viewDetailedReport()" class="px-6 py-2 bg-secondary text-secondary-foreground rounded-md hover:bg-secondary/90 transition-colors">
                    📊 상세 리포트
                </button>
            </div>
        </div>
    </main>

    <script>
        // Initialize charts
        let lossChart, reconstructionChart;
        let isTraining = false;
        let trainingInterval;

        function initCharts() {
            // Loss Chart
            const lossCtx = document.getElementById('lossChart')?.getContext('2d');
            if (lossCtx) {
                lossChart = new Chart(lossCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '학습 손실',
                            data: [],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }, {
                            label: '검증 손실',
                            data: [],
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Epoch' } },
                            y: { title: { display: true, text: 'Loss' } }
                        }
                    }
                });
            }

            // Reconstruction Error Distribution Chart
            const reconCtx = document.getElementById('reconstructionChart')?.getContext('2d');
            if (reconCtx) {
                reconstructionChart = new Chart(reconCtx, {
                    type: 'bar',
                    data: {
                        labels: ['0-0.1', '0.1-0.2', '0.2-0.3', '0.3-0.4', '0.4-0.5', '0.5-0.6', '0.6-0.7', '0.7-0.8', '0.8-0.9', '0.9-1.0'],
                        datasets: [{
                            label: '재구성 오류 분포',
                            data: [],
                            backgroundColor: 'rgba(34, 197, 94, 0.5)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 0 },
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Error Range' } },
                            y: { title: { display: true, text: 'Count' } }
                        }
                    }
                });
            }
        }

        async function startTraining() {
            const dataset = document.getElementById('datasetSelect').value;
            const learningRate = parseFloat(document.getElementById('learningRate').value);
            const batchSize = parseInt(document.getElementById('batchSize').value);
            const epochs = parseInt(document.getElementById('epochs').value);
            const dropoutRate = parseFloat(document.getElementById('dropoutRate').value);
            const validationSplit = parseFloat(document.getElementById('validationSplit').value);
            const anomalyThreshold = parseFloat(document.getElementById('anomalyThreshold').value);

            // Show training progress
            document.getElementById('trainingProgress').style.display = 'block';
            document.getElementById('trainingResults').style.display = 'none';
            
            // Disable/enable buttons
            document.getElementById('startTrainingBtn').disabled = true;
            document.getElementById('stopTrainingBtn').disabled = false;
            
            isTraining = true;

            // Generate sophisticated mock training data
            const trainingData = generateMockTrainingData(dataset);
            console.log(`📊 Autoencoder 학습 데이터 준비 완료: ${trainingData.length}개 샘플`);

            // Start training via API
            try {
                const response = await fetch('http://localhost:3004/api/models/autoencoder/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        datasetId: dataset,
                        hyperparameters: {
                            learningRate,
                            epochs,
                            batchSize,
                            threshold: anomalyThreshold,
                            dropoutRate,
                            validationSplit
                        },
                        trainingData: trainingData
                    })
                });

                if (!response.ok) {
                    throw new Error('Training failed');
                }

                // Simulate training progress
                simulateTrainingProgress(epochs);

            } catch (error) {
                console.log('⚠️ AIOps API 서버 연결 실패, 모의 Autoencoder 학습으로 전환:', error.message);
                console.log('🔄 클라이언트 기반 Autoencoder 모델 학습 시뮬레이션을 시작합니다...');
                // Continue with enhanced mock training simulation
                simulateTrainingProgress(epochs);
            }
        }

        // Enhanced Autoencoder training simulation with realistic patterns
        function simulateTrainingProgress(totalEpochs) {
            let currentEpoch = 0;
            const startTime = Date.now();
            const learningRate = parseFloat(document.getElementById('learningRate').value);
            const batchSize = parseInt(document.getElementById('batchSize').value);
            const dataset = document.getElementById('datasetSelect').value;
            
            console.log(`🚀 Autoencoder 모델 학습 시작: ${totalEpochs} epochs, LR=${learningRate}, Batch=${batchSize}, Dataset=${dataset}`);
            
            trainingInterval = setInterval(() => {
                if (!isTraining || currentEpoch >= totalEpochs) {
                    clearInterval(trainingInterval);
                    if (currentEpoch >= totalEpochs) {
                        console.log('✅ Autoencoder 모델 학습 완료!');
                        showTrainingResults();
                    }
                    return;
                }

                currentEpoch++;
                const progress = (currentEpoch / totalEpochs) * 100;
                const normalizedProgress = currentEpoch / totalEpochs;
                
                // Update progress bar
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = `${currentEpoch} / ${totalEpochs} epochs`;
                document.getElementById('currentEpoch').textContent = currentEpoch;
                
                // Enhanced loss simulation with realistic Autoencoder patterns
                const initialTrainLoss = 1.2; // Higher initial loss for reconstruction
                const trainLoss = Math.max(0.01, initialTrainLoss * Math.exp(-normalizedProgress * 2.8) + Math.random() * 0.015 + 0.005);
                
                // Validation loss with slight overfitting tendency
                const overfittingFactor = Math.max(0, normalizedProgress - 0.7) * 0.05; // Start overfitting after 70%
                const valLoss = Math.max(0.01, trainLoss + Math.random() * 0.02 + overfittingFactor);
                
                document.getElementById('trainingLoss').textContent = trainLoss.toFixed(4);
                document.getElementById('validationLoss').textContent = valLoss.toFixed(4);
                
                // Calculate remaining time with realistic estimates
                const elapsedTime = Date.now() - startTime;
                const avgTimePerEpoch = elapsedTime / currentEpoch;
                const remainingEpochs = totalEpochs - currentEpoch;
                const remainingMs = avgTimePerEpoch * remainingEpochs;
                const remainingMinutes = Math.floor(remainingMs / 60000);
                const remainingSeconds = Math.floor((remainingMs % 60000) / 1000);
                document.getElementById('remainingTime').textContent = 
                    `${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                
                // Log progress periodically
                if (currentEpoch % 10 === 0 || currentEpoch === 1) {
                    console.log(`📊 Epoch ${currentEpoch}/${totalEpochs}: Train Loss=${trainLoss.toFixed(4)}, Val Loss=${valLoss.toFixed(4)}`);
                }
                
                // Update loss chart with smoother curves
                if (lossChart) {
                    lossChart.data.labels.push(currentEpoch);
                    lossChart.data.datasets[0].data.push(trainLoss);
                    lossChart.data.datasets[1].data.push(valLoss);
                    lossChart.update('none');
                }
                
                // Update reconstruction error distribution with realistic patterns
                if (reconstructionChart && currentEpoch % 5 === 0) {
                    // Simulate improving reconstruction quality over time
                    const improvementFactor = 1 - normalizedProgress * 0.8; // Errors get more concentrated in lower bins
                    const distribution = [
                        Math.floor(1000 * (0.85 + normalizedProgress * 0.1) * (1 + Math.random() * 0.1)), // 0-0.1: Most normal data
                        Math.floor(300 * improvementFactor * (1 + Math.random() * 0.2)), // 0.1-0.2
                        Math.floor(150 * improvementFactor * (1 + Math.random() * 0.3)), // 0.2-0.3
                        Math.floor(80 * improvementFactor * (1 + Math.random() * 0.4)),  // 0.3-0.4
                        Math.floor(40 * improvementFactor * (1 + Math.random() * 0.5)),  // 0.4-0.5
                        Math.floor(25 * improvementFactor * (1 + Math.random() * 0.6)),  // 0.5-0.6
                        Math.floor(15 * improvementFactor * (1 + Math.random() * 0.7)),  // 0.6-0.7
                        Math.floor(10 * improvementFactor * (1 + Math.random() * 0.8)),  // 0.7-0.8
                        Math.floor(8 * improvementFactor * (1 + Math.random() * 0.9)),   // 0.8-0.9
                        Math.floor(5 * (1 + Math.random()))  // 0.9-1.0: Anomalies should stay in high error range
                    ];
                    
                    reconstructionChart.data.datasets[0].data = distribution;
                    reconstructionChart.update('none');
                }
                
                // Variable delay for realistic training simulation
                const delay = Math.max(200, 400 - (normalizedProgress * 200)); // Faster near end
                
            }, 300); // Base interval for better UX
        }

        function stopTraining() {
            isTraining = false;
            if (trainingInterval) {
                clearInterval(trainingInterval);
            }
            
            document.getElementById('startTrainingBtn').disabled = false;
            document.getElementById('stopTrainingBtn').disabled = true;
        }

        function showTrainingResults() {
            stopTraining();
            document.getElementById('trainingResults').style.display = 'block';
            
            // Set final results (mock data)
            document.getElementById('finalTrainLoss').textContent = '0.0234';
            document.getElementById('finalValidLoss').textContent = '0.0267';
            document.getElementById('finalAccuracy').textContent = '95.3%';
            document.getElementById('falsePositiveRate').textContent = '2.1%';
            document.getElementById('falseNegativeRate').textContent = '4.7%';
            document.getElementById('totalTrainingTime').textContent = '45분 23초';
            document.getElementById('avgTimePerEpoch').textContent = '27.14초';
            document.getElementById('trainingDataSize').textContent = '50,000';
            document.getElementById('validationDataSize').textContent = '10,000';
            document.getElementById('bestEpoch').textContent = '87';
        }

        // Generate sophisticated mock training data for Autoencoder
        function generateMockTrainingData(dataset) {
            const dataSize = dataset === 'recent' ? 2000 : dataset === 'month' ? 8000 : dataset === 'quarter' ? 25000 : dataset === 'benchmark' ? 50000 : 12000;
            const data = [];
            
            console.log(`📊 Autoencoder 학습 데이터 생성 시작: ${dataSize}개 샘플`);
            
            const services = ['api-gateway', 'user-service', 'payment-service', 'order-service', 'inventory-service', 'notification-service'];
            
            // Define normal and anomalous patterns
            const normalPatterns = {
                'normal_operation': { cpu: [20, 60], memory: [30, 70], disk: [10, 40], network: [50, 200], responseTime: [100, 500] },
                'moderate_load': { cpu: [40, 75], memory: [50, 80], disk: [20, 60], network: [100, 400], responseTime: [200, 800] },
                'high_load': { cpu: [60, 85], memory: [70, 90], disk: [40, 80], network: [200, 600], responseTime: [500, 1500] }
            };
            
            const anomalousPatterns = {
                'memory_leak': { cpu: [30, 50], memory: [90, 100], disk: [20, 40], network: [100, 300], responseTime: [2000, 8000] },
                'cpu_spike': { cpu: [95, 100], memory: [40, 70], disk: [30, 60], network: [300, 1000], responseTime: [3000, 10000] },
                'disk_saturation': { cpu: [40, 80], memory: [60, 85], disk: [95, 100], network: [100, 400], responseTime: [5000, 15000] },
                'network_congestion': { cpu: [30, 60], memory: [40, 70], disk: [20, 50], network: [2000, 5000], responseTime: [8000, 20000] },
                'service_degradation': { cpu: [70, 90], memory: [80, 95], disk: [60, 90], network: [500, 1500], responseTime: [4000, 12000] }
            };
            
            // Generate 95% normal data, 5% anomalous data
            for (let i = 0; i < dataSize; i++) {
                const isAnomalous = Math.random() < 0.05; // 5% anomaly rate
                const patterns = isAnomalous ? anomalousPatterns : normalPatterns;
                const patternKeys = Object.keys(patterns);
                const patternType = patternKeys[Math.floor(Math.random() * patternKeys.length)];
                const pattern = patterns[patternType];
                
                // Generate timestamp with realistic distribution (more data during business hours)
                const timestamp = new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000);
                const hour = timestamp.getHours();
                const businessHourMultiplier = (hour >= 8 && hour <= 18) ? 1.2 : 0.8;
                
                // Generate correlated metrics
                const cpu = Math.min(100, Math.max(0, pattern.cpu[0] + Math.random() * (pattern.cpu[1] - pattern.cpu[0])));
                const memory = Math.min(100, Math.max(0, pattern.memory[0] + Math.random() * (pattern.memory[1] - pattern.memory[0])));
                const disk = Math.min(100, Math.max(0, pattern.disk[0] + Math.random() * (pattern.disk[1] - pattern.disk[0])));
                const network = Math.max(0, pattern.network[0] + Math.random() * (pattern.network[1] - pattern.network[0]));
                const responseTime = Math.max(50, pattern.responseTime[0] + Math.random() * (pattern.responseTime[1] - pattern.responseTime[0]));
                
                // Calculate derived metrics
                const errorRate = isAnomalous ? Math.random() * 15 + 5 : Math.random() * 2;
                const throughput = Math.max(1, 1000 - (responseTime * 0.3) - (cpu * 5) + Math.random() * 200) * businessHourMultiplier;
                const connections = Math.floor(Math.max(1, throughput * 0.1 + Math.random() * 50));
                const threads = Math.floor(Math.max(1, cpu * 2 + Math.random() * 50));
                const transactions = Math.floor(Math.max(1, throughput * 0.8 + Math.random() * 100));
                const heapUsage = Math.min(100, memory + Math.random() * 10 - 5);
                const gcCount = Math.floor(Math.max(0, (memory - 70) * 0.5 + Math.random() * 5));
                
                data.push({
                    id: `sample_${String(i + 1).padStart(6, '0')}`,
                    timestamp: timestamp.toISOString(),
                    service: services[Math.floor(Math.random() * services.length)],
                    pattern_type: patternType,
                    is_anomaly: isAnomalous,
                    // Primary metrics (input features for autoencoder)
                    cpu_usage: cpu,
                    memory_usage: memory,
                    disk_usage: disk,
                    network_latency: network,
                    response_time: responseTime,
                    error_rate: errorRate,
                    throughput: throughput,
                    active_connections: connections,
                    thread_count: threads,
                    transaction_count: transactions,
                    heap_usage: heapUsage,
                    gc_count: gcCount,
                    // Additional features for more robust anomaly detection
                    request_queue_size: Math.floor(Math.max(0, (cpu + memory) * 0.5 + Math.random() * 20)),
                    session_count: Math.floor(Math.max(0, connections * 0.7 + Math.random() * 30)),
                    cache_hit_ratio: Math.max(0.3, 1 - (responseTime / 10000) + Math.random() * 0.2),
                    db_query_time: Math.max(1, responseTime * 0.3 + Math.random() * 100),
                    jvm_old_gen_usage: Math.min(100, memory * 0.8 + Math.random() * 20),
                    // Feature vector for autoencoder (normalized to 0-1 range)
                    feature_vector: [
                        cpu / 100, memory / 100, disk / 100, network / 5000, responseTime / 20000,
                        errorRate / 20, throughput / 2000, connections / 500, threads / 200, 
                        transactions / 2000, heapUsage / 100, gcCount / 20
                    ]
                });
            }
            
            const anomalyCount = data.filter(d => d.is_anomaly).length;
            console.log(`✅ Autoencoder 학습 데이터 생성 완료: ${dataSize}개 샘플, 이상치 ${anomalyCount}개 (${(anomalyCount/dataSize*100).toFixed(1)}%)`);
            return data;
        }

        async function saveCheckpoint() {
            try {
                const checkpointName = prompt('체크포인트 이름을 입력하세요:', `checkpoint_${new Date().getTime()}`);
                if (!checkpointName) return;
                
                const response = await fetch('http://localhost:3004/api/models/autoencoder/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ checkpointName })
                });
                
                if (response.ok) {
                    alert('체크포인트가 저장되었습니다.');
                }
            } catch (error) {
                console.log('⚠️ API 연결 실패, 로컬 체크포인트 시뮬레이션:', error.message);
                alert(`체크포인트 '${checkpointName}'이 로컬로 저장되었습니다 (모의 모드).`);
            }
        }

        async function loadCheckpoint() {
            try {
                const checkpointName = prompt('불러올 체크포인트 이름을 입력하세요:');
                if (!checkpointName) return;
                
                const response = await fetch('http://localhost:3004/api/models/autoencoder/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ checkpointName })
                });
                
                if (response.ok) {
                    alert('체크포인트가 로드되었습니다.');
                }
            } catch (error) {
                console.log('⚠️ API 연결 실패, 로컬 체크포인트 시뮬레이션:', error.message);
                alert(`체크포인트 '${checkpointName}'이 로컬에서 로드되었습니다 (모의 모드).`);
            }
        }

        function deployModel() {
            if (confirm('현재 모델을 프로덕션에 배포하시겠습니까?')) {
                alert('모델이 성공적으로 배포되었습니다.');
            }
        }

        function exportModel() {
            alert('모델 내보내기 기능이 준비 중입니다.');
        }

        function viewDetailedReport() {
            window.open('/ml-training-report.html?model=autoencoder', '_blank');
        }

        // Update current time
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updateTime();
            setInterval(updateTime, 1000);
        });
    </script>
</body>
</html>