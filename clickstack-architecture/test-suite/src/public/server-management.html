<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œë²„ ê´€ë¦¬ - AIRIS-MON</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="/components/common-layout.js"></script>
    <style>
        .server-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .server-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .server-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .server-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .server-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .server-status.online {
            background: #ecfdf5;
            color: #10b981;
        }

        .server-status.offline {
            background: #fef2f2;
            color: #ef4444;
        }

        .server-status.installing {
            background: #fef3c7;
            color: #f59e0b;
        }

        .server-status.unknown {
            background: #f1f5f9;
            color: #64748b;
        }

        .server-info {
            margin: 1rem 0;
        }

        .server-info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .server-info-label {
            font-weight: 500;
            color: #64748b;
        }

        .server-info-value {
            color: #1e293b;
            text-align: right;
        }

        .server-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border-color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            padding: 0.5rem 0.5rem 0.5rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            width: 250px;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: #2563eb;
            transition: width 0.3s ease;
        }

        .log-viewer {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.online {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: #ef4444;
        }

        .status-dot.installing {
            background: #f59e0b;
            animation: pulse 2s infinite;
        }

        .status-dot.unknown {
            background: #64748b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #ecfdf5;
            color: #10b981;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fef2f2;
            color: #ef4444;
            border: 1px solid #fca5a5;
        }

        .alert-warning {
            background: #fef3c7;
            color: #f59e0b;
            border: 1px solid #fcd34d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="airis-content-wrapper">
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalServers">0</div>
                <div class="stat-label">ì´ ì„œë²„</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="onlineServers">0</div>
                <div class="stat-label">ì˜¨ë¼ì¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="offlineServers">0</div>
                <div class="stat-label">ì˜¤í”„ë¼ì¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="installingServers">0</div>
                <div class="stat-label">ì„¤ì¹˜ ì¤‘</div>
            </div>
        </div>

        <!-- íˆ´ë°” -->
        <div class="toolbar">
            <div class="toolbar-left">
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="ì„œë²„ ê²€ìƒ‰...">
                </div>
                <select class="form-select" id="typeFilter" style="width: auto;">
                    <option value="">ëª¨ë“  íƒ€ì…</option>
                    <option value="app">ì• í”Œë¦¬ì¼€ì´ì…˜</option>
                    <option value="db">ë°ì´í„°ë² ì´ìŠ¤</option>
                    <option value="web">ì›¹ì„œë²„</option>
                    <option value="was">WAS</option>
                    <option value="system">ì‹œìŠ¤í…œ</option>
                </select>
                <select class="form-select" id="statusFilter" style="width: auto;">
                    <option value="">ëª¨ë“  ìƒíƒœ</option>
                    <option value="online">ì˜¨ë¼ì¸</option>
                    <option value="offline">ì˜¤í”„ë¼ì¸</option>
                    <option value="installing">ì„¤ì¹˜ ì¤‘</option>
                    <option value="unknown">ì•Œ ìˆ˜ ì—†ìŒ</option>
                </select>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="refreshServers()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button class="btn btn-primary" onclick="showAddServerModal()">â• ì„œë²„ ì¶”ê°€</button>
            </div>
        </div>

        <!-- ì•Œë¦¼ ì˜ì—­ -->
        <div id="alertContainer"></div>

        <!-- ì„œë²„ ê·¸ë¦¬ë“œ -->
        <div class="server-grid" id="serverGrid">
            <!-- ì„œë²„ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingIndicator" style="text-align: center; padding: 2rem; display: none;">
            <div>ì„œë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <!-- ë¹ˆ ìƒíƒœ -->
        <div id="emptyState" style="text-align: center; padding: 3rem; display: none;">
            <h3>ë“±ë¡ëœ ì„œë²„ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p style="color: #64748b; margin: 1rem 0;">ì²« ë²ˆì§¸ ì„œë²„ë¥¼ ì¶”ê°€í•˜ì—¬ ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
            <button class="btn btn-primary" onclick="showAddServerModal()">ì„œë²„ ì¶”ê°€</button>
        </div>
    </div>

    <!-- ì„œë²„ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="serverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">ì„œë²„ ì¶”ê°€</h2>
                <button class="modal-close" onclick="closeModal('serverModal')">&times;</button>
            </div>
            <form id="serverForm">
                <div class="form-group">
                    <label class="form-label">ì„œë²„ ì´ë¦„ *</label>
                    <input type="text" class="form-input" id="serverName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">í˜¸ìŠ¤íŠ¸ ì£¼ì†Œ *</label>
                    <input type="text" class="form-input" id="serverHost" required placeholder="ì˜ˆ: 192.168.1.100 ë˜ëŠ” server.example.com">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">SSH í¬íŠ¸</label>
                        <input type="number" class="form-input" id="serverPort" value="22">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì‚¬ìš©ìëª… *</label>
                        <input type="text" class="form-input" id="serverUsername" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">SSH í‚¤ íŒŒì¼ ê²½ë¡œ</label>
                    <input type="text" class="form-input" id="serverKeyPath" placeholder="ì˜ˆ: /home/user/.ssh/id_rsa (ì„ íƒì‚¬í•­)">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">ì„œë²„ íƒ€ì… *</label>
                        <select class="form-select" id="serverType" required>
                            <option value="">íƒ€ì… ì„ íƒ</option>
                            <option value="app">ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„</option>
                            <option value="db">ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„</option>
                            <option value="web">ì›¹ì„œë²„</option>
                            <option value="was">WAS ì„œë²„</option>
                            <option value="system">ì‹œìŠ¤í…œ ì„œë²„</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì„¸ë¶€ íƒ€ì…</label>
                        <select class="form-select" id="serverSubtype">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">AIRIS-MON ì„œë²„ ì—”ë“œí¬ì¸íŠ¸</label>
                    <input type="text" class="form-input" id="airisEndpoint" value="http://localhost:4317" placeholder="ì˜ˆ: http://airis-server:4317">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ì„¤ì¹˜í•  ì»´í¬ë„ŒíŠ¸</label>
                    <div class="checkbox-group" id="componentsContainer">
                        <!-- ì»´í¬ë„ŒíŠ¸ ì²´í¬ë°•ìŠ¤ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('serverModal')">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì„¤ì¹˜ ì§„í–‰ ëª¨ë‹¬ -->
    <div id="installModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ëª¨ë‹ˆí„°ë§ ì—ì´ì „íŠ¸ ì„¤ì¹˜</h2>
                <button class="modal-close" onclick="closeModal('installModal')">&times;</button>
            </div>
            <div id="installContent">
                <div class="form-group">
                    <label class="form-label">ì„œë²„: <span id="installServerName"></span></label>
                    <div class="progress-bar">
                        <div class="progress-fill" id="installProgress" style="width: 0%"></div>
                    </div>
                    <div style="text-align: center; margin: 0.5rem 0;">
                        <span id="installProgressText">0%</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ì„¤ì¹˜ ë¡œê·¸</label>
                    <div class="log-viewer" id="installLogs">ì„¤ì¹˜ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...</div>
                </div>
                
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-secondary" id="installCloseBtn" onclick="closeModal('installModal')" disabled>ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let servers = [];
        let currentEditingServer = null;

        // ì„œë²„ íƒ€ì…ë³„ ì„¸ë¶€ íƒ€ì… ì˜µì…˜
        const subtypeOptions = {
            app: ['nodejs', 'java', 'python', 'go', 'php', 'ruby', 'dotnet'],
            db: ['mysql', 'postgresql', 'mongodb', 'redis', 'oracle', 'mssql'],
            web: ['nginx', 'apache', 'lighttpd', 'caddy'],
            was: ['tomcat', 'jetty', 'jboss', 'websphere', 'weblogic'],
            system: ['linux', 'windows', 'unix']
        };

        // íƒ€ì…ë³„ ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸
        const defaultComponents = {
            app: ['otel', 'node'],
            db: ['otel', 'node'],
            web: ['otel', 'node', 'nginx'],
            was: ['otel', 'node', 'java'],
            system: ['node']
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadServers();
        });

        function setupEventListeners() {
            // ê²€ìƒ‰ ë° í•„í„°ë§
            document.getElementById('searchInput').addEventListener('input', filterServers);
            document.getElementById('typeFilter').addEventListener('change', filterServers);
            document.getElementById('statusFilter').addEventListener('change', filterServers);

            // ì„œë²„ íƒ€ì… ë³€ê²½ ì‹œ ì„¸ë¶€ íƒ€ì… ì—…ë°ì´íŠ¸
            document.getElementById('serverType').addEventListener('change', updateSubtypeOptions);

            // í¼ ì œì¶œ
            document.getElementById('serverForm').addEventListener('submit', handleServerSubmit);
        }

        async function loadServers() {
            try {
                showLoading(true);
                const response = await fetch('/api/servers');
                const result = await response.json();

                if (result.success) {
                    servers = result.data;
                    updateStats();
                    renderServers();
                } else {
                    showAlert('ì„œë²„ ëª©ë¡ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to load servers:', error);
                showAlert('ì„œë²„ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            } finally {
                showLoading(false);
            }
        }

        function updateStats() {
            const total = servers.length;
            const online = servers.filter(s => s.status === 'online').length;
            const offline = servers.filter(s => s.status === 'offline').length;
            const installing = servers.filter(s => s.status === 'installing').length;

            document.getElementById('totalServers').textContent = total;
            document.getElementById('onlineServers').textContent = online;
            document.getElementById('offlineServers').textContent = offline;
            document.getElementById('installingServers').textContent = installing;
        }

        function renderServers() {
            const container = document.getElementById('serverGrid');
            const emptyState = document.getElementById('emptyState');

            if (servers.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            container.innerHTML = servers.map(server => createServerCard(server)).join('');
        }

        function createServerCard(server) {
            const lastCheck = server.lastCheck ? new Date(server.lastCheck).toLocaleString('ko-KR') : 'í™•ì¸ ì•ˆë¨';
            const components = server.components ? server.components.join(', ') : 'ì—†ìŒ';

            return `
                <div class="server-card">
                    <div class="server-header">
                        <h3 class="server-name">${server.name}</h3>
                        <span class="server-status ${server.status}">
                            <span class="status-dot ${server.status}"></span>
                            ${getStatusText(server.status)}
                        </span>
                    </div>
                    
                    <div class="server-info">
                        <div class="server-info-item">
                            <span class="server-info-label">í˜¸ìŠ¤íŠ¸</span>
                            <span class="server-info-value">${server.host}:${server.port}</span>
                        </div>
                        <div class="server-info-item">
                            <span class="server-info-label">íƒ€ì…</span>
                            <span class="server-info-value">${getTypeText(server.type)} ${server.subtype ? `(${server.subtype})` : ''}</span>
                        </div>
                        <div class="server-info-item">
                            <span class="server-info-label">ì‚¬ìš©ì</span>
                            <span class="server-info-value">${server.username}</span>
                        </div>
                        <div class="server-info-item">
                            <span class="server-info-label">ì»´í¬ë„ŒíŠ¸</span>
                            <span class="server-info-value">${components}</span>
                        </div>
                        <div class="server-info-item">
                            <span class="server-info-label">ë§ˆì§€ë§‰ í™•ì¸</span>
                            <span class="server-info-value">${lastCheck}</span>
                        </div>
                    </div>
                    
                    <div class="server-actions">
                        <button class="btn btn-secondary" onclick="checkConnection('${server.id}')">
                            ğŸ” ì—°ê²° í™•ì¸
                        </button>
                        <button class="btn btn-success" onclick="installAgents('${server.id}')">
                            ğŸ¤– ì—ì´ì „íŠ¸ ì„¤ì¹˜
                        </button>
                        <button class="btn btn-secondary" onclick="editServer('${server.id}')">
                            âœï¸ ìˆ˜ì •
                        </button>
                        <button class="btn btn-danger" onclick="deleteServer('${server.id}')">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </div>
                </div>
            `;
        }

        function getStatusText(status) {
            const statusMap = {
                online: 'ì˜¨ë¼ì¸',
                offline: 'ì˜¤í”„ë¼ì¸',
                installing: 'ì„¤ì¹˜ ì¤‘',
                unknown: 'ì•Œ ìˆ˜ ì—†ìŒ',
                error: 'ì˜¤ë¥˜'
            };
            return statusMap[status] || status;
        }

        function getTypeText(type) {
            const typeMap = {
                app: 'ì• í”Œë¦¬ì¼€ì´ì…˜',
                db: 'ë°ì´í„°ë² ì´ìŠ¤',
                web: 'ì›¹ì„œë²„',
                was: 'WAS',
                system: 'ì‹œìŠ¤í…œ'
            };
            return typeMap[type] || type;
        }

        function filterServers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            const filteredServers = servers.filter(server => {
                const matchesSearch = server.name.toLowerCase().includes(searchTerm) ||
                                    server.host.toLowerCase().includes(searchTerm);
                const matchesType = !typeFilter || server.type === typeFilter;
                const matchesStatus = !statusFilter || server.status === statusFilter;

                return matchesSearch && matchesType && matchesStatus;
            });

            const container = document.getElementById('serverGrid');
            container.innerHTML = filteredServers.map(server => createServerCard(server)).join('');
        }

        function showAddServerModal() {
            currentEditingServer = null;
            document.getElementById('modalTitle').textContent = 'ì„œë²„ ì¶”ê°€';
            document.getElementById('serverForm').reset();
            document.getElementById('airisEndpoint').value = 'http://localhost:4317';
            updateComponentsContainer();
            showModal('serverModal');
        }

        function editServer(serverId) {
            const server = servers.find(s => s.id === serverId);
            if (!server) return;

            currentEditingServer = server;
            document.getElementById('modalTitle').textContent = 'ì„œë²„ ìˆ˜ì •';
            
            // í¼ í•„ë“œ ì±„ìš°ê¸°
            document.getElementById('serverName').value = server.name;
            document.getElementById('serverHost').value = server.host;
            document.getElementById('serverPort').value = server.port;
            document.getElementById('serverUsername').value = server.username;
            document.getElementById('serverKeyPath').value = server.keyPath || '';
            document.getElementById('serverType').value = server.type;
            document.getElementById('airisEndpoint').value = server.airisEndpoint || 'http://localhost:4317';
            
            updateSubtypeOptions();
            document.getElementById('serverSubtype').value = server.subtype || '';
            
            updateComponentsContainer();
            // ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ ì„ íƒ
            if (server.components) {
                server.components.forEach(component => {
                    const checkbox = document.querySelector(`input[name="components"][value="${component}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            showModal('serverModal');
        }

        function updateSubtypeOptions() {
            const type = document.getElementById('serverType').value;
            const subtypeSelect = document.getElementById('serverSubtype');
            
            subtypeSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            if (type && subtypeOptions[type]) {
                subtypeOptions[type].forEach(subtype => {
                    const option = document.createElement('option');
                    option.value = subtype;
                    option.textContent = subtype.toUpperCase();
                    subtypeSelect.appendChild(option);
                });
            }
            
            updateComponentsContainer();
        }

        function updateComponentsContainer() {
            const type = document.getElementById('serverType').value;
            const container = document.getElementById('componentsContainer');
            
            const allComponents = ['otel', 'node', 'nginx', 'apache', 'mysql', 'postgresql', 'mongodb', 'redis', 'java', 'nodejs', 'python'];
            const recommended = defaultComponents[type] || ['otel', 'node'];
            
            container.innerHTML = allComponents.map(component => {
                const isRecommended = recommended.includes(component);
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" name="components" value="${component}" id="comp-${component}" ${isRecommended ? 'checked' : ''}>
                        <label for="comp-${component}">${component.toUpperCase()}</label>
                    </div>
                `;
            }).join('');
        }

        async function handleServerSubmit(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('serverName').value,
                host: document.getElementById('serverHost').value,
                port: parseInt(document.getElementById('serverPort').value),
                username: document.getElementById('serverUsername').value,
                keyPath: document.getElementById('serverKeyPath').value || null,
                type: document.getElementById('serverType').value,
                subtype: document.getElementById('serverSubtype').value || null,
                airisEndpoint: document.getElementById('airisEndpoint').value,
                components: Array.from(document.querySelectorAll('input[name="components"]:checked')).map(cb => cb.value)
            };

            try {
                const url = currentEditingServer ? `/api/servers/${currentEditingServer.id}` : '/api/servers';
                const method = currentEditingServer ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                    closeModal('serverModal');
                    loadServers();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to save server:', error);
                showAlert('ì„œë²„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        async function checkConnection(serverId) {
            try {
                const response = await fetch(`/api/servers/${serverId}/check-connection`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    if (result.connected) {
                        showAlert('ì„œë²„ ì—°ê²°ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤', 'success');
                    } else {
                        showAlert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message, 'error');
                    }
                    loadServers(); // ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ë‹¤ì‹œ ë¡œë“œ
                } else {
                    showAlert('ì—°ê²° í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to check connection:', error);
                showAlert('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        async function installAgents(serverId) {
            const server = servers.find(s => s.id === serverId);
            if (!server) return;

            document.getElementById('installServerName').textContent = server.name;
            document.getElementById('installProgress').style.width = '0%';
            document.getElementById('installProgressText').textContent = '0%';
            document.getElementById('installLogs').textContent = 'ì„¤ì¹˜ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...';
            document.getElementById('installCloseBtn').disabled = true;
            
            showModal('installModal');

            try {
                const response = await fetch(`/api/servers/${serverId}/install`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        components: server.components
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // ì„¤ì¹˜ ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§ ì‹œì‘
                    monitorInstallation(serverId, result.jobId);
                } else {
                    showAlert('ì„¤ì¹˜ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message, 'error');
                    closeModal('installModal');
                }
            } catch (error) {
                console.error('Failed to start installation:', error);
                showAlert('ì„¤ì¹˜ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                closeModal('installModal');
            }
        }

        function monitorInstallation(serverId, jobId) {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/servers/${serverId}/install-status/${jobId}`);
                    const result = await response.json();

                    if (result.success) {
                        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                        document.getElementById('installProgress').style.width = result.progress + '%';
                        document.getElementById('installProgressText').textContent = result.progress + '%';

                        // ë¡œê·¸ ì—…ë°ì´íŠ¸
                        if (result.logs && result.logs.length > 0) {
                            document.getElementById('installLogs').textContent = result.logs.join('\n');
                            // ë¡œê·¸ ë·°ì–´ë¥¼ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
                            const logViewer = document.getElementById('installLogs');
                            logViewer.scrollTop = logViewer.scrollHeight;
                        }

                        // ì™„ë£Œ ë˜ëŠ” ì‹¤íŒ¨ ì‹œ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
                        if (result.status === 'completed' || result.status === 'failed') {
                            clearInterval(pollInterval);
                            document.getElementById('installCloseBtn').disabled = false;
                            
                            if (result.status === 'completed') {
                                showAlert('ëª¨ë‹ˆí„°ë§ ì—ì´ì „íŠ¸ ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                            } else {
                                showAlert('ëª¨ë‹ˆí„°ë§ ì—ì´ì „íŠ¸ ì„¤ì¹˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                            }
                            
                            loadServers(); // ì„œë²„ ìƒíƒœ ì—…ë°ì´íŠ¸
                        }
                    }
                } catch (error) {
                    console.error('Failed to get install status:', error);
                    clearInterval(pollInterval);
                    document.getElementById('installCloseBtn').disabled = false;
                }
            }, 2000); // 2ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
        }

        async function deleteServer(serverId) {
            const server = servers.find(s => s.id === serverId);
            if (!server) return;

            if (!confirm(`ì •ë§ë¡œ "${server.name}" ì„œë²„ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/servers/${serverId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    loadServers();
                } else {
                    showAlert('ì„œë²„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Failed to delete server:', error);
                showAlert('ì„œë²„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        function refreshServers() {
            loadServers();
            showAlert('ì„œë²„ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤', 'success');
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.appendChild(alert);
            
            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 3000);
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>