<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trace ë¶„ì„ ëŒ€ì‹œë³´ë“œ - AIRIS-MON</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="components/common-layout.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-blue: #0d6efd;
            --accent-green: #198754;
            --accent-yellow: #ffc107;
            --accent-red: #dc3545;
            --accent-purple: #6f42c1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .analysis-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0 auto;
            max-width: 1400px;
            padding: 0 20px;
            background: var(--bg-primary);
        }

        /* íŒì—… ì°½ì—ì„œëŠ” ì‚¬ì´ë“œë°” ì—¬ë°± ì œê±° */
        .popup-analysis-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0 auto;
            max-width: 1400px;
            padding: 0 20px;
            background: var(--bg-primary);
        }

        /* ìƒë‹¨ 1/3: ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ Bar Chart */
        .top-section {
            height: 33.33vh;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            min-height: 60px;
        }

        .top-section.collapsed {
            height: 60px;
            padding: 10px 20px;
        }

        .top-section.collapsed .chart-container {
            display: none;
        }

        .top-section.expanded {
            height: 80vh;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            user-select: none;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-control-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .section-control-btn:hover {
            background: var(--accent-blue);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .collapse-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .collapse-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .collapse-btn.collapsed {
            transform: rotate(180deg);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .time-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .time-range-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .time-range-btn:hover,
        .time-range-btn.active {
            background: var(--accent-blue);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .chart-container {
            flex: 1;
            position: relative;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
        }

        /* ì¤‘ê°„ 2/3: Trace ì •ë³´ */
        .middle-section {
            height: 33.33vh;
            display: flex;
            border-bottom: 2px solid var(--border-color);
            transition: all 0.3s ease;
            min-height: 60px;
        }

        .middle-section.collapsed {
            height: 60px;
        }

        .middle-section.collapsed .panel-content {
            display: none;
        }

        .middle-section.expanded {
            height: 80vh;
        }

        .trace-list-panel {
            width: 50%;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .span-detail-panel {
            width: 50%;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            padding-left: 0;
        }

        .panel-header {
            padding: 15px 10px 15px 5px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .panel-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        /* Trace ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .trace-item {
            padding: 12px;
            margin: 8px 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trace-item:hover {
            background: var(--bg-primary);
            border-color: var(--accent-blue);
        }

        .trace-item.selected {
            background: var(--accent-blue);
            color: var(--bg-primary);
            border-color: var(--accent-blue);
        }

        .trace-id {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .trace-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .trace-item.selected .trace-info {
            color: var(--bg-secondary);
        }

        /* Span ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .span-item {
            padding: 10px;
            margin: 6px 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
        }

        .span-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        /* Waterfall Chart ìŠ¤íƒ€ì¼ */
        .waterfall-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
        }

        .waterfall-header {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            padding: 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .waterfall-labels {
            width: 180px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            padding: 0 4px 0 0;
        }

        .label-column {
            padding: 2px 0;
        }

        .waterfall-timeline {
            flex: 1;
            position: relative;
            height: 40px;
            border-left: 1px solid var(--border-color);
        }

        .timeline-tick {
            position: absolute;
            top: 0;
            height: 100%;
            border-left: 1px solid var(--border-color);
            font-size: 10px;
            color: var(--text-secondary);
            padding-left: 4px;
            display: flex;
            align-items: center;
        }

        .waterfall-body {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .waterfall-row {
            display: flex;
            height: 40px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .waterfall-row:hover {
            background: var(--bg-secondary);
        }

        .span-labels {
            width: 180px;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 4px 0 0;
            border-right: 1px solid var(--border-color);
            font-size: 11px;
        }

        .span-service {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .span-operation {
            color: var(--text-secondary);
            font-size: 10px;
        }

        .span-timeline {
            flex: 1;
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
        }

        .span-bar {
            position: absolute;
            height: 20px;
            top: 4px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 2px;
        }

        .span-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .span-bar.error {
            border: 2px solid var(--accent-red);
        }

        .span-bar.success {
            opacity: 0.8;
        }

        .span-duration-label {
            color: white;
            font-size: 9px;
            font-weight: 600;
            padding-left: 4px;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            overflow: hidden;
        }

        .span-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: var(--accent-purple);
        }

        .span-duration {
            color: var(--accent-yellow);
            font-weight: 500;
        }

        .span-operation {
            color: var(--text-secondary);
            font-size: 11px;
        }

        /* í•˜ë‹¨ 1/3: ì„¸ì…˜ ë¦¬í”Œë ˆì´ ë° í”„ë¡œê·¸ë¨ ë¦¬ìŠ¤íŠ¸ */
        .bottom-section {
            height: 33.33vh;
            display: flex;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            min-height: 60px;
        }

        .bottom-section.collapsed {
            height: 60px;
        }

        .bottom-section.collapsed .panel-content {
            display: none;
        }

        .bottom-section.expanded {
            height: 80vh;
        }

        .session-panel {
            width: 50%;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .program-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
        }

        .session-item, .program-item {
            padding: 10px;
            margin: 6px 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .session-item:hover, .program-item:hover {
            background: var(--bg-primary);
            border-color: var(--accent-green);
        }

        .session-id {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--accent-green);
            font-weight: bold;
        }

        .session-info, .program-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .program-name {
            font-size: 13px;
            color: var(--accent-yellow);
            font-weight: 500;
        }

        /* ë¡œë”© ë° ë¹ˆ ìƒíƒœ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .panel-content::-webkit-scrollbar {
            width: 6px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .panel-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* ì°¨íŠ¸ íˆ´íŒ ìŠ¤íƒ€ì¼ */
        .chart-tooltip {
            background: var(--bg-primary) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
            border-radius: 4px !important;
            padding: 8px !important;
            font-size: 12px !important;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .analysis-container {
                margin-left: 0;
            }
            
            .middle-section, .bottom-section {
                flex-direction: column;
            }
            
            .trace-list-panel, .span-detail-panel,
            .session-panel, .program-panel {
                width: 100%;
                height: 50%;
            }
        }
    </style>
</head>
<body>
    <!-- ìƒë‹¨ 1/3: ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ Bar Chart -->
    <div class="analysis-container" id="analysisContainer">
        <div class="top-section">
            <div class="section-header" onclick="toggleSection('top')">
                <h2 class="section-title">
                    <div class="status-indicator"></div>
                    ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ ë¶„ì„ (1ì´ˆ ë‹¨ìœ„)
                </h2>
                <div class="section-controls">
                    <div class="time-controls">
                        <button class="time-range-btn active" data-range="5m" onclick="event.stopPropagation()">5ë¶„</button>
                        <button class="time-range-btn" data-range="15m" onclick="event.stopPropagation()">15ë¶„</button>
                        <button class="time-range-btn" data-range="1h" onclick="event.stopPropagation()">1ì‹œê°„</button>
                        <button class="time-range-btn" data-range="6h" onclick="event.stopPropagation()">6ì‹œê°„</button>
                    </div>
                    <button class="section-control-btn" onclick="event.stopPropagation(); openInPopup('top')" title="ë³„ë„ ì°½ìœ¼ë¡œ ì—´ê¸°">ğŸ“¤</button>
                    <button class="collapse-btn" id="topCollapseBtn" onclick="event.stopPropagation(); toggleSection('top')" title="ì ‘ê¸°/í¼ì¹˜ê¸°">â–¼</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- ì¤‘ê°„ 2/3: Trace ì •ë³´ -->
        <div class="middle-section">
            <!-- ì™¼ìª½: Trace ëª©ë¡ -->
            <div class="trace-list-panel">
                <div class="panel-header" onclick="toggleSection('middle')">
                    <h3 class="panel-title">Trace ëª©ë¡ <span id="selectedTimeDisplay">ì‹œê°„ ì„ íƒ í•„ìš”</span></h3>
                    <div class="section-controls">
                        <button class="section-control-btn" onclick="event.stopPropagation(); openInPopup('middle')" title="ë³„ë„ ì°½ìœ¼ë¡œ ì—´ê¸°">ğŸ“¤</button>
                        <button class="collapse-btn" id="middleCollapseBtn" onclick="event.stopPropagation(); toggleSection('middle')" title="ì ‘ê¸°/í¼ì¹˜ê¸°">â–¼</button>
                    </div>
                </div>
                <div class="panel-content" id="traceListContent">
                    <div class="empty-state">
                        <div>ğŸ“Š</div>
                        <div>ì°¨íŠ¸ì—ì„œ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”</div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: Span Waterfall Chart -->
            <div class="span-detail-panel">
                <div class="panel-header">
                    <h3 class="panel-title">Span Waterfall Chart <span id="selectedTraceDisplay">Trace ì„ íƒ í•„ìš”</span></h3>
                </div>
                <div class="panel-content" id="spanDetailContent">
                    <div class="empty-state">
                        <div>ğŸ”</div>
                        <div>Traceë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨ 1/3: ì„¸ì…˜ ë¦¬í”Œë ˆì´ ë° í”„ë¡œê·¸ë¨ ë¦¬ìŠ¤íŠ¸ -->
        <div class="bottom-section">
            <!-- ì™¼ìª½: ì„¸ì…˜ ë¦¬í”Œë ˆì´ -->
            <div class="session-panel">
                <div class="panel-header" onclick="toggleSection('bottom')">
                    <h3 class="panel-title">ì—°ê´€ ì„¸ì…˜ ë¦¬í”Œë ˆì´ <span id="sessionCountDisplay"></span></h3>
                    <div class="section-controls">
                        <button class="section-control-btn" onclick="event.stopPropagation(); openInPopup('bottom')" title="ë³„ë„ ì°½ìœ¼ë¡œ ì—´ê¸°">ğŸ“¤</button>
                        <button class="collapse-btn" id="bottomCollapseBtn" onclick="event.stopPropagation(); toggleSection('bottom')" title="ì ‘ê¸°/í¼ì¹˜ê¸°">â–¼</button>
                    </div>
                </div>
                <div class="panel-content" id="sessionListContent">
                    <div class="empty-state">
                        <div>ğŸ¬</div>
                        <div>Traceë¥¼ ì„ íƒí•˜ë©´ ì—°ê´€ ì„¸ì…˜ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: í”„ë¡œê·¸ë¨ ë¦¬ìŠ¤íŠ¸ -->
            <div class="program-panel">
                <div class="panel-header">
                    <h3 class="panel-title">ì—°ê´€ í”„ë¡œê·¸ë¨ <span id="programCountDisplay"></span></h3>
                </div>
                <div class="panel-content" id="programListContent">
                    <div class="empty-state">
                        <div>ğŸ’»</div>
                        <div>Traceë¥¼ ì„ íƒí•˜ë©´ ì—°ê´€ í”„ë¡œê·¸ë¨ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let performanceChart = null;
        let selectedTimeIndex = null;
        let selectedTraceId = null;
        let currentTimeRange = '5m';
        let openPopups = new Map(); // ì—´ë¦° íŒì—… ì°½ë“¤ ê´€ë¦¬
        
        // ì„¹ì…˜ ìƒíƒœ ê´€ë¦¬
        const sectionStates = {
            top: { collapsed: false, expanded: false },
            middle: { collapsed: false, expanded: false },
            bottom: { collapsed: false, expanded: false }
        };
        
        // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
        const sampleData = {
            performance: [],
            traces: {},
            sessions: {},
            programs: {}
        };

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // URL íŒŒë¼ë¯¸í„° ì²´í¬ë¡œ íŒì—… ëª¨ë“œ ê°ì§€
            const urlParams = new URLSearchParams(window.location.search);
            const isPopup = urlParams.get('popup') === 'true' || window.opener;
            const sectionParam = urlParams.get('section');
            
            // íŒì—… ëª¨ë“œì¸ ê²½ìš° ë ˆì´ì•„ì›ƒ ì¡°ì •
            if (isPopup) {
                const container = document.getElementById('analysisContainer');
                if (container) {
                    container.className = 'popup-analysis-container';
                    container.style.marginLeft = '0';
                }
                // ê³µí†µ ë ˆì´ì•„ì›ƒ ë¹„í™œì„±í™”
                const commonLayoutScript = document.querySelector('script[src*="common-layout.js"]');
                if (commonLayoutScript) {
                    commonLayoutScript.remove();
                }
                
                // íŠ¹ì • ì„¹ì…˜ë§Œ í‘œì‹œ
                if (sectionParam) {
                    setTimeout(() => showPopupSection(sectionParam), 100);
                }
            }
            
            // í™”ë©´ í¬ê¸° í™•ì¸ ë° ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
            console.log('ğŸš€ Trace ë¶„ì„ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì‹œì‘...', { isPopup, screenWidth: window.innerWidth });
            
            if (window.innerWidth >= 1024 || isPopup) {
                // ê°€ë¡œ í™”ë©´ ë˜ëŠ” íŒì—…ì—ì„œë§Œ ë¶„ì„ ê¸°ëŠ¥ í™œì„±í™”
                initializeData();
                initializeChart();
                setupEventListeners();
                
                // 5ì´ˆë§ˆë‹¤ ë°ì´í„° ì—…ë°ì´íŠ¸
                setInterval(updateData, 5000);
                
                console.log('ğŸš€ Trace ë¶„ì„ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì™„ë£Œ', isPopup ? '(íŒì—… ëª¨ë“œ)' : '');
            } else {
                console.log('ğŸ“± ì„¸ë¡œ í™”ë©´ ê°ì§€ - ë¶„ì„ ê¸°ëŠ¥ ë¹„í™œì„±í™” (ìµœì†Œ í•´ìƒë„: 1024px)');
            }
        });

        // ë°ì´í„° ì´ˆê¸°í™”
        function initializeData() {
            const now = Date.now();
            const intervals = {
                '5m': { count: 300, interval: 1000 },    // 5ë¶„ = 300ì´ˆ
                '15m': { count: 900, interval: 1000 },   // 15ë¶„ = 900ì´ˆ  
                '1h': { count: 3600, interval: 1000 },   // 1ì‹œê°„ = 3600ì´ˆ
                '6h': { count: 21600, interval: 1000 }   // 6ì‹œê°„ = 21600ì´ˆ
            };

            const config = intervals[currentTimeRange];
            
            // ì„±ëŠ¥ ë°ì´í„° ìƒì„±
            sampleData.performance = [];
            for (let i = config.count; i > 0; i--) {
                const timestamp = now - (i * config.interval);
                const responseTime = 100 + Math.random() * 400 + Math.sin(i * 0.1) * 50;
                const throughput = 50 + Math.random() * 100;
                const errorRate = Math.random() * 5;
                
                sampleData.performance.push({
                    timestamp: timestamp,
                    responseTime: Math.round(responseTime),
                    throughput: Math.round(throughput),
                    errorRate: parseFloat(errorRate.toFixed(2)),
                    traceCount: Math.floor(Math.random() * 20) + 5
                });
            }

            // ê° ì‹œê°„ëŒ€ë³„ Trace ë°ì´í„° ìƒì„±
            sampleData.performance.forEach((point, index) => {
                const traces = [];
                const traceCount = point.traceCount;
                
                for (let i = 0; i < traceCount; i++) {
                    const traceId = generateTraceId();
                    const spans = generateSpans(traceId);
                    
                    traces.push({
                        traceId: traceId,
                        timestamp: point.timestamp + (i * 100),
                        duration: Math.round(point.responseTime + (Math.random() * 100 - 50)),
                        service: ['user-service', 'payment-service', 'order-service', 'notification-service'][Math.floor(Math.random() * 4)],
                        status: Math.random() > 0.95 ? 'error' : 'success',
                        spans: spans,
                        sessionId: Math.random() > 0.7 ? generateSessionId() : null
                    });
                }
                
                sampleData.traces[index] = traces;
                
                // ì„¸ì…˜ ë° í”„ë¡œê·¸ë¨ ë°ì´í„° ìƒì„±
                traces.forEach(trace => {
                    if (trace.sessionId) {
                        if (!sampleData.sessions[trace.traceId]) {
                            sampleData.sessions[trace.traceId] = {
                                sessionId: trace.sessionId,
                                userId: 'user_' + Math.floor(Math.random() * 1000),
                                duration: Math.floor(Math.random() * 300) + 60,
                                pages: Math.floor(Math.random() * 10) + 1,
                                actions: Math.floor(Math.random() * 50) + 10
                            };
                        }
                    }
                    
                    if (!sampleData.programs[trace.traceId]) {
                        sampleData.programs[trace.traceId] = generatePrograms(trace.service);
                    }
                });
            });
        }

        // Trace ID ìƒì„±
        function generateTraceId() {
            return 'trace_' + Math.random().toString(36).substr(2, 16);
        }

        // Session ID ìƒì„±
        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 12);
        }

        // Span ìƒì„±
        function generateSpans(traceId) {
            const spanCount = Math.floor(Math.random() * 8) + 3;
            const spans = [];
            
            for (let i = 0; i < spanCount; i++) {
                spans.push({
                    spanId: 'span_' + Math.random().toString(36).substr(2, 8),
                    parentSpanId: i > 0 && Math.random() > 0.5 ? spans[Math.floor(Math.random() * i)].spanId : null,
                    operation: ['HTTP GET', 'Database Query', 'Cache Read', 'External API', 'Processing'][Math.floor(Math.random() * 5)],
                    service: ['frontend', 'backend', 'database', 'cache', 'external'][Math.floor(Math.random() * 5)],
                    duration: Math.floor(Math.random() * 200) + 10,
                    startTime: Date.now() + (i * 50),
                    tags: {
                        'http.method': ['GET', 'POST', 'PUT', 'DELETE'][Math.floor(Math.random() * 4)],
                        'db.type': 'postgresql',
                        'component': 'http-client'
                    }
                });
            }
            
            return spans;
        }

        // í”„ë¡œê·¸ë¨ ìƒì„±
        function generatePrograms(service) {
            const programs = [
                { name: 'UserController.java', type: 'Controller', lines: 245, complexity: 'Medium' },
                { name: 'PaymentService.js', type: 'Service', lines: 189, complexity: 'High' },
                { name: 'OrderRepository.py', type: 'Repository', lines: 156, complexity: 'Low' },
                { name: 'NotificationHandler.go', type: 'Handler', lines: 98, complexity: 'Low' },
                { name: 'DatabaseConnection.java', type: 'Utility', lines: 67, complexity: 'Medium' }
            ];
            
            return programs.slice(0, Math.floor(Math.random() * 3) + 2);
        }

        // Chart.js ì´ˆê¸°í™”
        function initializeChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sampleData.performance.map(p => new Date(p.timestamp).toLocaleTimeString()),
                    datasets: [{
                        label: 'ì‘ë‹µì‹œê°„ (ms)',
                        data: sampleData.performance.map(p => p.responseTime),
                        backgroundColor: function(context) {
                            const value = context.parsed.y;
                            if (value > 400) return '#f85149';
                            if (value > 250) return '#d29922';
                            return '#3fb950';
                        },
                        borderColor: '#30363d',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    onClick: handleChartClick,
                    scales: {
                        x: {
                            grid: {
                                color: '#30363d'
                            },
                            ticks: {
                                color: '#8b949e',
                                maxTicksLimit: 20
                            }
                        },
                        y: {
                            grid: {
                                color: '#30363d'
                            },
                            ticks: {
                                color: '#8b949e'
                            },
                            title: {
                                display: true,
                                text: 'ì‘ë‹µì‹œê°„ (ms)',
                                color: '#f0f6fc'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#0d1117',
                            titleColor: '#f0f6fc',
                            bodyColor: '#f0f6fc',
                            borderColor: '#30363d',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const point = sampleData.performance[context.dataIndex];
                                    return [
                                        `ì‘ë‹µì‹œê°„: ${point.responseTime}ms`,
                                        `ì²˜ë¦¬ëŸ‰: ${point.throughput} req/s`,
                                        `ì—ëŸ¬ìœ¨: ${point.errorRate}%`,
                                        `Trace ìˆ˜: ${point.traceCount}ê°œ`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // ì°¨íŠ¸ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleChartClick(event, elements) {
            if (elements.length > 0) {
                const clickedIndex = elements[0].index;
                selectedTimeIndex = clickedIndex;
                
                const selectedPoint = sampleData.performance[clickedIndex];
                const timeStr = new Date(selectedPoint.timestamp).toLocaleTimeString();
                
                document.getElementById('selectedTimeDisplay').textContent = `(${timeStr})`;
                
                loadTraceList(clickedIndex);
                clearSpanDetail();
                clearSessionAndPrograms();
            }
        }

        // Trace ëª©ë¡ ë¡œë“œ
        function loadTraceList(timeIndex) {
            const traces = sampleData.traces[timeIndex] || [];
            const content = document.getElementById('traceListContent');
            
            if (traces.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ“Š</div>
                        <div>ì´ ì‹œê°„ëŒ€ì— Traceê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = traces.map(trace => `
                <div class="trace-item" onclick="selectTrace('${trace.traceId}', ${timeIndex})">
                    <div class="trace-id">${trace.traceId}</div>
                    <div class="trace-info">
                        <span>${trace.service}</span>
                        <span>${trace.duration}ms</span>
                        <span class="status-${trace.status}">${trace.status}</span>
                    </div>
                </div>
            `).join('');
        }

        // Trace ì„ íƒ
        function selectTrace(traceId, timeIndex) {
            selectedTraceId = traceId;
            
            // ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.trace-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            document.getElementById('selectedTraceDisplay').textContent = `(${traceId})`;
            
            loadSpanDetail(traceId, timeIndex);
            loadSessionAndPrograms(traceId);
        }

        // Span Waterfall Chart ë¡œë“œ
        function loadSpanDetail(traceId, timeIndex) {
            const traces = sampleData.traces[timeIndex] || [];
            const trace = traces.find(t => t.traceId === traceId);
            const content = document.getElementById('spanDetailContent');
            
            if (!trace || !trace.spans) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ”</div>
                        <div>Span ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                return;
            }
            
            // Waterfall Chart ìƒì„±
            createWaterfallChart(trace.spans, content);
        }
        
        // Waterfall Chart ìƒì„±
        function createWaterfallChart(spans, container) {
            // ì „ì²´ íƒ€ì„ë¼ì¸ ê³„ì‚°
            const minStartTime = Math.min(...spans.map(s => s.startTime || 0));
            const maxEndTime = Math.max(...spans.map(s => (s.startTime || 0) + s.duration));
            const totalDuration = maxEndTime - minStartTime || spans.reduce((max, s) => Math.max(max, s.duration), 0);
            
            // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
            container.innerHTML = `
                <div class="waterfall-container">
                    <div class="waterfall-header">
                        <div class="waterfall-labels">
                            <div class="label-column">Service</div>
                            <div class="label-column">Operation</div>
                        </div>
                        <div class="waterfall-timeline">
                            <div class="timeline-tick" style="left: 0%">0ms</div>
                            <div class="timeline-tick" style="left: 25%">${Math.round(totalDuration/4)}ms</div>
                            <div class="timeline-tick" style="left: 50%">${Math.round(totalDuration/2)}ms</div>
                            <div class="timeline-tick" style="left: 75%">${Math.round(totalDuration*3/4)}ms</div>
                            <div class="timeline-tick" style="left: 100%">${totalDuration}ms</div>
                        </div>
                    </div>
                    <div class="waterfall-body" id="waterfallBody"></div>
                </div>
            `;
            
            const waterfallBody = document.getElementById('waterfallBody');
            
            // ê° Spanì— ëŒ€í•œ Waterfall ë°” ìƒì„±
            spans.forEach((span, index) => {
                const startTime = span.startTime || 0;
                const startOffset = totalDuration > 0 ? ((startTime - minStartTime) / totalDuration) * 100 : 0;
                const width = totalDuration > 0 ? (span.duration / totalDuration) * 100 : 20;
                
                const spanRow = document.createElement('div');
                spanRow.className = 'waterfall-row';
                spanRow.innerHTML = `
                    <div class="span-labels">
                        <div class="span-service">${span.service}</div>
                        <div class="span-operation">${span.operation}</div>
                    </div>
                    <div class="span-timeline">
                        <div class="span-bar ${span.status || 'success'}" 
                             style="left: ${startOffset}%; width: ${Math.max(width, 2)}%; background-color: ${getSpanColor(span.service, index)};"
                             title="${span.operation} (${span.service}) - ${span.duration}ms">
                            <span class="span-duration-label">${span.duration}ms</span>
                        </div>
                    </div>
                `;
                
                waterfallBody.appendChild(spanRow);
            });
        }
        
        // Spanë³„ ìƒ‰ìƒ ìƒì„±
        function getSpanColor(service, index) {
            const colors = {
                'user-service': '#3b82f6',
                'payment-service': '#10b981', 
                'order-service': '#f59e0b',
                'notification-service': '#8b5cf6',
                'database': '#ef4444',
                'cache': '#06b6d4',
                'api-gateway': '#84cc16',
                'auth-service': '#f97316',
                'http': '#3b82f6',
                'db': '#ef4444'
            };
            return colors[service] || `hsl(${(index * 137.5) % 360}, 70%, 60%)`;
        }

        // Span Waterfall ì´ˆê¸°í™”
        function clearSpanDetail() {
            selectedTraceId = null;
            document.getElementById('selectedTraceDisplay').textContent = 'Trace ì„ íƒ í•„ìš”';
            document.getElementById('spanDetailContent').innerHTML = `
                <div class="empty-state">
                    <div>ğŸ”</div>
                    <div>Traceë¥¼ ì„ íƒí•˜ë©´ Span Waterfallì´ í‘œì‹œë©ë‹ˆë‹¤</div>
                </div>
            `;
        }

        // ì„¸ì…˜ ë° í”„ë¡œê·¸ë¨ ë¡œë“œ
        function loadSessionAndPrograms(traceId) {
            const session = sampleData.sessions[traceId];
            const programs = sampleData.programs[traceId];
            
            // ì„¸ì…˜ ë¡œë“œ
            const sessionContent = document.getElementById('sessionListContent');
            if (session) {
                document.getElementById('sessionCountDisplay').textContent = '(1ê°œ)';
                sessionContent.innerHTML = `
                    <div class="session-item" onclick="openSessionReplay('${session.sessionId}')">
                        <div class="session-id">${session.sessionId}</div>
                        <div class="session-info">
                            ì‚¬ìš©ì: ${session.userId} | 
                            ì§€ì†ì‹œê°„: ${session.duration}ì´ˆ | 
                            í˜ì´ì§€: ${session.pages}ê°œ | 
                            ì•¡ì…˜: ${session.actions}ê°œ
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('sessionCountDisplay').textContent = '';
                sessionContent.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ¬</div>
                        <div>ì—°ê´€ëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
            }
            
            // í”„ë¡œê·¸ë¨ ë¡œë“œ
            const programContent = document.getElementById('programListContent');
            if (programs && programs.length > 0) {
                document.getElementById('programCountDisplay').textContent = `(${programs.length}ê°œ)`;
                programContent.innerHTML = programs.map(program => `
                    <div class="program-item" onclick="openProgramDetail('${program.name}')">
                        <div class="program-name">${program.name}</div>
                        <div class="program-info">
                            ${program.type} | ${program.lines} lines | ë³µì¡ë„: ${program.complexity}
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('programCountDisplay').textContent = '';
                programContent.innerHTML = `
                    <div class="empty-state">
                        <div>ğŸ’»</div>
                        <div>ì—°ê´€ëœ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
            }
        }

        // ì„¸ì…˜ ë° í”„ë¡œê·¸ë¨ ì´ˆê¸°í™”
        function clearSessionAndPrograms() {
            document.getElementById('sessionCountDisplay').textContent = '';
            document.getElementById('programCountDisplay').textContent = '';
            
            document.getElementById('sessionListContent').innerHTML = `
                <div class="empty-state">
                    <div>ğŸ¬</div>
                    <div>Traceë¥¼ ì„ íƒí•˜ë©´ ì—°ê´€ ì„¸ì…˜ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
                </div>
            `;
            
            document.getElementById('programListContent').innerHTML = `
                <div class="empty-state">
                    <div>ğŸ’»</div>
                    <div>Traceë¥¼ ì„ íƒí•˜ë©´ ì—°ê´€ í”„ë¡œê·¸ë¨ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
                </div>
            `;
        }

        // ì„¸ì…˜ ë¦¬í”Œë ˆì´ ì—´ê¸°
        function openSessionReplay(sessionId) {
            console.log('ì„¸ì…˜ ë¦¬í”Œë ˆì´ ì—´ê¸°:', sessionId);
            // ìƒˆ ì°½ì—ì„œ ì„¸ì…˜ ë¦¬í”Œë ˆì´ ì—´ê¸°
            window.open(`/enhanced-player.html?sessionId=${sessionId}`, '_blank');
        }

        // í”„ë¡œê·¸ë¨ ìƒì„¸ ì—´ê¸°
        function openProgramDetail(programName) {
            console.log('í”„ë¡œê·¸ë¨ ìƒì„¸ ë³´ê¸°:', programName);
            // í”„ë¡œê·¸ë¨ ë¶„ì„ í˜ì´ì§€ë¡œ ì´ë™
            window.open(`/project-analysis.html?file=${programName}`, '_blank');
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ì‹œê°„ ë²”ìœ„ ë²„íŠ¼
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentTimeRange = this.dataset.range;
                    initializeData();
                    updateChart();
                    clearAllSelections();
                });
            });
        }

        // ëª¨ë“  ì„ íƒ ì´ˆê¸°í™”
        function clearAllSelections() {
            selectedTimeIndex = null;
            selectedTraceId = null;
            
            document.getElementById('selectedTimeDisplay').textContent = 'ì‹œê°„ ì„ íƒ í•„ìš”';
            document.getElementById('traceListContent').innerHTML = `
                <div class="empty-state">
                    <div>ğŸ“Š</div>
                    <div>ì°¨íŠ¸ì—ì„œ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”</div>
                </div>
            `;
            
            clearSpanDetail();
            clearSessionAndPrograms();
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateChart() {
            if (performanceChart) {
                performanceChart.data.labels = sampleData.performance.map(p => new Date(p.timestamp).toLocaleTimeString());
                performanceChart.data.datasets[0].data = sampleData.performance.map(p => p.responseTime);
                performanceChart.update();
            }
        }

        // ë°ì´í„° ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„)
        function updateData() {
            // ìƒˆë¡œìš´ ë°ì´í„° í¬ì¸íŠ¸ ì¶”ê°€
            const now = Date.now();
            const newPoint = {
                timestamp: now,
                responseTime: Math.round(100 + Math.random() * 400 + Math.sin(Date.now() * 0.001) * 50),
                throughput: Math.round(50 + Math.random() * 100),
                errorRate: parseFloat((Math.random() * 5).toFixed(2)),
                traceCount: Math.floor(Math.random() * 20) + 5
            };
            
            // ê¸°ì¡´ ë°ì´í„°ì—ì„œ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ ì œê±°í•˜ê³  ìƒˆ ë°ì´í„° ì¶”ê°€
            sampleData.performance.shift();
            sampleData.performance.push(newPoint);
            
            // ìƒˆ Trace ë°ì´í„° ìƒì„±
            const newTraces = [];
            for (let i = 0; i < newPoint.traceCount; i++) {
                const traceId = generateTraceId();
                newTraces.push({
                    traceId: traceId,
                    timestamp: newPoint.timestamp + (i * 100),
                    duration: Math.round(newPoint.responseTime + (Math.random() * 100 - 50)),
                    service: ['user-service', 'payment-service', 'order-service', 'notification-service'][Math.floor(Math.random() * 4)],
                    status: Math.random() > 0.95 ? 'error' : 'success',
                    spans: generateSpans(traceId),
                    sessionId: Math.random() > 0.7 ? generateSessionId() : null
                });
            }
            
            // Trace ë°ì´í„° ë°°ì—´ ì‹œí”„íŠ¸
            const traceKeys = Object.keys(sampleData.traces).map(Number).sort((a, b) => a - b);
            if (traceKeys.length > 0) {
                delete sampleData.traces[traceKeys[0]];
            }
            sampleData.traces[sampleData.performance.length - 1] = newTraces;
            
            updateChart();
        }

        // ì„¹ì…˜ í† ê¸€ ê¸°ëŠ¥
        function toggleSection(sectionName) {
            const section = document.querySelector(`.${sectionName}-section`);
            const collapseBtn = document.getElementById(`${sectionName}CollapseBtn`);
            const state = sectionStates[sectionName];
            
            if (state.expanded) {
                // í™•ì¥ëœ ìƒíƒœì—ì„œ ì¼ë°˜ ìƒíƒœë¡œ
                section.classList.remove('expanded');
                state.expanded = false;
                collapseBtn.textContent = 'â–¼';
                collapseBtn.title = 'ì ‘ê¸°/í¼ì¹˜ê¸°';
            } else if (state.collapsed) {
                // ì ‘íŒ ìƒíƒœì—ì„œ ì¼ë°˜ ìƒíƒœë¡œ
                section.classList.remove('collapsed');
                collapseBtn.classList.remove('collapsed');
                state.collapsed = false;
                collapseBtn.textContent = 'â–¼';
                collapseBtn.title = 'ì ‘ê¸°/í¼ì¹˜ê¸°';
            } else {
                // ì¼ë°˜ ìƒíƒœì—ì„œ ì ‘íŒ ìƒíƒœë¡œ
                section.classList.add('collapsed');
                collapseBtn.classList.add('collapsed');
                state.collapsed = true;
                collapseBtn.textContent = 'â–²';
                collapseBtn.title = 'í¼ì¹˜ê¸°';
            }
            
            // ì°¨íŠ¸ í¬ê¸° ì¡°ì • (ì„±ëŠ¥ ì°¨íŠ¸ì¸ ê²½ìš°)
            if (sectionName === 'top' && performanceChart) {
                setTimeout(() => {
                    performanceChart.resize();
                }, 300);
            }
        }

        // ì„¹ì…˜ í™•ì¥ ê¸°ëŠ¥
        function expandSection(sectionName) {
            const section = document.querySelector(`.${sectionName}-section`);
            const collapseBtn = document.getElementById(`${sectionName}CollapseBtn`);
            const state = sectionStates[sectionName];
            
            // ëª¨ë“  ì„¹ì…˜ì„ ì ‘ê¸°
            Object.keys(sectionStates).forEach(name => {
                if (name !== sectionName) {
                    const otherSection = document.querySelector(`.${name}-section`);
                    const otherBtn = document.getElementById(`${name}CollapseBtn`);
                    otherSection.classList.add('collapsed');
                    otherBtn.classList.add('collapsed');
                    otherBtn.textContent = 'â–²';
                    sectionStates[name].collapsed = true;
                    sectionStates[name].expanded = false;
                }
            });
            
            // í˜„ì¬ ì„¹ì…˜ í™•ì¥
            section.classList.remove('collapsed');
            section.classList.add('expanded');
            collapseBtn.classList.remove('collapsed');
            collapseBtn.textContent = 'â—¼';
            collapseBtn.title = 'ì¼ë°˜ í¬ê¸°ë¡œ';
            state.collapsed = false;
            state.expanded = true;
            
            // ì°¨íŠ¸ í¬ê¸° ì¡°ì •
            if (sectionName === 'top' && performanceChart) {
                setTimeout(() => {
                    performanceChart.resize();
                }, 300);
            }
        }

        // íŒì—… ì°½ì—ì„œ ì„¹ì…˜ ì—´ê¸°
        function openInPopup(sectionName) {
            const sectionTitles = {
                top: 'ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ ë¶„ì„',
                middle: 'Trace ë¶„ì„',
                bottom: 'ì„¸ì…˜ & í”„ë¡œê·¸ë¨ ë¶„ì„'
            };
            
            // í˜„ì¬ í˜ì´ì§€ë¥¼ íŒì—… ëª¨ë“œë¡œ ìƒˆ ì°½ì—ì„œ ì—´ê¸°
            const currentUrl = window.location.href.split('?')[0];
            const popupUrl = currentUrl + '?popup=true&section=' + sectionName;
            
            const popupName = sectionName + '_popup_' + Date.now();
            const popupWindow = window.open(popupUrl, popupName, 
                'width=1200,height=800,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=no,status=no'
            );
            
            if (!popupWindow) {
                alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log('íŒì—… ì°½ ì—´ë¦¼: ' + sectionTitles[sectionName]);
        }

        // íŒì—… ëª¨ë“œì—ì„œ íŠ¹ì • ì„¹ì…˜ë§Œ í‘œì‹œ
        function showPopupSection(sectionName) {
            const sections = ['top', 'middle', 'bottom'];
            
            sections.forEach(section => {
                const element = document.querySelector('.' + section + '-section');
                if (element) {
                    if (section === sectionName) {
                        element.style.display = 'flex';
                        element.style.height = '100vh';
                        element.style.flexDirection = 'column';
                    } else {
                        element.style.display = 'none';
                    }
                }
            });
            
            // í˜ì´ì§€ ì œëª© ë³€ê²½
            const titles = {
                top: 'ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ ë¶„ì„',
                middle: 'Trace ë¶„ì„',
                bottom: 'ì„¸ì…˜ & í”„ë¡œê·¸ë¨ ë¶„ì„'
            };
            document.title = titles[sectionName] + ' - AIRIS-MON';
        }
        // ê°„ë‹¨í•œ íŒì—… ê¸°ëŠ¥ (URL íŒŒë¼ë¯¸í„° ë°©ì‹)
        function openInPopup(sectionName) {
            const url = window.location.href.split('?')[0] + '?popup=true&section=' + sectionName;
            const popupWindow = window.open(url, 'popup_' + sectionName, 
                'width=1200,height=800,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=no,status=no'
            );
            if (popupWindow) {
                popupWindow.focus();
            }
        }

        // URL íŒŒë¼ë¯¸í„° í™•ì¸í•˜ì—¬ íŒì—… ëª¨ë“œ ì ìš©
        function checkPopupMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const isPopup = urlParams.get('popup') === 'true';
            const section = urlParams.get('section');
            
            if (isPopup && section) {
                showPopupSection(section);
            }
        }

        // íŒì—…ì—ì„œ íŠ¹ì • ì„¹ì…˜ë§Œ í‘œì‹œ
        function showPopupSection(sectionName) {
            // ì‚¬ì´ë“œë°” ìˆ¨ê¸°ê¸°
            const sidebar = document.querySelector('.airis-sidebar');
            if (sidebar) sidebar.style.display = 'none';
            
            // ë©”ì¸ ì»¨í…ì¸  ì¡°ì •
            const mainContent = document.querySelector('.airis-main-content');
            if (mainContent) {
                mainContent.style.marginLeft = '0';
                mainContent.style.width = '100%';
            }
            
            // ë‹¤ë¥¸ ì„¹ì…˜ë“¤ ìˆ¨ê¸°ê¸°
            const allSections = ['.top-section', '.middle-section', '.bottom-section'];
            allSections.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    if (selector === '.' + sectionName + '-section') {
                        element.style.display = 'flex';
                        element.style.height = '100vh';
                        element.style.flexDirection = 'column';
                    } else {
                        element.style.display = 'none';
                    }
                }
            });
            
            // í˜ì´ì§€ ì œëª© ë³€ê²½
            const titles = {
                top: 'ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ ë¶„ì„',
                middle: 'Trace ë¶„ì„',
                bottom: 'ì„¸ì…˜ & í”„ë¡œê·¸ë¨ ë¶„ì„'
            };
            document.title = titles[sectionName] + ' - AIRIS-MON';
        }

        // ë”ë¸”í´ë¦­ìœ¼ë¡œ ì„¹ì…˜ í™•ì¥
        document.addEventListener('dblclick', function(e) {
            const section = e.target.closest('.top-section, .middle-section, .bottom-section');
            if (section) {
                const sectionName = section.classList.contains('top-section') ? 'top' : 
                    section.classList.contains('middle-section') ? 'middle' : 'bottom';
                expandSection(sectionName);
            }
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // ESCë¡œ ëª¨ë“  í™•ì¥ í•´ì œ
                Object.keys(sectionStates).forEach(sectionName => {
                    const section = document.querySelector(`.${sectionName}-section`);
                    const collapseBtn = document.getElementById(`${sectionName}CollapseBtn`);
                    const state = sectionStates[sectionName];
                    if (state.expanded || state.collapsed) {
                        section.classList.remove('expanded', 'collapsed');
                        collapseBtn.classList.remove('collapsed');
                        collapseBtn.textContent = 'â–¼';
                        collapseBtn.title = 'ì ‘ê¸°/í¼ì¹˜ê¸°';
                        state.expanded = false;
                        state.collapsed = false;
                    }
                });
                if (performanceChart) {
                    setTimeout(() => performanceChart.resize(), 300);
                }
                clearAllSelections();
            }
            // F11ë¡œ ì „ì²´í™”ë©´ ì„¹ì…˜ í† ê¸€ (Shift+F11ë¡œ ê° ì„¹ì…˜ ìˆœì°¨ì ìœ¼ë¡œ)
            if (e.key === 'F11') {
                e.preventDefault();
                if (e.shiftKey) {
                    // Shift+F11: ë‹¤ìŒ ì„¹ì…˜ í™•ì¥
                    const sections = ['top', 'middle', 'bottom'];
                    const expandedSection = sections.find(name => sectionStates[name].expanded);
                    const nextIndex = expandedSection ? (sections.indexOf(expandedSection) + 1) % sections.length : 0;
                    expandSection(sections[nextIndex]);
                } else {
                    // F11: ì²« ë²ˆì§¸ ì„¹ì…˜ í™•ì¥
                    expandSection('top');
                }
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ íŒì—… ëª¨ë“œ í™•ì¸
        window.addEventListener('load', function() {
            checkPopupMode();
        });

        // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ë°˜ì‘í˜• ì²˜ë¦¬
        window.addEventListener('resize', function() {
            const isWideScreen = window.innerWidth >= 1024;
            const analysisContainer = document.getElementById('analysisContainer');
            
            if (isWideScreen) {
                // ê°€ë¡œ í™”ë©´ìœ¼ë¡œ ë³€ê²½ ì‹œ ë¶„ì„ ê¸°ëŠ¥ í™œì„±í™”
                if (!document.querySelector('.top-section').style.display || 
                    document.querySelector('.top-section').style.display === 'none') {
                    location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì™„ì „ ì´ˆê¸°í™”
                }
            } else {
                // ì„¸ë¡œ í™”ë©´ìœ¼ë¡œ ë³€ê²½ ì‹œ ëª¨ë°”ì¼ ë©”ì‹œì§€ í‘œì‹œ
                const mobileMessage = document.querySelector('.mobile-message');
                if (mobileMessage) {
                    mobileMessage.style.display = 'flex';
                }
                
                // ë¶„ì„ ì„¹ì…˜ë“¤ ìˆ¨ê¸°ê¸°
                const sections = ['.top-section', '.middle-section', '.bottom-section'];
                sections.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) element.style.display = 'none';
                });
            }
            
            console.log('ğŸ“± í™”ë©´ í¬ê¸° ë³€ê²½:', { 
                width: window.innerWidth, 
                isWideScreen, 
                analysisActive: isWideScreen 
            });
        });

    </script>
</body>
</html>