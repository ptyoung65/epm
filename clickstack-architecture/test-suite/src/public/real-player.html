<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÑ∏ÏÖò Î¶¨ÌîåÎ†àÏù¥ ÌîåÎ†àÏù¥Ïñ¥ - AIRIS-MON</title>
    <script src="https://cdn.jsdelivr.net/npm/rrweb@2.0.0-alpha.11/dist/rrweb-all.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f172a;
            color: white;
            overflow: hidden;
        }
        
        .player-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .player-header {
            background: linear-gradient(90deg, #1e293b 0%, #334155 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .session-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .info-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 2px;
        }
        
        .info-value {
            font-size: 14px;
            font-weight: 600;
        }
        
        .player-viewport {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #0f172a;
            position: relative;
            overflow: hidden;
        }
        
        #replayContainer {
            background: white;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            transform-origin: center center;
        }
        
        .player-controls {
            background: linear-gradient(90deg, #1e293b 0%, #334155 100%);
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        
        .timeline-container {
            margin-bottom: 20px;
        }
        
        .timeline {
            position: relative;
            height: 6px;
            background: #475569;
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
        }
        
        .timeline-progress {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
        }
        
        .timeline-buffer {
            position: absolute;
            height: 100%;
            background: rgba(255,255,255,0.1);
            width: 100%;
        }
        
        .timeline-thumb {
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: grab;
        }
        
        .timeline-thumb:active {
            cursor: grabbing;
        }
        
        .timeline-time {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 12px;
            color: #94a3b8;
        }
        
        .control-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .control-btn {
            background: #334155;
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
        }
        
        .control-btn:hover {
            background: #475569;
            transform: scale(1.1);
        }
        
        .control-btn.primary {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }
        
        .control-btn.primary:hover {
            transform: scale(1.15);
            box-shadow: 0 5px 20px rgba(59, 130, 246, 0.5);
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }
        
        .speed-select {
            background: #334155;
            border: 1px solid #475569;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .event-sidebar {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: #1e293b;
            transition: right 0.3s;
            z-index: 100;
            overflow-y: auto;
            box-shadow: -5px 0 20px rgba(0,0,0,0.3);
        }
        
        .event-sidebar.open {
            right: 0;
        }
        
        .sidebar-header {
            padding: 20px;
            background: #0f172a;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .event-list {
            padding: 20px;
        }
        
        .event-item {
            background: #334155;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .event-item:hover {
            background: #475569;
            transform: translateX(-5px);
        }
        
        .event-item.active {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }
        
        .event-type {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 4px;
        }
        
        .event-time {
            font-size: 14px;
            font-weight: 600;
        }
        
        .toggle-sidebar {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 101;
            transition: all 0.3s;
        }
        
        .toggle-sidebar:hover {
            transform: translateY(-50%) scale(1.1);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #334155;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: #94a3b8;
        }
        
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ef4444;
            color: white;
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            z-index: 1001;
        }
        
        .error-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ÏÑ∏ÏÖò Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>
    </div>
    
    <!-- ÏóêÎü¨ Î©îÏãúÏßÄ -->
    <div class="error-message" id="errorMessage"></div>
    
    <!-- ÏÇ¨Ïù¥ÎìúÎ∞î ÌÜ†Í∏Ä Î≤ÑÌäº -->
    <button class="toggle-sidebar" onclick="toggleSidebar()">üìã</button>
    
    <!-- Ïù¥Î≤§Ìä∏ ÏÇ¨Ïù¥ÎìúÎ∞î -->
    <div class="event-sidebar" id="eventSidebar">
        <div class="sidebar-header">
            <h3>Ïù¥Î≤§Ìä∏ ÌÉÄÏûÑÎùºÏù∏</h3>
            <p style="color: #94a3b8; font-size: 14px; margin-top: 5px;">
                Ï¥ù <span id="totalEvents">0</span>Í∞ú Ïù¥Î≤§Ìä∏
            </p>
        </div>
        <div class="event-list" id="eventList"></div>
    </div>
    
    <!-- Î©îÏù∏ ÌîåÎ†àÏù¥Ïñ¥ -->
    <div class="player-container">
        <div class="player-header">
            <div class="header-left">
                <div class="logo">
                    üé¨ AIRIS-MON Session Replay
                </div>
            </div>
            
            <div class="session-info">
                <div class="info-item">
                    <span class="info-label">ÏÑ∏ÏÖò ID</span>
                    <span class="info-value" id="sessionIdDisplay">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ÎÖπÌôî ÏãúÍ∞Ñ</span>
                    <span class="info-value" id="recordingDate">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Ï¥ù ÏãúÍ∞Ñ</span>
                    <span class="info-value" id="totalDuration">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Ïù¥Î≤§Ìä∏ Ïàò</span>
                    <span class="info-value" id="eventCountDisplay">-</span>
                </div>
            </div>
        </div>
        
        <div class="player-viewport">
            <div id="replayContainer"></div>
        </div>
        
        <div class="player-controls">
            <div class="timeline-container">
                <div class="timeline" id="timeline">
                    <div class="timeline-buffer"></div>
                    <div class="timeline-progress" id="timelineProgress"></div>
                    <div class="timeline-thumb" id="timelineThumb"></div>
                </div>
                <div class="timeline-time">
                    <span id="currentTime">00:00</span>
                    <span id="totalTime">00:00</span>
                </div>
            </div>
            
            <div style="display: flex; align-items: center;">
                <div class="control-buttons">
                    <button class="control-btn" onclick="skipBackward()">‚è™</button>
                    <button class="control-btn primary" id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂Ô∏è</button>
                    <button class="control-btn" onclick="skipForward()">‚è©</button>
                </div>
                
                <div class="speed-control">
                    <label style="color: #94a3b8;">ÏÜçÎèÑ:</label>
                    <select class="speed-select" id="speedSelect" onchange="changeSpeed()">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="2">2x</option>
                        <option value="4">4x</option>
                        <option value="8">8x</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let replayer = null;
        let events = [];
        let sessionData = null;
        let isPlaying = false;
        let currentTime = 0;
        let totalTime = 0;
        
        // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú ÏÑ∏ÏÖò ID Í∞ÄÏ†∏Ïò§Í∏∞
        function getSessionId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('sessionId');
        }
        
        // ÏÑ∏ÏÖò Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadSession() {
            const sessionId = getSessionId();
            
            if (!sessionId) {
                showError('ÏÑ∏ÏÖò IDÍ∞Ä Ï†úÍ≥µÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§');
                return;
            }
            
            document.getElementById('sessionIdDisplay').textContent = sessionId.substring(0, 8) + '...';
            
            try {
                // Î®ºÏ†Ä Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÌôïÏù∏
                const localData = localStorage.getItem(sessionId);
                
                if (localData) {
                    sessionData = JSON.parse(localData);
                    events = sessionData.events;
                } else {
                    // ÏÑúÎ≤ÑÏóêÏÑú Î°úÎìú
                    const response = await fetch(`/api/session-replay/session/${sessionId}`);
                    if (!response.ok) throw new Error('ÏÑ∏ÏÖòÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                    
                    sessionData = await response.json();
                    events = sessionData.events;
                }
                
                if (!events || events.length === 0) {
                    throw new Error('ÏÑ∏ÏÖòÏóê Ïù¥Î≤§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§');
                }
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                updateSessionInfo();
                
                // Î¶¨ÌîåÎ†àÏù¥Ïñ¥ Ï¥àÍ∏∞Ìôî
                initReplayer();
                
                // Ïù¥Î≤§Ìä∏ Î™©Î°ù ÌëúÏãú
                displayEventList();
                
                // Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ Ïà®Í∏∞Í∏∞
                document.getElementById('loadingOverlay').style.display = 'none';
                
            } catch (error) {
                console.error('ÏÑ∏ÏÖò Î°úÎìú Ïã§Ìå®:', error);
                showError('ÏÑ∏ÏÖòÏùÑ Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§: ' + error.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
        
        // ÏÑ∏ÏÖò Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateSessionInfo() {
            if (!sessionData) return;
            
            // ÎÇ†Ïßú ÌëúÏãú
            const date = new Date(sessionData.timestamp || sessionData.startTime);
            document.getElementById('recordingDate').textContent = date.toLocaleString('ko-KR');
            
            // Ï¥ù ÏãúÍ∞Ñ Í≥ÑÏÇ∞
            const duration = sessionData.duration || (sessionData.endTime - sessionData.startTime);
            totalTime = duration;
            document.getElementById('totalDuration').textContent = formatTime(duration);
            document.getElementById('totalTime').textContent = formatTime(duration);
            
            // Ïù¥Î≤§Ìä∏ Ïàò
            document.getElementById('eventCountDisplay').textContent = events.length;
            document.getElementById('totalEvents').textContent = events.length;
        }
        
        // rrweb Î¶¨ÌîåÎ†àÏù¥Ïñ¥ Ï¥àÍ∏∞Ìôî
        function initReplayer() {
            const container = document.getElementById('replayContainer');
            
            // Î¶¨ÌîåÎ†àÏù¥Ïñ¥ ÏÉùÏÑ±
            replayer = new rrweb.Replayer(events, {
                root: container,
                wrapper: container,
                speed: 1,
                skipInactive: true,
                showWarning: true,
                showDebug: false,
                blockClass: 'rr-block',
                liveMode: false,
                insertStyleRules: [],
                triggerFocus: false,
                UNSAFE_replayCanvas: true,
                pauseAnimation: false,
                mouseTail: {
                    duration: 500,
                    lineCap: 'round',
                    lineWidth: 3,
                    strokeStyle: '#3b82f6'
                }
            });
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            replayer.on('finish', () => {
                isPlaying = false;
                updatePlayButton();
            });
            
            replayer.on('skip-start', () => {
                isPlaying = true;
                updatePlayButton();
            });
            
            replayer.on('skip-end', () => {
                isPlaying = false;
                updatePlayButton();
            });
            
            // ÌÉÄÏûÑÎùºÏù∏ ÏóÖÎç∞Ïù¥Ìä∏
            startTimelineUpdate();
            
            // Î∑∞Ìè¨Ìä∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï
            adjustViewport();
        }
        
        // Î∑∞Ìè¨Ìä∏ ÌÅ¨Í∏∞ Ï°∞Ï†ï
        function adjustViewport() {
            const container = document.getElementById('replayContainer');
            const viewport = document.querySelector('.player-viewport');
            
            // ÏõêÎ≥∏ ÌÅ¨Í∏∞ (Î≥¥ÌÜµ 1920x1080)
            const originalWidth = 1920;
            const originalHeight = 1080;
            
            // ÌòÑÏû¨ Î∑∞Ìè¨Ìä∏ ÌÅ¨Í∏∞
            const viewportWidth = viewport.clientWidth - 100;
            const viewportHeight = viewport.clientHeight - 100;
            
            // Ïä§ÏºÄÏùº Í≥ÑÏÇ∞
            const scaleX = viewportWidth / originalWidth;
            const scaleY = viewportHeight / originalHeight;
            const scale = Math.min(scaleX, scaleY, 1);
            
            // Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞ ÏÑ§Ï†ï
            container.style.width = originalWidth + 'px';
            container.style.height = originalHeight + 'px';
            container.style.transform = `scale(${scale})`;
        }
        
        // Ïû¨ÏÉù/ÏùºÏãúÏ†ïÏßÄ ÌÜ†Í∏Ä
        function togglePlayPause() {
            if (!replayer) return;
            
            if (isPlaying) {
                replayer.pause();
                isPlaying = false;
            } else {
                replayer.play();
                isPlaying = true;
            }
            
            updatePlayButton();
        }
        
        // Ïû¨ÏÉù Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
        function updatePlayButton() {
            const btn = document.getElementById('playPauseBtn');
            btn.textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
        }
        
        // ÏïûÏúºÎ°ú Ïä§ÌÇµ
        function skipForward() {
            if (!replayer) return;
            const current = replayer.getCurrentTime();
            replayer.play(current + 10000); // 10Ï¥à ÏïûÏúºÎ°ú
        }
        
        // Îí§Î°ú Ïä§ÌÇµ
        function skipBackward() {
            if (!replayer) return;
            const current = replayer.getCurrentTime();
            replayer.play(Math.max(0, current - 10000)); // 10Ï¥à Îí§Î°ú
        }
        
        // Ïû¨ÏÉù ÏÜçÎèÑ Î≥ÄÍ≤Ω
        function changeSpeed() {
            if (!replayer) return;
            const speed = parseFloat(document.getElementById('speedSelect').value);
            replayer.setConfig({ speed: speed });
        }
        
        // ÌÉÄÏûÑÎùºÏù∏ ÏóÖÎç∞Ïù¥Ìä∏
        function startTimelineUpdate() {
            setInterval(() => {
                if (!replayer || !isPlaying) return;
                
                const current = replayer.getCurrentTime();
                const progress = (current / totalTime) * 100;
                
                document.getElementById('timelineProgress').style.width = progress + '%';
                document.getElementById('timelineThumb').style.left = progress + '%';
                document.getElementById('currentTime').textContent = formatTime(current);
            }, 100);
        }
        
        // ÌÉÄÏûÑÎùºÏù∏ ÌÅ¥Î¶≠ Ï≤òÎ¶¨
        document.getElementById('timeline').addEventListener('click', (e) => {
            if (!replayer) return;
            
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percentage = x / rect.width;
            const targetTime = totalTime * percentage;
            
            replayer.play(targetTime);
        });
        
        // Ïù¥Î≤§Ìä∏ Î™©Î°ù ÌëúÏãú
        function displayEventList() {
            const container = document.getElementById('eventList');
            container.innerHTML = '';
            
            events.forEach((event, index) => {
                const item = document.createElement('div');
                item.className = 'event-item';
                item.onclick = () => jumpToEvent(event.timestamp);
                
                const typeMap = {
                    0: 'DOM ÏΩòÌÖêÏ∏† Î°úÎìú',
                    1: 'Meta Ï†ïÎ≥¥',
                    2: 'Ï†ÑÏ≤¥ Ïä§ÎÉÖÏÉ∑',
                    3: 'Ï¶ùÎ∂Ñ Ïä§ÎÉÖÏÉ∑',
                    4: 'ÌîåÎü¨Í∑∏Ïù∏',
                    5: 'Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏'
                };
                
                item.innerHTML = `
                    <div class="event-type">${typeMap[event.type] || 'Í∏∞ÌÉÄ'}</div>
                    <div class="event-time">${formatTime(event.timestamp)}</div>
                `;
                
                container.appendChild(item);
            });
        }
        
        // ÌäπÏ†ï Ïù¥Î≤§Ìä∏Î°ú Ï†êÌîÑ
        function jumpToEvent(timestamp) {
            if (!replayer) return;
            replayer.play(timestamp);
        }
        
        // ÏÇ¨Ïù¥ÎìúÎ∞î ÌÜ†Í∏Ä
        function toggleSidebar() {
            const sidebar = document.getElementById('eventSidebar');
            sidebar.classList.toggle('open');
        }
        
        // ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // ÏóêÎü¨ ÌëúÏãú
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }
        
        // ÏúàÎèÑÏö∞ Î¶¨ÏÇ¨Ïù¥Ï¶à Ï≤òÎ¶¨
        window.addEventListener('resize', adjustViewport);
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÑ∏ÏÖò Î°úÎìú
        window.addEventListener('load', loadSession);
    </script>
</body>
</html>