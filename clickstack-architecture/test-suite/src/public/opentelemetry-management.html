<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRIS-MON OpenTelemetry ê´€ë¦¬</title>
    <script src="/components/common-layout.js"></script>
    <style>
        .otel-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .otel-header h2 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }
        
        .otel-header .subtitle {
            color: var(--gray-600);
            font-size: 1rem;
        }

        .conversion-form {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-section {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .status-card {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .status-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .results-section {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .results-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-failed {
            background: #fef2f2;
            color: #dc2626;
        }

        .status-skipped {
            background: #fefce8;
            color: #ca8a04;
        }

        .logs-panel {
            background: var(--gray-900);
            color: var(--success);
            padding: 1.5rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.4;
            margin-top: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-info {
            background: #eff6ff;
            border-left: 4px solid var(--primary);
            color: var(--primary);
        }

        .alert-warning {
            background: #fffbeb;
            border-left: 4px solid var(--warning);
            color: var(--warning);
        }

        .alert-success {
            background: #f0fdf4;
            border-left: 4px solid var(--success);
            color: var(--success);
        }

        .project-info {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .info-item {
            text-align: center;
        }

        .info-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .info-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }
    </style>
</head>
<body>
    <div class="otel-header">
        <h2>ğŸ”§ OpenTelemetry ìë™ ì ìš© ê´€ë¦¬</h2>
        <div class="subtitle">Java, Python í”„ë¡œì íŠ¸ì— OpenTelemetry SDKë¥¼ ìë™ìœ¼ë¡œ ì ìš©í•˜ëŠ” ë°°ì¹˜ í”„ë¡œê·¸ë¨</div>
    </div>

    <!-- ë³€í™˜ í¼ -->
    <div class="conversion-form">
        <h3 style="margin-bottom: 1.5rem; color: var(--gray-900); font-size: 1.25rem;">í”„ë¡œì íŠ¸ ë³€í™˜ ì„¤ì •</h3>
        
        <div class="form-group">
            <label class="form-label" for="gitDirectory">
                <span style="color: var(--error);">*</span> Git ë””ë ‰í† ë¦¬ ê²½ë¡œ
            </label>
            <input 
                type="text" 
                id="gitDirectory" 
                class="form-input" 
                placeholder="/path/to/your/project/.git ë˜ëŠ” /path/to/your/project"
                value="/home/ptyoung/work/sample-project"
            />
            <small style="color: var(--gray-600); font-size: 0.875rem;">
                .git ë””ë ‰í† ë¦¬ê°€ ìˆëŠ” í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”
            </small>
        </div>

        <div class="form-group">
            <label class="form-label">ë³€í™˜ ì˜µì…˜</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="includeJava" checked>
                    <label for="includeJava">Java íŒŒì¼ (.java)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="includePython" checked>
                    <label for="includePython">Python íŒŒì¼ (.py)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="updateBuildFiles" checked>
                    <label for="updateBuildFiles">ë¹Œë“œ íŒŒì¼ ì—…ë°ì´íŠ¸</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="createBackup" checked>
                    <label for="createBackup">ë°±ì—… ìƒì„±</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label" for="excludePatterns">ì œì™¸í•  íŒ¨í„´ (ì„ íƒì‚¬í•­)</label>
            <textarea 
                id="excludePatterns" 
                class="form-input form-textarea" 
                placeholder="test&#10;target&#10;build&#10;node_modules"
            >test
target
build
node_modules
__pycache__</textarea>
            <small style="color: var(--gray-600); font-size: 0.875rem;">
                ê° ë¼ì¸ì— í•˜ë‚˜ì”© ì…ë ¥ (ë””ë ‰í† ë¦¬/íŒŒì¼ íŒ¨í„´)
            </small>
        </div>

        <div class="btn-group">
            <button class="btn btn-secondary" onclick="analyzeProject()">
                ğŸ“Š í”„ë¡œì íŠ¸ ë¶„ì„
            </button>
            <button class="btn btn-primary" onclick="startConversion()" id="convertBtn">
                ğŸš€ OpenTelemetry ì ìš© ì‹œì‘
            </button>
            <button class="btn btn-success" onclick="downloadReport()" id="downloadBtn" disabled>
                ğŸ“¥ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
            </button>
        </div>
    </div>

    <!-- ì§„í–‰ ìƒí™© -->
    <div class="progress-section" id="progressSection">
        <h3 style="margin-bottom: 1rem; color: var(--gray-900);">ë³€í™˜ ì§„í–‰ ìƒí™©</h3>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div id="currentStatus" style="text-align: center; color: var(--gray-600); margin: 0.5rem 0;">
            ëŒ€ê¸° ì¤‘...
        </div>

        <div class="status-grid">
            <div class="status-card">
                <div class="status-value" id="totalFiles">0</div>
                <div class="status-label">ì „ì²´ íŒŒì¼</div>
            </div>
            <div class="status-card">
                <div class="status-value" id="processedFiles">0</div>
                <div class="status-label">ì²˜ë¦¬ëœ íŒŒì¼</div>
            </div>
            <div class="status-card">
                <div class="status-value" id="successfulFiles">0</div>
                <div class="status-label">ì„±ê³µ</div>
            </div>
            <div class="status-card">
                <div class="status-value" id="failedFiles">0</div>
                <div class="status-label">ì‹¤íŒ¨</div>
            </div>
        </div>

        <div class="logs-panel" id="logsPanel">
            AIRIS-MON OpenTelemetry ìë™ ì ìš© ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ...
        </div>
    </div>

    <!-- í”„ë¡œì íŠ¸ ì •ë³´ -->
    <div class="project-info" id="projectInfo" style="display: none;">
        <h3 style="margin-bottom: 1rem; color: var(--gray-900);">í”„ë¡œì íŠ¸ ë¶„ì„ ê²°ê³¼</h3>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-value" id="infoJavaFiles">0</div>
                <div class="info-label">Java íŒŒì¼</div>
            </div>
            <div class="info-item">
                <div class="info-value" id="infoPythonFiles">0</div>
                <div class="info-label">Python íŒŒì¼</div>
            </div>
            <div class="info-item">
                <div class="info-value" id="infoFramework">unknown</div>
                <div class="info-label">í”„ë ˆì„ì›Œí¬</div>
            </div>
            <div class="info-item">
                <div class="info-value" id="infoBuildTool">none</div>
                <div class="info-label">ë¹Œë“œ ë„êµ¬</div>
            </div>
        </div>
    </div>

    <!-- ê²°ê³¼ ì„¹ì…˜ -->
    <div class="results-section" id="resultsSection">
        <h3 style="margin-bottom: 1rem; color: var(--gray-900);">ë³€í™˜ ê²°ê³¼</h3>
        
        <div id="resultsSummary"></div>
        
        <table class="results-table" id="resultsTable">
            <thead>
                <tr>
                    <th>íŒŒì¼ ê²½ë¡œ</th>
                    <th>ì–¸ì–´</th>
                    <th>ìƒíƒœ</th>
                    <th>í¬ê¸° ë³€í™”</th>
                    <th>ì¶”ê°€ëœ import</th>
                    <th>ë©”ì‹œì§€</th>
                </tr>
            </thead>
            <tbody id="resultsTableBody">
            </tbody>
        </table>
    </div>

    <script>
        let conversionInProgress = false;
        let currentConversionResult = null;

        // ë¡œê·¸ ì¶”ê°€ í•¨ìˆ˜
        function addLog(message, type = 'info') {
            const logsPanel = document.getElementById('logsPanel');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            logsPanel.textContent += logEntry + '\n';
            logsPanel.scrollTop = logsPanel.scrollHeight;
            
            console.log(`[OpenTelemetry] ${message}`);
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percentage, status) {
            const progressFill = document.getElementById('progressFill');
            const currentStatus = document.getElementById('currentStatus');
            
            progressFill.style.width = percentage + '%';
            currentStatus.textContent = status;
        }

        // ìƒíƒœ ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateStatusCards(stats) {
            document.getElementById('totalFiles').textContent = stats.total || 0;
            document.getElementById('processedFiles').textContent = stats.processed || 0;
            document.getElementById('successfulFiles').textContent = stats.successful || 0;
            document.getElementById('failedFiles').textContent = stats.failed || 0;
        }

        // í”„ë¡œì íŠ¸ ë¶„ì„
        async function analyzeProject() {
            const gitDirectory = document.getElementById('gitDirectory').value.trim();
            
            if (!gitDirectory) {
                alert('Git ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                addLog('í”„ë¡œì íŠ¸ ë¶„ì„ ì‹œì‘...');
                
                const response = await fetch('/api/opentelemetry/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        git_directory: gitDirectory
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayProjectInfo(result.analysis);
                    addLog('í”„ë¡œì íŠ¸ ë¶„ì„ ì™„ë£Œ');
                } else {
                    addLog(`í”„ë¡œì íŠ¸ ë¶„ì„ ì‹¤íŒ¨: ${result.error}`, 'error');
                    alert('í”„ë¡œì íŠ¸ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
                }
            } catch (error) {
                addLog(`í”„ë¡œì íŠ¸ ë¶„ì„ ì˜¤ë¥˜: ${error.message}`, 'error');
                alert('í”„ë¡œì íŠ¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í”„ë¡œì íŠ¸ ì •ë³´ í‘œì‹œ
        function displayProjectInfo(analysis) {
            const projectInfo = document.getElementById('projectInfo');
            
            document.getElementById('infoJavaFiles').textContent = analysis.java_files;
            document.getElementById('infoPythonFiles').textContent = analysis.python_files;
            document.getElementById('infoFramework').textContent = analysis.framework_type;
            
            let buildTool = 'none';
            if (analysis.has_maven) buildTool = 'Maven';
            else if (analysis.has_gradle) buildTool = 'Gradle';
            else if (analysis.has_poetry) buildTool = 'Poetry';
            else if (analysis.has_requirements_txt) buildTool = 'pip';
            
            document.getElementById('infoBuildTool').textContent = buildTool;
            
            projectInfo.style.display = 'block';
            
            if (analysis.existing_otel) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning';
                alertDiv.innerHTML = 'âš ï¸ ì´ë¯¸ OpenTelemetryê°€ ì ìš©ëœ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.';
                projectInfo.appendChild(alertDiv);
            }
        }

        // OpenTelemetry ì ìš© ì‹œì‘
        async function startConversion() {
            if (conversionInProgress) {
                alert('ì´ë¯¸ ë³€í™˜ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
                return;
            }

            const gitDirectory = document.getElementById('gitDirectory').value.trim();
            
            if (!gitDirectory) {
                alert('Git ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì˜µì…˜ ìˆ˜ì§‘
            const options = {
                git_directory: gitDirectory,
                include_java: document.getElementById('includeJava').checked,
                include_python: document.getElementById('includePython').checked,
                update_build_files: document.getElementById('updateBuildFiles').checked,
                create_backup: document.getElementById('createBackup').checked,
                exclude_patterns: document.getElementById('excludePatterns').value
                    .split('\n')
                    .map(p => p.trim())
                    .filter(p => p.length > 0)
            };

            try {
                conversionInProgress = true;
                document.getElementById('convertBtn').disabled = true;
                document.getElementById('progressSection').style.display = 'block';
                
                addLog('=== OpenTelemetry ìë™ ì ìš© ì‹œì‘ ===');
                updateProgress(0, 'ë³€í™˜ ì‹œì‘...');
                updateStatusCards({ total: 0, processed: 0, successful: 0, failed: 0 });

                const response = await fetch('/api/opentelemetry/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(options)
                });

                const result = await response.json();
                
                if (result.success) {
                    currentConversionResult = result;
                    displayConversionResults(result);
                    addLog('=== OpenTelemetry ì ìš© ì™„ë£Œ ===');
                    updateProgress(100, 'ë³€í™˜ ì™„ë£Œ');
                    document.getElementById('downloadBtn').disabled = false;
                } else {
                    addLog(`ë³€í™˜ ì‹¤íŒ¨: ${result.error}`, 'error');
                    updateProgress(0, 'ë³€í™˜ ì‹¤íŒ¨');
                    alert('OpenTelemetry ì ìš©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
                }
                
            } catch (error) {
                addLog(`ë³€í™˜ ì˜¤ë¥˜: ${error.message}`, 'error');
                updateProgress(0, 'ë³€í™˜ ì˜¤ë¥˜');
                alert('ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                conversionInProgress = false;
                document.getElementById('convertBtn').disabled = false;
            }
        }

        // ë³€í™˜ ê²°ê³¼ í‘œì‹œ
        function displayConversionResults(result) {
            const summary = result.conversion_summary;
            const results = result.conversion_results;
            
            // ìƒíƒœ ì¹´ë“œ ì—…ë°ì´íŠ¸
            updateStatusCards({
                total: summary.total_files,
                processed: summary.total_files,
                successful: summary.successful,
                failed: summary.failed
            });

            // ìš”ì•½ ì •ë³´ í‘œì‹œ
            const summaryDiv = document.getElementById('resultsSummary');
            summaryDiv.innerHTML = `
                <div class="alert alert-success">
                    âœ… ë³€í™˜ ì™„ë£Œ: ì„±ê³µ ${summary.successful}ê°œ, ì‹¤íŒ¨ ${summary.failed}ê°œ, ê±´ë„ˆëœ€ ${summary.skipped}ê°œ
                    ${result.build_files_updated ? '<br>ğŸ“¦ ë¹Œë“œ íŒŒì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ' : ''}
                </div>
            `;

            // ìƒì„¸ ê²°ê³¼ í…Œì´ë¸”
            const tableBody = document.getElementById('resultsTableBody');
            tableBody.innerHTML = '';
            
            results.forEach(item => {
                const row = document.createElement('tr');
                
                const statusClass = item.status === 'success' ? 'status-success' : 
                                   item.status === 'failed' ? 'status-failed' : 'status-skipped';
                
                const sizeChange = item.converted_size > item.original_size ? 
                                  `+${item.converted_size - item.original_size} bytes` : 
                                  item.converted_size === item.original_size ? 'No change' :
                                  `${item.converted_size - item.original_size} bytes`;

                row.innerHTML = `
                    <td title="${item.file_path}">${item.file_path.split('/').pop()}</td>
                    <td>${item.language.toUpperCase()}</td>
                    <td><span class="status-badge ${statusClass}">${item.status.toUpperCase()}</span></td>
                    <td>${sizeChange}</td>
                    <td>${item.added_imports.length} imports</td>
                    <td title="${item.error_message || ''}">${item.error_message || 'ì„±ê³µ'}</td>
                `;
                
                tableBody.appendChild(row);
            });

            // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('resultsSection').style.display = 'block';
        }

        // ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
        function downloadReport() {
            if (!currentConversionResult) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const reportData = {
                timestamp: timestamp,
                ...currentConversionResult
            };

            const blob = new Blob([JSON.stringify(reportData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `opentelemetry_conversion_report_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            addLog('ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            addLog('OpenTelemetry ìë™ ì ìš© ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ');
            addLog('í”„ë¡œì íŠ¸ ê²½ë¡œë¥¼ ì…ë ¥í•˜ê³  "í”„ë¡œì íŠ¸ ë¶„ì„" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”');
        });
    </script>
</body>
</html>