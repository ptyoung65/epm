<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClickHouse ë°ì´í„° ì¡°íšŒ</title>
    <script src="/components/common-layout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .clickhouse-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .clickhouse-header h2 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }
        
        .clickhouse-header .subtitle {
            color: var(--gray-600);
            font-size: 1rem;
        }

        .query-controls {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .filter-input {
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            background: var(--white);
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .query-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .query-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .query-btn.primary {
            background: var(--primary);
            color: var(--white);
        }

        .query-btn.primary:hover {
            background: var(--primary-dark);
        }

        .query-btn.secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
        }

        .query-btn.secondary:hover {
            background: var(--gray-200);
        }

        .results-section {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .results-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .results-meta {
            display: flex;
            gap: 2rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .query-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .query-status.loading {
            background: #dbeafe;
            color: var(--primary);
        }

        .query-status.success {
            background: #dcfce7;
            color: var(--success);
        }

        .query-status.error {
            background: #fef2f2;
            color: var(--error);
        }

        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .results-table th,
        .results-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.875rem;
        }

        .results-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            position: sticky;
            top: 0;
        }

        .results-table tbody tr:hover {
            background: var(--gray-50);
        }

        .trace-id {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: var(--gray-100);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.success {
            background: #dcfce7;
            color: var(--success);
        }

        .status-badge.error {
            background: #fef2f2;
            color: var(--error);
        }

        .status-badge.timeout {
            background: #fef3c7;
            color: var(--warning);
        }

        .duration {
            font-weight: 600;
            color: var(--primary);
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .export-options {
            display: flex;
            gap: 0.5rem;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .chart-container {
            height: 250px;
            position: relative;
        }

        @media (max-width: 768px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .query-actions {
                flex-direction: column;
            }
            
            .results-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="clickhouse-header">
        <h2>ğŸ” ClickHouse ë°ì´í„° ì¡°íšŒ</h2>
        <p class="subtitle">OpenTelemetry ì¶”ì  ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¡°íšŒí•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤</p>
    </div>

    <div class="query-controls">
        <div class="filters-grid">
            <div class="filter-group">
                <label class="filter-label">ì‹œê°„ ë²”ìœ„</label>
                <select class="filter-input" id="timeRange">
                    <option value="1h">ìµœê·¼ 1ì‹œê°„</option>
                    <option value="6h">ìµœê·¼ 6ì‹œê°„</option>
                    <option value="24h" selected>ìµœê·¼ 24ì‹œê°„</option>
                    <option value="7d">ìµœê·¼ 7ì¼</option>
                    <option value="30d">ìµœê·¼ 30ì¼</option>
                    <option value="custom">ì‚¬ìš©ì ì •ì˜</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">ì„œë¹„ìŠ¤ëª…</label>
                <select class="filter-input" id="serviceFilter">
                    <option value="">ì „ì²´ ì„œë¹„ìŠ¤</option>
                    <option value="user-service">user-service</option>
                    <option value="payment-service">payment-service</option>
                    <option value="order-service">order-service</option>
                    <option value="inventory-service">inventory-service</option>
                    <option value="notification-service">notification-service</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">ì¶”ì  ìƒíƒœ</label>
                <select class="filter-input" id="statusFilter">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="success">ì„±ê³µ</option>
                    <option value="error">ì˜¤ë¥˜</option>
                    <option value="timeout">íƒ€ì„ì•„ì›ƒ</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">ìµœì†Œ ì‘ë‹µì‹œê°„ (ms)</label>
                <input type="number" class="filter-input" id="minDuration" placeholder="ì˜ˆ: 100" min="0">
            </div>

            <div class="filter-group">
                <label class="filter-label">ìµœëŒ€ ì‘ë‹µì‹œê°„ (ms)</label>
                <input type="number" class="filter-input" id="maxDuration" placeholder="ì˜ˆ: 5000" min="0">
            </div>

            <div class="filter-group">
                <label class="filter-label">ìµœì†Œ ìŠ¤íŒ¬ ìˆ˜</label>
                <input type="number" class="filter-input" id="minSpans" placeholder="ì˜ˆ: 1" min="1">
            </div>
        </div>

        <div class="query-actions">
            <button class="query-btn primary" id="executeQuery">
                <span id="queryButtonText">ì¿¼ë¦¬ ì‹¤í–‰</span>
            </button>
            <button class="query-btn secondary" id="clearFilters">í•„í„° ì´ˆê¸°í™”</button>
            <button class="query-btn secondary" id="saveQuery">ì¿¼ë¦¬ ì €ì¥</button>
        </div>
    </div>

    <div class="charts-section" id="chartsSection" style="display: none;">
        <div class="chart-card">
            <div class="chart-title">ì„œë¹„ìŠ¤ë³„ ì¶”ì  ë¶„í¬</div>
            <div class="chart-container">
                <canvas id="serviceChart"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">ì‘ë‹µì‹œê°„ ë¶„í¬</div>
            <div class="chart-container">
                <canvas id="durationChart"></canvas>
            </div>
        </div>
    </div>

    <div class="results-section">
        <div class="results-header">
            <div>
                <div class="results-title">ì¡°íšŒ ê²°ê³¼</div>
                <div class="query-status" id="queryStatus">
                    <span>ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ì—¬ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì„¸ìš”</span>
                </div>
            </div>
            <div class="results-meta" id="resultsMeta" style="display: none;">
                <span id="resultsCount">0ê°œ ê²°ê³¼</span>
                <span id="queryTime">ì‹¤í–‰ ì‹œê°„: 0ms</span>
                <div class="export-options">
                    <button class="query-btn secondary" id="exportCSV">CSV ë‚´ë³´ë‚´ê¸°</button>
                    <button class="query-btn secondary" id="exportJSON">JSON ë‚´ë³´ë‚´ê¸°</button>
                </div>
            </div>
        </div>

        <div id="resultsContainer">
            <div class="no-results">
                ì•„ì§ ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ í•„í„°ë¥¼ ì„¤ì •í•˜ê³  "ì¿¼ë¦¬ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentResults = [];
        let serviceChart = null;
        let durationChart = null;

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initializeCharts() {
            // ì„œë¹„ìŠ¤ë³„ ì°¨íŠ¸
            const serviceCtx = document.getElementById('serviceChart').getContext('2d');
            serviceChart = new Chart(serviceCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // ì‘ë‹µì‹œê°„ ì°¨íŠ¸
            const durationCtx = document.getElementById('durationChart').getContext('2d');
            durationChart = new Chart(durationCtx, {
                type: 'bar',
                data: {
                    labels: ['0-100ms', '100-500ms', '500ms-1s', '1s-3s', '3s+'],
                    datasets: [{
                        label: 'ì¶”ì  ìˆ˜',
                        data: [],
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ì¿¼ë¦¬ ì‹¤í–‰
        async function executeQuery() {
            const statusEl = document.getElementById('queryStatus');
            const buttonEl = document.getElementById('queryButtonText');
            const metaEl = document.getElementById('resultsMeta');
            const chartsEl = document.getElementById('chartsSection');

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            statusEl.className = 'query-status loading';
            statusEl.innerHTML = '<div class="spinner"></div> ë°ì´í„° ì¡°íšŒ ì¤‘...';
            buttonEl.textContent = 'ì¡°íšŒ ì¤‘...';

            const startTime = Date.now();

            try {
                // í•„í„° ê°’ ìˆ˜ì§‘
                const filters = {
                    timeRange: document.getElementById('timeRange').value,
                    service: document.getElementById('serviceFilter').value,
                    status: document.getElementById('statusFilter').value,
                    minDuration: document.getElementById('minDuration').value,
                    maxDuration: document.getElementById('maxDuration').value,
                    minSpans: document.getElementById('minSpans').value
                };

                // API í˜¸ì¶œ
                const response = await fetch('/api/clickhouse/traces');
                const data = await response.json();

                // í•„í„° ì ìš©
                const filteredResults = applyFilters(data.traces, filters);
                currentResults = filteredResults;

                const queryTime = Date.now() - startTime;

                // ì„±ê³µ ìƒíƒœ í‘œì‹œ
                statusEl.className = 'query-status success';
                statusEl.innerHTML = 'âœ“ ì¡°íšŒ ì™„ë£Œ';
                buttonEl.textContent = 'ì¿¼ë¦¬ ì‹¤í–‰';

                // ê²°ê³¼ ë©”íƒ€ë°ì´í„° í‘œì‹œ
                document.getElementById('resultsCount').textContent = `${filteredResults.length}ê°œ ê²°ê³¼`;
                document.getElementById('queryTime').textContent = `ì‹¤í–‰ ì‹œê°„: ${queryTime}ms`;
                metaEl.style.display = 'flex';

                // ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
                renderResults(filteredResults);

                // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                updateCharts(filteredResults);
                chartsEl.style.display = filteredResults.length > 0 ? 'grid' : 'none';

            } catch (error) {
                console.error('ì¿¼ë¦¬ ì‹¤í–‰ ì˜¤ë¥˜:', error);
                statusEl.className = 'query-status error';
                statusEl.innerHTML = 'âŒ ì¿¼ë¦¬ ì‹¤í–‰ ì‹¤íŒ¨';
                buttonEl.textContent = 'ì¿¼ë¦¬ ì‹¤í–‰';
                metaEl.style.display = 'none';
            }
        }

        // í•„í„° ì ìš©
        function applyFilters(traces, filters) {
            return traces.filter(trace => {
                // ì„œë¹„ìŠ¤ í•„í„°
                if (filters.service && !trace.serviceName.includes(filters.service)) {
                    return false;
                }

                // ìƒíƒœ í•„í„°
                if (filters.status && trace.status !== filters.status) {
                    return false;
                }

                // ì‘ë‹µì‹œê°„ í•„í„°
                if (filters.minDuration && trace.duration < parseInt(filters.minDuration)) {
                    return false;
                }
                if (filters.maxDuration && trace.duration > parseInt(filters.maxDuration)) {
                    return false;
                }

                // ìŠ¤íŒ¬ ìˆ˜ í•„í„°
                if (filters.minSpans && trace.spanCount < parseInt(filters.minSpans)) {
                    return false;
                }

                return true;
            });
        }

        // ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
        function renderResults(results) {
            const container = document.getElementById('resultsContainer');

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        í•„í„° ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì¡°ê±´ì„ ì‹œë„í•´ë³´ì„¸ìš”.
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>ì¶”ì  ID</th>
                            <th>ì„œë¹„ìŠ¤</th>
                            <th>ì‘ì—…</th>
                            <th>ìƒíƒœ</th>
                            <th>ì‘ë‹µì‹œê°„</th>
                            <th>ìŠ¤íŒ¬ ìˆ˜</th>
                            <th>ì‹œì‘ ì‹œê°„</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map(trace => `
                            <tr>
                                <td><span class="trace-id">${trace.traceId}</span></td>
                                <td>${trace.serviceName}</td>
                                <td>${trace.operationName}</td>
                                <td><span class="status-badge ${trace.status}">${getStatusText(trace.status)}</span></td>
                                <td><span class="duration">${trace.duration}ms</span></td>
                                <td>${trace.spanCount}</td>
                                <td>${new Date(trace.startTime).toLocaleString('ko-KR')}</td>
                                <td>
                                    <button class="query-btn secondary" onclick="viewTraceDetails('${trace.traceId}')">
                                        ìƒì„¸ë³´ê¸°
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
        function getStatusText(status) {
            const statusMap = {
                'success': 'ì„±ê³µ',
                'error': 'ì˜¤ë¥˜',
                'timeout': 'íƒ€ì„ì•„ì›ƒ'
            };
            return statusMap[status] || status;
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateCharts(results) {
            // ì„œë¹„ìŠ¤ë³„ ë¶„í¬
            const serviceCounts = {};
            results.forEach(trace => {
                serviceCounts[trace.serviceName] = (serviceCounts[trace.serviceName] || 0) + 1;
            });

            serviceChart.data.labels = Object.keys(serviceCounts);
            serviceChart.data.datasets[0].data = Object.values(serviceCounts);
            serviceChart.update();

            // ì‘ë‹µì‹œê°„ ë¶„í¬
            const durationBuckets = [0, 0, 0, 0, 0]; // 0-100ms, 100-500ms, 500ms-1s, 1s-3s, 3s+
            results.forEach(trace => {
                const duration = trace.duration;
                if (duration <= 100) durationBuckets[0]++;
                else if (duration <= 500) durationBuckets[1]++;
                else if (duration <= 1000) durationBuckets[2]++;
                else if (duration <= 3000) durationBuckets[3]++;
                else durationBuckets[4]++;
            });

            durationChart.data.datasets[0].data = durationBuckets;
            durationChart.update();
        }

        // ì¶”ì  ìƒì„¸ë³´ê¸°
        function viewTraceDetails(traceId) {
            window.open(`/trace-detail-analyzer.html?traceId=${traceId}`, '_blank');
        }

        // í•„í„° ì´ˆê¸°í™”
        function clearFilters() {
            document.getElementById('timeRange').value = '24h';
            document.getElementById('serviceFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('minDuration').value = '';
            document.getElementById('maxDuration').value = '';
            document.getElementById('minSpans').value = '';
        }

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportData(format) {
            if (currentResults.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
            const filename = `clickhouse_traces_${timestamp}`;

            if (format === 'csv') {
                const csv = convertToCSV(currentResults);
                downloadFile(csv, `${filename}.csv`, 'text/csv');
            } else if (format === 'json') {
                const json = JSON.stringify(currentResults, null, 2);
                downloadFile(json, `${filename}.json`, 'application/json');
            }
        }

        // CSV ë³€í™˜
        function convertToCSV(data) {
            const headers = ['ì¶”ì ID', 'ì„œë¹„ìŠ¤', 'ì‘ì—…', 'ìƒíƒœ', 'ì‘ë‹µì‹œê°„(ms)', 'ìŠ¤íŒ¬ìˆ˜', 'ì‹œì‘ì‹œê°„'];
            const rows = data.map(trace => [
                trace.traceId,
                trace.serviceName,
                trace.operationName,
                getStatusText(trace.status),
                trace.duration,
                trace.spanCount,
                new Date(trace.startTime).toLocaleString('ko-KR')
            ]);

            return [headers, ...rows].map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
        }

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();

            // ì¿¼ë¦¬ ì‹¤í–‰ ë²„íŠ¼
            document.getElementById('executeQuery').addEventListener('click', executeQuery);

            // í•„í„° ì´ˆê¸°í™” ë²„íŠ¼
            document.getElementById('clearFilters').addEventListener('click', clearFilters);

            // ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ë“¤
            document.getElementById('exportCSV').addEventListener('click', () => exportData('csv'));
            document.getElementById('exportJSON').addEventListener('click', () => exportData('json'));

            // ì—”í„° í‚¤ë¡œ ì¿¼ë¦¬ ì‹¤í–‰
            document.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        executeQuery();
                    }
                });
            });
        });
    </script>
</body>
</html>