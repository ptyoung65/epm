<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRIS-MON ëª¨ë°”ì¼ ì„¸ì…˜ í”Œë ˆì´ì–´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
            touch-action: manipulation;
        }

        .player-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .player-header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .session-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .session-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #667eea;
        }

        .session-details {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .player-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .control-btn:hover, .control-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .play-btn {
            background: #667eea !important;
            font-size: 1rem;
            padding: 0.75rem 1rem;
        }

        .viewport {
            flex: 1;
            position: relative;
            background: #f9fafb;
            overflow: hidden;
        }

        .mobile-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 375px;
            height: 667px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border: 8px solid #333;
        }

        @media (max-width: 400px) {
            .mobile-screen {
                width: 100vw;
                height: 100%;
                border-radius: 0;
                border: none;
                top: 0;
                left: 0;
                transform: none;
                position: static;
            }
        }

        .screen-content {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem;
            color: white;
        }

        .touch-indicator {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid #667eea;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.2);
            pointer-events: none;
            z-index: 50;
            transform: translate(-50%, -50%);
            animation: touchPulse 0.5s ease-out;
        }

        @keyframes touchPulse {
            0% { 
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0;
            }
        }

        .swipe-indicator {
            position: absolute;
            width: 60px;
            height: 4px;
            background: #667eea;
            border-radius: 2px;
            pointer-events: none;
            z-index: 50;
            animation: swipeMove 0.8s ease-out;
        }

        @keyframes swipeMove {
            0% { 
                opacity: 1;
                transform: scale(0.5);
            }
            50% {
                opacity: 0.8;
                transform: scale(1);
            }
            100% { 
                opacity: 0;
                transform: scale(1.2);
            }
        }

        .gesture-indicator {
            position: absolute;
            font-size: 2rem;
            pointer-events: none;
            z-index: 50;
            transform: translate(-50%, -50%);
            animation: gestureShow 1s ease-out;
        }

        @keyframes gestureShow {
            0% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.5);
            }
        }

        .timeline-container {
            background: rgba(0, 0, 0, 0.8);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .timeline-progress {
            height: 100%;
            background: #667eea;
            border-radius: 2px;
            transition: width 0.1s ease;
        }

        .timeline-handle {
            position: absolute;
            top: -6px;
            width: 16px;
            height: 16px;
            background: #667eea;
            border-radius: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .timeline-handle:hover {
            transform: translateX(-50%) scale(1.2);
        }

        .time-display {
            font-size: 0.8rem;
            color: #9ca3af;
            min-width: 80px;
            text-align: center;
        }

        .speed-control {
            display: flex;
            gap: 0.25rem;
        }

        .speed-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .speed-btn.active {
            background: #667eea;
        }

        .event-log {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 250px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 0.75rem;
            overflow-y: auto;
            font-size: 0.7rem;
            color: #9ca3af;
            z-index: 60;
            display: none;
        }

        @media (max-width: 768px) {
            .event-log {
                display: none !important;
            }
        }

        .event-log.visible {
            display: block;
        }

        .log-entry {
            margin-bottom: 0.25rem;
            padding: 0.25rem;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
        }

        .log-entry.active {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ef4444;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            text-align: center;
        }

        .mobile-elements {
            display: grid;
            gap: 0.75rem;
            grid-template-columns: 1fr;
            margin-top: 1rem;
        }

        .mobile-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            backdrop-filter: blur(10px);
        }

        .mobile-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 0.5rem;
        }

        .mobile-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .touch-button {
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .swipe-demo-area {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }

        .debug-info {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            color: #9ca3af;
            z-index: 60;
            display: none;
        }

        .debug-info.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <!-- í—¤ë” -->
        <div class="player-header">
            <div class="session-info">
                <div class="session-title" id="sessionTitle">ëª¨ë°”ì¼ ì„¸ì…˜ ë¡œë”© ì¤‘...</div>
                <div class="session-details" id="sessionDetails">ì„¸ì…˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>
            </div>
            
            <div class="player-controls">
                <button class="control-btn" onclick="toggleEventLog()">
                    ğŸ“‹ ë¡œê·¸
                </button>
                <button class="control-btn" onclick="toggleDebug()">
                    ğŸ› ë””ë²„ê·¸
                </button>
                <button class="control-btn" onclick="resetPlayer()">
                    ğŸ”„ ì´ˆê¸°í™”
                </button>
                <button class="play-btn" id="playBtn" onclick="togglePlayback()">
                    â–¶ï¸ ì¬ìƒ
                </button>
            </div>
        </div>

        <!-- ë·°í¬íŠ¸ -->
        <div class="viewport">
            <div class="mobile-screen">
                <div class="screen-content" id="screenContent">
                    <h2 style="margin-bottom: 1rem; text-align: center;">ğŸ“± ëª¨ë°”ì¼ í…ŒìŠ¤íŠ¸ ì•±</h2>
                    
                    <div class="mobile-elements">
                        <div class="mobile-card">
                            <h4 style="margin-bottom: 0.5rem;">ì‚¬ìš©ì ì •ë³´</h4>
                            <input type="text" class="mobile-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" id="replayNameInput">
                            <input type="email" class="mobile-input" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" id="replayEmailInput">
                        </div>

                        <div class="mobile-card">
                            <h4 style="margin-bottom: 0.5rem;">ì•¡ì…˜ ë²„íŠ¼</h4>
                            <button class="touch-button" id="replayPrimaryBtn">
                                ì£¼ìš” ì•¡ì…˜ ë²„íŠ¼
                            </button>
                            <button class="touch-button" id="replaySecondaryBtn" style="background: rgba(239, 68, 68, 0.6);">
                                ë³´ì¡° ì•¡ì…˜ ë²„íŠ¼
                            </button>
                        </div>

                        <div class="mobile-card">
                            <h4 style="margin-bottom: 0.5rem;">ì„ íƒ ì˜µì…˜</h4>
                            <select class="mobile-input" id="replayCategorySelect">
                                <option>ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                                <option>ê¸°ìˆ </option>
                                <option>ë””ìì¸</option>
                                <option>ë§ˆì¼€íŒ…</option>
                            </select>
                        </div>

                        <div class="mobile-card">
                            <div class="swipe-demo-area" id="replaySwipeArea">
                                â† ìŠ¤ì™€ì´í”„ ë°ëª¨ ì˜ì—­ â†’<br>
                                <small>í„°ì¹˜ì™€ ì œìŠ¤ì²˜ë¥¼ ì¬í˜„í•©ë‹ˆë‹¤</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-spinner"></div>
                <p>ëª¨ë°”ì¼ ì„¸ì…˜ì„ ë¡œë”©í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
        </div>

        <!-- íƒ€ì„ë¼ì¸ ì»¨íŠ¸ë¡¤ -->
        <div class="timeline-container">
            <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
            
            <div class="timeline" id="timeline">
                <div class="timeline-progress" id="timelineProgress"></div>
                <div class="timeline-handle" id="timelineHandle"></div>
            </div>
            
            <div class="speed-control">
                <button class="speed-btn" onclick="setPlaybackSpeed(0.5)">0.5x</button>
                <button class="speed-btn active" onclick="setPlaybackSpeed(1)">1x</button>
                <button class="speed-btn" onclick="setPlaybackSpeed(2)">2x</button>
                <button class="speed-btn" onclick="setPlaybackSpeed(4)">4x</button>
            </div>
        </div>
    </div>

    <!-- ì´ë²¤íŠ¸ ë¡œê·¸ -->
    <div class="event-log" id="eventLog">
        <h4 style="margin-bottom: 0.5rem; color: #667eea;">ì´ë²¤íŠ¸ ë¡œê·¸</h4>
        <div id="eventLogContent">ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <!-- ë””ë²„ê·¸ ì •ë³´ -->
    <div class="debug-info" id="debugInfo">
        <div>í˜„ì¬ ì´ë²¤íŠ¸: <span id="currentEventIndex">0</span> / <span id="totalEvents">0</span></div>
        <div>ì¬ìƒ ì†ë„: <span id="currentSpeed">1x</span></div>
        <div>ì„¸ì…˜ ì‹œê°„: <span id="sessionDuration">0s</span></div>
    </div>

    <script>
        // ê¸€ë¡œë²Œ ë³€ìˆ˜
        let currentSession = null;
        let sessionEvents = [];
        let isPlaying = false;
        let currentEventIndex = 0;
        let playbackSpeed = 1;
        let sessionStartTime = null;
        let playbackStartTime = null;
        let playbackTimer = null;
        let sessionDuration = 0;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            
            if (sessionId) {
                loadSession(sessionId);
            } else {
                showError('ì„¸ì…˜ IDê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
            
            setupTimelineControls();
        });

        // ì„¸ì…˜ ë°ì´í„° ë¡œë“œ
        async function loadSession(sessionId) {
            try {
                showLoading(true);
                
                const response = await fetch(`/api/session-replay/session/${sessionId}`);
                const data = await response.json();
                
                if (!data.success || !data.session) {
                    throw new Error('ì„¸ì…˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                currentSession = data.session;
                sessionEvents = data.session.events || [];
                sessionDuration = currentSession.duration || 0;
                
                // UI ì—…ë°ì´íŠ¸
                updateSessionInfo();
                updateDebugInfo();
                
                console.log('ëª¨ë°”ì¼ ì„¸ì…˜ ë¡œë“œ ì™„ë£Œ:', sessionId, sessionEvents.length, 'ê°œ ì´ë²¤íŠ¸');
                
                showLoading(false);
                
            } catch (error) {
                console.error('ì„¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('ì„¸ì…˜ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì„¸ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSessionInfo() {
            document.getElementById('sessionTitle').textContent = 
                `ëª¨ë°”ì¼ ì„¸ì…˜ ${currentSession.id.substring(0, 8)}...`;
            
            document.getElementById('sessionDetails').textContent = 
                `${sessionEvents.length}ê°œ ì´ë²¤íŠ¸ | ${formatDuration(sessionDuration)} | ${new Date(currentSession.startTime).toLocaleString()}`;
            
            // ì´ë²¤íŠ¸ ë¡œê·¸ ì—…ë°ì´íŠ¸
            updateEventLog();
        }

        // ì¬ìƒ/ì¼ì‹œì •ì§€ í† ê¸€
        function togglePlayback() {
            if (isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        }

        // ì¬ìƒ ì‹œì‘
        function startPlayback() {
            if (sessionEvents.length === 0) {
                alert('ì¬ìƒí•  ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            isPlaying = true;
            playbackStartTime = Date.now();
            
            // ì²« ë²ˆì§¸ ì´ë²¤íŠ¸ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘ ì‹œê°„ ì¡°ì •
            if (sessionEvents.length > 0) {
                const firstEventTime = sessionEvents[0].timestamp || 0;
                if (firstEventTime > 5000) { // 5ì´ˆ ì´ìƒ ì§€ì—°ëœ ê²½ìš° ì¡°ì •
                    sessionStartTime = firstEventTime;
                } else {
                    sessionStartTime = 0;
                }
            }
            
            playbackTimer = setInterval(processPlayback, 50); // 20fps
            
            document.getElementById('playBtn').textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
            document.getElementById('playBtn').style.background = '#ef4444';
            
            console.log('ëª¨ë°”ì¼ ì„¸ì…˜ ì¬ìƒ ì‹œì‘');
        }

        // ì¬ìƒ ì¼ì‹œì •ì§€
        function pausePlayback() {
            isPlaying = false;
            
            if (playbackTimer) {
                clearInterval(playbackTimer);
                playbackTimer = null;
            }
            
            document.getElementById('playBtn').textContent = 'â–¶ï¸ ì¬ìƒ';
            document.getElementById('playBtn').style.background = '#667eea';
        }

        // ì¬ìƒ ì²˜ë¦¬
        function processPlayback() {
            if (!isPlaying || currentEventIndex >= sessionEvents.length) {
                if (currentEventIndex >= sessionEvents.length) {
                    // ì¬ìƒ ì™„ë£Œ
                    pausePlayback();
                    console.log('ëª¨ë°”ì¼ ì„¸ì…˜ ì¬ìƒ ì™„ë£Œ');
                }
                return;
            }
            
            const elapsed = (Date.now() - playbackStartTime) * playbackSpeed;
            const targetTime = sessionStartTime + elapsed;
            
            // í˜„ì¬ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ì´ë²¤íŠ¸ë“¤ ì²˜ë¦¬
            while (currentEventIndex < sessionEvents.length) {
                const event = sessionEvents[currentEventIndex];
                const eventTime = event.timestamp || 0;
                
                if (eventTime <= targetTime) {
                    processEvent(event, currentEventIndex);
                    currentEventIndex++;
                } else {
                    break;
                }
            }
            
            // UI ì—…ë°ì´íŠ¸
            updateTimeline(elapsed / sessionDuration * 100);
            updateTimeDisplay(elapsed);
            updateDebugInfo();
        }

        // ì´ë²¤íŠ¸ ì²˜ë¦¬
        function processEvent(event, index) {
            try {
                switch (event.type) {
                    case 'touchstart':
                    case 'touchend':
                        handleTouchEvent(event);
                        break;
                        
                    case 'touchmove':
                        // í„°ì¹˜ ì´ë™ì€ ë„ˆë¬´ ë§ìœ¼ë¯€ë¡œ ì¼ë¶€ë§Œ ì²˜ë¦¬
                        if (index % 3 === 0) {
                            handleTouchEvent(event);
                        }
                        break;
                        
                    case 'swipe':
                        handleSwipeEvent(event);
                        break;
                        
                    case 'gesturestart':
                    case 'gestureend':
                        handleGestureEvent(event);
                        break;
                        
                    case 'click':
                        handleClickEvent(event);
                        break;
                        
                    case 'input':
                        handleInputEvent(event);
                        break;
                        
                    case 'focus':
                    case 'blur':
                        handleFocusEvent(event);
                        break;
                        
                    default:
                        console.log('ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸ íƒ€ì…:', event.type);
                }
                
                // ì´ë²¤íŠ¸ ë¡œê·¸ ì—…ë°ì´íŠ¸
                highlightEventInLog(index);
                
            } catch (error) {
                console.error('ì´ë²¤íŠ¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error, event);
            }
        }

        // í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleTouchEvent(event) {
            if (event.touches && event.touches.length > 0) {
                const touch = event.touches[0];
                showTouchIndicator(touch.x, touch.y);
            }
        }

        // ìŠ¤ì™€ì´í”„ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleSwipeEvent(event) {
            if (event.touches && event.touches.length > 0) {
                const touch = event.touches[0];
                showSwipeIndicator(touch.x, touch.y, event.direction);
                showGestureIndicator(touch.x, touch.y, event.direction);
            }
        }

        // ì œìŠ¤ì²˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleGestureEvent(event) {
            if (event.target) {
                const rect = getElementPosition(event.target);
                if (rect) {
                    showGestureIndicator(rect.x + rect.width/2, rect.y + rect.height/2, 'gesture');
                }
            }
        }

        // í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleClickEvent(event) {
            if (event.x && event.y) {
                showTouchIndicator(event.x, event.y);
            }
            
            if (event.target) {
                highlightElement(event.target);
            }
        }

        // ì…ë ¥ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleInputEvent(event) {
            if (event.target && event.value) {
                const element = findElementByTarget(event.target);
                if (element) {
                    element.value = event.value;
                    highlightElement(event.target, 'input');
                }
            }
        }

        // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleFocusEvent(event) {
            if (event.target) {
                const element = findElementByTarget(event.target);
                if (element) {
                    if (event.type === 'focus') {
                        element.focus();
                        highlightElement(event.target, 'focus');
                    } else {
                        element.blur();
                    }
                }
            }
        }

        // í„°ì¹˜ ì¸ë””ì¼€ì´í„° í‘œì‹œ
        function showTouchIndicator(x, y) {
            const screen = document.querySelector('.mobile-screen');
            const screenRect = screen.getBoundingClientRect();
            
            // ëª¨ë°”ì¼ ìŠ¤í¬ë¦° ë‚´ ì¢Œí‘œë¡œ ë³€í™˜
            const screenX = x * (screenRect.width / 375);
            const screenY = y * (screenRect.height / 667);
            
            const indicator = document.createElement('div');
            indicator.className = 'touch-indicator';
            indicator.style.left = screenX + 'px';
            indicator.style.top = screenY + 'px';
            
            screen.appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 500);
        }

        // ìŠ¤ì™€ì´í”„ ì¸ë””ì¼€ì´í„° í‘œì‹œ
        function showSwipeIndicator(x, y, direction) {
            const screen = document.querySelector('.mobile-screen');
            const screenRect = screen.getBoundingClientRect();
            
            const screenX = x * (screenRect.width / 375);
            const screenY = y * (screenRect.height / 667);
            
            const indicator = document.createElement('div');
            indicator.className = 'swipe-indicator';
            indicator.style.left = screenX + 'px';
            indicator.style.top = screenY + 'px';
            
            // ë°©í–¥ì— ë”°ë¼ íšŒì „
            const rotations = { 'right': 0, 'down': 90, 'left': 180, 'up': 270 };
            const rotation = rotations[direction] || 0;
            indicator.style.transform = `rotate(${rotation}deg)`;
            
            screen.appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 800);
        }

        // ì œìŠ¤ì²˜ ì¸ë””ì¼€ì´í„° í‘œì‹œ
        function showGestureIndicator(x, y, type) {
            const screen = document.querySelector('.mobile-screen');
            const screenRect = screen.getBoundingClientRect();
            
            const screenX = x * (screenRect.width / 375);
            const screenY = y * (screenRect.height / 667);
            
            const indicator = document.createElement('div');
            indicator.className = 'gesture-indicator';
            indicator.style.left = screenX + 'px';
            indicator.style.top = screenY + 'px';
            
            const symbols = {
                'left': 'â¬…ï¸',
                'right': 'â¡ï¸',
                'up': 'â¬†ï¸',
                'down': 'â¬‡ï¸',
                'gesture': 'ğŸ¤',
                'pinch': 'ğŸ¤',
                'zoom': 'ğŸ”'
            };
            
            indicator.textContent = symbols[type] || 'ğŸ‘†';
            
            screen.appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 1000);
        }

        // ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸
        function highlightElement(targetInfo, type = 'click') {
            const element = findElementByTarget(targetInfo);
            if (element) {
                const colors = {
                    'click': 'rgba(102, 126, 234, 0.5)',
                    'input': 'rgba(16, 185, 129, 0.5)',
                    'focus': 'rgba(245, 158, 11, 0.5)'
                };
                
                const originalBackground = element.style.backgroundColor;
                element.style.backgroundColor = colors[type] || colors['click'];
                element.style.transition = 'background-color 0.3s ease';
                
                setTimeout(() => {
                    element.style.backgroundColor = originalBackground;
                    element.style.transition = '';
                }, 1000);
            }
        }

        // íƒ€ê²Ÿ ì •ë³´ë¡œ ìš”ì†Œ ì°¾ê¸°
        function findElementByTarget(targetInfo) {
            if (!targetInfo) return null;
            
            // IDë¡œ ì°¾ê¸°
            if (targetInfo.id) {
                const byId = document.getElementById(targetInfo.id.replace('Input', 'ReplayInput').replace('Btn', 'ReplayBtn').replace('Select', 'ReplaySelect'));
                if (byId) return byId;
            }
            
            // íƒœê·¸ ì´ë¦„ê³¼ í´ë˜ìŠ¤ë¡œ ì°¾ê¸°
            const selector = targetInfo.tagName + 
                (targetInfo.className ? '.' + targetInfo.className.split(' ')[0] : '');
            
            const elements = document.querySelectorAll(selector);
            if (elements.length > 0) {
                return elements[0];
            }
            
            return null;
        }

        // ìš”ì†Œ ìœ„ì¹˜ ê³„ì‚°
        function getElementPosition(targetInfo) {
            const element = findElementByTarget(targetInfo);
            if (element) {
                const rect = element.getBoundingClientRect();
                const screen = document.querySelector('.mobile-screen').getBoundingClientRect();
                
                return {
                    x: rect.left - screen.left,
                    y: rect.top - screen.top,
                    width: rect.width,
                    height: rect.height
                };
            }
            return null;
        }

        // íƒ€ì„ë¼ì¸ ì»¨íŠ¸ë¡¤ ì„¤ì •
        function setupTimelineControls() {
            const timeline = document.getElementById('timeline');
            const handle = document.getElementById('timelineHandle');
            
            let isDragging = false;
            
            timeline.addEventListener('click', function(e) {
                if (sessionDuration > 0) {
                    const rect = timeline.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    seekToPercent(percent);
                }
            });
            
            handle.addEventListener('mousedown', function(e) {
                isDragging = true;
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isDragging && sessionDuration > 0) {
                    const rect = timeline.getBoundingClientRect();
                    let percent = (e.clientX - rect.left) / rect.width;
                    percent = Math.max(0, Math.min(1, percent));
                    seekToPercent(percent);
                }
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
        }

        // íŠ¹ì • ìœ„ì¹˜ë¡œ ì‹œí¬
        function seekToPercent(percent) {
            const targetTime = sessionDuration * percent;
            const targetIndex = sessionEvents.findIndex(event => 
                (event.timestamp || 0) > targetTime + sessionStartTime
            );
            
            currentEventIndex = Math.max(0, targetIndex - 1);
            
            if (isPlaying) {
                playbackStartTime = Date.now() - (targetTime / playbackSpeed);
            }
            
            updateTimeline(percent * 100);
            updateTimeDisplay(targetTime);
            updateDebugInfo();
        }

        // ì¬ìƒ ì†ë„ ì„¤ì •
        function setPlaybackSpeed(speed) {
            playbackSpeed = speed;
            
            // ì¬ìƒ ì¤‘ì´ë©´ ì‹œì‘ ì‹œê°„ ì¡°ì •
            if (isPlaying) {
                const elapsed = (Date.now() - playbackStartTime) * playbackSpeed;
                playbackStartTime = Date.now() - (elapsed / speed);
            }
            
            // UI ì—…ë°ì´íŠ¸
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            updateDebugInfo();
        }

        // í”Œë ˆì´ì–´ ì´ˆê¸°í™”
        function resetPlayer() {
            pausePlayback();
            currentEventIndex = 0;
            updateTimeline(0);
            updateTimeDisplay(0);
            updateDebugInfo();
            
            // ìŠ¤í¬ë¦° ì´ˆê¸°í™”
            const inputs = document.querySelectorAll('.mobile-input');
            inputs.forEach(input => {
                input.value = '';
                input.style.backgroundColor = '';
            });
        }

        // ì´ë²¤íŠ¸ ë¡œê·¸ í† ê¸€
        function toggleEventLog() {
            const log = document.getElementById('eventLog');
            log.classList.toggle('visible');
        }

        // ë””ë²„ê·¸ ì •ë³´ í† ê¸€
        function toggleDebug() {
            const debug = document.getElementById('debugInfo');
            debug.classList.toggle('visible');
        }

        // ì´ë²¤íŠ¸ ë¡œê·¸ ì—…ë°ì´íŠ¸
        function updateEventLog() {
            const logContent = document.getElementById('eventLogContent');
            
            if (sessionEvents.length === 0) {
                logContent.innerHTML = 'ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }
            
            logContent.innerHTML = sessionEvents.slice(0, 50).map((event, index) => `
                <div class="log-entry" id="log-${index}">
                    <strong>${event.type}</strong> @ ${formatTime(event.timestamp || 0)}
                    ${event.target ? `<br><small>${event.target.tagName || ''} ${event.target.id || ''}</small>` : ''}
                </div>
            `).join('');
        }

        // ì´ë²¤íŠ¸ ë¡œê·¸ì—ì„œ í˜„ì¬ ì´ë²¤íŠ¸ í•˜ì´ë¼ì´íŠ¸
        function highlightEventInLog(index) {
            document.querySelectorAll('.log-entry').forEach(entry => {
                entry.classList.remove('active');
            });
            
            const currentLog = document.getElementById(`log-${index}`);
            if (currentLog) {
                currentLog.classList.add('active');
                currentLog.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // íƒ€ì„ë¼ì¸ ì—…ë°ì´íŠ¸
        function updateTimeline(percent) {
            document.getElementById('timelineProgress').style.width = percent + '%';
            document.getElementById('timelineHandle').style.left = percent + '%';
        }

        // ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateTimeDisplay(elapsed) {
            const current = formatTime(elapsed);
            const total = formatTime(sessionDuration);
            document.getElementById('timeDisplay').textContent = `${current} / ${total}`;
        }

        // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateDebugInfo() {
            document.getElementById('currentEventIndex').textContent = currentEventIndex;
            document.getElementById('totalEvents').textContent = sessionEvents.length;
            document.getElementById('currentSpeed').textContent = playbackSpeed + 'x';
            document.getElementById('sessionDuration').textContent = formatTime(sessionDuration);
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            if (seconds < 60) {
                return seconds + 'ì´ˆ';
            }
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}ë¶„ ${remainingSeconds}ì´ˆ`;
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            showLoading(false);
            const viewport = document.querySelector('.viewport');
            viewport.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', function(e) {
            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    togglePlayback();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    if (sessionDuration > 0) {
                        const newPercent = Math.max(0, (currentEventIndex / sessionEvents.length) - 0.05);
                        seekToPercent(newPercent);
                    }
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    if (sessionDuration > 0) {
                        const newPercent = Math.min(1, (currentEventIndex / sessionEvents.length) + 0.05);
                        seekToPercent(newPercent);
                    }
                    break;
                case 'KeyR':
                    e.preventDefault();
                    resetPlayer();
                    break;
            }
        });
    </script>
</body>
</html>