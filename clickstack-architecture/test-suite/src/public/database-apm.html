<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database APM - AIRIS-MON 데이터베이스 성능 모니터링</title>
    <script src="/components/common-layout.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 .icon {
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-label {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .neutral {
            color: #6b7280;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .panel-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .query-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .query-item {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .query-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .query-item.slow {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .query-item.optimized {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .query-sql {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #1f2937;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            overflow-x: auto;
        }

        .query-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6b7280;
        }

        .query-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .performance-chart {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            border-radius: 8px;
            position: relative;
        }

        .chart-placeholder {
            color: #9ca3af;
            font-size: 14px;
        }

        .connection-pool {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .connection {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .connection.active {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .connection.idle {
            background: #fbbf24;
        }

        .connection.blocked {
            background: #ef4444;
        }

        .connection.available {
            background: #e5e7eb;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .transaction-timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .timeline-marker {
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            margin-right: 15px;
            z-index: 2;
        }

        .timeline-content {
            flex: 1;
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
        }

        .timeline-line {
            position: absolute;
            left: 5px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
            z-index: 1;
        }

        .index-performance {
            display: grid;
            gap: 12px;
        }

        .index-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .index-item:hover {
            background: #f3f4f6;
        }

        .index-name {
            font-weight: 500;
            color: #374151;
        }

        .index-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }

        .index-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6b7280;
        }

        .progress-bar {
            width: 100px;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .alert-banner {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .alert-banner.show {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .query-explain {
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 6px;
            border: 1px solid #bfdbfe;
        }

        .explain-step {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .explain-icon {
            width: 24px;
            height: 24px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .lock-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .lock-item {
            text-align: center;
            padding: 15px;
            background: #fef3c7;
            border-radius: 6px;
            border: 1px solid #fde68a;
        }

        .lock-count {
            font-size: 24px;
            font-weight: bold;
            color: #f59e0b;
        }

        .lock-label {
            font-size: 12px;
            color: #92400e;
            margin-top: 5px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .floating-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .tooltip {
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1001;
        }

        .tooltip.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="airis-content-wrapper">
    <div class="container">
        <!-- Alert Banner -->
        <div id="alertBanner" class="alert-banner">
            <span>⚠️ <span id="alertMessage">슬로우 쿼리 감지: 5초 이상 실행 중인 쿼리가 3개 있습니다</span></span>
            <button class="btn btn-secondary" onclick="dismissAlert()">확인</button>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>
                <span class="icon">🗄️</span>
                Database APM
            </h1>
            <p class="subtitle">실시간 데이터베이스 성능 모니터링 및 분석 | PostgreSQL / MySQL / MongoDB 지원</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">활성 연결</div>
                <div class="stat-value" id="activeConnections">47</div>
                <div class="stat-change positive">
                    <span>↑</span> 12% vs 1시간 전
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">평균 쿼리 시간</div>
                <div class="stat-value" id="avgQueryTime">124<span style="font-size: 16px;">ms</span></div>
                <div class="stat-change positive">
                    <span>↓</span> 8% 개선
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">슬로우 쿼리</div>
                <div class="stat-value negative" id="slowQueries">8</div>
                <div class="stat-change negative">
                    <span>↑</span> 3개 증가
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">트랜잭션/초</div>
                <div class="stat-value" id="tps">2,847</div>
                <div class="stat-change neutral">
                    <span>→</span> 변동 없음
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">캐시 히트율</div>
                <div class="stat-value" id="cacheHit">94<span style="font-size: 16px;">%</span></div>
                <div class="stat-change positive">
                    <span>↑</span> 2% 향상
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">데드락</div>
                <div class="stat-value" id="deadlocks">0</div>
                <div class="stat-change positive">
                    <span>✓</span> 정상
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Real-time Query Monitor -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">🔍 실시간 쿼리 모니터</h3>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="pauseMonitoring()">⏸️ 일시정지</button>
                        <button class="btn btn-primary" onclick="filterSlowQueries()">🐌 슬로우만</button>
                    </div>
                </div>
                <div class="query-list" id="queryList">
                    <!-- Queries will be inserted here -->
                </div>
            </div>

            <!-- Connection Pool Status -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">🔗 연결 풀 상태</h3>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="refreshPools()">🔄 새로고침</button>
                    </div>
                </div>
                <div class="connection-pool" id="connectionPool">
                    <!-- Connection blocks will be inserted here -->
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #10b981;"></div>
                        <span>활성 (Active)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fbbf24;"></div>
                        <span>대기 (Idle)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ef4444;"></div>
                        <span>차단 (Blocked)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e5e7eb;"></div>
                        <span>사용가능 (Available)</span>
                    </div>
                </div>
            </div>

            <!-- Query Performance Chart -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">📊 쿼리 성능 추이</h3>
                    <div class="panel-actions">
                        <select class="btn btn-secondary" onchange="changeTimeRange(this.value)">
                            <option value="1h">1시간</option>
                            <option value="6h">6시간</option>
                            <option value="24h">24시간</option>
                            <option value="7d">7일</option>
                        </select>
                    </div>
                </div>
                <div class="performance-chart">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <!-- Transaction Timeline -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">⏱️ 트랜잭션 타임라인</h3>
                    <div class="panel-actions">
                        <button class="btn btn-primary" onclick="analyzeTransaction()">🔍 분석</button>
                    </div>
                </div>
                <div class="transaction-timeline">
                    <div class="timeline-line"></div>
                    <div id="transactionTimeline">
                        <!-- Timeline items will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Index Performance -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">📈 인덱스 성능 분석</h3>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="optimizeIndexes()">⚡ 최적화</button>
                    </div>
                </div>
                <div class="index-performance" id="indexPerformance">
                    <!-- Index items will be inserted here -->
                </div>
            </div>

            <!-- Lock Analysis -->
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">🔒 락 분석</h3>
                    <div class="panel-actions">
                        <button class="btn btn-primary" onclick="analyzeLocks()">상세 분석</button>
                    </div>
                </div>
                <div class="lock-analysis" id="lockAnalysis">
                    <div class="lock-item">
                        <div class="lock-count">0</div>
                        <div class="lock-label">행 락</div>
                    </div>
                    <div class="lock-item">
                        <div class="lock-count">0</div>
                        <div class="lock-label">테이블 락</div>
                    </div>
                    <div class="lock-item">
                        <div class="lock-count">0</div>
                        <div class="lock-label">대기 중</div>
                    </div>
                    <div class="lock-item">
                        <div class="lock-count">0</div>
                        <div class="lock-label">데드락</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Query Execution Plan -->
        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title">🎯 쿼리 실행 계획</h3>
                <div class="panel-actions">
                    <button class="btn btn-secondary" onclick="exportPlan()">📥 내보내기</button>
                    <button class="btn btn-primary" onclick="analyzePlan()">🔍 분석</button>
                </div>
            </div>
            <div class="query-explain" id="queryExplain">
                <div class="explain-step">
                    <div class="explain-icon">1</div>
                    <span>Seq Scan on users (cost=0.00..458.00 rows=10000)</span>
                </div>
                <div class="explain-step">
                    <div class="explain-icon">2</div>
                    <span>Hash Join (cost=458.00..1234.50 rows=500)</span>
                </div>
                <div class="explain-step">
                    <div class="explain-icon">3</div>
                    <span>Index Scan on orders (cost=0.42..8.44 rows=1)</span>
                </div>
            </div>
        </div>

        <!-- Floating Controls -->
        <div class="floating-controls">
            <button class="fab" onclick="startRecording()" title="녹화 시작">
                ⏺️
            </button>
            <button class="fab" onclick="openSettings()" title="설정">
                ⚙️
            </button>
            <button class="fab" onclick="exportReport()" title="리포트 생성">
                📊
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Sample query data
        const sampleQueries = [
            {
                sql: "SELECT u.id, u.name, COUNT(o.id) FROM users u LEFT JOIN orders o ON u.id = o.user_id GROUP BY u.id",
                time: 3420,
                rows: 1247,
                database: "production",
                user: "app_user",
                status: "slow"
            },
            {
                sql: "UPDATE inventory SET quantity = quantity - 1 WHERE product_id = $1",
                time: 45,
                rows: 1,
                database: "production",
                user: "app_user",
                status: "optimized"
            },
            {
                sql: "SELECT * FROM products WHERE category_id IN (SELECT id FROM categories WHERE active = true)",
                time: 892,
                rows: 3421,
                database: "production",
                user: "analytics",
                status: "normal"
            },
            {
                sql: "INSERT INTO user_sessions (user_id, token, created_at) VALUES ($1, $2, NOW())",
                time: 12,
                rows: 1,
                database: "production",
                user: "app_user",
                status: "optimized"
            },
            {
                sql: "DELETE FROM expired_tokens WHERE created_at < NOW() - INTERVAL '7 days'",
                time: 5643,
                rows: 15234,
                database: "production",
                user: "maintenance",
                status: "slow"
            }
        ];

        // Initialize query list
        function initializeQueries() {
            const queryList = document.getElementById('queryList');
            queryList.innerHTML = '';
            
            sampleQueries.forEach((query, index) => {
                const queryItem = document.createElement('div');
                queryItem.className = `query-item ${query.status}`;
                queryItem.innerHTML = `
                    <div class="query-sql">${query.sql}</div>
                    <div class="query-meta">
                        <span>⏱️ ${query.time}ms</span>
                        <span>📊 ${query.rows.toLocaleString()} rows</span>
                        <span>🗄️ ${query.database}</span>
                        <span>👤 ${query.user}</span>
                    </div>
                `;
                queryList.appendChild(queryItem);
            });
        }

        // Initialize connection pool
        function initializeConnectionPool() {
            const pool = document.getElementById('connectionPool');
            pool.innerHTML = '';
            
            const states = ['active', 'idle', 'blocked', 'available'];
            const distribution = [15, 20, 2, 63]; // Percentage distribution
            
            for (let i = 0; i < 100; i++) {
                const conn = document.createElement('div');
                const random = Math.random() * 100;
                let cumulative = 0;
                let state = 'available';
                
                for (let j = 0; j < states.length; j++) {
                    cumulative += distribution[j];
                    if (random < cumulative) {
                        state = states[j];
                        break;
                    }
                }
                
                conn.className = `connection ${state}`;
                conn.title = `Connection #${i + 1} - ${state}`;
                pool.appendChild(conn);
            }
        }

        // Initialize transaction timeline
        function initializeTimeline() {
            const timeline = document.getElementById('transactionTimeline');
            const transactions = [
                { time: '10:23:45', action: 'BEGIN TRANSACTION', duration: '0ms' },
                { time: '10:23:45', action: 'SELECT FROM users', duration: '23ms' },
                { time: '10:23:45', action: 'UPDATE orders SET status', duration: '45ms' },
                { time: '10:23:45', action: 'INSERT INTO audit_log', duration: '12ms' },
                { time: '10:23:45', action: 'COMMIT', duration: '8ms' }
            ];
            
            timeline.innerHTML = transactions.map(t => `
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <strong>${t.time}</strong> - ${t.action} (${t.duration})
                    </div>
                </div>
            `).join('');
        }

        // Initialize index performance
        function initializeIndexPerformance() {
            const indexPerf = document.getElementById('indexPerformance');
            const indexes = [
                { name: 'users_email_idx', usage: 95, size: '124 MB' },
                { name: 'orders_user_id_idx', usage: 78, size: '256 MB' },
                { name: 'products_category_idx', usage: 45, size: '89 MB' },
                { name: 'sessions_token_idx', usage: 92, size: '512 MB' },
                { name: 'audit_created_at_idx', usage: 12, size: '1.2 GB' }
            ];
            
            indexPerf.innerHTML = indexes.map(idx => `
                <div class="index-item">
                    <div class="index-name">${idx.name}</div>
                    <div class="index-stats">
                        <div class="index-stat">
                            <span>사용률:</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${idx.usage}%"></div>
                            </div>
                            <span>${idx.usage}%</span>
                        </div>
                        <div class="index-stat">
                            <span>크기: ${idx.size}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Initialize performance chart
        function initializeChart() {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
                    datasets: [{
                        label: '평균 응답 시간 (ms)',
                        data: [120, 115, 125, 145, 180, 165, 130],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: '슬로우 쿼리',
                        data: [2, 1, 3, 5, 8, 6, 3],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Legacy function - now replaced by the updated version below

        // Add new query to the list
        function addNewQuery() {
            const queryList = document.getElementById('queryList');
            const queries = queryList.children;
            
            if (queries.length > 10) {
                queryList.removeChild(queries[queries.length - 1]);
            }
            
            const newQuery = sampleQueries[Math.floor(Math.random() * sampleQueries.length)];
            const queryItem = document.createElement('div');
            queryItem.className = `query-item ${newQuery.status}`;
            queryItem.innerHTML = `
                <div class="query-sql">${newQuery.sql}</div>
                <div class="query-meta">
                    <span>⏱️ ${newQuery.time}ms</span>
                    <span>📊 ${newQuery.rows.toLocaleString()} rows</span>
                    <span>🗄️ ${newQuery.database}</span>
                    <span>👤 ${newQuery.user}</span>
                </div>
            `;
            queryItem.style.animation = 'slideDown 0.3s ease';
            queryList.insertBefore(queryItem, queries[0]);
        }

        // Button actions
        let isMonitoringPaused = false;
        let realTimeInterval = null;
        
        function pauseMonitoring() {
            isMonitoringPaused = !isMonitoringPaused;
            const btn = event.target;
            
            if (isMonitoringPaused) {
                btn.innerHTML = '▶️ 재개';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                if (realTimeInterval) {
                    clearInterval(realTimeInterval);
                    realTimeInterval = null;
                }
                showNotification('실시간 모니터링이 일시정지되었습니다', 'info');
            } else {
                btn.innerHTML = '⏸️ 일시정지';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                startRealTimeUpdates();
                showNotification('실시간 모니터링이 재개되었습니다', 'success');
            }
        }

        function filterSlowQueries() {
            const modal = createModal('슬로우 쿼리 필터', `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">실행 시간 필터</label>
                    <select id="queryTimeFilter" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="all">모든 쿼리</option>
                        <option value="slow">슬로우 쿼리 (>1000ms)</option>
                        <option value="medium">중간 속도 (100-1000ms)</option>
                        <option value="fast">빠른 쿼리 (<100ms)</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">데이터베이스</label>
                    <select id="databaseFilter" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="all">모든 데이터베이스</option>
                        <option value="production">Production</option>
                        <option value="staging">Staging</option>
                        <option value="analytics">Analytics</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">사용자</label>
                    <select id="userFilter" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="all">모든 사용자</option>
                        <option value="app_user">app_user</option>
                        <option value="analytics">analytics</option>
                        <option value="maintenance">maintenance</option>
                    </select>
                </div>
            `, [
                { text: '필터 적용', primary: true, handler: applyQueryFilter },
                { text: '초기화', handler: resetQueryFilter }
            ]);
        }

        function applyQueryFilter() {
            const timeFilter = document.getElementById('queryTimeFilter').value;
            const dbFilter = document.getElementById('databaseFilter').value;
            const userFilter = document.getElementById('userFilter').value;
            
            const queries = document.querySelectorAll('.query-item');
            let visibleCount = 0;
            
            queries.forEach(query => {
                const timeText = query.querySelector('.query-meta span').textContent;
                const time = parseInt(timeText.match(/(\d+)ms/)[1]);
                const database = query.querySelector('.query-meta span:nth-child(3)').textContent.replace('🗄️ ', '');
                const user = query.querySelector('.query-meta span:nth-child(4)').textContent.replace('👤 ', '');
                
                let show = true;
                
                // Time filter
                if (timeFilter === 'slow' && time <= 1000) show = false;
                if (timeFilter === 'medium' && (time < 100 || time > 1000)) show = false;
                if (timeFilter === 'fast' && time >= 100) show = false;
                
                // Database filter
                if (dbFilter !== 'all' && database !== dbFilter) show = false;
                
                // User filter
                if (userFilter !== 'all' && user !== userFilter) show = false;
                
                query.style.display = show ? 'block' : 'none';
                if (show) visibleCount++;
            });
            
            closeModal();
            showNotification(`${visibleCount}개의 쿼리가 필터링되었습니다`, 'success');
        }

        function resetQueryFilter() {
            const queries = document.querySelectorAll('.query-item');
            queries.forEach(query => {
                query.style.display = 'block';
            });
            closeModal();
            showNotification('필터가 초기화되었습니다', 'info');
        }

        function refreshPools() {
            showNotification('연결 풀을 새로고침하고 있습니다...', 'info');
            
            // Animate refresh
            const pool = document.getElementById('connectionPool');
            pool.style.opacity = '0.5';
            
            setTimeout(() => {
                initializeConnectionPool();
                pool.style.opacity = '1';
                showNotification('연결 풀이 성공적으로 새로고침되었습니다', 'success');
            }, 1000);
        }

        function changeTimeRange(range) {
            showNotification(`시간 범위가 ${range}로 변경되었습니다`, 'info');
            
            // Simulate chart update
            const chart = document.getElementById('performanceChart');
            chart.style.opacity = '0.5';
            
            setTimeout(() => {
                chart.style.opacity = '1';
                // Here you would update the chart with new data
                console.log('Chart updated for range:', range);
            }, 500);
        }

        function analyzeTransaction() {
            const modal = createModal('트랜잭션 분석 결과', `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: #374151;">📊 트랜잭션 성능 분석</h4>
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <strong>평균 트랜잭션 시간:</strong><br>
                                <span style="font-size: 18px; color: #3b82f6;">88ms</span>
                            </div>
                            <div>
                                <strong>최대 트랜잭션 시간:</strong><br>
                                <span style="font-size: 18px; color: #ef4444;">245ms</span>
                            </div>
                        </div>
                    </div>
                    
                    <h5 style="margin-bottom: 10px;">🎯 최적화 제안:</h5>
                    <ul style="margin-left: 20px; color: #6b7280;">
                        <li>orders_user_id_idx 인덱스 사용률이 낮습니다</li>
                        <li>SELECT 문에서 불필요한 JOIN을 제거하세요</li>
                        <li>트랜잭션 범위를 최소화하세요</li>
                    </ul>
                    
                    <h5 style="margin-bottom: 10px; margin-top: 15px;">⚠️ 주의사항:</h5>
                    <ul style="margin-left: 20px; color: #6b7280;">
                        <li>2개의 트랜잭션이 100ms를 초과했습니다</li>
                        <li>데드락 위험이 있는 패턴이 감지되었습니다</li>
                    </ul>
                </div>
            `, [
                { text: 'CSV 내보내기', handler: () => exportData('transaction_analysis', 'csv') },
                { text: '닫기', primary: true, handler: closeModal }
            ]);
        }

        function optimizeIndexes() {
            const modal = createModal('인덱스 최적화 제안', `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #374151;">⚡ 인덱스 최적화 분석 결과</h4>
                    
                    <div style="background: #fef3c7; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                        <h5 style="margin-bottom: 10px;">🔍 사용률이 낮은 인덱스</h5>
                        <ul style="margin-left: 20px;">
                            <li><code>audit_created_at_idx</code> - 사용률: 12%</li>
                            <li><code>products_category_idx</code> - 사용률: 45%</li>
                        </ul>
                    </div>
                    
                    <div style="background: #dcfce7; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                        <h5 style="margin-bottom: 10px;">💡 최적화 제안</h5>
                        <ul style="margin-left: 20px;">
                            <li>복합 인덱스 생성: <code>(user_id, created_at)</code></li>
                            <li>Partial 인덱스 적용: active = true 조건</li>
                            <li>사용하지 않는 인덱스 제거 검토</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fef2f2; padding: 15px; border-radius: 6px; border-left: 4px solid #ef4444;">
                        <h5 style="margin-bottom: 10px;">⚠️ 주의사항</h5>
                        <ul style="margin-left: 20px;">
                            <li>인덱스 변경 전 백업을 권장합니다</li>
                            <li>피크 시간대 변경을 피하세요</li>
                            <li>변경 후 쿼리 성능을 모니터링하세요</li>
                        </ul>
                    </div>
                </div>
            `, [
                { text: 'SQL 스크립트 생성', handler: generateOptimizationSQL },
                { text: '제안서 내보내기', handler: () => exportData('index_optimization', 'pdf') },
                { text: '닫기', primary: true, handler: closeModal }
            ]);
        }

        function generateOptimizationSQL() {
            const sqlScript = `-- 인덱스 최적화 SQL 스크립트
-- 생성일: ${new Date().toLocaleString()}

-- 1. 복합 인덱스 생성
CREATE INDEX idx_orders_user_created ON orders(user_id, created_at);

-- 2. Partial 인덱스 생성  
CREATE INDEX idx_categories_active ON categories(id) WHERE active = true;

-- 3. 사용하지 않는 인덱스 제거 (주의: 사전 검토 필요)
-- DROP INDEX audit_created_at_idx; -- 사용률: 12%

-- 4. 인덱스 재구성 (PostgreSQL)
REINDEX TABLE orders;
REINDEX TABLE products;

-- 5. 통계 정보 업데이트
ANALYZE orders;
ANALYZE products;
ANALYZE categories;`;

            downloadFile('index_optimization.sql', sqlScript, 'text/plain');
            closeModal();
            showNotification('SQL 스크립트가 다운로드되었습니다', 'success');
        }

        function analyzeLocks() {
            const modal = createModal('락 상세 분석', `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #374151;">🔒 현재 락 상태 분석</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">0</div>
                            <div style="font-size: 12px; color: #6b7280;">활성 락</div>
                        </div>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">2</div>
                            <div style="font-size: 12px; color: #6b7280;">대기 중인 트랜잭션</div>
                        </div>
                    </div>
                    
                    <h5 style="margin-bottom: 10px;">📋 락 히스토리 (최근 1시간)</h5>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                        <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; font-family: monospace; font-size: 12px;">
                            14:23:45 - ROW EXCLUSIVE: orders (PID: 1234) - 45ms
                        </div>
                        <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; font-family: monospace; font-size: 12px;">
                            14:22:30 - SHARE: users (PID: 5678) - 12ms  
                        </div>
                        <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; font-family: monospace; font-size: 12px;">
                            14:21:15 - ACCESS EXCLUSIVE: products (PID: 9012) - 234ms
                        </div>
                    </div>
                    
                    <div style="background: #fef2f2; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #ef4444;">
                        <h5 style="margin-bottom: 10px;">⚠️ 락 경고</h5>
                        <ul style="margin-left: 20px; font-size: 14px;">
                            <li>orders 테이블에서 지속적인 락 경합이 발생하고 있습니다</li>
                            <li>인덱스 재구성 중 ACCESS EXCLUSIVE 락이 감지되었습니다</li>
                        </ul>
                    </div>
                </div>
            `, [
                { text: '락 모니터링 시작', handler: startLockMonitoring },
                { text: '락 리포트 내보내기', handler: () => exportData('lock_analysis', 'json') },
                { text: '닫기', primary: true, handler: closeModal }
            ]);
        }

        function startLockMonitoring() {
            closeModal();
            showNotification('실시간 락 모니터링이 시작되었습니다', 'info');
            
            // Update lock analysis panel with real-time data
            const lockAnalysis = document.getElementById('lockAnalysis');
            const interval = setInterval(() => {
                const lockItems = lockAnalysis.querySelectorAll('.lock-count');
                lockItems[0].textContent = Math.floor(Math.random() * 3); // 행 락
                lockItems[1].textContent = Math.floor(Math.random() * 2); // 테이블 락
                lockItems[2].textContent = Math.floor(Math.random() * 5); // 대기 중
                lockItems[3].textContent = Math.floor(Math.random() * 1); // 데드락
            }, 2000);
            
            // Stop monitoring after 30 seconds
            setTimeout(() => {
                clearInterval(interval);
                showNotification('락 모니터링이 종료되었습니다', 'info');
            }, 30000);
        }

        function dismissAlert() {
            const alertBanner = document.getElementById('alertBanner');
            alertBanner.classList.remove('show');
        }

        function startRecording() {
            const modal = createModal('쿼리 녹화 설정', `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #374151;">🎥 쿼리 녹화 설정</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">녹화 기간</label>
                        <select id="recordingDuration" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="300">5분</option>
                            <option value="900">15분</option>
                            <option value="1800">30분</option>
                            <option value="3600">1시간</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">녹화 조건</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="recordSlow" checked> 슬로우 쿼리
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="recordErrors"> 에러 쿼리
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="recordAll"> 모든 쿼리
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">저장 위치</label>
                        <input type="text" id="recordingPath" value="/tmp/db_recording_${Date.now()}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
            `, [
                { text: '녹화 시작', primary: true, handler: startQueryRecording },
                { text: '취소', handler: closeModal }
            ]);
        }

        function startQueryRecording() {
            const duration = document.getElementById('recordingDuration').value;
            const recordSlow = document.getElementById('recordSlow').checked;
            const recordErrors = document.getElementById('recordErrors').checked;
            const recordAll = document.getElementById('recordAll').checked;
            const path = document.getElementById('recordingPath').value;
            
            closeModal();
            showNotification(`쿼리 녹화가 시작되었습니다 (${duration}초간)`, 'success');
            
            // Simulate recording progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 2;
                if (progress <= 100) {
                    showNotification(`녹화 진행중... ${progress}%`, 'info');
                }
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    showNotification(`녹화 완료! 파일 저장됨: ${path}`, 'success');
                }
            }, parseInt(duration) * 10); // Scale down for demo
        }

        function openSettings() {
            const modal = createModal('Database APM 설정', `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #374151;">⚙️ 시스템 설정</h4>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="margin-bottom: 10px;">모니터링 설정</h5>
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" checked> 실시간 업데이트 활성화
                            </label>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px;">업데이트 주기 (초):</label>
                            <input type="range" min="1" max="10" value="3" style="width: 100%;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="margin-bottom: 10px;">알림 설정</h5>
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" checked> 슬로우 쿼리 알림
                            </label>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox"> 연결 풀 경고
                            </label>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox"> 데드락 감지
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="margin-bottom: 10px;">데이터 보관</h5>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px;">보관 기간:</label>
                            <select style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="7">7일</option>
                                <option value="30" selected>30일</option>
                                <option value="90">90일</option>
                                <option value="365">1년</option>
                            </select>
                        </div>
                    </div>
                </div>
            `, [
                { text: '설정 저장', primary: true, handler: saveSettings },
                { text: '취소', handler: closeModal }
            ]);
        }

        function saveSettings() {
            closeModal();
            showNotification('설정이 저장되었습니다', 'success');
        }

        function exportReport() {
            const modal = createModal('성능 리포트 생성', `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #374151;">📊 데이터베이스 성능 리포트</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">리포트 기간</label>
                        <select id="reportPeriod" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="today">오늘</option>
                            <option value="week" selected>지난 주</option>
                            <option value="month">지난 달</option>
                            <option value="quarter">지난 분기</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">포함할 섹션</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" checked> 성능 요약
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" checked> 슬로우 쿼리 분석
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" checked> 연결 풀 상태
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" checked> 인덱스 성능
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox"> 락 분석
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox"> 최적화 제안
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">출력 형식</label>
                        <select id="reportFormat" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="pdf">PDF</option>
                            <option value="html">HTML</option>
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                </div>
            `, [
                { text: '리포트 생성', primary: true, handler: generateReport },
                { text: '취소', handler: closeModal }
            ]);
        }

        function generateReport() {
            const period = document.getElementById('reportPeriod').value;
            const format = document.getElementById('reportFormat').value;
            
            closeModal();
            showNotification('리포트를 생성하고 있습니다...', 'info');
            
            setTimeout(() => {
                const reportData = {
                    period: period,
                    generated: new Date().toISOString(),
                    summary: {
                        totalQueries: 15234,
                        avgResponseTime: '124ms',
                        slowQueries: 8,
                        errorRate: '0.02%'
                    },
                    recommendations: [
                        '인덱스 최적화 권장',
                        '연결 풀 크기 조정',
                        '슬로우 쿼리 개선'
                    ]
                };
                
                downloadFile(`db_performance_report_${Date.now()}.${format}`, 
                           JSON.stringify(reportData, null, 2), 
                           'application/json');
                showNotification('리포트가 성공적으로 생성되었습니다', 'success');
            }, 2000);
        }

        function analyzePlan() {
            const modal = createModal('AI 쿼리 실행 계획 분석', `
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #374151;">🤖 AI 분석 결과</h4>
                    
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <h5 style="margin-bottom: 10px; color: #1e40af;">💡 최적화 제안</h5>
                        <ul style="margin-left: 20px; color: #374151;">
                            <li>Seq Scan 대신 Index Scan 사용을 권장합니다</li>
                            <li>Hash Join의 cost가 높습니다. 인덱스 추가를 고려하세요</li>
                            <li>WHERE 절에 인덱스 컬럼을 우선 배치하세요</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <h5 style="margin-bottom: 10px; color: #92400e;">⚡ 성능 예측</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>현재 예상 실행 시간: <strong>245ms</strong></div>
                            <div>최적화 후 예상 시간: <strong>89ms</strong></div>
                        </div>
                    </div>
                    
                    <div style="background: #dcfce7; padding: 15px; border-radius: 6px;">
                        <h5 style="margin-bottom: 10px; color: #166534;">🎯 권장 인덱스</h5>
                        <pre style="background: white; padding: 10px; border-radius: 4px; font-size: 12px; overflow-x: auto;">CREATE INDEX idx_users_orders_optimized 
ON users(id) 
INCLUDE (name, email) 
WHERE active = true;</pre>
                    </div>
                </div>
            `, [
                { text: 'SQL 생성', handler: generateOptimizedSQL },
                { text: '분석 저장', handler: () => exportData('query_analysis', 'json') },
                { text: '닫기', primary: true, handler: closeModal }
            ]);
        }

        function generateOptimizedSQL() {
            const optimizedSQL = `-- AI 분석 기반 최적화된 쿼리
-- 생성일: ${new Date().toLocaleString()}
-- 예상 성능 향상: 63%

-- 원본 쿼리 (245ms 예상)
/*
SELECT u.id, u.name, COUNT(o.id) 
FROM users u 
LEFT JOIN orders o ON u.id = o.user_id 
GROUP BY u.id
*/

-- 최적화된 쿼리 (89ms 예상)
SELECT u.id, u.name, 
       COALESCE(order_counts.order_count, 0) as order_count
FROM users u
LEFT JOIN (
    SELECT user_id, COUNT(*) as order_count
    FROM orders 
    WHERE created_at >= '2024-01-01'
    GROUP BY user_id
) order_counts ON u.id = order_counts.user_id
WHERE u.active = true;

-- 권장 인덱스
CREATE INDEX CONCURRENTLY idx_users_active_id 
ON users(active, id) 
WHERE active = true;

CREATE INDEX CONCURRENTLY idx_orders_user_created 
ON orders(user_id, created_at);`;

            downloadFile('optimized_query.sql', optimizedSQL, 'text/plain');
            closeModal();
            showNotification('최적화된 SQL이 다운로드되었습니다', 'success');
        }

        function exportPlan() {
            const executionPlan = {
                query: "SELECT u.id, u.name, COUNT(o.id) FROM users u LEFT JOIN orders o ON u.id = o.user_id GROUP BY u.id",
                plan: [
                    {
                        step: 1,
                        operation: "Seq Scan",
                        table: "users",
                        cost: "0.00..458.00",
                        rows: 10000,
                        time: "12.5ms"
                    },
                    {
                        step: 2,
                        operation: "Hash Join",
                        cost: "458.00..1234.50",
                        rows: 500,
                        time: "89.3ms"
                    },
                    {
                        step: 3,
                        operation: "Index Scan",
                        table: "orders",
                        cost: "0.42..8.44",
                        rows: 1,
                        time: "2.1ms"
                    }
                ],
                analysis: {
                    totalCost: 1234.50,
                    estimatedRows: 500,
                    actualTime: "245ms",
                    bufferHits: 1247,
                    bufferMisses: 23
                },
                recommendations: [
                    "Add index on users(active) for better filtering",
                    "Consider partitioning orders table by date",
                    "Update table statistics with ANALYZE"
                ]
            };
            
            downloadFile(`execution_plan_${Date.now()}.json`, 
                        JSON.stringify(executionPlan, null, 2), 
                        'application/json');
            showNotification('실행 계획이 JSON 형식으로 내보내졌습니다', 'success');
        }

        // Utility functions
        function createModal(title, content, buttons = []) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 25px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                transform: translateY(0);
                animation: slideIn 0.3s ease;
            `;

            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="color: #374151; font-size: 18px; font-weight: 600; margin: 0;">${title}</h3>
                    <button onclick="closeModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #6b7280; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">×</button>
                </div>
                <div>${content}</div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    ${buttons.map(btn => `
                        <button onclick="${btn.handler ? `(${btn.handler})()` : 'closeModal()'}" 
                                class="btn ${btn.primary ? 'btn-primary' : 'btn-secondary'}"
                                style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            ${btn.text}
                        </button>
                    `).join('')}
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Add CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideIn {
                    from { transform: translateY(-20px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            return modal;
        }

        function closeModal() {
            const modals = document.querySelectorAll('div[style*="position: fixed"]');
            modals.forEach(modal => modal.remove());
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10001;
                font-size: 14px;
                font-weight: 500;
                max-width: 400px;
                animation: slideInRight 0.3s ease;
            `;

            notification.textContent = message;
            document.body.appendChild(notification);

            // Add animation CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);

            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function downloadFile(filename, content, mimeType = 'text/plain') {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportData(type, format) {
            const data = {
                timestamp: new Date().toISOString(),
                type: type,
                format: format,
                data: getExportData(type)
            };

            const filename = `${type}_${Date.now()}.${format}`;
            const content = format === 'json' ? JSON.stringify(data, null, 2) : convertToCSV(data);
            const mimeType = format === 'json' ? 'application/json' : 'text/csv';

            downloadFile(filename, content, mimeType);
            showNotification(`${type} 데이터가 ${format.toUpperCase()} 형식으로 내보내졌습니다`, 'success');
        }

        function getExportData(type) {
            switch (type) {
                case 'transaction_analysis':
                    return {
                        averageTime: '88ms',
                        maxTime: '245ms',
                        recommendations: [
                            'orders_user_id_idx 인덱스 사용률이 낮습니다',
                            'SELECT 문에서 불필요한 JOIN을 제거하세요',
                            '트랜잭션 범위를 최소화하세요'
                        ],
                        warnings: [
                            '2개의 트랜잭션이 100ms를 초과했습니다',
                            '데드락 위험이 있는 패턴이 감지되었습니다'
                        ]
                    };
                case 'lock_analysis':
                    return {
                        activeLocks: 0,
                        waitingTransactions: 2,
                        lockHistory: [
                            '14:23:45 - ROW EXCLUSIVE: orders (PID: 1234) - 45ms',
                            '14:22:30 - SHARE: users (PID: 5678) - 12ms',
                            '14:21:15 - ACCESS EXCLUSIVE: products (PID: 9012) - 234ms'
                        ],
                        warnings: [
                            'orders 테이블에서 지속적인 락 경합이 발생하고 있습니다',
                            '인덱스 재구성 중 ACCESS EXCLUSIVE 락이 감지되었습니다'
                        ]
                    };
                case 'query_analysis':
                    return {
                        originalQuery: 'SELECT u.id, u.name, COUNT(o.id) FROM users u LEFT JOIN orders o ON u.id = o.user_id GROUP BY u.id',
                        currentExecutionTime: '245ms',
                        optimizedExecutionTime: '89ms',
                        performanceImprovement: '63%',
                        recommendations: [
                            'Seq Scan 대신 Index Scan 사용을 권장합니다',
                            'Hash Join의 cost가 높습니다. 인덱스 추가를 고려하세요',
                            'WHERE 절에 인덱스 컬럼을 우선 배치하세요'
                        ]
                    };
                default:
                    return { message: 'Unknown data type' };
            }
        }

        function convertToCSV(data) {
            const headers = Object.keys(data.data);
            const rows = [headers.join(',')];
            
            // Simple CSV conversion for demo
            headers.forEach(header => {
                const value = data.data[header];
                if (Array.isArray(value)) {
                    value.forEach((item, index) => {
                        if (!rows[index + 1]) rows[index + 1] = new Array(headers.length).fill('');
                        rows[index + 1][headers.indexOf(header)] = `"${item}"`;
                    });
                } else {
                    if (!rows[1]) rows[1] = new Array(headers.length).fill('');
                    rows[1][headers.indexOf(header)] = `"${value}"`;
                }
            });
            
            return rows.map(row => Array.isArray(row) ? row.join(',') : row).join('\n');
        }

        // Update the real-time updates function to use the global variable
        function startRealTimeUpdates() {
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
            }
            
            realTimeInterval = setInterval(() => {
                if (isMonitoringPaused) return;
                
                // Update active connections
                const activeConn = document.getElementById('activeConnections');
                activeConn.textContent = Math.floor(40 + Math.random() * 20);
                
                // Update average query time
                const avgTime = document.getElementById('avgQueryTime');
                avgTime.innerHTML = Math.floor(100 + Math.random() * 50) + '<span style="font-size: 16px;">ms</span>';
                
                // Update TPS
                const tps = document.getElementById('tps');
                tps.textContent = (2500 + Math.floor(Math.random() * 500)).toLocaleString();
                
                // Randomly add new query
                if (Math.random() > 0.7) {
                    addNewQuery();
                }
            }, 3000);
        }

        // Initialize everything on load
        window.addEventListener('load', () => {
            initializeQueries();
            initializeConnectionPool();
            initializeTimeline();
            initializeIndexPerformance();
            initializeChart();
            startRealTimeUpdates();
            
            // Show alert after 5 seconds
            setTimeout(() => {
                const alertBanner = document.getElementById('alertBanner');
                alertBanner.classList.add('show');
                setTimeout(() => {
                    alertBanner.classList.remove('show');
                }, 5000);
            }, 5000);
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        refreshPools();
                        break;
                    case 's':
                        e.preventDefault();
                        filterSlowQueries();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportReport();
                        break;
                }
            }
        });
    </script>
    </div>
</body>
</html>