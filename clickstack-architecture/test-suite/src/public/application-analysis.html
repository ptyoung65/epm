<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRIS-MON 시스템 아키텍처 분석</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/components/common-layout.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            list-style: none;
        }

        .nav-link {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: #667eea;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .page-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .page-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .stats-pills {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-pill {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-pill.programs {
            background: #d4edda;
            color: #155724;
        }

        .stat-pill.tables {
            background: #cce5ff;
            color: #004085;
        }

        .stat-pill.classes {
            background: #fff3cd;
            color: #856404;
        }

        .stat-pill.data {
            background: #f8d7da;
            color: #721c24;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .grid-full {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .grid-triple {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .network-container {
            position: relative;
            height: 500px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .diagram-container {
            position: relative;
            height: 600px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: auto;
            background: #f8f9fa;
        }

        .list-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .list-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .list-item-name {
            font-weight: 500;
            color: #333;
        }

        .list-item-type {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
        }

        .type-api {
            background: #28a745;
            color: white;
        }

        .type-service {
            background: #007bff;
            color: white;
        }

        .type-model {
            background: #ffc107;
            color: #333;
        }

        .type-util {
            background: #6c757d;
            color: white;
        }

        .type-master {
            background: #17a2b8;
            color: white;
        }

        .type-transaction {
            background: #dc3545;
            color: white;
        }

        .type-log {
            background: #6f42c1;
            color: white;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-fill.high {
            background: linear-gradient(90deg, #28a745, #20c997);
        }

        .progress-fill.medium {
            background: linear-gradient(90deg, #ffc107, #fd7e14);
        }

        .progress-fill.low {
            background: linear-gradient(90deg, #dc3545, #e83e8c);
        }

        .data-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .metric-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .grid, .grid-triple {
                grid-template-columns: 1fr;
            }
            
            .nav-menu {
                display: none;
            }
            
            .data-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* D3.js 네트워크 그래프 스타일 */
        .node {
            cursor: pointer;
        }

        .node circle {
            transition: all 0.3s ease;
        }

        .node:hover circle {
            stroke-width: 3px;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }

        .node text {
            font-size: 12px;
            font-weight: 500;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
        }

        /* CRUD 매트릭스 스타일 */
        .crud-matrix-container {
            width: 100%;
            overflow: auto;
            margin: 20px 0;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
        }

        .matrix-table-wrapper {
            min-width: 800px;
        }

        .crud-matrix {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            font-size: 13px;
        }

        .crud-matrix th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #5a6fd8;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .crud-matrix th.program-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: 1px solid #1e7e34;
            min-width: 200px;
            text-align: left;
            padding: 12px 16px;
            position: sticky;
            left: 0;
            z-index: 11;
        }

        .crud-matrix td.program-name {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px 16px;
            font-weight: 600;
            color: #495057;
            position: sticky;
            left: 0;
            z-index: 5;
            min-width: 200px;
        }

        .crud-matrix td.crud-cell {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center;
            min-width: 80px;
            background: white;
            transition: all 0.2s ease;
        }

        .crud-matrix td.crud-cell:hover {
            background: #e9ecef;
        }

        .crud-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin: 2px;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
        }

        .crud-badge.crud-c {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .crud-badge.crud-r {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }

        .crud-badge.crud-u {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }

        .crud-badge.crud-d {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .matrix-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .crud-cell-multiple {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
            align-items: center;
        }

        .crud-matrix tbody tr:nth-child(even) td.program-name {
            background: #e9ecef;
        }

        .crud-matrix tbody tr:hover td {
            background: #e3f2fd !important;
        }

        .crud-matrix tbody tr:hover td.program-name {
            background: #bbdefb !important;
        }
    </style>
</head>
<body>
    <div class="airis-content-wrapper">
        <div class="page-header">
            <h1 class="page-title">AIRIS-MON 시스템 아키텍처 분석</h1>
            <p class="page-subtitle">모듈 아키텍처, 데이터 저장소 관계, 의존성 구조 및 실시간 시스템 상태 분석</p>
            <div class="stats-pills">
                <div class="stat-pill programs">
                    <span>🧩</span> 모듈 <span id="programCount">10</span>개
                </div>
                <div class="stat-pill tables">
                    <span>💾</span> 데이터 저장소 <span id="tableCount">10</span>개
                </div>
                <div class="stat-pill classes">
                    <span>🏗️</span> 컴포넌트 <span id="classCount">25</span>개
                </div>
                <div class="stat-pill data">
                    <span>📊</span> 실시간 처리율 <span id="totalRecords">92%</span>
                </div>
            </div>
        </div>

        <!-- 프로그램-테이블 CRUD 매트릭스 -->
        <div class="grid-full">
            <div class="card">
                <h2 class="card-title">
                    <div class="card-icon" style="background: #28a745;">🔗</div>
                    프로그램-테이블 CRUD 매트릭스
                </h2>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label class="filter-label">프로그램 유형</label>
                        <select class="filter-select" id="programTypeFilter">
                            <option value="">전체</option>
                            <option value="main">메인</option>
                            <option value="module">모듈</option>
                            <option value="frontend">프론트엔드</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">데이터저장소 유형</label>
                        <select class="filter-select" id="tableTypeFilter">
                            <option value="">전체</option>
                            <option value="datastore">데이터저장소</option>
                            <option value="communication">통신</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">CRUD 필터</label>
                        <select class="filter-select" id="crudFilter">
                            <option value="">전체</option>
                            <option value="C">Create</option>
                            <option value="R">Read</option>
                            <option value="U">Update</option>
                            <option value="D">Delete</option>
                        </select>
                    </div>
                </div>
                <div class="crud-matrix-container">
                    <div class="matrix-table-wrapper">
                        <table class="crud-matrix" id="crudMatrix">
                            <thead>
                                <tr>
                                    <th class="program-header">프로그램 / 테이블</th>
                                    <!-- 테이블 헤더들이 동적으로 추가됩니다 -->
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 프로그램 행들이 동적으로 추가됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="matrix-legend">
                    <div class="legend-item">
                        <span class="crud-badge crud-c">C</span> Create (생성)
                    </div>
                    <div class="legend-item">
                        <span class="crud-badge crud-r">R</span> Read (조회)
                    </div>
                    <div class="legend-item">
                        <span class="crud-badge crud-u">U</span> Update (수정)
                    </div>
                    <div class="legend-item">
                        <span class="crud-badge crud-d">D</span> Delete (삭제)
                    </div>
                </div>
            </div>
        </div>

        <!-- 클래스 다이어그램 -->
        <div class="grid-full">
            <div class="card">
                <h2 class="card-title">
                    <div class="card-icon" style="background: #ffc107;">🏗️</div>
                    클래스 다이어그램
                </h2>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('overview')">전체 구조</button>
                    <button class="tab" onclick="switchTab('api')">API 레이어</button>
                    <button class="tab" onclick="switchTab('service')">서비스 레이어</button>
                    <button class="tab" onclick="switchTab('model')">모델 레이어</button>
                </div>
                <div class="tab-content active" id="overviewTab">
                    <div class="diagram-container" id="classDiagram"></div>
                </div>
                <div class="tab-content" id="apiTab">
                    <div class="diagram-container" id="apiDiagram"></div>
                </div>
                <div class="tab-content" id="serviceTab">
                    <div class="diagram-container" id="serviceDiagram"></div>
                </div>
                <div class="tab-content" id="modelTab">
                    <div class="diagram-container" id="modelDiagram"></div>
                </div>
            </div>
        </div>

        <!-- 프로그램 리스트, 테이블 리스트, 데이터 적재 현황 -->
        <div class="grid-triple">
            <div class="card">
                <h2 class="card-title">
                    <div class="card-icon" style="background: #6f42c1;">📱</div>
                    프로그램 리스트
                </h2>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label class="filter-label">필터</label>
                        <select class="filter-select" id="programFilter">
                            <option value="">전체</option>
                            <option value="api">API</option>
                            <option value="service">서비스</option>
                            <option value="model">모델</option>
                            <option value="util">유틸리티</option>
                        </select>
                    </div>
                </div>
                <div class="list-container" id="programList">
                    <!-- 프로그램 리스트가 여기에 로드됩니다 -->
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <div class="card-icon" style="background: #17a2b8;">🗄️</div>
                    테이블 리스트
                </h2>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label class="filter-label">필터</label>
                        <select class="filter-select" id="tableFilter">
                            <option value="">전체</option>
                            <option value="master">마스터</option>
                            <option value="transaction">트랜잭션</option>
                            <option value="log">로그</option>
                        </select>
                    </div>
                </div>
                <div class="list-container" id="tableList">
                    <!-- 테이블 리스트가 여기에 로드됩니다 -->
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <div class="card-icon" style="background: #dc3545;">📈</div>
                    데이터 적재 현황
                </h2>
                <div class="data-metrics">
                    <div class="metric-item">
                        <div class="metric-value" id="totalRows">1.2M</div>
                        <div class="metric-label">총 레코드</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="todayInserts">12.5K</div>
                        <div class="metric-label">오늘 추가</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="avgGrowth">+2.3%</div>
                        <div class="metric-label">일평균 증가율</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="dbSize">4.8GB</div>
                        <div class="metric-label">DB 사용량</div>
                    </div>
                </div>
                <div class="list-container" id="dataStatusList">
                    <!-- 테이블별 데이터 현황이 여기에 로드됩니다 -->
                </div>
            </div>
        </div>

    <script>
        // 관리자 설정 함수
        function openAdminSettings() {
            window.location.href = '/admin-settings.html';
        }

        // 탭 전환 함수
        function switchTab(tabName) {
            // 모든 탭과 컨텐츠 비활성화
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭과 컨텐츠 활성화
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // 해당 다이어그램 로드
            loadClassDiagram(tabName);
        }

        // 전역 변수
        let correlationData = null;
        let programData = null;
        let tableData = null;
        let dependencyChart = null;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 DOM 로드 완료, 초기화 시작...');
            
            try {
                // 차트 초기화는 스킵 (의존성 차트 요소가 없음)
                // initializeCharts();
                
                console.log('📊 분석 데이터 로드 시작...');
                loadAnalysisData();
                
                console.log('🔧 필터 설정 시작...');
                setupFilters();
                
                console.log('✅ 애플리케이션 분석 대시보드 로드 완료');
            } catch (error) {
                console.error('❌ 초기화 중 오류 발생:', error);
            }
        });

        // 차트 초기화
        function initializeCharts() {
            // 의존성 차트 초기화
            const ctx = document.getElementById('dependencyChart').getContext('2d');
            dependencyChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['API 레이어', '서비스 레이어', '모델 레이어', '유틸리티'],
                    datasets: [{
                        data: [35, 28, 25, 12],
                        backgroundColor: [
                            '#28a745',
                            '#007bff', 
                            '#ffc107',
                            '#6c757d'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // 분석 데이터 로드
        async function loadAnalysisData() {
            try {
                console.log('📊 상관도 데이터 로드 시작...');
                await loadCorrelationData();
                
                console.log('📋 프로그램 리스트 로드 시작...');
                await loadProgramList();
                
                console.log('🗄️ 테이블 리스트 로드 시작...');
                await loadTableList();
                
                console.log('📈 데이터 적재 현황 로드 시작...');
                await loadDataStatus();
                
                console.log('🏗️ 클래스 다이어그램 로드 시작...');
                await loadClassDiagram('overview');
                
                console.log('✅ 모든 분석 데이터 로드 완료');
            } catch (error) {
                console.error('❌ 분석 데이터 로드 실패:', error);
            }
        }

        // CRUD 매트릭스 데이터 로드 및 렌더링
        async function loadCorrelationData() {
            try {
                console.log('🔄 /api/analysis/correlation 호출 중...');
                const response = await fetch('/api/analysis/correlation');
                console.log('📡 API 응답 상태:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📦 응답 데이터:', data);
                
                if (data.success) {
                    correlationData = data.data;
                    console.log('✅ CRUD 매트릭스 데이터 파싱 완료:', {
                        programs: correlationData.programs?.length,
                        tables: correlationData.tables?.length,
                        matrix: Object.keys(correlationData.matrix || {}).length
                    });
                    renderCrudMatrix(correlationData);
                } else {
                    throw new Error('API 응답 success: false');
                }
            } catch (error) {
                console.error('❌ 상관도 데이터 로드 실패:', error);
                console.log('🔄 샘플 데이터로 대체 시도...');
                createSampleCrudMatrix();
            }
        }

        // 샘플 CRUD 매트릭스 생성
        function createSampleCrudMatrix() {
            const sampleData = {
                programs: [
                    { id: 'AIRISMonTestSuite', name: 'AIRIS-MON Test Suite', type: 'main' },
                    { id: 'DataSimulator', name: 'Data Simulator', type: 'module' },
                    { id: 'MetricsGenerator', name: 'Metrics Generator', type: 'module' },
                    { id: 'EventSimulator', name: 'Event Simulator', type: 'module' },
                    { id: 'SessionStorage', name: 'Session Storage', type: 'module' },
                    { id: 'NLPSearchTester', name: 'NLP Search Tester', type: 'module' },
                    { id: 'DashboardUI', name: 'Dashboard UI', type: 'frontend' },
                    { id: 'SessionReplayPlayer', name: 'Session Replay Player', type: 'frontend' },
                    { id: 'ApplicationAnalysis', name: 'Application Analysis', type: 'frontend' }
                ],
                tables: [
                    { id: 'kafka_events', name: 'Kafka Events', type: 'datastore' },
                    { id: 'clickhouse_metrics', name: 'ClickHouse Metrics', type: 'datastore' },
                    { id: 'redis_cache', name: 'Redis Cache', type: 'datastore' },
                    { id: 'session_data', name: 'Session Data', type: 'datastore' },
                    { id: 'nlp_queries', name: 'NLP Queries', type: 'datastore' },
                    { id: 'user_sessions', name: 'User Sessions', type: 'datastore' },
                    { id: 'system_logs', name: 'System Logs', type: 'datastore' },
                    { id: 'alert_history', name: 'Alert History', type: 'datastore' }
                ],
                matrix: {
                    'AIRISMonTestSuite': {
                        'kafka_events': ['R'],
                        'clickhouse_metrics': ['R'],
                        'session_data': ['C', 'R'],
                        'system_logs': ['C', 'R']
                    },
                    'DataSimulator': {
                        'kafka_events': ['C'],
                        'clickhouse_metrics': ['C'],
                        'redis_cache': ['C', 'R']
                    },
                    'MetricsGenerator': {
                        'clickhouse_metrics': ['C'],
                        'system_logs': ['C']
                    },
                    'EventSimulator': {
                        'kafka_events': ['C'],
                        'user_sessions': ['C']
                    },
                    'SessionStorage': {
                        'session_data': ['C', 'R', 'U', 'D'],
                        'user_sessions': ['R']
                    },
                    'NLPSearchTester': {
                        'nlp_queries': ['C', 'R'],
                        'clickhouse_metrics': ['R']
                    },
                    'DashboardUI': {
                        'clickhouse_metrics': ['R'],
                        'alert_history': ['R'],
                        'system_logs': ['R']
                    },
                    'SessionReplayPlayer': {
                        'session_data': ['R'],
                        'user_sessions': ['R']
                    },
                    'ApplicationAnalysis': {
                        'clickhouse_metrics': ['R'],
                        'system_logs': ['R']
                    }
                }
            };
            
            renderCrudMatrix(sampleData);
        }

        // CRUD 매트릭스 테이블 렌더링
        function renderCrudMatrix(data) {
            console.log('🔧 CRUD 매트릭스 렌더링 시작...', data);
            
            const matrix = document.getElementById('crudMatrix');
            if (!matrix) {
                console.error('❌ crudMatrix 요소를 찾을 수 없습니다!');
                return;
            }
            
            const thead = matrix.querySelector('thead tr');
            const tbody = matrix.querySelector('tbody');
            
            if (!thead || !tbody) {
                console.error('❌ 테이블 thead 또는 tbody를 찾을 수 없습니다!');
                return;
            }
            
            console.log('📋 테이블 요소 확인 완료');
            
            // 기존 컬럼 헤더 제거 (첫 번째 컬럼 제외)
            while (thead.children.length > 1) {
                thead.removeChild(thead.lastChild);
            }
            console.log('🗑️ 기존 헤더 제거 완료');
            
            // 테이블 헤더 추가
            data.tables.forEach((table, index) => {
                const th = document.createElement('th');
                th.textContent = table.name;
                th.title = `${table.name} (${table.type})`;
                thead.appendChild(th);
                console.log(`➕ 헤더 추가: ${index + 1}. ${table.name}`);
            });
            
            // 기존 tbody 내용 제거
            tbody.innerHTML = '';
            console.log('🗑️ 기존 tbody 내용 제거 완료');
            
            // 프로그램 행 추가
            data.programs.forEach((program, programIndex) => {
                const tr = document.createElement('tr');
                
                // 프로그램 이름 셀
                const programCell = document.createElement('td');
                programCell.className = 'program-name';
                programCell.innerHTML = `
                    <div>${program.name}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 2px;">${getTypeLabel(program.type)}</div>
                `;
                tr.appendChild(programCell);
                
                // CRUD 셀들 추가
                data.tables.forEach((table, tableIndex) => {
                    const crudCell = document.createElement('td');
                    crudCell.className = 'crud-cell';
                    
                    const crudOps = data.matrix[program.id] && data.matrix[program.id][table.id];
                    if (crudOps && crudOps.length > 0) {
                        const crudContainer = document.createElement('div');
                        crudContainer.className = 'crud-cell-multiple';
                        
                        crudOps.forEach(op => {
                            const badge = document.createElement('span');
                            badge.className = `crud-badge crud-${op.toLowerCase()}`;
                            badge.textContent = op;
                            badge.title = getCrudLabel(op);
                            crudContainer.appendChild(badge);
                        });
                        
                        crudCell.appendChild(crudContainer);
                        console.log(`✅ CRUD 추가: ${program.name} → ${table.name}: [${crudOps.join(',')}]`);
                    }
                    
                    tr.appendChild(crudCell);
                });
                
                tbody.appendChild(tr);
                console.log(`📝 프로그램 행 추가: ${programIndex + 1}. ${program.name}`);
            });
            
            console.log('✅ CRUD 매트릭스 렌더링 완료:', data.programs.length, '프로그램 ×', data.tables.length, '테이블');
        }
        
        // CRUD 라벨 가져오기
        function getCrudLabel(operation) {
            const labels = {
                'C': 'Create (생성)',
                'R': 'Read (조회)',
                'U': 'Update (수정)',
                'D': 'Delete (삭제)'
            };
            return labels[operation] || operation;
        }

        // 프로그램 리스트 로드
        async function loadProgramList() {
            try {
                console.log('🔄 /api/analysis/programs 호출 중...');
                const response = await fetch('/api/analysis/programs');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📦 프로그램 응답 데이터:', data);
                
                if (data.success) {
                    programData = data.data;
                    displayProgramList(programData);
                    console.log('✅ 프로그램 리스트 로드 완료:', programData.length, '개');
                } else {
                    throw new Error('API 응답 success: false');
                }
            } catch (error) {
                console.error('❌ 프로그램 리스트 로드 실패:', error);
                console.log('🔄 샘플 데이터로 대체...');
                displaySampleProgramList();
            }
        }

        // 샘플 프로그램 리스트 표시
        function displaySampleProgramList() {
            const programs = [
                {name: 'UserController', type: 'api', complexity: 'medium'},
                {name: 'OrderController', type: 'api', complexity: 'high'},
                {name: 'AuthController', type: 'api', complexity: 'low'},
                {name: 'UserService', type: 'service', complexity: 'medium'},
                {name: 'OrderService', type: 'service', complexity: 'high'},
                {name: 'PaymentService', type: 'service', complexity: 'high'},
                {name: 'User', type: 'model', complexity: 'low'},
                {name: 'Order', type: 'model', complexity: 'medium'},
                {name: 'Product', type: 'model', complexity: 'low'},
                {name: 'DateUtil', type: 'util', complexity: 'low'},
                {name: 'ValidationUtil', type: 'util', complexity: 'medium'},
                {name: 'CryptoUtil', type: 'util', complexity: 'high'}
            ];
            
            displayProgramList(programs);
        }

        // 프로그램 리스트 표시
        function displayProgramList(programs) {
            console.log('📋 프로그램 리스트 표시 시작...', programs);
            
            const container = document.getElementById('programList');
            if (!container) {
                console.error('❌ programList 요소를 찾을 수 없습니다!');
                return;
            }
            
            const html = programs.map((program, index) => {
                console.log(`📝 프로그램 ${index + 1}: ${program.name} (${program.type})`);
                return `
                    <div class="list-item" onclick="showProgramDetail('${program.name}')">
                        <div>
                            <div class="list-item-name">${program.name}</div>
                            <div class="list-item-type type-${getProgramTypeClass(program.type)}">${program.type}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 2px;">${program.loc.toLocaleString()} LOC</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: #666;">복잡도</div>
                            <div style="font-size: 10px; color: ${getComplexityColor(program.complexity)}">${getComplexityLabel(program.complexity)}</div>
                            <div style="font-size: 9px; color: #999; margin-top: 2px;">${program.dependencies} deps</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            console.log('✅ 프로그램 리스트 표시 완료:', programs.length, '개');
        }
        
        // 프로그램 타입 클래스 변환
        function getProgramTypeClass(type) {
            const typeMap = {
                'Main Application': 'api',
                'Service Module': 'service', 
                'Storage Module': 'model',
                'UI Module': 'util'
            };
            return typeMap[type] || 'service';
        }

        // 테이블 리스트 로드
        async function loadTableList() {
            try {
                console.log('🔄 /api/analysis/tables 호출 중...');
                const response = await fetch('/api/analysis/tables');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📦 테이블 응답 데이터:', data);
                
                if (data.success) {
                    tableData = data.data;
                    displayTableList(tableData);
                    console.log('✅ 테이블 리스트 로드 완료:', tableData.length, '개');
                } else {
                    throw new Error('API 응답 success: false');
                }
            } catch (error) {
                console.error('❌ 테이블 리스트 로드 실패:', error);
                console.log('🔄 샘플 데이터로 대체...');
                displaySampleTableList();
            }
        }

        // 샘플 테이블 리스트 표시
        function displaySampleTableList() {
            const tables = [
                {name: 'users', type: 'master', records: 50000, size: '125MB'},
                {name: 'orders', type: 'transaction', records: 180000, size: '890MB'},
                {name: 'products', type: 'master', records: 15000, size: '45MB'},
                {name: 'order_items', type: 'transaction', records: 650000, size: '1.2GB'},
                {name: 'sessions', type: 'log', records: 120000, size: '230MB'},
                {name: 'audit_logs', type: 'log', records: 500000, size: '2.1GB'},
                {name: 'categories', type: 'master', records: 200, size: '5MB'},
                {name: 'payments', type: 'transaction', records: 95000, size: '340MB'},
                {name: 'user_profiles', type: 'master', records: 48000, size: '180MB'},
                {name: 'error_logs', type: 'log', records: 75000, size: '420MB'}
            ];
            
            displayTableList(tables);
        }

        // 테이블 리스트 표시
        function displayTableList(tables) {
            console.log('🗄️ 테이블 리스트 표시 시작...', tables);
            
            const container = document.getElementById('tableList');
            if (!container) {
                console.error('❌ tableList 요소를 찾을 수 없습니다!');
                return;
            }
            
            const html = tables.map((table, index) => {
                console.log(`📝 테이블 ${index + 1}: ${table.name} (${table.type})`);
                return `
                    <div class="list-item" onclick="showTableDetail('${table.name}')">
                        <div>
                            <div class="list-item-name">${table.name}</div>
                            <div class="list-item-type type-${getTableTypeClass(table.type)}">${table.type}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 2px;">${table.engine}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: #666;">${getTableMetric(table)}</div>
                            <div style="font-size: 10px; color: #999;">${table.size}</div>
                            <div style="font-size: 9px; color: #999; margin-top: 2px;">${table.connections} conn</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            console.log('✅ 테이블 리스트 표시 완료:', tables.length, '개');
        }
        
        // 테이블 타입 클래스 변환
        function getTableTypeClass(type) {
            const typeMap = {
                'Streaming': 'log',
                'Analytics': 'master',
                'Cache': 'transaction',
                'File Storage': 'master',
                'Model Storage': 'master',
                'Transactional': 'transaction',
                'Search Index': 'log',
                'State Management': 'transaction',
                'Real-time Communication': 'log',
                'Configuration': 'master'
            };
            return typeMap[type] || 'master';
        }
        
        // 테이블 메트릭 표시
        function getTableMetric(table) {
            if (table.records) return table.records.toLocaleString() + ' 레코드';
            if (table.files) return table.files.toLocaleString() + ' 파일';
            if (table.models) return table.models + ' 모델';
            if (table.keys) return table.keys.toLocaleString() + ' 키';
            if (table.connections) return table.connections + ' 연결';
            return table.size || '데이터';
        }

        // 데이터 적재 현황 로드
        async function loadDataStatus() {
            try {
                const response = await fetch('/api/analysis/data-status');
                const data = await response.json();
                
                if (data.success) {
                    displayDataStatus(data.status);
                }
            } catch (error) {
                console.error('데이터 현황 로드 실패:', error);
                displaySampleDataStatus();
            }
        }

        // 샘플 데이터 현황 표시
        function displaySampleDataStatus() {
            const status = [
                {table: 'orders', growth: 95, todayInserts: 1250, status: 'high'},
                {table: 'users', growth: 78, todayInserts: 45, status: 'medium'},
                {table: 'sessions', growth: 88, todayInserts: 3400, status: 'high'},
                {table: 'audit_logs', growth: 92, todayInserts: 8500, status: 'high'},
                {table: 'products', growth: 45, todayInserts: 12, status: 'low'},
                {table: 'payments', growth: 82, todayInserts: 890, status: 'medium'},
                {table: 'categories', growth: 15, todayInserts: 2, status: 'low'},
                {table: 'error_logs', growth: 67, todayInserts: 245, status: 'medium'}
            ];
            
            displayDataStatus(status);
        }

        // 데이터 현황 표시
        function displayDataStatus(status) {
            const container = document.getElementById('dataStatusList');
            container.innerHTML = status.map(item => `
                <div class="list-item">
                    <div>
                        <div class="list-item-name">${item.table}</div>
                        <div style="font-size: 12px; color: #666;">오늘 ${item.todayInserts?.toLocaleString()} 건 추가</div>
                        <div class="progress-bar">
                            <div class="progress-fill ${item.status}" style="width: ${item.growth}%"></div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; font-weight: bold; color: ${getStatusColor(item.status)}">${item.growth}%</div>
                    </div>
                </div>
            `).join('');
        }

        // 클래스 다이어그램 로드
        async function loadClassDiagram(type) {
            const diagramId = type === 'overview' ? 'classDiagram' : `${type}Diagram`;
            const container = document.getElementById(diagramId);
            
            // Mermaid 다이어그램 생성
            const diagram = getClassDiagramDefinition(type);
            
            try {
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'default',
                    flowchart: {
                        useMaxWidth: true,
                        htmlLabels: true
                    }
                });
                
                const { svg } = await mermaid.render(`diagram-${type}`, diagram);
                container.innerHTML = svg;
            } catch (error) {
                console.error('다이어그램 생성 실패:', error);
                container.innerHTML = '<div style="padding: 50px; text-align: center; color: #666;">다이어그램을 로드할 수 없습니다.</div>';
            }
        }

        // 클래스 다이어그램 정의 생성
        function getClassDiagramDefinition(type) {
            const diagrams = {
                overview: `
                    classDiagram
                        class UserController {
                            +getUser(id)
                            +createUser(data)
                            +updateUser(id, data)
                            +deleteUser(id)
                        }
                        class UserService {
                            +findById(id)
                            +create(userData)
                            +update(id, data)
                            +delete(id)
                        }
                        class User {
                            +id: Long
                            +name: String
                            +email: String
                            +createdAt: Date
                        }
                        class OrderController {
                            +getOrders()
                            +createOrder(data)
                            +getOrderById(id)
                        }
                        class OrderService {
                            +findAll()
                            +create(orderData)
                            +findById(id)
                        }
                        class Order {
                            +id: Long
                            +userId: Long
                            +amount: BigDecimal
                            +status: String
                        }
                        
                        UserController --> UserService
                        UserService --> User
                        OrderController --> OrderService
                        OrderService --> Order
                        Order --> User
                `,
                api: `
                    classDiagram
                        class BaseController {
                            <<abstract>>
                            +handleException(e)
                            +validateRequest(req)
                        }
                        class UserController {
                            +getUser(id)
                            +createUser(data)
                            +updateUser(id, data)
                            +deleteUser(id)
                        }
                        class OrderController {
                            +getOrders()
                            +createOrder(data)
                            +getOrderById(id)
                            +updateOrderStatus(id, status)
                        }
                        class AuthController {
                            +login(credentials)
                            +logout()
                            +refreshToken()
                        }
                        
                        BaseController <|-- UserController
                        BaseController <|-- OrderController
                        BaseController <|-- AuthController
                `,
                service: `
                    classDiagram
                        class BaseService {
                            <<abstract>>
                            +validateData(data)
                            +handleTransaction()
                        }
                        class UserService {
                            +findById(id)
                            +create(userData)
                            +update(id, data)
                            +delete(id)
                        }
                        class OrderService {
                            +findAll()
                            +create(orderData)
                            +findById(id)
                            +updateStatus(id, status)
                        }
                        class PaymentService {
                            +processPayment(data)
                            +refund(paymentId)
                            +getPaymentStatus(id)
                        }
                        class NotificationService {
                            +sendEmail(to, subject, content)
                            +sendSMS(to, message)
                        }
                        
                        BaseService <|-- UserService
                        BaseService <|-- OrderService
                        BaseService <|-- PaymentService
                        OrderService --> PaymentService
                        OrderService --> NotificationService
                `,
                model: `
                    classDiagram
                        class BaseEntity {
                            <<abstract>>
                            +id: Long
                            +createdAt: Date
                            +updatedAt: Date
                        }
                        class User {
                            +name: String
                            +email: String
                            +password: String
                            +status: UserStatus
                        }
                        class Order {
                            +userId: Long
                            +amount: BigDecimal
                            +status: OrderStatus
                            +orderDate: Date
                        }
                        class OrderItem {
                            +orderId: Long
                            +productId: Long
                            +quantity: Integer
                            +price: BigDecimal
                        }
                        class Product {
                            +name: String
                            +description: String
                            +price: BigDecimal
                            +categoryId: Long
                        }
                        class Category {
                            +name: String
                            +description: String
                        }
                        
                        BaseEntity <|-- User
                        BaseEntity <|-- Order
                        BaseEntity <|-- OrderItem
                        BaseEntity <|-- Product
                        BaseEntity <|-- Category
                        Order --> User
                        OrderItem --> Order
                        OrderItem --> Product
                        Product --> Category
                `
            };
            
            return diagrams[type] || diagrams.overview;
        }

        // 필터 설정
        function setupFilters() {
            document.getElementById('programFilter').addEventListener('change', function() {
                filterPrograms(this.value);
            });
            
            document.getElementById('tableFilter').addEventListener('change', function() {
                filterTables(this.value);
            });
            
            document.getElementById('programTypeFilter').addEventListener('change', function() {
                filterCorrelationNetwork();
            });
            
            document.getElementById('tableTypeFilter').addEventListener('change', function() {
                filterCorrelationNetwork();
            });
            
            document.getElementById('crudFilter').addEventListener('change', function() {
                filterCorrelationNetwork();
            });
        }

        // 프로그램 필터링
        function filterPrograms(type) {
            if (!programData) return;
            
            const filtered = type ? programData.filter(p => p.type === type) : programData;
            displayProgramList(filtered);
        }

        // 테이블 필터링
        function filterTables(type) {
            if (!tableData) return;
            
            const filtered = type ? tableData.filter(t => t.type === type) : tableData;
            displayTableList(filtered);
        }

        // CRUD 매트릭스 필터링
        function filterCorrelationNetwork() {
            const programTypeFilter = document.getElementById('programTypeFilter').value;
            const tableTypeFilter = document.getElementById('tableTypeFilter').value;
            const crudFilter = document.getElementById('crudFilter').value;
            
            if (!correlationData) {
                createSampleCrudMatrix();
                return;
            }
            
            // 필터링된 데이터 생성
            let filteredData = {
                programs: correlationData.programs,
                tables: correlationData.tables,
                matrix: correlationData.matrix
            };
            
            // 프로그램 타입 필터
            if (programTypeFilter) {
                filteredData.programs = filteredData.programs.filter(p => p.type === programTypeFilter);
            }
            
            // 테이블 타입 필터
            if (tableTypeFilter) {
                filteredData.tables = filteredData.tables.filter(t => t.type === tableTypeFilter);
            }
            
            // CRUD 필터
            if (crudFilter) {
                const newMatrix = {};
                for (const programId in filteredData.matrix) {
                    if (filteredData.programs.find(p => p.id === programId)) {
                        newMatrix[programId] = {};
                        for (const tableId in filteredData.matrix[programId]) {
                            if (filteredData.tables.find(t => t.id === tableId)) {
                                const operations = filteredData.matrix[programId][tableId];
                                if (operations && operations.includes(crudFilter)) {
                                    newMatrix[programId][tableId] = operations;
                                }
                            }
                        }
                    }
                }
                filteredData.matrix = newMatrix;
            }
            
            renderCrudMatrix(filteredData);
        }

        // 유틸리티 함수들
        function getTypeLabel(type) {
            const labels = {
                'api': 'API',
                'service': '서비스',
                'model': '모델',
                'util': '유틸리티',
                'master': '마스터',
                'transaction': '트랜잭션',
                'log': '로그'
            };
            return labels[type] || type;
        }

        function getComplexityLabel(complexity) {
            const labels = {
                'low': '낮음',
                'medium': '보통',
                'high': '높음',
                'very_high': '매우높음'
            };
            return labels[complexity] || complexity;
        }

        function getComplexityColor(complexity) {
            const colors = {
                'low': '#28a745',
                'medium': '#ffc107',
                'high': '#dc3545',
                'very_high': '#6f42c1'
            };
            return colors[complexity] || '#6c757d';
        }

        function getStatusColor(status) {
            const colors = {
                'low': '#dc3545',
                'medium': '#ffc107',
                'high': '#28a745'
            };
            return colors[status] || '#6c757d';
        }

        // 상세 정보 표시 함수들
        function showProgramDetail(name) {
            alert(`프로그램 상세 정보: ${name}\n(상세 정보 모달을 구현할 예정)`);
        }

        function showTableDetail(name) {
            alert(`테이블 상세 정보: ${name}\n(상세 정보 모달을 구현할 예정)`);
        }

        // 데이터 새로고침
        async function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.innerHTML = '<div class="spinner"></div>';
            refreshBtn.disabled = true;

            try {
                await loadAnalysisData();
                
                refreshBtn.innerHTML = '✅';
                setTimeout(() => {
                    refreshBtn.innerHTML = '🔄';
                    refreshBtn.disabled = false;
                }, 1000);
            } catch (error) {
                console.error('데이터 새로고침 실패:', error);
                refreshBtn.innerHTML = '❌';
                setTimeout(() => {
                    refreshBtn.innerHTML = '🔄';
                    refreshBtn.disabled = false;
                }, 2000);
            }
        }
    </script>
</body>
</html>