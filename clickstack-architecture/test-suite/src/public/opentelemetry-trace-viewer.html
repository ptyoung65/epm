<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenTelemetry ì¶”ì  ë·°ì–´ | AIRIS-MON</title>
    <script src="/components/common-layout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --white: #ffffff;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --border-radius: 8px;
        }

        .trace-header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: var(--spacing-lg) 0;
            margin-bottom: var(--spacing-xl);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .header-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: 10px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-danger {
            background: var(--error);
            color: var(--white);
        }

        .filter-panel {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .filter-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .filter-label {
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: var(--spacing-xs);
        }

        .form-input {
            padding: 10px 12px;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-select {
            padding: 10px 12px;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            font-size: 14px;
            background-color: var(--white);
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
        }

        .filter-tag {
            background: var(--primary);
            color: var(--white);
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .filter-tag-remove {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .metrics-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .metric-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: var(--spacing-lg);
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: var(--spacing-sm);
        }

        .metric-change {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .metric-change.positive { color: var(--success); }
        .metric-change.negative { color: var(--error); }

        .traces-container {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .traces-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .traces-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .traces-controls {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .table-container {
            overflow-x: auto;
        }

        .traces-table {
            width: 100%;
            border-collapse: collapse;
        }

        .traces-table th,
        .traces-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-100);
        }

        .traces-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            position: sticky;
            top: 0;
        }

        .traces-table tr:hover {
            background: var(--gray-50);
        }

        .trace-id {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            color: var(--primary);
            cursor: pointer;
        }

        .trace-id:hover {
            text-decoration: underline;
        }

        .service-name {
            font-weight: 500;
            color: var(--gray-900);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fef2f2;
            color: #dc2626;
        }

        .status-warning {
            background: #fefce8;
            color: #ca8a04;
        }

        .duration-bar {
            height: 20px;
            background: var(--gray-100);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            min-width: 100px;
        }

        .duration-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning), var(--error));
            border-radius: 10px;
            position: relative;
        }

        .duration-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .anomaly-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .anomaly-high {
            background: #fef2f2;
            color: #dc2626;
        }

        .anomaly-medium {
            background: #fefce8;
            color: #ca8a04;
        }

        .anomaly-low {
            background: #f0fdf4;
            color: #166534;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .alert-info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: var(--primary);
        }

        .alert-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: var(--success);
        }

        .alert-warning {
            background: #fffbeb;
            border: 1px solid #fed7aa;
            color: var(--warning);
        }

        .alert-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: var(--error);
        }

        .pagination {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: var(--spacing-lg);
            border-top: 1px solid var(--gray-200);
        }

        .pagination-info {
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .pagination-controls {
            display: flex;
            gap: var(--spacing-xs);
        }

        .page-btn {
            padding: 6px 12px;
            border: 1px solid var(--gray-200);
            background: var(--white);
            color: var(--gray-700);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem;
        }

        .page-btn:hover {
            background: var(--gray-50);
        }

        .page-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
        }

        .realtime-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chart-container {
            height: 200px;
            margin: var(--spacing-lg) 0;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl) * 2;
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-lg);
        }

        .saved-filters {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .saved-filter {
            padding: 6px 12px;
            background: var(--gray-100);
            border-radius: 20px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .saved-filter:hover {
            background: var(--gray-200);
        }

        .saved-filter.active {
            background: var(--primary);
            color: var(--white);
        }

        @media (max-width: 1024px) {
            .filter-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .metrics-panel {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-panel {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .table-container {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="airis-content-wrapper">
        <!-- í—¤ë” -->
        <div class="trace-header">
            <div class="header-content">
                <h1 class="header-title">
                    ğŸ” OpenTelemetry ì¶”ì  ë·°ì–´
                </h1>
                <div class="header-actions">
                    <div class="realtime-indicator">
                        <div class="realtime-dot"></div>
                        <span>ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</span>
                    </div>
                    <button class="btn btn-secondary" onclick="exportTraces()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn btn-primary" onclick="refreshTraces()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
        </div>

        <!-- ì•Œë¦¼ ì˜ì—­ -->
        <div id="alertContainer"></div>

        <!-- ì €ì¥ëœ í•„í„° -->
        <div class="saved-filters" id="savedFilters">
            <div class="saved-filter active" onclick="applySavedFilter('all')">
                ğŸ“Š ì „ì²´ ì¶”ì 
            </div>
            <div class="saved-filter" onclick="applySavedFilter('errors')">
                âŒ ì˜¤ë¥˜ ì¶”ì 
            </div>
            <div class="saved-filter" onclick="applySavedFilter('slow')">
                ğŸŒ ëŠë¦° ìš”ì²­
            </div>
            <div class="saved-filter" onclick="applySavedFilter('recent')">
                â° ìµœê·¼ 1ì‹œê°„
            </div>
        </div>

        <!-- í•„í„° íŒ¨ë„ -->
        <div class="filter-panel">
            <div class="filter-header">
                <h2 class="filter-title">ê³ ê¸‰ í•„í„°ë§</h2>
                <div>
                    <button class="btn btn-secondary" onclick="clearFilters()">ì´ˆê¸°í™”</button>
                    <button class="btn btn-primary" onclick="saveCurrentFilter()">í•„í„° ì €ì¥</button>
                </div>
            </div>
            
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">ì„œë¹„ìŠ¤ ì´ë¦„</label>
                    <input type="text" class="form-input" id="serviceFilter" 
                           placeholder="ì„œë¹„ìŠ¤ëª… ê²€ìƒ‰ (ì •ê·œì‹ ì§€ì›)" 
                           oninput="applyFilters()">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">ì‘ì—… ìœ í˜•</label>
                    <select class="form-select" id="operationFilter" onchange="applyFilters()">
                        <option value="">ëª¨ë“  ì‘ì—…</option>
                        <option value="http">HTTP ìš”ì²­</option>
                        <option value="database">ë°ì´í„°ë² ì´ìŠ¤</option>
                        <option value="cache">ìºì‹œ</option>
                        <option value="queue">ë©”ì‹œì§€ í</option>
                        <option value="external">ì™¸ë¶€ API</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">ìƒíƒœ ì½”ë“œ</label>
                    <select class="form-select" id="statusFilter" onchange="applyFilters()">
                        <option value="">ëª¨ë“  ìƒíƒœ</option>
                        <option value="success">ì„±ê³µ (2xx)</option>
                        <option value="error">ì˜¤ë¥˜ (4xx, 5xx)</option>
                        <option value="timeout">íƒ€ì„ì•„ì›ƒ</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">ì§€ì—° ì‹œê°„ ë²”ìœ„</label>
                    <select class="form-select" id="durationFilter" onchange="applyFilters()">
                        <option value="">ëª¨ë“  ë²”ìœ„</option>
                        <option value="fast">ë¹ ë¦„ (< 100ms)</option>
                        <option value="normal">ë³´í†µ (100ms - 1s)</option>
                        <option value="slow">ëŠë¦¼ (1s - 10s)</option>
                        <option value="very-slow">ë§¤ìš° ëŠë¦¼ (> 10s)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">ì‹œê°„ ë²”ìœ„</label>
                    <select class="form-select" id="timeRangeFilter" onchange="applyFilters()">
                        <option value="1h">ìµœê·¼ 1ì‹œê°„</option>
                        <option value="6h">ìµœê·¼ 6ì‹œê°„</option>
                        <option value="24h">ìµœê·¼ 24ì‹œê°„</option>
                        <option value="7d">ìµœê·¼ 7ì¼</option>
                        <option value="custom">ì‚¬ìš©ì ì •ì˜</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">ì´ìƒ ì§•í›„</label>
                    <select class="form-select" id="anomalyFilter" onchange="applyFilters()">
                        <option value="">ëª¨ë“  ì¶”ì </option>
                        <option value="high">ë†’ìŒ ìœ„í—˜</option>
                        <option value="medium">ì¤‘ê°„ ìœ„í—˜</option>
                        <option value="low">ë‚®ì€ ìœ„í—˜</option>
                    </select>
                </div>
            </div>
            
            <div class="filter-tags" id="activeFilters"></div>
        </div>

        <!-- ë©”íŠ¸ë¦­ íŒ¨ë„ -->
        <div class="metrics-panel">
            <div class="metric-card">
                <div class="metric-value" style="color: var(--primary);" id="totalTraces">0</div>
                <div class="metric-label">ì´ ì¶”ì </div>
                <div class="metric-change positive" id="tracesChange">+0%</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: var(--success);" id="avgLatency">0ms</div>
                <div class="metric-label">í‰ê·  ì§€ì—°ì‹œê°„</div>
                <div class="metric-change" id="latencyChange">+0%</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: var(--error);" id="errorRate">0%</div>
                <div class="metric-label">ì˜¤ë¥˜ìœ¨</div>
                <div class="metric-change" id="errorRateChange">+0%</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: var(--warning);" id="anomalies">0</div>
                <div class="metric-label">ì´ìƒ ì§•í›„</div>
                <div class="metric-change" id="anomaliesChange">+0%</div>
            </div>
        </div>

        <!-- ì¶”ì  í…Œì´ë¸” -->
        <div class="traces-container">
            <div class="traces-header">
                <h2 class="traces-title">ì¶”ì  ëª©ë¡</h2>
                <div class="traces-controls">
                    <select class="form-select" id="sortBy" onchange="sortTraces()">
                        <option value="timestamp">ì‹œê°„ìˆœ</option>
                        <option value="duration">ì§€ì—°ì‹œê°„ìˆœ</option>
                        <option value="service">ì„œë¹„ìŠ¤ìˆœ</option>
                        <option value="status">ìƒíƒœìˆœ</option>
                    </select>
                    <select class="form-select" id="pageSize" onchange="changePageSize()">
                        <option value="25">25ê°œì”©</option>
                        <option value="50">50ê°œì”©</option>
                        <option value="100">100ê°œì”©</option>
                    </select>
                </div>
            </div>
            
            <div class="table-container">
                <table class="traces-table">
                    <thead>
                        <tr>
                            <th>ì¶”ì  ID</th>
                            <th>ì„œë¹„ìŠ¤</th>
                            <th>ì‘ì—…</th>
                            <th>ìƒíƒœ</th>
                            <th>ì§€ì—°ì‹œê°„</th>
                            <th>ìŠ¤íŒ¬ ìˆ˜</th>
                            <th>ì‹œì‘ ì‹œê°„</th>
                            <th>ì´ìƒ ì§•í›„</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="tracesTableBody">
                        <!-- ì¶”ì  ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>

            <div class="pagination">
                <div class="pagination-info" id="paginationInfo">
                    1-25 / ì´ 0ê°œ ì¶”ì 
                </div>
                <div class="pagination-controls" id="paginationControls">
                    <button class="page-btn" id="prevBtn" onclick="prevPage()" disabled>ì´ì „</button>
                    <button class="page-btn" id="nextBtn" onclick="nextPage()" disabled>ë‹¤ìŒ</button>
                </div>
            </div>

            <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
            <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                <div class="spinner"></div>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-state-icon">ğŸ“Š</div>
                <h3>ì¶”ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>í•„í„° ì¡°ê±´ì„ ì¡°ì •í•˜ê±°ë‚˜ ìƒˆë¡œìš´ ì¶”ì ì´ ìƒì„±ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>
        </div>

        <!-- ì„±ëŠ¥ ì°¨íŠ¸ -->
        <div class="chart-container">
            <canvas id="performanceChart" width="800" height="200"></canvas>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let allTraces = [];
        let filteredTraces = [];
        let currentPage = 1;
        let pageSize = 25;
        let performanceChart = null;
        let anomalyDetector = null;
        let realtimeUpdateInterval = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeTraceViewer();
            loadInitialData();
            startRealtimeUpdates();
            initializeAnomalyDetection();
        });

        // ì¶”ì  ë·°ì–´ ì´ˆê¸°í™”
        function initializeTraceViewer() {
            console.log('OpenTelemetry ì¶”ì  ë·°ì–´ ì´ˆê¸°í™” ì¤‘...');
            
            // ì„±ëŠ¥ ì°¨íŠ¸ ì´ˆê¸°í™”
            initializePerformanceChart();
            
            // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì„¤ì •
            setupKeyboardShortcuts();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        async function loadInitialData() {
            showLoading(true);
            
            try {
                await loadTraces();
                applyFilters();
                updateMetrics();
                showAlert('ì¶”ì  ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showAlert('ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒ˜í”Œ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.', 'warning');
                generateSampleData();
            } finally {
                showLoading(false);
            }
        }

        // ì¶”ì  ë°ì´í„° ë¡œë“œ
        async function loadTraces() {
            try {
                const response = await fetch('/api/opentelemetry/traces/list');
                const data = await response.json();
                
                if (data.success) {
                    allTraces = data.traces;
                } else {
                    throw new Error(data.error || 'ì¶”ì  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('ì¶”ì  ë¡œë“œ ì˜¤ë¥˜:', error);
                generateSampleData();
            }
        }

        // ìƒ˜í”Œ ë°ì´í„° ìƒì„±
        function generateSampleData() {
            const services = ['user-service', 'order-service', 'payment-service', 'inventory-service', 'notification-service'];
            const operations = ['GET /users', 'POST /orders', 'PUT /payment', 'GET /inventory', 'POST /notify'];
            const statuses = ['success', 'error', 'timeout'];
            
            allTraces = [];
            
            for (let i = 0; i < 150; i++) {
                const service = services[Math.floor(Math.random() * services.length)];
                const operation = operations[Math.floor(Math.random() * operations.length)];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const duration = Math.floor(Math.random() * 5000) + 50;
                const spanCount = Math.floor(Math.random() * 15) + 3;
                const timestamp = new Date(Date.now() - Math.random() * 86400000);
                
                // ì´ìƒ ì§•í›„ ì ìˆ˜ ê³„ì‚° (ì‹œë®¬ë ˆì´ì…˜)
                let anomalyScore = 0;
                if (duration > 2000) anomalyScore += 0.3;
                if (status === 'error') anomalyScore += 0.5;
                if (spanCount > 10) anomalyScore += 0.2;
                anomalyScore += Math.random() * 0.3;
                
                let anomalyLevel = 'low';
                if (anomalyScore > 0.7) anomalyLevel = 'high';
                else if (anomalyScore > 0.4) anomalyLevel = 'medium';
                
                const trace = {
                    traceId: `trace_${i.toString().padStart(6, '0')}_${Date.now()}`,
                    service: service,
                    operation: operation,
                    status: status,
                    duration: duration,
                    spanCount: spanCount,
                    timestamp: timestamp.toISOString(),
                    anomalyScore: anomalyScore,
                    anomalyLevel: anomalyLevel,
                    tags: {
                        environment: Math.random() > 0.5 ? 'production' : 'staging',
                        region: ['us-east-1', 'eu-west-1', 'ap-northeast-1'][Math.floor(Math.random() * 3)],
                        version: ['v1.2.3', 'v1.2.4', 'v1.3.0'][Math.floor(Math.random() * 3)]
                    }
                };
                
                allTraces.push(trace);
            }
            
            // ì‹œê°„ìˆœ ì •ë ¬
            allTraces.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // í•„í„° ì ìš©
        function applyFilters() {
            const serviceFilter = document.getElementById('serviceFilter').value.toLowerCase();
            const operationFilter = document.getElementById('operationFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const durationFilter = document.getElementById('durationFilter').value;
            const timeRangeFilter = document.getElementById('timeRangeFilter').value;
            const anomalyFilter = document.getElementById('anomalyFilter').value;
            
            filteredTraces = allTraces.filter(trace => {
                // ì„œë¹„ìŠ¤ ì´ë¦„ í•„í„°
                if (serviceFilter && !trace.service.toLowerCase().includes(serviceFilter)) {
                    return false;
                }
                
                // ì‘ì—… ìœ í˜• í•„í„°
                if (operationFilter) {
                    switch (operationFilter) {
                        case 'http':
                            if (!trace.operation.includes('GET') && !trace.operation.includes('POST') && 
                                !trace.operation.includes('PUT') && !trace.operation.includes('DELETE')) {
                                return false;
                            }
                            break;
                        case 'database':
                            if (!trace.operation.toLowerCase().includes('db') && 
                                !trace.operation.toLowerCase().includes('query')) {
                                return false;
                            }
                            break;
                        // ì¶”ê°€ í•„í„° ë¡œì§...
                    }
                }
                
                // ìƒíƒœ í•„í„°
                if (statusFilter) {
                    switch (statusFilter) {
                        case 'success':
                            if (trace.status !== 'success') return false;
                            break;
                        case 'error':
                            if (trace.status !== 'error') return false;
                            break;
                        case 'timeout':
                            if (trace.status !== 'timeout') return false;
                            break;
                    }
                }
                
                // ì§€ì—°ì‹œê°„ í•„í„°
                if (durationFilter) {
                    switch (durationFilter) {
                        case 'fast':
                            if (trace.duration >= 100) return false;
                            break;
                        case 'normal':
                            if (trace.duration < 100 || trace.duration >= 1000) return false;
                            break;
                        case 'slow':
                            if (trace.duration < 1000 || trace.duration >= 10000) return false;
                            break;
                        case 'very-slow':
                            if (trace.duration < 10000) return false;
                            break;
                    }
                }
                
                // ì‹œê°„ ë²”ìœ„ í•„í„°
                if (timeRangeFilter && timeRangeFilter !== 'custom') {
                    const now = new Date();
                    const traceTime = new Date(trace.timestamp);
                    const timeDiff = now - traceTime;
                    
                    switch (timeRangeFilter) {
                        case '1h':
                            if (timeDiff > 60 * 60 * 1000) return false;
                            break;
                        case '6h':
                            if (timeDiff > 6 * 60 * 60 * 1000) return false;
                            break;
                        case '24h':
                            if (timeDiff > 24 * 60 * 60 * 1000) return false;
                            break;
                        case '7d':
                            if (timeDiff > 7 * 24 * 60 * 60 * 1000) return false;
                            break;
                    }
                }
                
                // ì´ìƒ ì§•í›„ í•„í„°
                if (anomalyFilter && trace.anomalyLevel !== anomalyFilter) {
                    return false;
                }
                
                return true;
            });
            
            currentPage = 1;
            updateTracesTable();
            updateActiveFilters();
            updateMetrics();
        }

        // ì¶”ì  í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateTracesTable() {
            const tbody = document.getElementById('tracesTableBody');
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageTraces = filteredTraces.slice(startIndex, endIndex);
            
            if (pageTraces.length === 0) {
                tbody.innerHTML = '';
                showEmptyState(true);
                updatePagination();
                return;
            }
            
            showEmptyState(false);
            
            tbody.innerHTML = pageTraces.map(trace => `
                <tr onclick="viewTraceDetails('${trace.traceId}')" style="cursor: pointer;">
                    <td>
                        <span class="trace-id">${trace.traceId.substring(0, 8)}...</span>
                    </td>
                    <td>
                        <span class="service-name">${trace.service}</span>
                    </td>
                    <td>${trace.operation}</td>
                    <td>
                        <span class="status-badge status-${trace.status}">${trace.status.toUpperCase()}</span>
                    </td>
                    <td>
                        <div class="duration-bar">
                            <div class="duration-fill" style="width: ${Math.min(trace.duration / 50, 100)}%"></div>
                            <div class="duration-text">${trace.duration}ms</div>
                        </div>
                    </td>
                    <td>${trace.spanCount}</td>
                    <td>${new Date(trace.timestamp).toLocaleString()}</td>
                    <td>
                        <span class="anomaly-indicator anomaly-${trace.anomalyLevel}">
                            ${trace.anomalyLevel === 'high' ? 'ğŸ”´' : trace.anomalyLevel === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢'}
                            ${trace.anomalyLevel.toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-secondary" onclick="event.stopPropagation(); viewTraceDetails('${trace.traceId}')">ìƒì„¸</button>
                    </td>
                </tr>
            `).join('');
            
            updatePagination();
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
        function updatePagination() {
            const totalPages = Math.ceil(filteredTraces.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, filteredTraces.length);
            
            document.getElementById('paginationInfo').textContent = 
                `${startIndex}-${endIndex} / ì´ ${filteredTraces.length}ê°œ ì¶”ì `;
            
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        // ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
        function updateMetrics() {
            const total = filteredTraces.length;
            const avgLatency = total > 0 ? 
                Math.round(filteredTraces.reduce((sum, t) => sum + t.duration, 0) / total) : 0;
            const errorRate = total > 0 ? 
                Math.round((filteredTraces.filter(t => t.status === 'error').length / total) * 100) : 0;
            const anomalies = filteredTraces.filter(t => t.anomalyLevel === 'high' || t.anomalyLevel === 'medium').length;
            
            document.getElementById('totalTraces').textContent = total.toLocaleString();
            document.getElementById('avgLatency').textContent = `${avgLatency}ms`;
            document.getElementById('errorRate').textContent = `${errorRate}%`;
            document.getElementById('anomalies').textContent = anomalies.toLocaleString();
            
            // ë³€í™”ìœ¨ ê³„ì‚° (ì‹œë®¬ë ˆì´ì…˜)
            updateMetricChanges();
        }

        // ë©”íŠ¸ë¦­ ë³€í™”ìœ¨ ì—…ë°ì´íŠ¸
        function updateMetricChanges() {
            // ì‹¤ì œë¡œëŠ” ì´ì „ ë°ì´í„°ì™€ ë¹„êµí•˜ì—¬ ê³„ì‚°
            const changes = [
                Math.floor(Math.random() * 20) - 10,
                Math.floor(Math.random() * 20) - 10,
                Math.floor(Math.random() * 10) - 5,
                Math.floor(Math.random() * 15) - 7
            ];
            
            const changeElements = ['tracesChange', 'latencyChange', 'errorRateChange', 'anomaliesChange'];
            
            changes.forEach((change, index) => {
                const element = document.getElementById(changeElements[index]);
                element.textContent = `${change > 0 ? '+' : ''}${change}%`;
                element.className = `metric-change ${change > 0 ? 'positive' : 'negative'}`;
            });
        }

        // í™œì„± í•„í„° ì—…ë°ì´íŠ¸
        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            const filters = [];
            
            const serviceFilter = document.getElementById('serviceFilter').value;
            const operationFilter = document.getElementById('operationFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const durationFilter = document.getElementById('durationFilter').value;
            const anomalyFilter = document.getElementById('anomalyFilter').value;
            
            if (serviceFilter) filters.push({ key: 'service', value: serviceFilter });
            if (operationFilter) filters.push({ key: 'operation', value: operationFilter });
            if (statusFilter) filters.push({ key: 'status', value: statusFilter });
            if (durationFilter) filters.push({ key: 'duration', value: durationFilter });
            if (anomalyFilter) filters.push({ key: 'anomaly', value: anomalyFilter });
            
            container.innerHTML = filters.map(filter => `
                <div class="filter-tag">
                    ${filter.key}: ${filter.value}
                    <button class="filter-tag-remove" onclick="removeFilter('${filter.key}')">&times;</button>
                </div>
            `).join('');
        }

        // í•„í„° ì œê±°
        function removeFilter(filterKey) {
            switch (filterKey) {
                case 'service':
                    document.getElementById('serviceFilter').value = '';
                    break;
                case 'operation':
                    document.getElementById('operationFilter').value = '';
                    break;
                case 'status':
                    document.getElementById('statusFilter').value = '';
                    break;
                case 'duration':
                    document.getElementById('durationFilter').value = '';
                    break;
                case 'anomaly':
                    document.getElementById('anomalyFilter').value = '';
                    break;
            }
            applyFilters();
        }

        // í•„í„° ì´ˆê¸°í™”
        function clearFilters() {
            document.getElementById('serviceFilter').value = '';
            document.getElementById('operationFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('durationFilter').value = '';
            document.getElementById('timeRangeFilter').value = '24h';
            document.getElementById('anomalyFilter').value = '';
            applyFilters();
        }

        // ì €ì¥ëœ í•„í„° ì ìš©
        function applySavedFilter(filterName) {
            // ëª¨ë“  ì €ì¥ëœ í•„í„°ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.saved-filter').forEach(el => el.classList.remove('active'));
            
            // í´ë¦­ëœ í•„í„°ì— active í´ë˜ìŠ¤ ì¶”ê°€
            event.target.classList.add('active');
            
            clearFilters();
            
            switch (filterName) {
                case 'all':
                    // ê¸°ë³¸ ìƒíƒœ
                    break;
                case 'errors':
                    document.getElementById('statusFilter').value = 'error';
                    break;
                case 'slow':
                    document.getElementById('durationFilter').value = 'slow';
                    break;
                case 'recent':
                    document.getElementById('timeRangeFilter').value = '1h';
                    break;
            }
            
            applyFilters();
        }

        // í˜„ì¬ í•„í„° ì €ì¥
        function saveCurrentFilter() {
            const filterName = prompt('í•„í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (filterName) {
                // ì‹¤ì œë¡œëŠ” ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë‚˜ ì„œë²„ì— ì €ì¥
                showAlert(`í•„í„° "${filterName}"ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }
        }

        // ì¶”ì  ìƒì„¸ ë³´ê¸°
        function viewTraceDetails(traceId) {
            window.open(`/trace-detail-analyzer.html?trace=${traceId}`, '_blank');
        }

        // í˜ì´ì§€ ì´ë™
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTracesTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredTraces.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                updateTracesTable();
            }
        }

        // í˜ì´ì§€ í¬ê¸° ë³€ê²½
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            updateTracesTable();
        }

        // ì •ë ¬
        function sortTraces() {
            const sortBy = document.getElementById('sortBy').value;
            
            filteredTraces.sort((a, b) => {
                switch (sortBy) {
                    case 'timestamp':
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    case 'duration':
                        return b.duration - a.duration;
                    case 'service':
                        return a.service.localeCompare(b.service);
                    case 'status':
                        return a.status.localeCompare(b.status);
                    default:
                        return 0;
                }
            });
            
            updateTracesTable();
        }

        // ì„±ëŠ¥ ì°¨íŠ¸ ì´ˆê¸°í™”
        function initializePerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'í‰ê·  ì‘ë‹µì‹œê°„ (ms)',
                        data: [],
                        borderColor: 'rgb(37, 99, 235)',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'ì˜¤ë¥˜ìœ¨ (%)',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
            
            updatePerformanceChart();
        }

        // ì„±ëŠ¥ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updatePerformanceChart() {
            // ì‹œê°„ë³„ ë°ì´í„° ìƒì„± (ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ê°€ì ¸ì˜´)
            const now = new Date();
            const labels = [];
            const latencyData = [];
            const errorRateData = [];
            
            for (let i = 23; i >= 0; i--) {
                const time = new Date(now - i * 60 * 60 * 1000);
                labels.push(time.getHours() + ':00');
                latencyData.push(Math.floor(Math.random() * 500) + 100);
                errorRateData.push(Math.floor(Math.random() * 10));
            }
            
            performanceChart.data.labels = labels;
            performanceChart.data.datasets[0].data = latencyData;
            performanceChart.data.datasets[1].data = errorRateData;
            performanceChart.update();
        }

        // ì´ìƒ ì§•í›„ ê°ì§€ ì´ˆê¸°í™”
        async function initializeAnomalyDetection() {
            try {
                console.log('ì´ìƒ ì§•í›„ ê°ì§€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
                // TensorFlow.js ëª¨ë¸ ë¡œë“œ (ì‹œë®¬ë ˆì´ì…˜)
                anomalyDetector = {
                    predict: function(trace) {
                        // ì‹¤ì œë¡œëŠ” í›ˆë ¨ëœ ML ëª¨ë¸ ì‚¬ìš©
                        let score = 0;
                        if (trace.duration > 2000) score += 0.4;
                        if (trace.status === 'error') score += 0.5;
                        if (trace.spanCount > 10) score += 0.3;
                        return Math.min(score + Math.random() * 0.2, 1.0);
                    }
                };
                console.log('ì´ìƒ ì§•í›„ ê°ì§€ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ');
            } catch (error) {
                console.error('ì´ìƒ ì§•í›„ ê°ì§€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        }

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
        function startRealtimeUpdates() {
            realtimeUpdateInterval = setInterval(() => {
                // ì‹¤ì œë¡œëŠ” WebSocketì´ë‚˜ Server-Sent Events ì‚¬ìš©
                updateRealtimeData();
            }, 30000); // 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        }

        // ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸
        function updateRealtimeData() {
            // ìƒˆë¡œìš´ ì¶”ì  ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜
            const newTraces = generateNewTraces(5);
            allTraces = [...newTraces, ...allTraces];
            
            // ìµœì‹  1000ê°œë§Œ ìœ ì§€
            if (allTraces.length > 1000) {
                allTraces = allTraces.slice(0, 1000);
            }
            
            applyFilters();
            updatePerformanceChart();
        }

        // ìƒˆë¡œìš´ ì¶”ì  ìƒì„±
        function generateNewTraces(count) {
            const services = ['user-service', 'order-service', 'payment-service', 'inventory-service'];
            const operations = ['GET /users', 'POST /orders', 'PUT /payment', 'GET /inventory'];
            const newTraces = [];
            
            for (let i = 0; i < count; i++) {
                const trace = {
                    traceId: `trace_${Date.now()}_${i}`,
                    service: services[Math.floor(Math.random() * services.length)],
                    operation: operations[Math.floor(Math.random() * operations.length)],
                    status: Math.random() > 0.1 ? 'success' : 'error',
                    duration: Math.floor(Math.random() * 2000) + 50,
                    spanCount: Math.floor(Math.random() * 12) + 3,
                    timestamp: new Date().toISOString(),
                    anomalyScore: Math.random(),
                    anomalyLevel: 'low',
                    tags: { environment: 'production' }
                };
                
                if (anomalyDetector) {
                    trace.anomalyScore = anomalyDetector.predict(trace);
                    if (trace.anomalyScore > 0.7) trace.anomalyLevel = 'high';
                    else if (trace.anomalyScore > 0.4) trace.anomalyLevel = 'medium';
                }
                
                newTraces.push(trace);
            }
            
            return newTraces;
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì„¤ì •
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 'r':
                            e.preventDefault();
                            refreshTraces();
                            break;
                        case 'f':
                            e.preventDefault();
                            document.getElementById('serviceFilter').focus();
                            break;
                        case 'e':
                            e.preventDefault();
                            exportTraces();
                            break;
                    }
                }
            });
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // í•„í„° ì…ë ¥ ë””ë°”ìš´ìŠ¤
            let filterTimeout;
            document.getElementById('serviceFilter').addEventListener('input', () => {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(applyFilters, 300);
            });
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showEmptyState(show) {
            document.getElementById('emptyState').style.display = show ? 'block' : 'none';
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span>${message}</span>
                <button style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2rem;" onclick="this.parentElement.remove()">&times;</button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }

        function refreshTraces() {
            loadInitialData();
        }

        function exportTraces() {
            const csvData = filteredTraces.map(trace => ({
                traceId: trace.traceId,
                service: trace.service,
                operation: trace.operation,
                status: trace.status,
                duration: trace.duration,
                spanCount: trace.spanCount,
                timestamp: trace.timestamp,
                anomalyLevel: trace.anomalyLevel
            }));
            
            const csv = convertToCSV(csvData);
            downloadCSV(csv, 'opentelemetry_traces.csv');
            showAlert('ì¶”ì  ë°ì´í„°ê°€ CSVë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.', 'success');
        }

        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');
            return csvContent;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (realtimeUpdateInterval) {
                clearInterval(realtimeUpdateInterval);
            }
        });
    </script>
</body>
</html>