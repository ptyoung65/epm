<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRIS-MON í†µí•© ì„¸ì…˜ ë…¹í™”ê¸°</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header .subtitle {
            opacity: 0.8;
            font-size: 1.1em;
        }
        
        .monitoring-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            text-align: center;
        }
        
        .status-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status-label {
            opacity: 0.8;
            font-size: 0.9em;
        }
        
        .controls-panel {
            background: rgba(255,255,255,0.15);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #4834d4, #686de0);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn:disabled {
            background: #6c757d !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .session-info {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            backdrop-filter: blur(5px);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .info-label {
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        .test-area {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .test-area h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-weight: 300;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #34495e;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .test-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .test-btn {
            padding: 12px 25px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .interactive-area {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .interactive-area:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
        }
        
        .logs-panel {
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.4;
        }
        
        /* ì‹¤ì‹œê°„ í”¼ë“œë°± ìŠ¤íƒ€ì¼ */
        .input-recording {
            border-color: #ff6b6b !important;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2) !important;
        }
        
        .click-recording {
            animation: clickPulse 0.3s ease;
        }
        
        @keyframes clickPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: rgba(255, 107, 107, 0.2); }
            100% { transform: scale(1); }
        }
        
        .recording-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff6b6b;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            animation: recordingBlink 1s infinite;
        }
        
        @keyframes recordingBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.7; }
        }
        
        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
            }
            
            .btn {
                min-width: 250px;
            }
            
            .test-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="recordingIndicator" class="recording-indicator" style="display: none;">
        ğŸ”´ ë…¹í™” ì¤‘...
    </div>
    
    <div class="header">
        <h1>ğŸ¬ AIRIS-MON í†µí•© ì„¸ì…˜ ë…¹í™”ê¸°</h1>
        <div class="subtitle">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ê³¼ í•¨ê»˜í•˜ëŠ” í–¥ìƒëœ ì„¸ì…˜ ë¦¬í”Œë ˆì´ ì‹œìŠ¤í…œ</div>
    </div>
    
    <div class="monitoring-status">
        <div class="status-card">
            <div class="status-value" id="activeConnections">0</div>
            <div class="status-label">í™œì„± ì—°ê²°</div>
        </div>
        <div class="status-card">
            <div class="status-value" id="totalSessions">0</div>
            <div class="status-label">ì´ ì„¸ì…˜</div>
        </div>
        <div class="status-card">
            <div class="status-value" id="currentEvents">0</div>
            <div class="status-label">ìˆ˜ì§‘ëœ ì´ë²¤íŠ¸</div>
        </div>
        <div class="status-card">
            <div class="status-value" id="systemHealth">100%</div>
            <div class="status-label">ì‹œìŠ¤í…œ ìƒíƒœ</div>
        </div>
    </div>
    
    <div class="controls-panel">
        <div class="controls-row">
            <button class="btn btn-primary" onclick="startIntegratedRecording()" id="startBtn">
                ğŸ”´ í†µí•© ë…¹í™” ì‹œì‘
            </button>
            <button class="btn btn-secondary" onclick="stopIntegratedRecording()" id="stopBtn" disabled>
                â¹ï¸ ë…¹í™” ì¤‘ì§€
            </button>
            <button class="btn btn-success" onclick="playIntegratedRecording()" id="playBtn" disabled>
                â–¶ï¸ ë¦¬í”Œë ˆì´ ë³´ê¸°
            </button>
        </div>
        
        <div class="controls-row">
            <select id="scenarioSelect" style="padding: 15px; border-radius: 25px; border: none; font-size: 16px; min-width: 200px;">
                <option value="integrated_test">í†µí•© í…ŒìŠ¤íŠ¸</option>
                <option value="performance_test">ì„±ëŠ¥ í…ŒìŠ¤íŠ¸</option>
                <option value="user_interaction">ì‚¬ìš©ì ìƒí˜¸ì‘ìš©</option>
                <option value="error_scenario">ì˜¤ë¥˜ ì‹œë‚˜ë¦¬ì˜¤</option>
            </select>
        </div>
    </div>
    
    <div class="session-info" id="sessionInfo" style="display: none;">
        <div class="info-grid">
            <div class="info-item">
                <div class="info-value" id="sessionId">-</div>
                <div class="info-label">ì„¸ì…˜ ID</div>
            </div>
            <div class="info-item">
                <div class="info-value" id="recordingTime">00:00</div>
                <div class="info-label">ë…¹í™” ì‹œê°„</div>
            </div>
            <div class="info-item">
                <div class="info-value" id="eventCount">0</div>
                <div class="info-label">ì´ë²¤íŠ¸ ìˆ˜</div>
            </div>
            <div class="info-item">
                <div class="info-value" id="dataSize">0 KB</div>
                <div class="info-label">ë°ì´í„° í¬ê¸°</div>
            </div>
        </div>
    </div>
    
    <div class="test-area" id="testArea">
        <h2>ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ ì˜ì—­</h2>
        
        <div class="form-group">
            <label class="form-label" for="userNameInput">ì‚¬ìš©ì ì´ë¦„</label>
            <input type="text" id="userNameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        
        <div class="form-group">
            <label class="form-label" for="emailInput">ì´ë©”ì¼ ì£¼ì†Œ</label>
            <input type="email" id="emailInput" placeholder="example@email.com">
        </div>
        
        <div class="form-group">
            <label class="form-label" for="categorySelect">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
            <select id="categorySelect">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="frontend">í”„ë¡ íŠ¸ì—”ë“œ</option>
                <option value="backend">ë°±ì—”ë“œ</option>
                <option value="database">ë°ì´í„°ë² ì´ìŠ¤</option>
                <option value="devops">DevOps</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="messageInput">ë©”ì‹œì§€</label>
            <textarea id="messageInput" rows="4" placeholder="ìƒì„¸í•œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
        
        <div class="test-buttons">
            <button class="test-btn" onclick="testAction('save')" id="saveBtn">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
            <button class="test-btn" onclick="testAction('validate')" id="validateBtn">âœ… ìœ íš¨ì„± ê²€ì‚¬</button>
            <button class="test-btn" onclick="testAction('submit')" id="submitBtn">ğŸ“¤ ì œì¶œí•˜ê¸°</button>
            <button class="test-btn" onclick="testAction('reset')" id="resetBtn">ğŸ”„ ì´ˆê¸°í™”</button>
        </div>
        
        <div class="interactive-area" onclick="interactiveAreaClick()" id="interactiveArea">
            <h3>ğŸ¯ ìƒí˜¸ì‘ìš© í…ŒìŠ¤íŠ¸ ì˜ì—­</h3>
            <p>ì´ ì˜ì—­ì„ í´ë¦­í•˜ì—¬ ìƒí˜¸ì‘ìš©ì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”</p>
            <div id="clickCounter" style="font-size: 1.2em; margin-top: 10px;">í´ë¦­ íšŸìˆ˜: 0</div>
        </div>
    </div>
    
    <div class="controls-panel">
        <h3 style="margin-bottom: 20px;">ğŸ› ì‹¤ì‹œê°„ ë¡œê·¸</h3>
        <div class="logs-panel" id="logsPanel">
            AIRIS-MON í†µí•© ì„¸ì…˜ ë…¹í™”ê¸° ì´ˆê¸°í™” ì¤‘...
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let isRecording = false;
        let sessionId = null;
        let startTime = null;
        let recordedEvents = [];
        let clickCount = 0;
        let recordingTimer = null;
        let websocket = null;
        
        // ëª¨ë‹ˆí„°ë§ ë°ì´í„°
        let monitoringData = {
            activeConnections: 0,
            totalSessions: 0,
            currentEvents: 0,
            systemHealth: 100
        };
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeIntegratedSystem();
        });
        
        // í†µí•© ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        function initializeIntegratedSystem() {
            addLog('ğŸš€ AIRIS-MON í†µí•© ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');
            
            // WebSocket ì—°ê²° ì‹œë„
            connectWebSocket();
            
            // ì‹œìŠ¤í…œ ìƒíƒœ ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
            setInterval(updateMonitoringStatus, 2000);
            
            // ê¸°ì¡´ ì„¸ì…˜ í†µê³„ ë¡œë“œ
            loadSystemStats();
            
            addLog('âœ… í†µí•© ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
        }
        
        // WebSocket ì—°ê²°
        function connectWebSocket() {
            try {
                websocket = new WebSocket('ws://localhost:3100');
                
                websocket.onopen = function() {
                    addLog('ğŸ”Œ WebSocket ì—°ê²° ì„±ê³µ');
                    monitoringData.activeConnections = 1;
                    updateMonitoringDisplay();
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                websocket.onclose = function() {
                    addLog('âŒ WebSocket ì—°ê²° ì¢…ë£Œ');
                    monitoringData.activeConnections = 0;
                    updateMonitoringDisplay();
                };
                
                websocket.onerror = function(error) {
                    addLog('âš ï¸ WebSocket ì˜¤ë¥˜: ' + error.message);
                };
                
            } catch (error) {
                addLog('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // WebSocket ë©”ì‹œì§€ ì²˜ë¦¬
        function handleWebSocketMessage(data) {
            if (data.type === 'monitoring_update') {
                Object.assign(monitoringData, data.data);
                updateMonitoringDisplay();
            }
        }
        
        // ì‹œìŠ¤í…œ í†µê³„ ë¡œë“œ
        async function loadSystemStats() {
            try {
                const response = await fetch('/api/session-replay/stats');
                const stats = await response.json();
                
                if (stats.success) {
                    monitoringData.totalSessions = stats.stats.totalSessions || 0;
                    updateMonitoringDisplay();
                    addLog('ğŸ“Š ì‹œìŠ¤í…œ í†µê³„ ë¡œë“œ ì™„ë£Œ');
                }
            } catch (error) {
                addLog('âš ï¸ ì‹œìŠ¤í…œ í†µê³„ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ëª¨ë‹ˆí„°ë§ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateMonitoringStatus() {
            // ì‹œë®¬ë ˆì´ì…˜ëœ ì‹¤ì‹œê°„ ë°ì´í„° (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì„œë²„ì—ì„œ ë°›ì•„ì˜´)
            if (isRecording) {
                monitoringData.currentEvents = recordedEvents.length;
                monitoringData.systemHealth = Math.max(85, 100 - Math.floor(Math.random() * 15));
            }
            updateMonitoringDisplay();
        }
        
        // ëª¨ë‹ˆí„°ë§ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
        function updateMonitoringDisplay() {
            document.getElementById('activeConnections').textContent = monitoringData.activeConnections;
            document.getElementById('totalSessions').textContent = monitoringData.totalSessions;
            document.getElementById('currentEvents').textContent = monitoringData.currentEvents;
            document.getElementById('systemHealth').textContent = monitoringData.systemHealth + '%';
        }
        
        // í†µí•© ë…¹í™” ì‹œì‘
        async function startIntegratedRecording() {
            addLog('=== í†µí•© ì„¸ì…˜ ë…¹í™” ì‹œì‘ ===');
            
            if (isRecording) {
                alert('ì´ë¯¸ ë…¹í™” ì¤‘ì…ë‹ˆë‹¤!');
                return;
            }
            
            try {
                // ì„¸ì…˜ ì´ˆê¸°í™”
                sessionId = 'integrated_' + Date.now();
                startTime = Date.now();
                recordedEvents = [];
                clickCount = 0;
                isRecording = true;
                
                // ì„œë²„ì— ì„¸ì…˜ ì‹œì‘ ì•Œë¦¼
                const scenario = document.getElementById('scenarioSelect').value;
                await startServerSession(scenario);
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('playBtn').disabled = true;
                document.getElementById('recordingIndicator').style.display = 'block';
                document.getElementById('sessionInfo').style.display = 'block';
                
                // ì„¸ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸
                updateSessionInfo();
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                setupEnhancedEventListeners();
                
                // ë…¹í™” íƒ€ì´ë¨¸ ì‹œì‘
                startRecordingTimer();
                
                // ì´ˆê¸° DOM ìŠ¤ëƒ…ìƒ· ì €ì¥
                await recordDOMSnapshot();
                
                addLog('âœ… í†µí•© ë…¹í™” ì‹œì‘ ì„±ê³µ: ' + sessionId);
                
                // WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ì•Œë¦¼
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({
                        type: 'session_started',
                        sessionId: sessionId,
                        scenario: scenario
                    }));
                }
                
            } catch (error) {
                addLog('âŒ í†µí•© ë…¹í™” ì‹œì‘ ì‹¤íŒ¨: ' + error.message);
                alert('ë…¹í™” ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                resetRecording();
            }
        }
        
        // ì„œë²„ ì„¸ì…˜ ì‹œì‘
        async function startServerSession(scenario) {
            const response = await fetch('/api/session-replay/start-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scenario: scenario,
                    userAgent: navigator.userAgent,
                    ipAddress: 'integrated_client'
                })
            });
            
            if (!response.ok) {
                throw new Error('ì„œë²„ ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨');
            }
            
            const result = await response.json();
            addLog('ğŸ“¡ ì„œë²„ ì„¸ì…˜ ì‹œì‘: ' + result.sessionId);
        }
        
        // DOM ìŠ¤ëƒ…ìƒ· ê¸°ë¡
        async function recordDOMSnapshot() {
            const snapshot = {
                url: window.location.href,
                timestamp: Date.now() - startTime,
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                testArea: document.getElementById('testArea').innerHTML
            };
            
            await recordEvent('dom_snapshot', document.body, '', { snapshot });
            addLog('ğŸ“¸ DOM ìŠ¤ëƒ…ìƒ· ì €ì¥');
        }
        
        // í–¥ìƒëœ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEnhancedEventListeners() {
            addLog('ğŸ¯ í–¥ìƒëœ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •');
            
            // í´ë¦­ ì´ë²¤íŠ¸ (ì‹œê°ì  í”¼ë“œë°± í¬í•¨)
            document.addEventListener('click', async function(e) {
                if (!isRecording) return;
                
                // ì‹œê°ì  í”¼ë“œë°±
                e.target.classList.add('click-recording');
                setTimeout(() => e.target.classList.remove('click-recording'), 300);
                
                await recordEvent('click', e.target, e.target.textContent || e.target.value, {
                    clientX: e.clientX,
                    clientY: e.clientY,
                    elementRect: e.target.getBoundingClientRect()
                });
            });
            
            // ì…ë ¥ ì´ë²¤íŠ¸ (ì‹¤ì‹œê°„ í‘œì‹œ)
            document.addEventListener('input', async function(e) {
                if (!isRecording) return;
                
                e.target.classList.add('input-recording');
                setTimeout(() => e.target.classList.remove('input-recording'), 500);
                
                await recordEvent('input', e.target, e.target.value, {
                    inputType: e.inputType,
                    selectionStart: e.target.selectionStart
                });
            });
            
            // í¬ì»¤ìŠ¤/ë¸”ëŸ¬ ì´ë²¤íŠ¸
            document.addEventListener('focus', async function(e) {
                if (!isRecording) return;
                await recordEvent('focus', e.target, e.target.value || '');
            }, true);
            
            document.addEventListener('blur', async function(e) {
                if (!isRecording) return;
                await recordEvent('blur', e.target, e.target.value || '');
            }, true);
            
            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
            document.addEventListener('keydown', async function(e) {
                if (!isRecording) return;
                await recordEvent('keydown', e.target, e.key, {
                    keyCode: e.keyCode,
                    ctrlKey: e.ctrlKey,
                    shiftKey: e.shiftKey,
                    altKey: e.altKey
                });
            });
        }
        
        // í–¥ìƒëœ ì´ë²¤íŠ¸ ê¸°ë¡
        async function recordEvent(type, target, value, extraData = {}) {
            if (!isRecording) return;
            
            const rect = target.getBoundingClientRect();
            const event = {
                type: type,
                timestamp: Date.now() - startTime,
                target: {
                    tagName: target.tagName,
                    id: target.id,
                    className: target.className,
                    textContent: target.textContent ? target.textContent.substring(0, 100) : ''
                },
                value: value || '',
                position: {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                },
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                ...extraData
            };
            
            recordedEvents.push(event);
            
            // ì„œë²„ë¡œ ì‹¤ì‹œê°„ ì „ì†¡
            try {
                await fetch('/api/session-replay/add-event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        event: event
                    })
                });
            } catch (error) {
                addLog('âš ï¸ ì„œë²„ ì´ë²¤íŠ¸ ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
            }
            
            // UI ì—…ë°ì´íŠ¸
            updateSessionInfo();
            
            addLog(`ğŸ“ ì´ë²¤íŠ¸ ê¸°ë¡: ${type} - ${target.tagName}#${target.id}`);
        }
        
        // ë…¹í™” íƒ€ì´ë¨¸
        function startRecordingTimer() {
            recordingTimer = setInterval(() => {
                if (isRecording) {
                    updateSessionInfo();
                }
            }, 1000);
        }
        
        // ì„¸ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateSessionInfo() {
            if (!isRecording) return;
            
            const duration = Date.now() - startTime;
            const minutes = Math.floor(duration / 60000);
            const seconds = Math.floor((duration % 60000) / 1000);
            
            document.getElementById('sessionId').textContent = sessionId.substring(11, 25) + '...';
            document.getElementById('recordingTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('eventCount').textContent = recordedEvents.length;
            
            const dataSize = JSON.stringify(recordedEvents).length;
            document.getElementById('dataSize').textContent = (dataSize / 1024).toFixed(1) + ' KB';
        }
        
        // í†µí•© ë…¹í™” ì¤‘ì§€
        async function stopIntegratedRecording() {
            addLog('=== í†µí•© ì„¸ì…˜ ë…¹í™” ì¤‘ì§€ ===');
            
            if (!isRecording) {
                alert('ë…¹í™” ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤!');
                return;
            }
            
            try {
                isRecording = false;
                
                // íƒ€ì´ë¨¸ ì •ì§€
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
                
                // ìµœì¢… ìŠ¤ëƒ…ìƒ· ì €ì¥
                await recordDOMSnapshot();
                
                // ì„œë²„ ì„¸ì…˜ ì¢…ë£Œ
                await endServerSession();
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('playBtn').disabled = false;
                document.getElementById('recordingIndicator').style.display = 'none';
                
                // ì„¸ì…˜ ë°ì´í„° ë¡œì»¬ ì €ì¥
                saveSessionLocally();
                
                addLog(`âœ… í†µí•© ë…¹í™” ì™„ë£Œ: ${recordedEvents.length}ê°œ ì´ë²¤íŠ¸, ${clickCount}ë²ˆ í´ë¦­`);
                
                // ì„±ê³µ ì•Œë¦¼
                alert(`âœ… í†µí•© ì„¸ì…˜ ë…¹í™” ì™„ë£Œ!\n\nì„¸ì…˜ ID: ${sessionId}\nì´ë²¤íŠ¸ ìˆ˜: ${recordedEvents.length}ê°œ\ní´ë¦­ ìˆ˜: ${clickCount}ë²ˆ\në…¹í™” ì‹œê°„: ${formatDuration(Date.now() - startTime)}`);
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                monitoringData.totalSessions++;
                updateMonitoringDisplay();
                
            } catch (error) {
                addLog('âŒ í†µí•© ë…¹í™” ì¤‘ì§€ ì‹¤íŒ¨: ' + error.message);
                alert('ë…¹í™” ì¤‘ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ì„œë²„ ì„¸ì…˜ ì¢…ë£Œ
        async function endServerSession() {
            const response = await fetch('/api/session-replay/end-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sessionId: sessionId,
                    reason: 'user_stopped'
                })
            });
            
            if (response.ok) {
                addLog('ğŸ“¡ ì„œë²„ ì„¸ì…˜ ì¢…ë£Œ ì™„ë£Œ');
            }
        }
        
        // ë¡œì»¬ ì„¸ì…˜ ì €ì¥
        function saveSessionLocally() {
            const sessionData = {
                id: sessionId,
                startTime: startTime,
                endTime: Date.now(),
                duration: Date.now() - startTime,
                events: recordedEvents,
                eventCount: recordedEvents.length,
                clickCount: clickCount,
                scenario: document.getElementById('scenarioSelect').value,
                metadata: {
                    userAgent: navigator.userAgent,
                    viewport: `${window.innerWidth}x${window.innerHeight}`,
                    timestamp: new Date().toISOString()
                }
            };
            
            localStorage.setItem(sessionId, JSON.stringify(sessionData));
            addLog('ğŸ’¾ ë¡œì»¬ ì„¸ì…˜ ë°ì´í„° ì €ì¥ ì™„ë£Œ');
        }
        
        // í†µí•© ë¦¬í”Œë ˆì´ ì¬ìƒ
        function playIntegratedRecording() {
            addLog('=== í†µí•© ë¦¬í”Œë ˆì´ ì¬ìƒ ===');
            
            if (!sessionId || recordedEvents.length === 0) {
                alert('ì¬ìƒí•  ì„¸ì…˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // í–¥ìƒëœ í”Œë ˆì´ì–´ë¡œ ì´ë™
            const playerUrl = `enhanced-player.html?sessionId=${sessionId}`;
            const playerWindow = window.open(playerUrl, '_blank', 'width=1400,height=900,scrollbars=yes,resizable=yes');
            
            if (!playerWindow) {
                alert('âš ï¸ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            } else {
                addLog('ğŸ¬ í–¥ìƒëœ í”Œë ˆì´ì–´ ì°½ ì—´ë¦¼');
            }
        }
        
        // í…ŒìŠ¤íŠ¸ ì•¡ì…˜ í•¨ìˆ˜ë“¤
        function testAction(action) {
            addLog(`ğŸ¯ í…ŒìŠ¤íŠ¸ ì•¡ì…˜: ${action}`);
            
            const btn = event.target;
            const originalText = btn.textContent;
            
            switch (action) {
                case 'save':
                    btn.textContent = 'ğŸ’¾ ì €ì¥ ì¤‘...';
                    btn.style.background = 'linear-gradient(45deg, #00d2d3, #54a0ff)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 1000);
                    break;
                    
                case 'validate':
                    btn.textContent = 'âœ… ê²€ì‚¬ ì¤‘...';
                    btn.style.background = 'linear-gradient(45deg, #00d2d3, #1dd1a1)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 1500);
                    break;
                    
                case 'submit':
                    btn.textContent = 'ğŸ“¤ ì œì¶œ ì¤‘...';
                    btn.style.background = 'linear-gradient(45deg, #ff6b6b, #ee5a24)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                    break;
                    
                case 'reset':
                    // í¼ ì´ˆê¸°í™”
                    document.getElementById('userNameInput').value = '';
                    document.getElementById('emailInput').value = '';
                    document.getElementById('categorySelect').selectedIndex = 0;
                    document.getElementById('messageInput').value = '';
                    clickCount = 0;
                    document.getElementById('clickCounter').textContent = 'í´ë¦­ íšŸìˆ˜: 0';
                    
                    btn.textContent = 'ğŸ”„ ì´ˆê¸°í™” ì™„ë£Œ';
                    btn.style.background = 'linear-gradient(45deg, #ffa726, #ff7043)';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 1000);
                    break;
            }
        }
        
        // ìƒí˜¸ì‘ìš© ì˜ì—­ í´ë¦­
        function interactiveAreaClick() {
            clickCount++;
            document.getElementById('clickCounter').textContent = `í´ë¦­ íšŸìˆ˜: ${clickCount}`;
            
            // ìƒ‰ìƒ ë³€ê²½ íš¨ê³¼
            const area = document.getElementById('interactiveArea');
            const colors = [
                'linear-gradient(45deg, #f093fb, #f5576c)',
                'linear-gradient(45deg, #4facfe, #00f2fe)',
                'linear-gradient(45deg, #43e97b, #38f9d7)',
                'linear-gradient(45deg, #fa709a, #fee140)',
                'linear-gradient(45deg, #a8edea, #fed6e3)'
            ];
            
            area.style.background = colors[Math.floor(Math.random() * colors.length)];
            
            addLog(`ğŸ¯ ìƒí˜¸ì‘ìš© ì˜ì—­ í´ë¦­ #${clickCount}`);
        }
        
        // ë…¹í™” ë¦¬ì…‹
        function resetRecording() {
            isRecording = false;
            sessionId = null;
            startTime = null;
            recordedEvents = [];
            clickCount = 0;
            
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('recordingIndicator').style.display = 'none';
            document.getElementById('sessionInfo').style.display = 'none';
        }
        
        // ì‹œê°„ í¬ë§·íŒ…
        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}ë¶„ ${seconds}ì´ˆ`;
        }
        
        // ë¡œê·¸ ì¶”ê°€ í•¨ìˆ˜
        function addLog(message) {
            const logsPanel = document.getElementById('logsPanel');
            const timestamp = new Date().toLocaleTimeString();
            logsPanel.textContent += `[${timestamp}] ${message}\n`;
            logsPanel.scrollTop = logsPanel.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (isRecording) {
                // ì„¸ì…˜ ìë™ ì €ì¥ ì‹œë„
                saveSessionLocally();
            }
            
            if (websocket) {
                websocket.close();
            }
        });
        
        addLog('ğŸ¬ AIRIS-MON í†µí•© ì„¸ì…˜ ë…¹í™”ê¸° ë¡œë”© ì™„ë£Œ');
    </script>
</body>
</html>