<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë””ë²„ê·¸ - CRUD ë§¤íŠ¸ë¦­ìŠ¤ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .crud-matrix {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .crud-matrix th, .crud-matrix td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .crud-matrix th {
            background: #f0f0f0;
        }
        .crud-badge {
            display: inline-block;
            padding: 2px 6px;
            margin: 1px;
            border-radius: 3px;
            font-size: 11px;
            color: white;
        }
        .crud-c { background: #28a745; }
        .crud-r { background: #17a2b8; }
        .crud-u { background: #ffc107; color: #333; }
        .crud-d { background: #dc3545; }
        #log {
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ CRUD ë§¤íŠ¸ë¦­ìŠ¤ ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸</h1>
    
    <div class="test-section">
        <h2>API í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testCorrelationAPI()">ìƒê´€ë„ API í…ŒìŠ¤íŠ¸</button>
        <button onclick="testProgramsAPI()">í”„ë¡œê·¸ë¨ API í…ŒìŠ¤íŠ¸</button>
        <button onclick="testTablesAPI()">í…Œì´ë¸” API í…ŒìŠ¤íŠ¸</button>
        <button onclick="clearLog()">ë¡œê·¸ í´ë¦¬ì–´</button>
    </div>
    
    <div class="test-section">
        <h2>CRUD ë§¤íŠ¸ë¦­ìŠ¤</h2>
        <table class="crud-matrix" id="testMatrix">
            <thead>
                <tr>
                    <th>í”„ë¡œê·¸ë¨ / í…Œì´ë¸”</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    
    <div class="test-section">
        <h2>í”„ë¡œê·¸ë¨ ë¦¬ìŠ¤íŠ¸</h2>
        <div id="programList"></div>
    </div>
    
    <div class="test-section">
        <h2>í…Œì´ë¸” ë¦¬ìŠ¤íŠ¸</h2>
        <div id="tableList"></div>
    </div>
    
    <div class="test-section">
        <h2>ë¡œê·¸</h2>
        <div id="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testCorrelationAPI() {
            try {
                log('ğŸ”„ /api/analysis/correlation í˜¸ì¶œ ì¤‘...');
                const response = await fetch('/api/analysis/correlation');
                log(`ğŸ“¡ ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                log(`ğŸ“¦ ì‘ë‹µ ë°ì´í„° í¬ê¸°: ${JSON.stringify(data).length} bytes`);
                log(`âœ… success: ${data.success}`);
                
                if (data.success && data.data) {
                    log(`ğŸ“‹ í”„ë¡œê·¸ë¨: ${data.data.programs?.length || 0}ê°œ`);
                    log(`ğŸ—„ï¸ í…Œì´ë¸”: ${data.data.tables?.length || 0}ê°œ`);
                    log(`ğŸ”— ë§¤íŠ¸ë¦­ìŠ¤: ${Object.keys(data.data.matrix || {}).length}ê°œ í”„ë¡œê·¸ë¨`);
                    
                    // ë§¤íŠ¸ë¦­ìŠ¤ ë Œë”ë§ í…ŒìŠ¤íŠ¸
                    renderTestMatrix(data.data);
                }
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function testProgramsAPI() {
            try {
                log('ğŸ”„ /api/analysis/programs í˜¸ì¶œ ì¤‘...');
                const response = await fetch('/api/analysis/programs');
                const data = await response.json();
                
                log(`ğŸ“¦ í”„ë¡œê·¸ë¨ ë°ì´í„°: ${data.success ? 'OK' : 'FAIL'}`);
                if (data.success) {
                    log(`ğŸ“‹ í”„ë¡œê·¸ë¨ ê°œìˆ˜: ${data.data?.length || 0}`);
                    displayTestPrograms(data.data || []);
                }
            } catch (error) {
                log(`âŒ í”„ë¡œê·¸ë¨ API ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function testTablesAPI() {
            try {
                log('ğŸ”„ /api/analysis/tables í˜¸ì¶œ ì¤‘...');
                const response = await fetch('/api/analysis/tables');
                const data = await response.json();
                
                log(`ğŸ“¦ í…Œì´ë¸” ë°ì´í„°: ${data.success ? 'OK' : 'FAIL'}`);
                if (data.success) {
                    log(`ğŸ—„ï¸ í…Œì´ë¸” ê°œìˆ˜: ${data.data?.length || 0}`);
                    displayTestTables(data.data || []);
                }
            } catch (error) {
                log(`âŒ í…Œì´ë¸” API ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        function renderTestMatrix(data) {
            if (!data || !data.programs || !data.tables) {
                log('âŒ ë§¤íŠ¸ë¦­ìŠ¤ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ');
                return;
            }
            
            const matrix = document.getElementById('testMatrix');
            const thead = matrix.querySelector('thead tr');
            const tbody = matrix.querySelector('tbody');
            
            // í—¤ë” ì´ˆê¸°í™”
            while (thead.children.length > 1) {
                thead.removeChild(thead.lastChild);
            }
            
            // í…Œì´ë¸” í—¤ë” ì¶”ê°€
            data.tables.forEach(table => {
                const th = document.createElement('th');
                th.textContent = table.name;
                thead.appendChild(th);
            });
            
            // ë°”ë”” ì´ˆê¸°í™”
            tbody.innerHTML = '';
            
            // í”„ë¡œê·¸ë¨ í–‰ ì¶”ê°€
            data.programs.forEach(program => {
                const tr = document.createElement('tr');
                
                // í”„ë¡œê·¸ë¨ ì´ë¦„
                const programCell = document.createElement('td');
                programCell.textContent = program.name;
                programCell.style.fontWeight = 'bold';
                tr.appendChild(programCell);
                
                // CRUD ì…€ë“¤
                data.tables.forEach(table => {
                    const crudCell = document.createElement('td');
                    const crudOps = data.matrix[program.id] && data.matrix[program.id][table.id];
                    
                    if (crudOps && crudOps.length > 0) {
                        crudOps.forEach(op => {
                            const badge = document.createElement('span');
                            badge.className = `crud-badge crud-${op.toLowerCase()}`;
                            badge.textContent = op;
                            crudCell.appendChild(badge);
                        });
                    }
                    
                    tr.appendChild(crudCell);
                });
                
                tbody.appendChild(tr);
            });
            
            log(`âœ… ë§¤íŠ¸ë¦­ìŠ¤ ë Œë”ë§ ì™„ë£Œ: ${data.programs.length} x ${data.tables.length}`);
        }
        
        function displayTestPrograms(programs) {
            const container = document.getElementById('programList');
            container.innerHTML = programs.map(program => `
                <div style="padding: 8px; border: 1px solid #ddd; margin: 4px 0; border-radius: 4px;">
                    <strong>${program.name}</strong> (${program.type})<br>
                    <small>LOC: ${program.loc}, ë³µì¡ë„: ${program.complexity}, ì˜ì¡´ì„±: ${program.dependencies}</small>
                </div>
            `).join('');
        }
        
        function displayTestTables(tables) {
            const container = document.getElementById('tableList');
            container.innerHTML = tables.map(table => `
                <div style="padding: 8px; border: 1px solid #ddd; margin: 4px 0; border-radius: 4px;">
                    <strong>${table.name}</strong> (${table.type})<br>
                    <small>ì—”ì§„: ${table.engine}, í¬ê¸°: ${table.size}, ì—°ê²°: ${table.connections}</small>
                </div>
            `).join('');
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í…ŒìŠ¤íŠ¸
        window.addEventListener('DOMContentLoaded', function() {
            log('ğŸ¯ ë””ë²„ê·¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            log('ğŸ“ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ APIë¥¼ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”');
        });
    </script>
</body>
</html>