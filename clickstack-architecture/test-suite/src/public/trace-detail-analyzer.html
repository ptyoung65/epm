<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶”ì  ìƒì„¸ ë¶„ì„ê¸° | AIRIS-MON</title>
    <script src="/components/common-layout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --white: #ffffff;
        }

        .trace-detail-header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .trace-info {
            flex: 1;
            min-width: 300px;
        }

        .trace-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .trace-meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .trace-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .btn-success { background: var(--success); color: var(--white); }

        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }

        .analysis-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .analysis-panel {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
        }

        .panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .panel-content {
            padding: 1.5rem;
        }

        .waterfall-container {
            height: 600px;
            overflow: auto;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
        }

        .waterfall-chart {
            min-width: 800px;
            height: 100%;
        }

        .span-row {
            display: flex;
            align-items: center;
            height: 40px;
            border-bottom: 1px solid var(--gray-100);
            padding: 0 1rem;
            position: relative;
        }

        .span-row:hover {
            background: var(--gray-50);
        }

        .span-name {
            width: 250px;
            font-weight: 500;
            color: var(--gray-900);
            font-size: 0.875rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .span-timeline {
            flex: 1;
            position: relative;
            margin-left: 1rem;
        }

        .span-bar {
            height: 20px;
            border-radius: 4px;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--white);
            cursor: pointer;
        }

        .span-bar.service-frontend { background: #3b82f6; }
        .span-bar.service-api { background: #10b981; }
        .span-bar.service-database { background: #f59e0b; }
        .span-bar.service-cache { background: #8b5cf6; }
        .span-bar.service-external { background: #ef4444; }
        .span-bar.service-default { background: var(--gray-400); }

        .span-bar:hover {
            filter: brightness(1.1);
        }

        .timeline-ruler {
            height: 30px;
            border-bottom: 2px solid var(--gray-200);
            position: relative;
            margin: 0 1rem 0 251px;
        }

        .ruler-tick {
            position: absolute;
            top: 0;
            height: 100%;
            border-left: 1px solid var(--gray-300);
            font-size: 0.75rem;
            color: var(--gray-500);
            padding-left: 4px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .metric-value {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .span-details {
            margin-top: 2rem;
        }

        .span-details-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .span-header {
            padding: 1rem 1.5rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .span-header:hover {
            background: var(--gray-100);
        }

        .span-info {
            flex: 1;
        }

        .span-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .span-subtitle {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .span-duration {
            font-weight: 600;
            color: var(--primary);
        }

        .span-body {
            padding: 1.5rem;
            display: none;
        }

        .span-body.expanded {
            display: block;
        }

        .attributes-table {
            width: 100%;
            margin-bottom: 1.5rem;
        }

        .attributes-table th,
        .attributes-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.875rem;
        }

        .attributes-table th {
            font-weight: 600;
            color: var(--gray-700);
            background: var(--gray-50);
        }

        .events-list {
            margin-top: 1rem;
        }

        .event-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .event-time {
            font-weight: 600;
            color: var(--primary);
            font-family: monospace;
        }

        .event-name {
            font-weight: 500;
            color: var(--gray-900);
        }

        .event-attributes {
            color: var(--gray-600);
            font-size: 0.75rem;
        }

        .performance-insights {
            grid-column: 1 / -1;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .insight-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .insight-card.warning {
            border-left: 4px solid var(--warning);
        }

        .insight-card.error {
            border-left: 4px solid var(--error);
        }

        .insight-card.info {
            border-left: 4px solid var(--primary);
        }

        .insight-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .insight-content {
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .chart-container {
            height: 300px;
            margin: 1rem 0;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--gray-500);
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--gray-900);
        }
        
        .close {
            font-size: 2rem;
            font-weight: bold;
            color: var(--gray-400);
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover {
            color: var(--gray-600);
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .trace-filter {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .trace-filter input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .trace-list-container {
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .trace-list-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .trace-list-table th {
            background: var(--gray-50);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .trace-list-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .trace-list-table tbody tr:hover {
            background: var(--gray-50);
        }
        
        .trace-list-table .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .trace-list-table .status-badge.success {
            background: #dcfce7;
            color: #166534;
        }
        
        .trace-list-table .status-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-success { background: var(--success); }
        .status-error { background: var(--error); }
        .status-warning { background: var(--warning); }

        .dependency-graph {
            height: 400px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            background: var(--white);
        }

        .legend {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        @media (max-width: 1024px) {
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .span-name {
                width: 150px;
            }
            
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Trace ì„ íƒ ëª¨ë‹¬ -->
    <div id="traceModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ClickHouse Trace ì„ íƒ</h2>
                <span class="close" onclick="closeTraceModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="trace-filter">
                    <input type="text" id="traceFilter" placeholder="Trace ID ë˜ëŠ” ì„œë¹„ìŠ¤ëª…ìœ¼ë¡œ ê²€ìƒ‰..." onkeyup="filterTraces()">
                    <button class="btn btn-primary" onclick="loadClickHouseTraces()">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div class="trace-list-container">
                    <table class="trace-list-table">
                        <thead>
                            <tr>
                                <th>Trace ID</th>
                                <th>ì„œë¹„ìŠ¤</th>
                                <th>ì‘ì—…</th>
                                <th>ì‹œì‘ ì‹œê°„</th>
                                <th>ì§€ì†ì‹œê°„</th>
                                <th>ìƒíƒœ</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody id="traceListBody">
                            <tr><td colspan="7" style="text-align: center;">ë¡œë”© ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="airis-content-wrapper">
        <!-- í—¤ë” -->
        <div class="trace-detail-header">
            <div class="header-content">
                <div class="trace-info">
                    <h1 class="trace-title" id="traceTitle">ì¶”ì  ë¡œë”© ì¤‘...</h1>
                    <div class="trace-meta" id="traceMeta">
                        <span id="traceId">-</span>
                        <span id="traceStatus">-</span>
                        <span id="traceTime">-</span>
                    </div>
                </div>
                <div class="trace-actions">
                    <button class="btn btn-success" onclick="showTraceSelector()">ğŸ” ì¶”ì  ì„ íƒ</button>
                    <button class="btn btn-secondary" onclick="history.back()">â¬…ï¸ ëŒì•„ê°€ê¸°</button>
                    <button class="btn btn-secondary" onclick="exportTrace()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn btn-primary" onclick="refreshTrace()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
        </div>

        <!-- ë©”íŠ¸ë¦­ ê°œìš” -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" style="color: var(--primary);" id="totalDuration">-</div>
                <div class="metric-label">ì´ ì‹¤í–‰ì‹œê°„</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: var(--success);" id="spanCount">-</div>
                <div class="metric-label">ìŠ¤íŒ¬ ê°œìˆ˜</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: var(--warning);" id="serviceCount">-</div>
                <div class="metric-label">ì„œë¹„ìŠ¤ ê°œìˆ˜</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" style="color: var(--error);" id="errorCount">-</div>
                <div class="metric-label">ì˜¤ë¥˜ ê°œìˆ˜</div>
            </div>
        </div>

        <!-- ë¶„ì„ ê·¸ë¦¬ë“œ -->
        <div class="analysis-grid">
            <!-- Waterfall ì°¨íŠ¸ -->
            <div class="analysis-panel">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸŒŠ Waterfall ì°¨íŠ¸</h2>
                </div>
                <div class="panel-content">
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color service-frontend"></div>
                            <span>í”„ë¡ íŠ¸ì—”ë“œ</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color service-api"></div>
                            <span>API</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color service-database"></div>
                            <span>ë°ì´í„°ë² ì´ìŠ¤</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color service-cache"></div>
                            <span>ìºì‹œ</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color service-external"></div>
                            <span>ì™¸ë¶€ API</span>
                        </div>
                    </div>
                    
                    <div class="waterfall-container" id="waterfallContainer">
                        <div class="loading" id="waterfallLoading">
                            <div class="spinner"></div>
                            <span>Waterfall ì°¨íŠ¸ ìƒì„± ì¤‘...</span>
                        </div>
                        <div class="waterfall-chart" id="waterfallChart" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- ì„œë¹„ìŠ¤ ì˜ì¡´ì„± ê·¸ë˜í”„ -->
            <div class="analysis-panel">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ”— ì„œë¹„ìŠ¤ ì˜ì¡´ì„±</h2>
                </div>
                <div class="panel-content">
                    <div class="dependency-graph" id="dependencyGraph">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>ì˜ì¡´ì„± ê·¸ë˜í”„ ìƒì„± ì¤‘...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì„±ëŠ¥ ì¸ì‚¬ì´íŠ¸ -->
        <div class="analysis-panel performance-insights">
            <div class="panel-header">
                <h2 class="panel-title">ğŸ’¡ ì„±ëŠ¥ ì¸ì‚¬ì´íŠ¸</h2>
            </div>
            <div class="panel-content">
                <div class="insights-grid" id="insightsGrid">
                    <!-- ì¸ì‚¬ì´íŠ¸ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>

        <!-- ìŠ¤íŒ¬ ìƒì„¸ ì •ë³´ -->
        <div class="analysis-panel">
            <div class="panel-header">
                <h2 class="panel-title">ğŸ“‹ ìŠ¤íŒ¬ ìƒì„¸ ì •ë³´</h2>
            </div>
            <div class="panel-content">
                <div class="span-details" id="spanDetails">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>ìŠ¤íŒ¬ ì •ë³´ ë¡œë”© ì¤‘...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentTrace = null;
        let waterfallChart = null;
        let dependencyChart = null;
        let allTraces = [];
        let filteredTraces = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeTraceAnalyzer();
            
            // URLì— trace íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ë¡œë“œ, ì—†ìœ¼ë©´ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
            const urlParams = new URLSearchParams(window.location.search);
            const traceId = urlParams.get('trace');
            
            if (traceId) {
                loadTraceData();
            } else {
                showTraceSelector();
            }
        });

        // ì¶”ì  ë¶„ì„ê¸° ì´ˆê¸°í™”
        function initializeTraceAnalyzer() {
            console.log('ì¶”ì  ìƒì„¸ ë¶„ì„ê¸° ì´ˆê¸°í™” ì¤‘...');
            
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì¶”ì  ID ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const traceId = urlParams.get('trace');
            
            if (!traceId) {
                showAlert('ì¶”ì  IDê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            console.log('ë¶„ì„í•  ì¶”ì  ID:', traceId);
        }

        // ì¶”ì  ë°ì´í„° ë¡œë“œ
        async function loadTraceData() {
            const urlParams = new URLSearchParams(window.location.search);
            const traceId = urlParams.get('trace');
            
            if (!traceId) return;
            
            try {
                // APIì—ì„œ ìƒì„¸ ì¶”ì  ë°ì´í„° ë¡œë“œ
                const response = await fetch(`/api/opentelemetry/traces/${traceId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentTrace = data.trace;
                    displayTraceOverview(currentTrace);
                    generateWaterfallChart(currentTrace);
                    generateDependencyGraph(currentTrace);
                    generatePerformanceInsights(currentTrace);
                    displaySpanDetails(currentTrace);
                } else {
                    throw new Error(data.error || 'ì¶”ì  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('ì¶”ì  ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                // ClickHouseì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„
                if (traceId) {
                    await loadClickHouseTraceData(traceId);
                } else {
                    generateSampleTraceData(traceId || 'trace_sample_' + Date.now());
                }
            }
        }

        // ìƒ˜í”Œ ì¶”ì  ë°ì´í„° ìƒì„±
        function generateSampleTraceData(traceId) {
            console.log('ìƒ˜í”Œ ì¶”ì  ë°ì´í„° ìƒì„±:', traceId);
            
            currentTrace = {
                traceId: traceId,
                operationName: 'E-Commerce ê²°ì œ í”„ë¡œì„¸ìŠ¤',
                serviceName: 'payment-service',
                status: 'success',
                startTime: new Date(Date.now() - 5000).toISOString(),
                duration: 1847,
                spans: [
                    {
                        spanId: 'span_001',
                        operationName: 'HTTP GET /checkout',
                        serviceName: 'web-frontend',
                        startTime: 0,
                        duration: 45,
                        status: 'success',
                        tags: {
                            'http.method': 'GET',
                            'http.url': '/checkout',
                            'http.status_code': 200,
                            'user.id': 'user_12345'
                        },
                        events: [
                            { name: 'request.start', timestamp: 0 },
                            { name: 'validation.complete', timestamp: 15 },
                            { name: 'response.sent', timestamp: 45 }
                        ]
                    },
                    {
                        spanId: 'span_002',
                        operationName: 'API Gateway',
                        serviceName: 'api-gateway',
                        startTime: 45,
                        duration: 25,
                        status: 'success',
                        tags: {
                            'component': 'api-gateway',
                            'version': 'v2.1.0'
                        },
                        events: []
                    },
                    {
                        spanId: 'span_003',
                        operationName: 'User Authentication',
                        serviceName: 'auth-service',
                        startTime: 70,
                        duration: 180,
                        status: 'success',
                        tags: {
                            'auth.method': 'jwt',
                            'user.role': 'customer',
                            'db.statement': 'SELECT * FROM users WHERE token = ?'
                        },
                        events: [
                            { name: 'token.validation.start', timestamp: 70 },
                            { name: 'db.query.start', timestamp: 85 },
                            { name: 'db.query.complete', timestamp: 120 },
                            { name: 'auth.complete', timestamp: 250 }
                        ]
                    },
                    {
                        spanId: 'span_004',
                        operationName: 'Cart Validation',
                        serviceName: 'cart-service',
                        startTime: 250,
                        duration: 220,
                        status: 'success',
                        tags: {
                            'cart.items.count': 3,
                            'db.statement': 'SELECT * FROM cart_items WHERE user_id = ?'
                        },
                        events: []
                    },
                    {
                        spanId: 'span_005',
                        operationName: 'Inventory Check',
                        serviceName: 'inventory-service',
                        startTime: 470,
                        duration: 310,
                        status: 'success',
                        tags: {
                            'inventory.reserved': true,
                            'products.checked': 3
                        },
                        events: []
                    },
                    {
                        spanId: 'span_006',
                        operationName: 'Payment Processing',
                        serviceName: 'payment-service',
                        startTime: 780,
                        duration: 450,
                        status: 'success',
                        tags: {
                            'payment.method': 'credit_card',
                            'payment.amount': 129.99,
                            'payment.currency': 'USD',
                            'external.gateway': 'stripe'
                        },
                        events: [
                            { name: 'payment.validate', timestamp: 780 },
                            { name: 'external.api.call', timestamp: 820 },
                            { name: 'payment.confirmed', timestamp: 1200 },
                            { name: 'receipt.generated', timestamp: 1230 }
                        ]
                    },
                    {
                        spanId: 'span_007',
                        operationName: 'Order Creation',
                        serviceName: 'order-service',
                        startTime: 1230,
                        duration: 180,
                        status: 'success',
                        tags: {
                            'order.id': 'ORDER_789123',
                            'order.total': 129.99
                        },
                        events: []
                    },
                    {
                        spanId: 'span_008',
                        operationName: 'Notification Send',
                        serviceName: 'notification-service',
                        startTime: 1410,
                        duration: 85,
                        status: 'success',
                        tags: {
                            'notification.type': 'email',
                            'template': 'order_confirmation'
                        },
                        events: []
                    },
                    {
                        spanId: 'span_009',
                        operationName: 'Cache Update',
                        serviceName: 'cache-service',
                        startTime: 1495,
                        duration: 65,
                        status: 'success',
                        tags: {
                            'cache.key': 'user:12345:orders',
                            'cache.ttl': 3600
                        },
                        events: []
                    },
                    {
                        spanId: 'span_010',
                        operationName: 'Response',
                        serviceName: 'api-gateway',
                        startTime: 1560,
                        duration: 35,
                        status: 'success',
                        tags: {
                            'http.status_code': 200,
                            'response.size': 1024
                        },
                        events: []
                    }
                ]
            };
            
            displayTraceOverview(currentTrace);
            generateWaterfallChart(currentTrace);
            generateDependencyGraph(currentTrace);
            generatePerformanceInsights(currentTrace);
            displaySpanDetails(currentTrace);
        }

        // ì¶”ì  ê°œìš” í‘œì‹œ
        function displayTraceOverview(trace) {
            document.getElementById('traceTitle').textContent = trace.operationName;
            document.getElementById('traceId').textContent = `ID: ${trace.traceId}`;
            document.getElementById('traceStatus').innerHTML = `<span class="status-indicator status-${trace.status}"></span>${trace.status.toUpperCase()}`;
            document.getElementById('traceTime').textContent = new Date(trace.startTime).toLocaleString();
            
            // ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
            document.getElementById('totalDuration').textContent = `${trace.duration}ms`;
            document.getElementById('spanCount').textContent = trace.spans.length;
            
            const uniqueServices = [...new Set(trace.spans.map(s => s.serviceName))];
            document.getElementById('serviceCount').textContent = uniqueServices.length;
            
            const errorCount = trace.spans.filter(s => s.status === 'error').length;
            document.getElementById('errorCount').textContent = errorCount;
        }

        // Waterfall ì°¨íŠ¸ ìƒì„±
        function generateWaterfallChart(trace) {
            console.log('Waterfall ì°¨íŠ¸ ìƒì„± ì¤‘...');
            
            const container = document.getElementById('waterfallChart');
            const loading = document.getElementById('waterfallLoading');
            
            // ì‹œê°„ì¶• ê³„ì‚°
            const maxDuration = trace.duration;
            const timelineWidth = 500;
            
            // ë£°ëŸ¬ ìƒì„±
            const rulerHtml = generateTimelineRuler(maxDuration, timelineWidth);
            
            // ìŠ¤íŒ¬ í–‰ë“¤ ìƒì„±
            const spansHtml = trace.spans
                .sort((a, b) => a.startTime - b.startTime)
                .map(span => generateSpanRow(span, maxDuration, timelineWidth))
                .join('');
            
            container.innerHTML = `
                <div class="timeline-ruler">${rulerHtml}</div>
                ${spansHtml}
            `;
            
            // ë¡œë”© ìˆ¨ê¸°ê¸°, ì°¨íŠ¸ ë³´ì´ê¸°
            loading.style.display = 'none';
            container.style.display = 'block';
            
            // ìŠ¤íŒ¬ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            container.querySelectorAll('.span-bar').forEach(bar => {
                bar.addEventListener('click', (e) => {
                    const spanId = e.target.getAttribute('data-span-id');
                    highlightSpan(spanId);
                    showSpanTooltip(e, spanId);
                });
            });
        }

        // íƒ€ì„ë¼ì¸ ë£°ëŸ¬ ìƒì„±
        function generateTimelineRuler(maxDuration, width) {
            const ticks = [];
            const tickCount = 10;
            const interval = maxDuration / tickCount;
            
            for (let i = 0; i <= tickCount; i++) {
                const time = i * interval;
                const position = (time / maxDuration) * width;
                ticks.push(`
                    <div class="ruler-tick" style="left: ${position}px;">
                        ${Math.round(time)}ms
                    </div>
                `);
            }
            
            return ticks.join('');
        }

        // ìŠ¤íŒ¬ í–‰ ìƒì„±
        function generateSpanRow(span, maxDuration, timelineWidth) {
            const startPercent = (span.startTime / maxDuration) * 100;
            const widthPercent = (span.duration / maxDuration) * 100;
            
            // ì„œë¹„ìŠ¤ íƒ€ì…ë³„ í´ë˜ìŠ¤ ê²°ì •
            let serviceClass = 'service-default';
            if (span.serviceName.includes('frontend') || span.serviceName.includes('web')) {
                serviceClass = 'service-frontend';
            } else if (span.serviceName.includes('api') || span.serviceName.includes('gateway')) {
                serviceClass = 'service-api';
            } else if (span.serviceName.includes('database') || span.serviceName.includes('db')) {
                serviceClass = 'service-database';
            } else if (span.serviceName.includes('cache')) {
                serviceClass = 'service-cache';
            } else if (span.serviceName.includes('payment') || span.serviceName.includes('external')) {
                serviceClass = 'service-external';
            }
            
            return `
                <div class="span-row" data-span-id="${span.spanId}">
                    <div class="span-name" title="${span.operationName} (${span.serviceName})">
                        ${span.operationName}
                    </div>
                    <div class="span-timeline">
                        <div class="span-bar ${serviceClass}" 
                             data-span-id="${span.spanId}"
                             style="left: ${startPercent}%; width: ${widthPercent}%;"
                             title="${span.operationName} - ${span.duration}ms">
                            ${span.duration}ms
                        </div>
                    </div>
                </div>
            `;
        }

        // ì„œë¹„ìŠ¤ ì˜ì¡´ì„± ê·¸ë˜í”„ ìƒì„±
        function generateDependencyGraph(trace) {
            console.log('ì„œë¹„ìŠ¤ ì˜ì¡´ì„± ê·¸ë˜í”„ ìƒì„± ì¤‘...');
            
            const container = d3.select('#dependencyGraph');
            container.selectAll('*').remove();
            
            const width = container.node().clientWidth;
            const height = 400;
            
            // ì„œë¹„ìŠ¤ ë…¸ë“œ ìƒì„±
            const services = [...new Set(trace.spans.map(s => s.serviceName))];
            const nodes = services.map(service => ({
                id: service,
                name: service,
                calls: trace.spans.filter(s => s.serviceName === service).length
            }));
            
            // ì„œë¹„ìŠ¤ ê°„ ì—°ê²° ìƒì„±
            const links = [];
            for (let i = 0; i < trace.spans.length - 1; i++) {
                const current = trace.spans[i];
                const next = trace.spans[i + 1];
                
                if (current.serviceName !== next.serviceName) {
                    const existing = links.find(l => 
                        l.source === current.serviceName && l.target === next.serviceName);
                    if (existing) {
                        existing.value++;
                    } else {
                        links.push({
                            source: current.serviceName,
                            target: next.serviceName,
                            value: 1
                        });
                    }
                }
            }
            
            // D3.js í¬ìŠ¤ ì‹œë®¬ë ˆì´ì…˜
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));
            
            // ë§í¬ ê·¸ë¦¬ê¸°
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('stroke', '#999')
                .attr('stroke-opacity', 0.6)
                .attr('stroke-width', d => Math.sqrt(d.value) * 2);
            
            // ë…¸ë“œ ê·¸ë¦¬ê¸°
            const node = svg.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter().append('circle')
                .attr('r', d => Math.sqrt(d.calls) * 5 + 10)
                .attr('fill', d => getServiceColor(d.id))
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            // ë¼ë²¨ ì¶”ê°€
            const label = svg.append('g')
                .selectAll('text')
                .data(nodes)
                .enter().append('text')
                .text(d => d.name.split('-')[0])
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .attr('text-anchor', 'middle')
                .attr('fill', '#333');
            
            // ì‹œë®¬ë ˆì´ì…˜ ì—…ë°ì´íŠ¸
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y + 5);
            });
            
            // ë“œë˜ê·¸ í•¨ìˆ˜ë“¤
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        // ì„œë¹„ìŠ¤ë³„ ìƒ‰ìƒ ë°˜í™˜
        function getServiceColor(serviceName) {
            const colors = {
                'web-frontend': '#3b82f6',
                'api-gateway': '#10b981',
                'auth-service': '#f59e0b',
                'cart-service': '#8b5cf6',
                'inventory-service': '#ef4444',
                'payment-service': '#06b6d4',
                'order-service': '#84cc16',
                'notification-service': '#f97316',
                'cache-service': '#ec4899'
            };
            
            return colors[serviceName] || '#6b7280';
        }

        // ì„±ëŠ¥ ì¸ì‚¬ì´íŠ¸ ìƒì„±
        function generatePerformanceInsights(trace) {
            console.log('ì„±ëŠ¥ ì¸ì‚¬ì´íŠ¸ ìƒì„± ì¤‘...');
            
            const insights = [];
            
            // ê°€ì¥ ëŠë¦° ìŠ¤íŒ¬ ë¶„ì„
            const slowestSpan = trace.spans.reduce((prev, current) => 
                (prev.duration > current.duration) ? prev : current);
            
            if (slowestSpan.duration > trace.duration * 0.3) {
                insights.push({
                    type: 'warning',
                    title: 'ë³‘ëª© ì§€ì  ë°œê²¬',
                    content: `${slowestSpan.serviceName}ì˜ ${slowestSpan.operationName} ì‘ì—…ì´ ì „ì²´ ì‹œê°„ì˜ ${Math.round((slowestSpan.duration / trace.duration) * 100)}%ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤. ìµœì í™”ë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”.`
                });
            }
            
            // ì˜¤ë¥˜ ë¶„ì„
            const errorSpans = trace.spans.filter(s => s.status === 'error');
            if (errorSpans.length > 0) {
                insights.push({
                    type: 'error',
                    title: 'ì˜¤ë¥˜ ë°œìƒ',
                    content: `${errorSpans.length}ê°œì˜ ìŠ¤íŒ¬ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì£¼ìš” ì˜¤ë¥˜: ${errorSpans.map(s => s.serviceName).join(', ')}`
                });
            }
            
            // ê¸´ ì‹¤í–‰ì‹œê°„ ê²½ê³ 
            if (trace.duration > 2000) {
                insights.push({
                    type: 'warning',
                    title: 'ê¸´ ì‘ë‹µì‹œê°„',
                    content: `ì´ ì‹¤í–‰ì‹œê°„ ${trace.duration}msê°€ ê¶Œì¥ ì„ê³„ê°’(2ì´ˆ)ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ì ê²½í—˜ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
                });
            }
            
            // ë§ì€ ìŠ¤íŒ¬ ê²½ê³ 
            if (trace.spans.length > 20) {
                insights.push({
                    type: 'info',
                    title: 'ë³µì¡í•œ íŠ¸ë ˆì´ìŠ¤',
                    content: `${trace.spans.length}ê°œì˜ ìŠ¤íŒ¬ìœ¼ë¡œ êµ¬ì„±ëœ ë³µì¡í•œ ì¶”ì ì…ë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ê³„ì¸¡ì„ ì œê±°í•˜ì—¬ ì˜¤ë²„í—¤ë“œë¥¼ ì¤„ì´ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`
                });
            }
            
            // ì™¸ë¶€ API í˜¸ì¶œ ë¶„ì„
            const externalCalls = trace.spans.filter(s => 
                s.tags && (s.tags['external.gateway'] || s.serviceName.includes('external')));
            
            if (externalCalls.length > 0) {
                const totalExternalTime = externalCalls.reduce((sum, span) => sum + span.duration, 0);
                insights.push({
                    type: 'info',
                    title: 'ì™¸ë¶€ ì˜ì¡´ì„±',
                    content: `${externalCalls.length}ê°œì˜ ì™¸ë¶€ API í˜¸ì¶œë¡œ ì´ ${totalExternalTime}ms ì†Œìš”. íƒ€ì„ì•„ì›ƒ ë° ì¬ì‹œë„ ì •ì±…ì„ í™•ì¸í•˜ì„¸ìš”.`
                });
            }
            
            // ê¸°ë³¸ ì„±ê³µ ë©”ì‹œì§€
            if (insights.length === 0 && trace.status === 'success' && trace.duration < 1000) {
                insights.push({
                    type: 'info',
                    title: 'ì¢‹ì€ ì„±ëŠ¥',
                    content: 'ì´ ì¶”ì ì€ ì¢‹ì€ ì„±ëŠ¥ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. ì‘ë‹µì‹œê°„ì´ ë¹ ë¥´ê³  ì˜¤ë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.'
                });
            }
            
            // ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ ë Œë”ë§
            const container = document.getElementById('insightsGrid');
            container.innerHTML = insights.map(insight => `
                <div class="insight-card ${insight.type}">
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-content">${insight.content}</div>
                </div>
            `).join('');
        }

        // ìŠ¤íŒ¬ ìƒì„¸ ì •ë³´ í‘œì‹œ
        function displaySpanDetails(trace) {
            console.log('ìŠ¤íŒ¬ ìƒì„¸ ì •ë³´ í‘œì‹œ ì¤‘...');
            
            const container = document.getElementById('spanDetails');
            const sortedSpans = trace.spans.sort((a, b) => a.startTime - b.startTime);
            
            container.innerHTML = sortedSpans.map(span => `
                <div class="span-details-card">
                    <div class="span-header" onclick="toggleSpanDetails('${span.spanId}')">
                        <div class="span-info">
                            <div class="span-title">${span.operationName}</div>
                            <div class="span-subtitle">
                                ${span.serviceName} â€¢ ì‹œì‘: +${span.startTime}ms
                                ${span.status !== 'success' ? `â€¢ <span style="color: var(--error);">${span.status.toUpperCase()}</span>` : ''}
                            </div>
                        </div>
                        <div class="span-duration">${span.duration}ms</div>
                    </div>
                    <div class="span-body" id="span-body-${span.spanId}">
                        ${generateSpanDetailsContent(span)}
                    </div>
                </div>
            `).join('');
        }

        // ìŠ¤íŒ¬ ìƒì„¸ ë‚´ìš© ìƒì„±
        function generateSpanDetailsContent(span) {
            const attributesHtml = span.tags ? Object.entries(span.tags).map(([key, value]) => `
                <tr>
                    <td>${key}</td>
                    <td>${value}</td>
                </tr>
            `).join('') : '<tr><td colspan="2">ì†ì„± ì—†ìŒ</td></tr>';
            
            const eventsHtml = span.events && span.events.length > 0 ? 
                span.events.map(event => `
                    <div class="event-item">
                        <div class="event-time">+${event.timestamp}ms</div>
                        <div class="event-name">${event.name}</div>
                        <div class="event-attributes">${event.attributes || ''}</div>
                    </div>
                `).join('') : '<div style="color: var(--gray-500); text-align: center; padding: 1rem;">ì´ë²¤íŠ¸ ì—†ìŒ</div>';
            
            return `
                <div>
                    <h4 style="margin-bottom: 1rem; color: var(--gray-900);">ì†ì„±</h4>
                    <table class="attributes-table">
                        <thead>
                            <tr>
                                <th>í‚¤</th>
                                <th>ê°’</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${attributesHtml}
                        </tbody>
                    </table>
                </div>
                
                <div>
                    <h4 style="margin-bottom: 1rem; color: var(--gray-900);">ì´ë²¤íŠ¸</h4>
                    <div class="events-list">
                        ${eventsHtml}
                    </div>
                </div>
            `;
        }

        // ìŠ¤íŒ¬ ìƒì„¸ í† ê¸€
        function toggleSpanDetails(spanId) {
            console.log('toggleSpanDetails called with:', spanId);
            const body = document.getElementById(`span-body-${spanId}`);
            if (body) {
                body.classList.toggle('expanded');
                console.log('Toggled expanded class:', body.classList.contains('expanded'));
            } else {
                console.error('Element not found:', `span-body-${spanId}`);
            }
        }
        
        // ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ ë…¸ì¶œ
        window.toggleSpanDetails = toggleSpanDetails;

        // ìŠ¤íŒ¬ í•˜ì´ë¼ì´íŠ¸
        function highlightSpan(spanId) {
            // ëª¨ë“  ìŠ¤íŒ¬ì—ì„œ í•˜ì´ë¼ì´íŠ¸ ì œê±°
            document.querySelectorAll('.span-row').forEach(row => {
                row.style.background = '';
            });
            
            // ì„ íƒëœ ìŠ¤íŒ¬ í•˜ì´ë¼ì´íŠ¸
            const selectedRow = document.querySelector(`[data-span-id="${spanId}"]`);
            if (selectedRow) {
                selectedRow.style.background = 'var(--gray-100)';
            }
        }

        // ìŠ¤íŒ¬ íˆ´íŒ í‘œì‹œ
        function showSpanTooltip(event, spanId) {
            const span = currentTrace.spans.find(s => s.spanId === spanId);
            if (!span) return;
            
            // ê°„ë‹¨í•œ ì•Œë¦¼ìœ¼ë¡œ ìŠ¤íŒ¬ ì •ë³´ í‘œì‹œ (ì‹¤ì œë¡œëŠ” íˆ´íŒ êµ¬í˜„)
            alert(`ìŠ¤íŒ¬: ${span.operationName}
ì„œë¹„ìŠ¤: ${span.serviceName}
ì§€ì†ì‹œê°„: ${span.duration}ms
ìƒíƒœ: ${span.status}`);
        }

        // ì¶”ì  ìƒˆë¡œê³ ì¹¨
        function refreshTrace() {
            loadTraceData();
        }

        // ì¶”ì  ë‚´ë³´ë‚´ê¸°
        function exportTrace() {
            if (!currentTrace) return;
            
            const data = JSON.stringify(currentTrace, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trace_${currentTrace.traceId}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Trace ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
        function showTraceSelector() {
            document.getElementById('traceModal').style.display = 'block';
            loadClickHouseTraces();
        }
        
        // Trace ì„ íƒ ëª¨ë‹¬ ë‹«ê¸°
        function closeTraceModal() {
            document.getElementById('traceModal').style.display = 'none';
        }
        
        // ClickHouseì—ì„œ trace ëª©ë¡ ë¡œë“œ
        async function loadClickHouseTraces() {
            try {
                const response = await fetch('/api/clickhouse/traces');
                const data = await response.json();
                
                if (data.success) {
                    allTraces = data.traces;
                    filteredTraces = allTraces;
                    displayTraceList(filteredTraces);
                } else {
                    console.error('Trace ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ClickHouse trace ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // Trace ëª©ë¡ í‘œì‹œ
        function displayTraceList(traces) {
            const tbody = document.getElementById('traceListBody');
            
            if (traces.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">ì¶”ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            tbody.innerHTML = traces.map(trace => `
                <tr>
                    <td style="font-family: monospace; font-size: 0.875rem;">${trace.traceId}</td>
                    <td>${trace.serviceName}</td>
                    <td>${trace.operationName}</td>
                    <td>${new Date(trace.startTime).toLocaleString('ko-KR')}</td>
                    <td>${trace.duration}ms</td>
                    <td>
                        <span class="status-badge ${trace.status}">
                            ${trace.status === 'success' ? 'ì„±ê³µ' : 'ì˜¤ë¥˜'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary" onclick="selectTrace('${trace.traceId}')">ì„ íƒ</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Trace í•„í„°ë§
        function filterTraces() {
            const filterValue = document.getElementById('traceFilter').value.toLowerCase();
            
            if (!filterValue) {
                filteredTraces = allTraces;
            } else {
                filteredTraces = allTraces.filter(trace => 
                    trace.traceId.toLowerCase().includes(filterValue) ||
                    trace.serviceName.toLowerCase().includes(filterValue) ||
                    trace.operationName.toLowerCase().includes(filterValue)
                );
            }
            
            displayTraceList(filteredTraces);
        }
        
        // Trace ì„ íƒ
        function selectTrace(traceId) {
            // URL íŒŒë¼ë¯¸í„° ì—…ë°ì´íŠ¸
            const url = new URL(window.location);
            url.searchParams.set('trace', traceId);
            window.history.pushState({}, '', url);
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeTraceModal();
            
            // ì„ íƒëœ trace ë¡œë“œ
            loadTraceData();
        }
        
        // ClickHouseì—ì„œ íŠ¹ì • trace ë°ì´í„° ë¡œë“œ
        async function loadClickHouseTraceData(traceId) {
            try {
                console.log('ClickHouseì—ì„œ trace ë¡œë”©:', traceId);
                const response = await fetch(`/api/clickhouse/trace/${traceId}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log('ClickHouse trace ë¡œë“œ ì„±ê³µ:', data.trace);
                    currentTrace = data.trace;
                    displayTraceData(currentTrace);
                } else {
                    console.error('Trace ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                    generateSampleTraceData(traceId);
                }
            } catch (error) {
                console.error('ClickHouse trace ë¡œë“œ ì˜¤ë¥˜:', error);
                generateSampleTraceData(traceId);
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type = 'info') {
            // ê°„ë‹¨í•œ ì•Œë¦¼ (ì‹¤ì œë¡œëŠ” í† ìŠ¤íŠ¸ êµ¬í˜„)
            alert(message);
        }
    </script>
</body>
</html>