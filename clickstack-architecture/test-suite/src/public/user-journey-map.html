<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRIS-MON ì‚¬ìš©ì ì—¬ì • ë§µ</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/components/common-layout.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: #4c51bf;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #6b7280;
            font-size: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .controls {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .quick-actions {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .quick-actions h3 {
            color: #92400e;
            margin-bottom: 1rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn-success {
            background: linear-gradient(135deg, #34d399, #10b981);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        .btn-info {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        select, input {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .journey-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            min-height: 600px;
        }

        .journey-header {
            background: #f9fafb;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .journey-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
        }

        .journey-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .journey-content {
            position: relative;
            height: 600px;
            overflow: hidden;
        }

        #journeyMap {
            width: 100%;
            height: 100%;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            transform: scale(1.1);
        }

        .node circle {
            fill: #667eea;
            stroke: #fff;
            stroke-width: 3px;
        }

        .node.start-page circle {
            fill: #10b981;
        }

        .node.end-page circle {
            fill: #ef4444;
        }

        .node.high-traffic circle {
            fill: #f59e0b;
        }

        .node text {
            font-family: inherit;
            font-size: 12px;
            fill: #1f2937;
            text-anchor: middle;
            dominant-baseline: middle;
        }

        .link {
            fill: none;
            stroke: #9ca3af;
            stroke-width: 2;
            marker-end: url(#arrowhead);
            transition: all 0.3s ease;
        }

        .link.thick {
            stroke-width: 4;
            stroke: #667eea;
        }

        .link.medium {
            stroke-width: 3;
            stroke: #8b5cf6;
        }

        .link:hover {
            stroke: #4c51bf;
            stroke-width: 5;
        }

        .tooltip {
            position: absolute;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 8px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 10;
            display: none;
            max-width: 250px;
            line-height: 1.4;
        }

        .legend {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 200px;
        }

        .legend-title {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .path-analysis {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-top: 2rem;
        }

        .path-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }

        .path-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .path-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .path-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .path-card-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }

        .path-steps {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .path-step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: #6b7280;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #fecaca;
            margin: 1rem 0;
        }

        .success-message {
            background: #d1fae5;
            color: #059669;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #a7f3d0;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
                margin: 1rem auto;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .journey-header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .journey-stats {
                gap: 1rem;
            }
            
            .legend {
                position: relative;
                top: auto;
                right: auto;
                margin: 1rem;
            }

            .path-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="airis-content-wrapper">
    <div class="header">
        <h1>ğŸ—ºï¸ AIRIS-MON ì‚¬ìš©ì ì—¬ì • ë§µ</h1>
        <p>ì‚¬ìš©ìì˜ í˜ì´ì§€ ì´ë™ íŒ¨í„´ì„ ì‹œê°ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ì‚¬ìš©ì ê²½í—˜ì„ ê°œì„ í•˜ì„¸ìš”</p>
    </div>

    <div class="container">
        <!-- ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì„¹ì…˜ -->
        <div class="quick-actions">
            <h3>ğŸš€ ë¹ ë¥¸ ì‹œì‘ - í…ŒìŠ¤íŠ¸ ì„¸ì…˜ ìƒì„±</h3>
            <div id="alertContainer"></div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="createSampleSessions()">
                    ğŸ¯ ìƒ˜í”Œ ì„¸ì…˜ 5ê°œ ìƒì„±
                </button>
                <button class="btn btn-warning" onclick="createRealisticSession()">
                    ğŸ›’ ì‹¤ì œ ì´ì»¤ë¨¸ìŠ¤ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±
                </button>
                <button class="btn btn-info" onclick="createComplexJourney()">
                    ğŸ”„ ë³µì¡í•œ ì—¬ì • ìƒì„± (20+ í˜ì´ì§€)
                </button>
                <button class="btn" onclick="loadExistingSessions()">
                    ğŸ“‚ ê¸°ì¡´ ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
            </div>
            <p style="margin-top: 1rem; color: #6b7280; font-size: 0.9rem;">
                ğŸ’¡ íŒ: í…ŒìŠ¤íŠ¸ ì„¸ì…˜ì„ ë¨¼ì € ìƒì„±í•œ í›„, ì•„ë˜ì—ì„œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ê³  "ì—¬ì • ë§µ ìƒì„±"ì„ í´ë¦­í•˜ì„¸ìš”
            </p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>ë¶„ì„í•  ì„¸ì…˜ ì„ íƒ</label>
                <select id="sessionSelect">
                    <option value="">ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”...</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>ì—¬ì • ìœ í˜•</label>
                <select id="journeyType">
                    <option value="all">ì „ì²´ ì—¬ì •</option>
                    <option value="successful">ì„±ê³µì  ì „í™˜</option>
                    <option value="abandoned">ì¤‘ë‹¨ëœ ì—¬ì •</option>
                    <option value="loops">ìˆœí™˜ íŒ¨í„´</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>ìµœì†Œ ë°©ë¬¸ ìˆ˜</label>
                <input type="number" id="minVisits" value="1" min="1" max="100" placeholder="1">
            </div>
            
            <div class="control-group">
                <label>ë ˆì´ì•„ì›ƒ íƒ€ì…</label>
                <select id="layoutType">
                    <option value="force">í¬ìŠ¤ ë‹¤ì´ë ‰í‹°ë“œ</option>
                    <option value="hierarchical">ê³„ì¸µí˜•</option>
                    <option value="circular">ì›í˜•</option>
                </select>
            </div>
            
            <div class="control-group">
                <button class="btn" onclick="generateJourneyMap()">ğŸ—ºï¸ ì—¬ì • ë§µ ìƒì„±</button>
            </div>
            
            <div class="control-group">
                <button class="btn" onclick="exportJourneyMap()" style="background: linear-gradient(135deg, #10b981, #059669);">ğŸ’¾ SVGë¡œ ë‚´ë³´ë‚´ê¸°</button>
            </div>
        </div>

        <div class="journey-container">
            <div class="journey-header">
                <div class="journey-title">ì‚¬ìš©ì ì—¬ì • ì‹œê°í™”</div>
                <div class="journey-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalPages">0</div>
                        <div class="stat-label">í˜ì´ì§€</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalTransitions">0</div>
                        <div class="stat-label">ì „í™˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgPathLength">0</div>
                        <div class="stat-label">í‰ê·  ê²½ë¡œ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="bounceRate">0%</div>
                        <div class="stat-label">ì´íƒˆë¥ </div>
                    </div>
                </div>
            </div>
            
            <div class="journey-content">
                <svg id="journeyMap"></svg>
                <div class="tooltip" id="tooltip"></div>
                
                <div class="legend">
                    <div class="legend-title">í˜ì´ì§€ ìœ í˜•</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #10b981;"></div>
                        <span>ì‹œì‘ í˜ì´ì§€</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ef4444;"></div>
                        <span>ì¢…ë£Œ/ì´íƒˆ í˜ì´ì§€</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f59e0b;"></div>
                        <span>ê³ íŠ¸ë˜í”½ í˜ì´ì§€</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #667eea;"></div>
                        <span>ì¼ë°˜ í˜ì´ì§€</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="path-analysis">
            <div class="path-title">ì£¼ìš” ì‚¬ìš©ì ê²½ë¡œ ë¶„ì„</div>
            <div class="path-grid" id="pathAnalysis">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
        </div>
    </div>

    <script>
        // ê¸€ë¡œë²Œ ë³€ìˆ˜
        let journeyData = null;
        let currentSession = null;
        let svg, g, simulation;
        let width, height;

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // ìƒ˜í”Œ ì„¸ì…˜ ìƒì„± (5ê°œ)
        async function createSampleSessions() {
            try {
                const scenarios = ['e-commerce', 'dashboard', 'blog', 'landing', 'support'];
                const createdSessions = [];

                for (let i = 0; i < 5; i++) {
                    const scenario = scenarios[i];
                    const sessionId = await createTestSession(scenario, 10 + Math.floor(Math.random() * 20));
                    createdSessions.push(sessionId);
                }

                showAlert(`âœ… 5ê°œì˜ ìƒ˜í”Œ ì„¸ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                await loadSessions(); // ì„¸ì…˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                
                // ì²« ë²ˆì§¸ ì„¸ì…˜ ìë™ ì„ íƒ
                if (createdSessions[0]) {
                    document.getElementById('sessionSelect').value = createdSessions[0];
                }
            } catch (error) {
                showAlert('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ì‹¤ì œ ì´ì»¤ë¨¸ìŠ¤ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±
        async function createRealisticSession() {
            try {
                const sessionId = await createEcommerceJourney();
                showAlert(`âœ… ì´ì»¤ë¨¸ìŠ¤ ì„¸ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: ${sessionId.substring(0, 8)}...)`, 'success');
                await loadSessions();
                document.getElementById('sessionSelect').value = sessionId;
            } catch (error) {
                showAlert('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ë³µì¡í•œ ì—¬ì • ìƒì„±
        async function createComplexJourney() {
            try {
                const sessionId = await createComplexUserJourney();
                showAlert(`âœ… ë³µì¡í•œ ì—¬ì • ì„¸ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (20+ í˜ì´ì§€ ë°©ë¬¸)`, 'success');
                await loadSessions();
                document.getElementById('sessionSelect').value = sessionId;
            } catch (error) {
                showAlert('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ê¸°ì¡´ ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadExistingSessions() {
            await loadSessions();
            const sessionSelect = document.getElementById('sessionSelect');
            if (sessionSelect.options.length > 1) {
                showAlert(`âœ… ${sessionSelect.options.length - 1}ê°œì˜ ê¸°ì¡´ ì„¸ì…˜ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`, 'info');
            } else {
                showAlert('ê¸°ì¡´ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•´ì£¼ì„¸ìš”.', 'info');
            }
        }

        // í…ŒìŠ¤íŠ¸ ì„¸ì…˜ ìƒì„± í—¬í¼ í•¨ìˆ˜
        async function createTestSession(scenario, eventCount) {
            // ì„¸ì…˜ ì‹œì‘
            const startResponse = await fetch('/api/session-replay/start-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scenario: `journey_${scenario}`,
                    metadata: {
                        testType: 'user_journey',
                        scenario: scenario,
                        timestamp: new Date().toISOString()
                    }
                })
            });

            const sessionData = await startResponse.json();
            const sessionId = sessionData.sessionId;

            // í˜ì´ì§€ ë°©ë¬¸ ì´ë²¤íŠ¸ ìƒì„±
            const pages = generatePageSequence(scenario);
            for (let i = 0; i < eventCount && i < pages.length; i++) {
                const event = {
                    type: 'page_load',
                    timestamp: Date.now() + (i * 1000),
                    page_url: pages[i],
                    title: pages[i].split('/').pop() || 'home',
                    referrer: i > 0 ? pages[i-1] : null,
                    load_time: Math.floor(Math.random() * 2000) + 500
                };

                await fetch('/api/session-replay/add-event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        event: event
                    })
                });
            }

            // ì„¸ì…˜ ì¢…ë£Œ
            await fetch('/api/session-replay/end-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sessionId: sessionId,
                    summary: { pageViews: eventCount }
                })
            });

            return sessionId;
        }

        // ì´ì»¤ë¨¸ìŠ¤ ì—¬ì • ìƒì„±
        async function createEcommerceJourney() {
            const journey = [
                '/', '/products', '/products/laptop', '/products/laptop/reviews',
                '/products/laptop', '/cart', '/checkout', '/checkout/shipping',
                '/checkout/payment', '/checkout/confirm', '/order/success'
            ];

            return await createJourneyWithPages(journey, 'e-commerce');
        }

        // ë³µì¡í•œ ì‚¬ìš©ì ì—¬ì • ìƒì„±
        async function createComplexUserJourney() {
            const journey = [
                '/', '/about', '/products', '/products/category/electronics',
                '/products/laptop', '/products/laptop/compare', '/products/mouse',
                '/blog', '/blog/tech-tips', '/support', '/support/contact',
                '/products', '/products/keyboard', '/cart', '/products/monitor',
                '/cart', '/account/login', '/account/dashboard', '/account/orders',
                '/checkout', '/checkout/shipping', '/checkout/payment', '/order/success'
            ];

            return await createJourneyWithPages(journey, 'complex');
        }

        // í˜ì´ì§€ ì‹œí€€ìŠ¤ë¡œ ì—¬ì • ìƒì„±
        async function createJourneyWithPages(pages, scenario) {
            const startResponse = await fetch('/api/session-replay/start-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scenario: `journey_${scenario}`,
                    metadata: {
                        testType: 'user_journey',
                        scenario: scenario,
                        timestamp: new Date().toISOString()
                    }
                })
            });

            const sessionData = await startResponse.json();
            const sessionId = sessionData.sessionId;

            for (let i = 0; i < pages.length; i++) {
                const event = {
                    type: 'page_load',
                    timestamp: Date.now() + (i * 2000),
                    page_url: pages[i],
                    title: pages[i].split('/').pop() || 'home',
                    referrer: i > 0 ? pages[i-1] : null,
                    load_time: Math.floor(Math.random() * 2000) + 500,
                    duration: Math.floor(Math.random() * 5000) + 1000
                };

                await fetch('/api/session-replay/add-event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        event: event
                    })
                });

                // í˜ì´ì§€ë³„ ì¶”ê°€ ì´ë²¤íŠ¸ (í´ë¦­, ìŠ¤í¬ë¡¤ ë“±)
                if (Math.random() > 0.5) {
                    await fetch('/api/session-replay/add-event', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: sessionId,
                            event: {
                                type: 'click',
                                timestamp: Date.now() + (i * 2000) + 500,
                                page_url: pages[i],
                                target: { tagName: 'button', text: 'Action' }
                            }
                        })
                    });
                }
            }

            await fetch('/api/session-replay/end-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sessionId: sessionId,
                    summary: { 
                        pageViews: pages.length,
                        journeyComplete: true 
                    }
                })
            });

            return sessionId;
        }

        // ì‹œë‚˜ë¦¬ì˜¤ë³„ í˜ì´ì§€ ì‹œí€€ìŠ¤ ìƒì„±
        function generatePageSequence(scenario) {
            const sequences = {
                'e-commerce': [
                    '/', '/products', '/products/item1', '/cart', 
                    '/checkout', '/payment', '/confirmation'
                ],
                'dashboard': [
                    '/login', '/dashboard', '/dashboard/analytics',
                    '/dashboard/reports', '/dashboard/settings', '/dashboard'
                ],
                'blog': [
                    '/', '/blog', '/blog/post1', '/blog/post2',
                    '/about', '/contact', '/'
                ],
                'landing': [
                    '/', '/features', '/pricing', '/testimonials',
                    '/signup', '/thank-you'
                ],
                'support': [
                    '/', '/support', '/support/docs', '/support/faq',
                    '/support/contact', '/support/ticket'
                ]
            };

            return sequences[scenario] || sequences['e-commerce'];
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadSessions();
            initializeVisualization();
            
            // ì‹œì‘ ì‹œ ë„ì›€ë§ í‘œì‹œ
            showAlert('ğŸ‘‹ ì‹œì‘í•˜ë ¤ë©´ "ìƒ˜í”Œ ì„¸ì…˜ 5ê°œ ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”!', 'info');
        });

        // ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
        async function loadSessions() {
            try {
                // ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ì˜ ì„¸ì…˜ ê°€ì ¸ì˜¤ê¸° (journey_ ì‹œë‚˜ë¦¬ì˜¤ í¬í•¨)
                const scenarios = [
                    'journey_e-commerce', 'journey_dashboard', 'journey_blog', 
                    'journey_landing', 'journey_support', 'journey_complex',
                    'bug_payment', 'ux_navigation', 'security_attack', 
                    'performance_slow', 'enhanced_recording', 'e2e_test_e-commerce',
                    'e2e_test_dashboard', 'e2e_test_search', 'e2e_test_form',
                    'e2e_test_media', 'e2e_test_api-heavy', 'e2e_test_realtime'
                ];
                
                const select = document.getElementById('sessionSelect');
                
                // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™” (ì²« ë²ˆì§¸ ë¹ˆ ì˜µì…˜ ì œì™¸)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                let totalSessionCount = 0;
                
                for (const scenario of scenarios) {
                    const response = await fetch(`/api/session-replay/sessions/${scenario}`);
                    const data = await response.json();
                    
                    if (data.success && data.sessions && data.sessions.length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = getScenarioName(scenario);
                        
                        data.sessions.forEach(session => {
                            const option = document.createElement('option');
                            option.value = session.id;
                            const timestamp = session.startTime ? new Date(session.startTime).toLocaleTimeString() : '';
                            option.textContent = `${session.id.substring(0, 8)}... (${session.eventCount || 0}ê°œ ì´ë²¤íŠ¸) ${timestamp}`;
                            optgroup.appendChild(option);
                            totalSessionCount++;
                        });
                        
                        select.appendChild(optgroup);
                    }
                }
                
                // ì„¸ì…˜ì´ ì—†ì„ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€
                if (totalSessionCount === 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ ë²„íŠ¼ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”.";
                    option.disabled = true;
                    select.appendChild(option);
                }
                
                console.log(`ì´ ${totalSessionCount}ê°œ ì„¸ì…˜ ë¡œë“œ ì™„ë£Œ`);
                
            } catch (error) {
                console.error('ì„¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                showAlert('ì„¸ì…˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ì´ë¦„ ë³€í™˜
        function getScenarioName(scenario) {
            const names = {
                'bug_payment': 'ğŸ› ë²„ê·¸ ì¬í˜„ ì‹œë‚˜ë¦¬ì˜¤',
                'ux_navigation': 'ğŸ“Š UX/UI ê°œì„  ì‹œë‚˜ë¦¬ì˜¤',
                'security_attack': 'ğŸš¨ ë³´ì•ˆ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤',
                'performance_slow': 'âš¡ ì„±ëŠ¥ ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤',
                'enhanced_recording': 'ğŸ¯ í–¥ìƒëœ ë…¹í™” ì„¸ì…˜'
            };
            return names[scenario] || scenario;
        }

        // ì‹œê°í™” ì´ˆê¸°í™”
        function initializeVisualization() {
            const container = document.querySelector('.journey-content');
            width = container.clientWidth;
            height = container.clientHeight;

            svg = d3.select('#journeyMap')
                .attr('width', width)
                .attr('height', height);

            // ë§ˆì»¤ ì •ì˜ (í™”ì‚´í‘œ)
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '0 -5 10 10')
                .attr('refX', 15)
                .attr('refY', -0.5)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('fill', '#9ca3af');

            g = svg.append('g');
            
            // ì¤Œ ê¸°ëŠ¥ ì¶”ê°€
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
            showDefaultMessage();
        }

        // ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
        function showDefaultMessage() {
            g.append('text')
                .attr('x', width / 2)
                .attr('y', height / 2)
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'middle')
                .style('font-size', '18px')
                .style('fill', '#6b7280')
                .text('ì„¸ì…˜ì„ ì„ íƒí•˜ê³  ì—¬ì • ë§µ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”');
        }

        // ì—¬ì • ë§µ ìƒì„±
        async function generateJourneyMap() {
            const sessionId = document.getElementById('sessionSelect').value;
            if (!sessionId) {
                showError('ë¶„ì„í•  ì„¸ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                showLoading();
                
                // ì„¸ì…˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`/api/session-replay/session/${sessionId}`);
                const data = await response.json();

                if (!data.success || !data.session) {
                    throw new Error('ì„¸ì…˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                currentSession = data.session;
                
                // ì—¬ì • ë°ì´í„° ì²˜ë¦¬
                const journeyData = processJourneyData(data.session.events);
                
                // ì—¬ì • ë§µ ë Œë”ë§
                renderJourneyMap(journeyData);
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                updateJourneyStats(journeyData);
                
                // ê²½ë¡œ ë¶„ì„ ì—…ë°ì´íŠ¸
                updatePathAnalysis(journeyData);
                
                showSuccess('ì‚¬ìš©ì ì—¬ì • ë§µì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                console.error('ì—¬ì • ë§µ ìƒì„± ì˜¤ë¥˜:', error);
                showError('ì—¬ì • ë§µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ì—¬ì • ë°ì´í„° ì²˜ë¦¬
        function processJourneyData(events) {
            const journeyType = document.getElementById('journeyType').value;
            const minVisits = parseInt(document.getElementById('minVisits').value) || 1;

            // í˜ì´ì§€ ë¡œë“œ ì´ë²¤íŠ¸ í•„í„°ë§ (rrweb_event ë˜í•‘ ê³ ë ¤)
            const pageLoadEvents = events
                .filter(event => {
                    // rrweb_eventë¡œ ë˜í•‘ëœ page_load ì´ë²¤íŠ¸ ì²˜ë¦¬
                    if (event.type === 'rrweb_event' && event.rrwebType === 'page_load' && event.originalEvent) {
                        return event.originalEvent.page_url;
                    }
                    // ì§ì ‘ì ì¸ page_load ì´ë²¤íŠ¸ ì²˜ë¦¬
                    return event.type === 'page_load' && event.page_url;
                })
                .map(event => {
                    // rrweb_eventì¸ ê²½ìš° originalEvent ë°ì´í„°ë¥¼ ì‚¬ìš©
                    if (event.type === 'rrweb_event' && event.originalEvent) {
                        return {
                            ...event.originalEvent,
                            timestamp: event.timestamp || event.originalEvent.timestamp,
                            id: event.id
                        };
                    }
                    return event;
                })
                .sort((a, b) => a.timestamp - b.timestamp);

            if (pageLoadEvents.length === 0) {
                throw new Error('í˜ì´ì§€ ë¡œë“œ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            // í˜ì´ì§€ë³„ ë°©ë¬¸ ìˆ˜ ê³„ì‚°
            const pageVisits = {};
            const transitions = {};
            const paths = [];
            let currentPath = [];

            pageLoadEvents.forEach((event, index) => {
                const page = event.page_url;
                
                // í˜ì´ì§€ ë°©ë¬¸ ìˆ˜ ì¦ê°€
                pageVisits[page] = (pageVisits[page] || 0) + 1;
                
                // ê²½ë¡œ ì¶”ê°€
                currentPath.push({
                    page: page,
                    timestamp: event.timestamp,
                    index: index
                });
                
                // ë‹¤ìŒ í˜ì´ì§€ë¡œì˜ ì „í™˜ ê³„ì‚°
                if (index > 0) {
                    const prevPage = pageLoadEvents[index - 1].page_url;
                    const transitionKey = `${prevPage} -> ${page}`;
                    transitions[transitionKey] = (transitions[transitionKey] || 0) + 1;
                }
            });

            // ìµœì†Œ ë°©ë¬¸ ìˆ˜ í•„í„°ë§
            const filteredPages = Object.keys(pageVisits).filter(page => 
                pageVisits[page] >= minVisits
            );

            // ë…¸ë“œ ìƒì„±
            const nodes = filteredPages.map(page => {
                const visits = pageVisits[page];
                const isStart = page === pageLoadEvents[0].page_url;
                const isEnd = page === pageLoadEvents[pageLoadEvents.length - 1].page_url;
                const isHighTraffic = visits > Math.max(2, Object.values(pageVisits).reduce((a, b) => a + b, 0) / Object.keys(pageVisits).length);

                return {
                    id: page,
                    page: page,
                    visits: visits,
                    isStart,
                    isEnd,
                    isHighTraffic,
                    type: isStart ? 'start-page' : isEnd ? 'end-page' : isHighTraffic ? 'high-traffic' : 'normal'
                };
            });

            // ë§í¬ ìƒì„±
            const links = [];
            Object.entries(transitions).forEach(([transition, count]) => {
                const [source, target] = transition.split(' -> ');
                if (filteredPages.includes(source) && filteredPages.includes(target)) {
                    links.push({
                        source: source,
                        target: target,
                        count: count,
                        thickness: count > 2 ? 'thick' : count > 1 ? 'medium' : 'thin'
                    });
                }
            });

            return {
                nodes,
                links,
                pageVisits,
                transitions,
                paths: [currentPath]
            };
        }

        // ì—¬ì • ë§µ ë Œë”ë§
        function renderJourneyMap(data) {
            // ê¸°ì¡´ ìš”ì†Œ ì œê±°
            g.selectAll('*').remove();

            const layoutType = document.getElementById('layoutType').value;

            // ë ˆì´ì•„ì›ƒì— ë”°ë¥¸ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •
            let simulation;
            
            switch (layoutType) {
                case 'hierarchical':
                    simulation = createHierarchicalLayout(data);
                    break;
                case 'circular':
                    simulation = createCircularLayout(data);
                    break;
                default:
                    simulation = createForceLayout(data);
            }

            // ë§í¬ ê·¸ë¦¬ê¸°
            const link = g.append('g')
                .attr('class', 'links')
                .selectAll('path')
                .data(data.links)
                .enter().append('path')
                .attr('class', d => `link ${d.thickness}`)
                .on('mouseover', showLinkTooltip)
                .on('mouseout', hideTooltip);

            // ë…¸ë“œ ê·¸ë¦¬ê¸°
            const node = g.append('g')
                .attr('class', 'nodes')
                .selectAll('.node')
                .data(data.nodes)
                .enter().append('g')
                .attr('class', d => `node ${d.type}`)
                .on('mouseover', showNodeTooltip)
                .on('mouseout', hideTooltip)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // ë…¸ë“œ ì› ê·¸ë¦¬ê¸°
            node.append('circle')
                .attr('r', d => Math.max(20, Math.sqrt(d.visits) * 8));

            // ë…¸ë“œ í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
            node.append('text')
                .text(d => getPageName(d.page))
                .attr('dy', 0.35)
                .style('font-weight', 'bold');

            // ë°©ë¬¸ ìˆ˜ í…ìŠ¤íŠ¸
            node.append('text')
                .text(d => `${d.visits}íšŒ`)
                .attr('dy', 12)
                .style('font-size', '10px')
                .style('fill', '#666');

            // ì‹œë®¬ë ˆì´ì…˜ tick ì´ë²¤íŠ¸
            simulation.on('tick', () => {
                link.attr('d', linkPath);
                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            window.currentSimulation = simulation;
            journeyData = data;
        }

        // í¬ìŠ¤ ë ˆì´ì•„ì›ƒ ìƒì„±
        function createForceLayout(data) {
            return d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.links).id(d => d.id).distance(100).strength(0.5))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => Math.max(25, Math.sqrt(d.visits) * 10)));
        }

        // ê³„ì¸µí˜• ë ˆì´ì•„ì›ƒ ìƒì„±
        function createHierarchicalLayout(data) {
            // ì‹œì‘ í˜ì´ì§€ë¶€í„° ë ˆë²¨ë³„ë¡œ ë°°ì¹˜
            const levels = {};
            const visited = new Set();
            
            // BFSë¡œ ë ˆë²¨ í• ë‹¹
            const queue = [{ node: data.nodes.find(n => n.isStart), level: 0 }];
            while (queue.length > 0) {
                const { node, level } = queue.shift();
                if (!node || visited.has(node.id)) continue;
                
                visited.add(node.id);
                if (!levels[level]) levels[level] = [];
                levels[level].push(node);
                
                // ë‹¤ìŒ ë ˆë²¨ ë…¸ë“œë“¤ ì¶”ê°€
                data.links
                    .filter(link => link.source === node.id)
                    .forEach(link => {
                        const targetNode = data.nodes.find(n => n.id === link.target);
                        if (targetNode && !visited.has(targetNode.id)) {
                            queue.push({ node: targetNode, level: level + 1 });
                        }
                    });
            }

            // ë ˆë²¨ë³„ ìœ„ì¹˜ ì„¤ì •
            Object.entries(levels).forEach(([level, nodes]) => {
                const y = (height / (Object.keys(levels).length + 1)) * (parseInt(level) + 1);
                nodes.forEach((node, index) => {
                    node.fx = (width / (nodes.length + 1)) * (index + 1);
                    node.fy = y;
                });
            });

            return d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.links).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('collision', d3.forceCollide().radius(30));
        }

        // ì›í˜• ë ˆì´ì•„ì›ƒ ìƒì„±
        function createCircularLayout(data) {
            const radius = Math.min(width, height) / 3;
            const centerX = width / 2;
            const centerY = height / 2;

            data.nodes.forEach((node, index) => {
                const angle = (2 * Math.PI * index) / data.nodes.length;
                node.fx = centerX + radius * Math.cos(angle);
                node.fy = centerY + radius * Math.sin(angle);
            });

            return d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.links).id(d => d.id).distance(50))
                .force('collision', d3.forceCollide().radius(35));
        }

        // ë§í¬ ê²½ë¡œ ìƒì„±
        function linkPath(d) {
            const dx = d.target.x - d.source.x;
            const dy = d.target.y - d.source.y;
            const dr = Math.sqrt(dx * dx + dy * dy) * 0.5;
            return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
        }

        // í˜ì´ì§€ ì´ë¦„ ì¶•ì•½
        function getPageName(url) {
            const names = {
                '/checkout': 'ê²°ì œ',
                '/products': 'ìƒí’ˆ',
                '/dashboard': 'ëŒ€ì‹œë³´ë“œ',
                '/login': 'ë¡œê·¸ì¸',
                '/': 'í™ˆ',
                '/cart': 'ì¥ë°”êµ¬ë‹ˆ',
                '/profile': 'í”„ë¡œí•„'
            };
            return names[url] || url.split('/').pop() || 'í™ˆ';
        }

        // íˆ´íŒ í‘œì‹œ
        function showNodeTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <strong>${getPageName(d.page)}</strong><br>
                URL: ${d.page}<br>
                ë°©ë¬¸ ìˆ˜: ${d.visits}íšŒ<br>
                ìœ í˜•: ${getNodeTypeText(d.type)}
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        function showLinkTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <strong>í˜ì´ì§€ ì „í™˜</strong><br>
                ${getPageName(d.source.page || d.source)} â†’ ${getPageName(d.target.page || d.target)}<br>
                ì „í™˜ ìˆ˜: ${d.count}íšŒ
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function getNodeTypeText(type) {
            const types = {
                'start-page': 'ì‹œì‘ í˜ì´ì§€',
                'end-page': 'ì¢…ë£Œ í˜ì´ì§€',
                'high-traffic': 'ê³ íŠ¸ë˜í”½ í˜ì´ì§€',
                'normal': 'ì¼ë°˜ í˜ì´ì§€'
            };
            return types[type] || 'ì¼ë°˜ í˜ì´ì§€';
        }

        // ë“œë˜ê·¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        function dragstarted(event, d) {
            if (!event.active) window.currentSimulation?.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) window.currentSimulation?.alphaTarget(0);
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateJourneyStats(data) {
            const totalPages = data.nodes.length;
            const totalTransitions = data.links.reduce((sum, link) => sum + link.count, 0);
            const avgPathLength = data.paths.length > 0 ? 
                data.paths.reduce((sum, path) => sum + path.length, 0) / data.paths.length : 0;
            const bounceRate = data.nodes.filter(n => n.visits === 1).length / totalPages * 100;

            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('totalTransitions').textContent = totalTransitions;
            document.getElementById('avgPathLength').textContent = avgPathLength.toFixed(1);
            document.getElementById('bounceRate').textContent = bounceRate.toFixed(0) + '%';
        }

        // ê²½ë¡œ ë¶„ì„ ì—…ë°ì´íŠ¸
        function updatePathAnalysis(data) {
            const container = document.getElementById('pathAnalysis');
            container.innerHTML = '';

            // ê°€ì¥ ì¸ê¸° ìˆëŠ” ê²½ë¡œ ì°¾ê¸°
            const popularPaths = findPopularPaths(data);
            
            popularPaths.forEach((path, index) => {
                const card = document.createElement('div');
                card.className = 'path-card';
                
                const title = document.createElement('div');
                title.className = 'path-card-title';
                title.textContent = `ì¸ê¸° ê²½ë¡œ ${index + 1} (${path.count}íšŒ)`;
                card.appendChild(title);
                
                const steps = document.createElement('div');
                steps.className = 'path-steps';
                
                path.steps.forEach((step, stepIndex) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'path-step';
                    
                    const stepNumber = document.createElement('div');
                    stepNumber.className = 'step-number';
                    stepNumber.textContent = stepIndex + 1;
                    stepDiv.appendChild(stepNumber);
                    
                    const stepText = document.createElement('span');
                    stepText.textContent = getPageName(step);
                    stepDiv.appendChild(stepText);
                    
                    steps.appendChild(stepDiv);
                });
                
                card.appendChild(steps);
                container.appendChild(card);
            });
        }

        // ì¸ê¸° ê²½ë¡œ ì°¾ê¸°
        function findPopularPaths(data) {
            // ë§í¬ ê¸°ë°˜ìœ¼ë¡œ ê²½ë¡œ êµ¬ì„±
            const pathCounts = {};
            
            // ì‹œì‘ í˜ì´ì§€ë¶€í„° DFSë¡œ ê²½ë¡œ íƒìƒ‰
            const startNodes = data.nodes.filter(n => n.isStart);
            
            startNodes.forEach(startNode => {
                const paths = findAllPaths(startNode.id, data.links, data.nodes);
                paths.forEach(path => {
                    const pathKey = path.join(' -> ');
                    pathCounts[pathKey] = (pathCounts[pathKey] || 0) + 1;
                });
            });

            // ìƒìœ„ 5ê°œ ê²½ë¡œ ë°˜í™˜
            return Object.entries(pathCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([path, count]) => ({
                    steps: path.split(' -> '),
                    count
                }));
        }

        // ëª¨ë“  ê²½ë¡œ ì°¾ê¸° (DFS)
        function findAllPaths(startId, links, nodes, visited = new Set(), currentPath = []) {
            if (visited.has(startId)) return [];
            
            visited.add(startId);
            currentPath.push(startId);
            
            const outgoingLinks = links.filter(link => link.source === startId || (link.source.id && link.source.id === startId));
            
            if (outgoingLinks.length === 0) {
                // ê²½ë¡œ ì¢…ë£Œ
                const result = [currentPath.slice()];
                visited.delete(startId);
                currentPath.pop();
                return result;
            }
            
            const allPaths = [];
            outgoingLinks.forEach(link => {
                const targetId = link.target.id || link.target;
                const paths = findAllPaths(targetId, links, nodes, visited, currentPath);
                allPaths.push(...paths);
            });
            
            visited.delete(startId);
            currentPath.pop();
            return allPaths;
        }

        // ë‚´ë³´ë‚´ê¸°
        function exportJourneyMap() {
            if (!journeyData) {
                showError('ë¨¼ì € ì—¬ì • ë§µì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const svgElement = document.getElementById('journeyMap');
            const svgString = new XMLSerializer().serializeToString(svgElement);
            const blob = new Blob([svgString], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.download = `user-journey-${currentSession?.id || 'unknown'}-${Date.now()}.svg`;
            link.href = url;
            link.click();
            
            URL.revokeObjectURL(url);
            showSuccess('ì—¬ì • ë§µ SVG íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // UI í—¬í¼ í•¨ìˆ˜ë“¤
        function showLoading() {
            const container = document.querySelector('.journey-content');
            if (!document.getElementById('loadingOverlay')) {
                const overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.className = 'loading';
                overlay.innerHTML = `
                    <div class="loading-spinner"></div>
                    <p>ì—¬ì • ë§µì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                `;
                container.appendChild(overlay);
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const container = document.querySelector('.container');
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ì¬ì¡°ì •
        window.addEventListener('resize', () => {
            const container = document.querySelector('.journey-content');
            const newWidth = container.clientWidth;
            const newHeight = container.clientHeight;
            
            if (newWidth !== width || newHeight !== height) {
                width = newWidth;
                height = newHeight;
                
                d3.select('#journeyMap')
                    .attr('width', width)
                    .attr('height', height);
                
                if (window.currentSimulation) {
                    window.currentSimulation.force('center', d3.forceCenter(width / 2, height / 2));
                    window.currentSimulation.alpha(0.3).restart();
                }
            }
        });
    </script>
    </div>
</body>
</html>