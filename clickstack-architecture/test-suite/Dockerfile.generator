# í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±ê¸° ì „ìš© Docker ì´ë¯¸ì§€
FROM node:18-alpine

WORKDIR /app

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apk add --no-cache curl bash tzdata \
    && cp /usr/share/zoneinfo/Asia/Seoul /etc/localtime \
    && echo "Asia/Seoul" > /etc/timezone

# í™˜ê²½ ì„¤ì •
ENV NODE_ENV=production
ENV TZ=Asia/Seoul

# ë°ì´í„° ìƒì„±ê¸° ì˜ì¡´ì„±
RUN npm init -y && \
    npm install kafkajs @clickhouse/client ioredis uuid @faker-js/faker chalk

# ë°ì´í„° ìƒì„±ê¸° ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo 'const kafka = require("kafkajs"); \
const { ClickHouseClient } = require("@clickhouse/client"); \
const Redis = require("ioredis"); \
const { v4: uuidv4 } = require("uuid"); \
const { faker } = require("@faker-js/faker"); \
\
class ContinuousDataGenerator { \
  constructor() { \
    this.kafka = kafka({ \
      clientId: "test-data-generator", \
      brokers: [process.env.KAFKA_BROKERS || "kafka:9092"] \
    }); \
    this.producer = null; \
    this.clickhouse = new ClickHouseClient({ \
      host: `http://${process.env.CLICKHOUSE_HOST || "clickhouse"}:8123`, \
      database: "airis_test" \
    }); \
    this.redis = new Redis({ \
      host: process.env.REDIS_HOST || "redis", \
      port: 6379 \
    }); \
  } \
\
  async initialize() { \
    this.producer = this.kafka.producer(); \
    await this.producer.connect(); \
    console.log("ðŸ“Š ë°ì´í„° ìƒì„±ê¸° ì´ˆê¸°í™” ì™„ë£Œ"); \
  } \
\
  async generateMetrics() { \
    const metrics = Array.from({length: parseInt(process.env.BATCH_SIZE) || 50}, () => ({ \
      id: uuidv4(), \
      timestamp: new Date().toISOString(), \
      metric_name: ["cpu_usage", "memory_usage", "disk_usage"][Math.floor(Math.random()*3)], \
      value: Math.random() * 100, \
      service: ["api-gateway", "aiops", "session-replay"][Math.floor(Math.random()*3)] \
    })); \
\
    await this.producer.send({ \
      topic: "test_metrics", \
      messages: metrics.map(m => ({key: m.id, value: JSON.stringify(m)})) \
    }); \
\
    console.log(`ðŸ“Š ${metrics.length}ê°œ ë©”íŠ¸ë¦­ ìƒì„±ë¨`); \
  } \
\
  async generateEvents() { \
    const events = Array.from({length: 20}, () => ({ \
      id: uuidv4(), \
      timestamp: new Date().toISOString(), \
      event_type: ["user_action", "system_event", "error_event"][Math.floor(Math.random()*3)], \
      message: faker.lorem.sentence(), \
      user_id: `user_${Math.floor(Math.random()*1000)}` \
    })); \
\
    await this.producer.send({ \
      topic: "test_events", \
      messages: events.map(e => ({key: e.id, value: JSON.stringify(e)})) \
    }); \
\
    console.log(`ðŸŽ¯ ${events.length}ê°œ ì´ë²¤íŠ¸ ìƒì„±ë¨`); \
  } \
\
  async start() { \
    await this.initialize(); \
    const interval = parseInt(process.env.GENERATION_INTERVAL) || 10000; \
\
    setInterval(async () => { \
      try { \
        await this.generateMetrics(); \
        await this.generateEvents(); \
      } catch (error) { \
        console.error("ë°ì´í„° ìƒì„± ì˜¤ë¥˜:", error.message); \
      } \
    }, interval); \
\
    console.log(`ðŸš€ ì—°ì† ë°ì´í„° ìƒì„± ì‹œìž‘ (${interval}ms ê°„ê²©)`); \
  } \
} \
\
const generator = new ContinuousDataGenerator(); \
generator.start().catch(console.error);' > generator.js

# ì‹œìž‘ ëª…ë ¹
CMD ["node", "generator.js"]