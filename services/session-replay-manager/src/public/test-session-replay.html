<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRIS EPM ì„¸ì…˜ ë¦¬í”Œë ˆì´ í…ŒìŠ¤íŠ¸</title>
    <!-- Socket.IO ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- rrweb ë¼ì´ë¸ŒëŸ¬ë¦¬ (OpenReplay í˜¸í™˜) -->
    <script src="https://cdn.jsdelivr.net/npm/rrweb@latest/dist/rrweb.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: #2d3748;
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .status-indicator {
            display: inline-block;
            background: #48bb78;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .content {
            padding: 2rem;
        }
        
        .test-section {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .test-section h2 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #3182ce;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-success { background: #48bb78; }
        .btn-success:hover { background: #38a169; }
        
        .btn-warning { background: #ed8936; }
        .btn-warning:hover { background: #dd6b20; }
        
        .btn-danger { background: #e53e3e; }
        .btn-danger:hover { background: #c53030; }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .log-container {
            background: #1a202c;
            color: #a0aec0;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .log-entry {
            margin-bottom: 0.25rem;
            padding: 0.25rem;
            border-radius: 3px;
        }
        
        .log-entry.info { background: rgba(66, 153, 225, 0.1); }
        .log-entry.success { background: rgba(72, 187, 120, 0.1); }
        .log-entry.warning { background: rgba(237, 137, 54, 0.1); }
        .log-entry.error { background: rgba(229, 62, 62, 0.1); }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4299e1;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .recording-indicator {
            animation: pulse 1s infinite;
            color: #e53e3e;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ AIRIS EPM ì„¸ì…˜ ë¦¬í”Œë ˆì´ í…ŒìŠ¤íŠ¸</h1>
            <p>OpenReplay í†µí•© ì„¸ì…˜ ê¸°ë¡ ë° ì¬ìƒ í…ŒìŠ¤íŠ¸ í™˜ê²½</p>
            <div class="status-indicator">
                âœ… Session Recording: <span id="recordingStatus">ì¤€ë¹„ë¨</span>
            </div>
            <div class="status-indicator">
                ğŸ†” Session ID: <span id="sessionId">ìƒì„±ì¤‘...</span>
            </div>
        </div>
        
        <div class="content">
            <!-- 1. ì„¸ì…˜ ê¸°ë¡ í…ŒìŠ¤íŠ¸ -->
            <div class="test-section">
                <h2>1. ì„¸ì…˜ ê¸°ë¡ í…ŒìŠ¤íŠ¸</h2>
                <p>ì‚¬ìš©ì í–‰ë™ì„ ê¸°ë¡í•˜ì—¬ ì„¸ì…˜ ë¦¬í”Œë ˆì´ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="startRecording()">ğŸ”´ ê¸°ë¡ ì‹œì‘</button>
                    <button class="btn btn-warning" onclick="pauseRecording()">â¸ï¸ ê¸°ë¡ ì¼ì‹œì •ì§€</button>
                    <button class="btn btn-danger" onclick="stopRecording()">â¹ï¸ ê¸°ë¡ ì¤‘ì§€</button>
                    <button class="btn" onclick="getSessionInfo()">ğŸ“Š ì„¸ì…˜ ì •ë³´</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="eventCount">0</div>
                        <div class="stat-label">ê¸°ë¡ëœ ì´ë²¤íŠ¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sessionDuration">00:00</div>
                        <div class="stat-label">ì„¸ì…˜ ì‹œê°„</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pageViews">1</div>
                        <div class="stat-label">í˜ì´ì§€ ë·°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="interactions">0</div>
                        <div class="stat-label">ìƒí˜¸ì‘ìš©</div>
                    </div>
                </div>
            </div>
            
            <!-- 2. ì‚¬ìš©ì í–‰ë™ ì‹œë®¬ë ˆì´ì…˜ -->
            <div class="test-section">
                <h2>2. ì‚¬ìš©ì í–‰ë™ ì‹œë®¬ë ˆì´ì…˜</h2>
                <p>ë‹¤ì–‘í•œ ì‚¬ìš©ì í–‰ë™ì„ ì‹œë®¬ë ˆì´ì…˜í•˜ì—¬ í’ë¶€í•œ ì„¸ì…˜ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                
                <div class="input-group">
                    <label>ì‚¬ìš©ì ì´ë¦„</label>
                    <input type="text" id="userName" placeholder="í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì" onchange="logInteraction('input', 'username')">
                </div>
                
                <div class="input-group">
                    <label>ì´ë©”ì¼</label>
                    <input type="email" id="userEmail" placeholder="test@example.com" onchange="logInteraction('input', 'email')">
                </div>
                
                <div class="input-group">
                    <label>ì„ í˜¸ ì¹´í…Œê³ ë¦¬</label>
                    <select id="category" onchange="logInteraction('select', 'category')">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="j2ee">J2EE ëª¨ë‹ˆí„°ë§</option>
                        <option value="was">WAS ëª¨ë‹ˆí„°ë§</option>
                        <option value="session">ì„¸ì…˜ ë¦¬í”Œë ˆì´</option>
                        <option value="analytics">ë¶„ì„ ë„êµ¬</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>í”¼ë“œë°±</label>
                    <textarea id="feedback" rows="3" placeholder="ì‹œìŠ¤í…œì— ëŒ€í•œ í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”..." onchange="logInteraction('textarea', 'feedback')"></textarea>
                </div>
                
                <div class="button-group">
                    <button class="btn" onclick="simulateClick()">ğŸ‘† í´ë¦­ ì‹œë®¬ë ˆì´ì…˜</button>
                    <button class="btn" onclick="simulateScroll()">ğŸ“œ ìŠ¤í¬ë¡¤ ì‹œë®¬ë ˆì´ì…˜</button>
                    <button class="btn" onclick="simulateNavigation()">ğŸ”— í˜ì´ì§€ ì´ë™</button>
                    <button class="btn btn-warning" onclick="simulateError()">âš ï¸ ì˜¤ë¥˜ ë°œìƒ</button>
                </div>
            </div>
            
            <!-- 3. ì„¸ì…˜ ë°ì´í„° í™•ì¸ -->
            <div class="test-section">
                <h2>3. ì„¸ì…˜ ë°ì´í„° í™•ì¸</h2>
                <p>ìˆ˜ì§‘ëœ ì„¸ì…˜ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤.</p>
                
                <div class="button-group">
                    <button class="btn" onclick="loadSessions()">ğŸ“‹ ì„¸ì…˜ ëª©ë¡</button>
                    <button class="btn" onclick="exportSession()">ğŸ’¾ ì„¸ì…˜ ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn" onclick="playSession()" id="playBtn" disabled>â–¶ï¸ ì„¸ì…˜ ì¬ìƒ</button>
                    <button class="btn btn-success" onclick="openDashboard()">ğŸ›ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</button>
                </div>
                
                <div id="sessionList" style="margin-top: 1rem;"></div>
            </div>
            
            <!-- 4. ì‹¤ì‹œê°„ ë¡œê·¸ -->
            <div class="test-section">
                <h2>4. ì‹¤ì‹œê°„ í™œë™ ë¡œê·¸</h2>
                <div class="log-container" id="activityLog">
                    <div class="log-entry info">[ì‹œìŠ¤í…œ] ì„¸ì…˜ ë¦¬í”Œë ˆì´ í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
                </div>
                <button class="btn" onclick="clearLog()" style="margin-top: 0.5rem;">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- ì„¸ì…˜ ì¬ìƒ ëª¨ë‹¬ -->
    <div id="replayModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReplayModal()">&times;</span>
            <h2>ğŸ“¹ ì„¸ì…˜ ë¦¬í”Œë ˆì´</h2>
            <div id="replayContainer" style="border: 1px solid #e2e8f0; border-radius: 6px; height: 400px; margin: 1rem 0;">
                <p style="text-align: center; padding: 2rem; color: #718096;">
                    ì„¸ì…˜ ì¬ìƒì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>
            <div class="button-group">
                <button class="btn" onclick="replayPlay()">â–¶ï¸ ì¬ìƒ</button>
                <button class="btn" onclick="replayPause()">â¸ï¸ ì¼ì‹œì •ì§€</button>
                <button class="btn" onclick="replayRestart()">ğŸ”„ ë‹¤ì‹œë³´ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ë° ì„¸ì…˜ ê´€ë¦¬
        let sessionId = getOrCreateSessionId();
        let isRecording = checkRecordingState();
        let startTime = getSessionStartTime();
        let eventCount = 0;
        let interactionCount = 0;
        let sessionDuration = 0;
        
        // ì„¸ì…˜ ID ê´€ë¦¬ (ë¸Œë¼ìš°ì € ì„¸ì…˜ ê°„ ìœ ì§€)
        function getOrCreateSessionId() {
            // 1. URL íŒŒë¼ë¯¸í„°ì—ì„œ í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            const urlSessionId = urlParams.get('sessionId');
            if (urlSessionId) {
                sessionStorage.setItem('airis_session_id', urlSessionId);
                return urlSessionId;
            }
            
            // 2. ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ í™•ì¸
            const storedSessionId = sessionStorage.getItem('airis_session_id');
            if (storedSessionId) {
                return storedSessionId;
            }
            
            // 3. ìƒˆë¡œìš´ ì„¸ì…˜ ID ìƒì„±
            const newSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('airis_session_id', newSessionId);
            return newSessionId;
        }
        
        // ê¸°ë¡ ìƒíƒœ í™•ì¸
        function checkRecordingState() {
            return sessionStorage.getItem('airis_recording') === 'true';
        }
        
        // ì„¸ì…˜ ì‹œì‘ ì‹œê°„ í™•ì¸
        function getSessionStartTime() {
            const storedStartTime = sessionStorage.getItem('airis_start_time');
            if (storedStartTime && checkRecordingState()) {
                return new Date(storedStartTime);
            }
            return null;
        }
        
        // ì„¸ì…˜ ìƒíƒœ ì €ì¥
        function saveSessionState() {
            sessionStorage.setItem('airis_session_id', sessionId);
            sessionStorage.setItem('airis_recording', isRecording ? 'true' : 'false');
            if (startTime) {
                sessionStorage.setItem('airis_start_time', startTime.toISOString());
            }
        }
        
        // rrweb ê´€ë ¨ ë³€ìˆ˜
        let rrwebEvents = [];
        let rrwebStopFn = null;
        let openReplaySocket = null;
        
        // WebSocket ì—°ê²°
        let socket = null;
        
        function connectWebSocket() {
            try {
                socket = io('http://localhost:3004');
                socket.on('connect', () => {
                    addLog('success', 'WebSocket ì—°ê²° ì„±ê³µ');
                    socket.emit('join_session', sessionId);
                });
                
                socket.on('disconnect', () => {
                    addLog('warning', 'WebSocket ì—°ê²° ëŠì–´ì§');
                });
                
                socket.on('session_update', (data) => {
                    addLog('info', 'ì„¸ì…˜ ì—…ë°ì´íŠ¸: ' + JSON.stringify(data));
                });
                
                // ì„¸ì…˜ ì €ì¥ ì™„ë£Œ ì´ë²¤íŠ¸
                socket.on('session_saved', (data) => {
                    console.log('ì„¸ì…˜ ì €ì¥ ì™„ë£Œ:', data);
                    addLog('success', `âœ… ì„¸ì…˜ ì €ì¥ ì™„ë£Œ: ${data.sessionId}`);
                });
                
                // ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜ ì´ë²¤íŠ¸
                socket.on('session_save_error', (data) => {
                    console.error('ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜:', data);
                    addLog('error', `âŒ ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜: ${data.error}`);
                });
            } catch (error) {
                addLog('error', 'WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error.message);
            }
        }

        // OpenReplay í†µí•© ì„œë¹„ìŠ¤ ì—°ê²° (ì¼ì‹œì ìœ¼ë¡œ ë¹„í™œì„±í™”)
        function connectOpenReplay() {
            console.log('OpenReplay ì„œë¹„ìŠ¤ ì—°ê²° ê±´ë„ˆëœ€ (í˜„ì¬ session-replay-managerë§Œ ì‚¬ìš©)');
            addLog('info', 'ğŸ“ OpenReplay ì„œë¹„ìŠ¤ ë¹„í™œì„±í™” - session-replay-manager ì‚¬ìš©');
            return;
            /*
            try {
                openReplaySocket = io('http://localhost:3030');
                openReplaySocket.on('connect', () => {
                    addLog('success', 'ğŸ¬ OpenReplay ì„œë¹„ìŠ¤ ì—°ê²° ì„±ê³µ');
                    console.log('OpenReplay ì—°ê²°ë¨:', openReplaySocket.id);
                });
                
                openReplaySocket.on('disconnect', () => {
                    addLog('warning', 'ğŸ¬ OpenReplay ì„œë¹„ìŠ¤ ì—°ê²° ëŠì–´ì§');
                });

                openReplaySocket.on('session_events_ack', (data) => {
                    console.log('OpenReplay ì´ë²¤íŠ¸ ìˆ˜ì‹  í™•ì¸:', data);
                    addLog('info', `ğŸ“¡ OpenReplay: ${data.eventCount}ê°œ ì´ë²¤íŠ¸ ìˆ˜ì‹ ë¨`);
                });

                openReplaySocket.on('session_events_error', (data) => {
                    console.error('OpenReplay ì´ë²¤íŠ¸ ì˜¤ë¥˜:', data);
                    addLog('error', `âŒ OpenReplay ì˜¤ë¥˜: ${data.error}`);
                });
            } catch (error) {
                addLog('error', 'ğŸ¬ OpenReplay ì—°ê²° ì‹¤íŒ¨: ' + error.message);
            }
            */
        }

        // OpenReplay ì„œë¹„ìŠ¤ë¡œ ì´ë²¤íŠ¸ ì „ì†¡ (ì¼ì‹œì ìœ¼ë¡œ ë¹„í™œì„±í™”)
        function sendEventsToOpenReplay() {
            console.log('OpenReplay ì´ë²¤íŠ¸ ì „ì†¡ ê±´ë„ˆëœ€');
            return;
            /*
            if (!openReplaySocket || !openReplaySocket.connected) {
                console.warn('OpenReplay ì†Œì¼“ì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ');
                return;
            }

            if (rrwebEvents.length === 0) {
                console.warn('ì „ì†¡í•  rrweb ì´ë²¤íŠ¸ê°€ ì—†ìŒ');
                return;
            }

            try {
                openReplaySocket.emit('session_events', {
                    sessionId: sessionId,
                    events: [...rrwebEvents] // ë³µì‚¬ë³¸ ì „ì†¡
                });
                
                console.log(`ğŸ“¡ OpenReplayë¡œ ${rrwebEvents.length}ê°œ ì´ë²¤íŠ¸ ì „ì†¡ë¨`);
                addLog('info', `ğŸ“¤ OpenReplay: ${rrwebEvents.length}ê°œ ì´ë²¤íŠ¸ ì „ì†¡`);
            } catch (error) {
                console.error('OpenReplay ì´ë²¤íŠ¸ ì „ì†¡ ì˜¤ë¥˜:', error);
                addLog('error', 'ğŸ“¤ OpenReplay ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
            }
            */
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            addLog('info', 'ì„¸ì…˜ ID: ' + sessionId);
            connectWebSocket();
            updateTimer();
            
            // ì‚¬ìš©ì í–‰ë™ ì¶”ì 
            document.addEventListener('click', trackClick);
            document.addEventListener('scroll', trackScroll);
            window.addEventListener('beforeunload', stopRecording);
        });
        
        // ì„¸ì…˜ ê¸°ë¡ ì‹œì‘
        function startRecording() {
            console.log('ğŸ”´ startRecording() í˜¸ì¶œë¨ - í•¨ìˆ˜ ì‹¤í–‰ ì‹œì‘');
            
            if (isRecording) {
                addLog('warning', 'âš ï¸ ì´ë¯¸ ê¸°ë¡ ì¤‘ì…ë‹ˆë‹¤');
                console.log('âš ï¸ ì´ë¯¸ ê¸°ë¡ ì¤‘ì¸ ìƒíƒœ');
                return;
            }
            
            try {
                isRecording = true;
                startTime = new Date();
                eventCount = 0;
                interactionCount = 0;
                rrwebEvents = []; // rrweb ì´ë²¤íŠ¸ ë°°ì—´ ì´ˆê¸°í™”
                
                console.log('ğŸ“Š ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ:', {isRecording, startTime, eventCount, interactionCount});
                
                const statusElement = document.getElementById('recordingStatus');
                if (statusElement) {
                    statusElement.textContent = 'ê¸°ë¡ ì¤‘';
                    statusElement.className = 'recording-indicator';
                    console.log('âœ… ìƒíƒœ ìš”ì†Œ ì—…ë°ì´íŠ¸ ì„±ê³µ');
                } else {
                    console.error('âŒ recordingStatus ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
                
                // rrweb ì´ë²¤íŠ¸ ìˆ˜ì§‘ ì‹œì‘ (ì„±ëŠ¥ ìµœì í™” ë²„ì „)
                if (typeof rrweb !== 'undefined' && rrweb.record) {
                    let updateCounter = 0;
                    rrwebStopFn = rrweb.record({
                        emit: function(event) {
                            // ë©”ëª¨ë¦¬ ë³´í˜¸ë¥¼ ìœ„í•œ ì´ë²¤íŠ¸ ìˆ˜ì§‘ ì œí•œ (ìµœëŒ€ 10000ê°œ)
                            if (rrwebEvents.length >= 10000) {
                                console.warn('âš ï¸ rrweb ì´ë²¤íŠ¸ ìˆ˜ì§‘ ì œí•œ ë„ë‹¬ (10000ê°œ)');
                                return;
                            }
                            
                            // ì´ë²¤íŠ¸ë¥¼ ë°°ì—´ì— ì €ì¥
                            rrwebEvents.push(event);
                            eventCount = rrwebEvents.length;
                            
                            // 100ê°œ ì´ë²¤íŠ¸ë§ˆë‹¤ í†µê³„ ì—…ë°ì´íŠ¸ (ì„±ëŠ¥ ìµœì í™”)
                            updateCounter++;
                            if (updateCounter % 100 === 0) {
                                updateStats();
                                
                                // ì½˜ì†” ë¡œê·¸ë„ 100ê°œë§ˆë‹¤ë§Œ ì¶œë ¥
                                console.log(`ğŸ“¹ rrweb ì´ë²¤íŠ¸ ìˆ˜ì§‘ ì¤‘... (${eventCount}ê°œ)`);
                            }
                            
                            // OpenReplay ì „ì†¡ì€ ë¹„í™œì„±í™”ë¨
                        },
                        // ì„±ëŠ¥ ìµœì í™” ì„¤ì •
                        recordCanvas: false, // ìº”ë²„ìŠ¤ ê¸°ë¡ ë¹„í™œì„±í™”ë¡œ ì„±ëŠ¥ í–¥ìƒ
                        collectFonts: false, // í°íŠ¸ ìˆ˜ì§‘ ë¹„í™œì„±í™”
                        inlineStylesheet: false, // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ìˆ˜ì§‘ ìµœì†Œí™”
                        maskInputOptions: {
                            password: true
                        },
                        slimDOMOptions: {
                            script: false, // script íƒœê·¸ ì œì™¸
                            comment: false, // ì£¼ì„ ì œì™¸
                            headFavicon: false,
                            headWhitespace: false,
                            headMetaSocial: false,
                            headMetaRobots: false,
                            headMetaHttpEquiv: false,
                            headMetaVerification: false
                        },
                        plugins: []
                    });
                    
                    addLog('success', 'ğŸ¬ rrweb ì„¸ì…˜ ê¸°ë¡ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤!');
                    console.log('âœ… rrweb ê¸°ë¡ ì‹œì‘ë¨');
                } else {
                    addLog('warning', 'âš ï¸ rrweb ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ê¸°ë¡ ëª¨ë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    console.warn('rrweb ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìŒ');
                }
                
                addLog('info', `ğŸ“… ì‹œì‘ ì‹œê°„: ${startTime.toLocaleString()}`);
                console.log('âœ… ì„¸ì…˜ ê¸°ë¡ ì‹œì‘ ì™„ë£Œ:', {sessionId, startTime});
                
                // ì„¸ì…˜ ìƒíƒœ ì €ì¥ (ë¸Œë¼ìš°ì € ê°„ ìœ ì§€)
                saveSessionState();
                addLog('info', 'ğŸ’¾ ì„¸ì…˜ ìƒíƒœê°€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œë„ ê³„ì† ê¸°ë¡ë¨)');
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                updateStats();
                
            } catch (error) {
                console.error('âŒ startRecording ì˜¤ë¥˜:', error);
                addLog('error', 'ê¸°ë¡ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            }
            
            // ì„œë²„ì— ê¸°ë¡ ì‹œì‘ ì•Œë¦¼
            fetch('http://localhost:3004/api/sessions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sessionId: sessionId,
                    action: 'start',
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    viewport: {
                        width: window.innerWidth,
                        height: window.innerHeight
                    }
                })
            }).then(response => response.json())
              .then(data => {
                  addLog('info', 'ì„œë²„ ì‘ë‹µ: ' + JSON.stringify(data));
              })
              .catch(error => {
                  addLog('error', 'ì„œë²„ í†µì‹  ì˜¤ë¥˜: ' + error.message);
              });
        }
        
        // ì„¸ì…˜ ê¸°ë¡ ì¼ì‹œì •ì§€
        function pauseRecording() {
            console.log('pauseRecording() í˜¸ì¶œë¨');
            
            if (!isRecording) {
                addLog('warning', 'âš ï¸ ê¸°ë¡ì´ ì§„í–‰ ì¤‘ì´ì§€ ì•ŠìŠµë‹ˆë‹¤');
                return;
            }
            
            try {
                isRecording = false;
                
                const statusElement = document.getElementById('recordingStatus');
                if (statusElement) {
                    statusElement.textContent = 'ì¼ì‹œì •ì§€';
                    statusElement.className = '';
                } else {
                    console.error('recordingStatus ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
                
                addLog('warning', 'â¸ï¸ ì„¸ì…˜ ê¸°ë¡ì„ ì¼ì‹œì •ì§€í–ˆìŠµë‹ˆë‹¤');
                console.log('ì„¸ì…˜ ê¸°ë¡ ì¼ì‹œì •ì§€');
            } catch (error) {
                console.error('pauseRecording ì˜¤ë¥˜:', error);
                addLog('error', 'ì¼ì‹œì •ì§€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            }
        }
        
        // ì„¸ì…˜ ê¸°ë¡ ì¤‘ì§€
        function stopRecording() {
            console.log('stopRecording() í˜¸ì¶œë¨');
            
            if (!isRecording && startTime === null) {
                addLog('warning', 'âš ï¸ ê¸°ë¡í•  ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            try {
                isRecording = false;
                
                // rrweb ê¸°ë¡ ì¤‘ì§€
                if (rrwebStopFn) {
                    rrwebStopFn();
                    rrwebStopFn = null;
                    addLog('info', 'ğŸ“¹ rrweb ê¸°ë¡ ì¤‘ì§€ë¨');
                    console.log('âœ… rrweb ê¸°ë¡ ì¤‘ì§€');
                }
                
                const statusElement = document.getElementById('recordingStatus');
                if (statusElement) {
                    statusElement.textContent = 'ì¤‘ì§€ë¨';
                    statusElement.className = '';
                } else {
                    console.error('recordingStatus ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
                
                const duration = startTime ? Math.floor((new Date() - startTime) / 1000) : 0;
                eventCount = rrwebEvents.length; // ìµœì¢… ì´ë²¤íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                addLog('success', `â¹ï¸ ì„¸ì…˜ ê¸°ë¡ì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤ (${duration}ì´ˆ, ì´ë²¤íŠ¸: ${eventCount}ê°œ)`);
                console.log('ì„¸ì…˜ ê¸°ë¡ ì¤‘ì§€:', {sessionId, duration, eventCount, rrwebEventCount: rrwebEvents.length});
                
                // ìµœì¢… ì´ë²¤íŠ¸ë¥¼ OpenReplayë¡œ ì „ì†¡
                if (rrwebEvents.length > 0) {
                    sendEventsToOpenReplay();
                    
                    // OpenReplay ì„œë¹„ìŠ¤ì— ì„¸ì…˜ ì™„ë£Œ ì•Œë¦¼
                    if (openReplaySocket && openReplaySocket.connected) {
                        const openReplaySessionData = {
                            sessionId: sessionId,
                            events: rrwebEvents,
                            startTime: startTime ? startTime.toISOString() : new Date().toISOString(),
                            endTime: new Date().toISOString(),
                            duration: duration,
                            eventCount: rrwebEvents.length,
                            userAgent: navigator.userAgent,
                            url: window.location.href,
                            viewport: {
                                width: window.innerWidth,
                                height: window.innerHeight
                            }
                        };
                        
                        // REST APIë¡œ OpenReplay ì„œë¹„ìŠ¤ì— ì„¸ì…˜ ì €ì¥
                        fetch('http://localhost:3030/api/sessions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(openReplaySessionData)
                        }).then(response => response.json())
                          .then(data => {
                              console.log('OpenReplay ì„¸ì…˜ ì €ì¥ ì‘ë‹µ:', data);
                              addLog('success', 'ğŸ¬ OpenReplayì— ì„¸ì…˜ ì €ì¥ ì™„ë£Œ');
                          })
                          .catch(error => {
                              console.error('OpenReplay ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜:', error);
                              addLog('error', 'âŒ OpenReplay ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                          });
                    }
                }
                
            } catch (error) {
                console.error('stopRecording ì˜¤ë¥˜:', error);
                addLog('error', 'ê¸°ë¡ ì¤‘ì§€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            }
            
            // ì„œë²„ì— ê¸°ë¡ ì¢…ë£Œ ì•Œë¦¼ (WebSocket + REST API)
            const calculatedDuration = startTime ? Math.floor((new Date() - startTime) / 1000) : 0;
            const sessionStopData = {
                sessionId: sessionId,
                action: 'stop',
                startTime: startTime ? startTime.toISOString() : new Date().toISOString(),
                duration: calculatedDuration,
                eventCount: rrwebEvents.length, // rrweb ì´ë²¤íŠ¸ ì¹´ìš´íŠ¸ ì‚¬ìš©
                interactionCount: interactionCount,
                userAgent: navigator.userAgent,
                url: window.location.href,
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                timestamp: new Date().toISOString(),
                rrwebEvents: [...rrwebEvents] // rrweb ì´ë²¤íŠ¸ í¬í•¨
            };
            
            // WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ì „ì†¡
            if (socket && socket.connected) {
                console.log('WebSocketìœ¼ë¡œ ì „ì†¡í•  ë°ì´í„°:', sessionStopData);
                console.log('rrwebEvents ìˆ˜:', sessionStopData.rrwebEvents ? sessionStopData.rrwebEvents.length : 0);
                socket.emit('session_stop', sessionStopData);
                addLog('info', `ğŸ“¡ WebSocketìœ¼ë¡œ ì„¸ì…˜ ë°ì´í„° ì „ì†¡ ì™„ë£Œ (rrweb: ${sessionStopData.rrwebEvents ? sessionStopData.rrwebEvents.length : 0}ê°œ)`);
            } else {
                console.warn('WebSocket ì—°ê²° ì•ˆë¨:', socket ? socket.connected : 'socket null');
                addLog('warning', 'âš ï¸ WebSocket ì—°ê²° ì‹¤íŒ¨ - REST APIë§Œ ì‚¬ìš©');
            }
            
            // REST APIë¡œë„ ì „ì†¡ (ë°±ì—…)
            console.log('REST APIë¡œ ì „ì†¡í•  ë°ì´í„°:', sessionStopData);
            fetch('http://localhost:3004/api/sessions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(sessionStopData)
            }).then(response => {
                console.log('REST API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                return response.json();
            }).then(data => {
                console.log('ì„¸ì…˜ ì €ì¥ ì‘ë‹µ:', data);
                addLog('success', `ğŸ’¾ REST API ì„¸ì…˜ ì €ì¥ ì™„ë£Œ (rrweb: ${sessionStopData.rrwebEvents ? sessionStopData.rrwebEvents.length : 0}ê°œ)`);
            }).catch(error => {
                console.error('ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜:', error);
                addLog('error', 'âŒ ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            });
            
            // ì„¸ì…˜ ìƒíƒœ í´ë¦¬ì–´
            sessionStorage.removeItem('airis_recording');
            sessionStorage.removeItem('airis_start_time');
            // ì„¸ì…˜ IDëŠ” ìœ ì§€ (ê°™ì€ ë¸Œë¼ìš°ì € ì„¸ì…˜ì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥)
            
            document.getElementById('playBtn').disabled = false;
        }
        
        // í´ë¦­ ì¶”ì 
        function trackClick(event) {
            if (!isRecording) return;
            
            eventCount++;
            interactionCount++;
            updateStats();
            
            const clickData = {
                type: 'click',
                target: event.target.tagName,
                x: event.clientX,
                y: event.clientY,
                timestamp: new Date().toISOString()
            };
            
            addLog('info', 'í´ë¦­ ì´ë²¤íŠ¸: ' + clickData.target + ' (' + clickData.x + ', ' + clickData.y + ')');
        }
        
        // ìŠ¤í¬ë¡¤ ì¶”ì 
        function trackScroll() {
            if (!isRecording) return;
            
            eventCount++;
            updateStats();
        }
        
        // ìƒí˜¸ì‘ìš© ë¡œê·¸
        function logInteraction(type, element) {
            if (!isRecording) return;
            
            eventCount++;
            interactionCount++;
            updateStats();
            
            addLog('info', type.toUpperCase() + ' ìƒí˜¸ì‘ìš©: ' + element);
        }
        
        // í´ë¦­ ì‹œë®¬ë ˆì´ì…˜
        function simulateClick() {
            console.log('ğŸ‘† simulateClick() í˜¸ì¶œë¨ - í´ë¦­ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘');
            try {
                interactionCount++;
                eventCount++;
                
                // ì‹¤ì œ í´ë¦­ ì´ë²¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜
                const x = Math.floor(Math.random() * window.innerWidth);
                const y = Math.floor(Math.random() * window.innerHeight);
                
                const event = new MouseEvent('click', {
                    bubbles: true,
                    cancelable: true,
                    clientX: x,
                    clientY: y
                });
                document.body.dispatchEvent(event);
                
                addLog('info', `ğŸ‘† í´ë¦­ ì´ë²¤íŠ¸ ìƒì„±ë¨ (ì¢Œí‘œ: ${x}, ${y})`);
                console.log('ğŸ“ í´ë¦­ ì¢Œí‘œ:', {x, y});
                console.log('ğŸ“Š í˜„ì¬ í†µê³„:', {eventCount, interactionCount});
                
                updateStats();
                console.log('âœ… í´ë¦­ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ simulateClick ì˜¤ë¥˜:', error);
                addLog('error', 'í´ë¦­ ì‹œë®¬ë ˆì´ì…˜ ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ìŠ¤í¬ë¡¤ ì‹œë®¬ë ˆì´ì…˜
        function simulateScroll() {
            console.log('simulateScroll() í˜¸ì¶œë¨');
            try {
                const scrollAmount = 100;
                window.scrollBy(0, scrollAmount);
                eventCount++;
                addLog('info', `ğŸ“œ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ìƒì„±ë¨ (${scrollAmount}px)`);
                updateStats();
                console.log('ìŠ¤í¬ë¡¤ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ');
            } catch (error) {
                console.error('simulateScroll ì˜¤ë¥˜:', error);
                addLog('error', 'ìŠ¤í¬ë¡¤ ì‹œë®¬ë ˆì´ì…˜ ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ë„¤ë¹„ê²Œì´ì…˜ ì‹œë®¬ë ˆì´ì…˜
        function simulateNavigation() {
            console.log('simulateNavigation() í˜¸ì¶œë¨');
            try {
                const testUrl = '?page=test&time=' + Date.now();
                window.history.pushState({}, '', testUrl);
                eventCount++;
                addLog('info', 'ğŸ”— í˜ì´ì§€ ì´ë™ ì‹œë®¬ë ˆì´ì…˜: ' + testUrl);
                updateStats();
                console.log('ë„¤ë¹„ê²Œì´ì…˜ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ');
            } catch (error) {
                console.error('simulateNavigation ì˜¤ë¥˜:', error);
                addLog('error', 'ë„¤ë¹„ê²Œì´ì…˜ ì‹œë®¬ë ˆì´ì…˜ ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ì˜¤ë¥˜ ì‹œë®¬ë ˆì´ì…˜
        function simulateError() {
            console.log('simulateError() í˜¸ì¶œë¨');
            try {
                eventCount++;
                addLog('error', 'âš ï¸ JavaScript ì˜¤ë¥˜ ì‹œë®¬ë ˆì´ì…˜');
                console.error('ì‹œë®¬ë ˆì´ì…˜ëœ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜ - ì •ìƒ ë™ì‘ì…ë‹ˆë‹¤');
                updateStats();
                console.log('ì˜¤ë¥˜ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ');
            } catch (error) {
                console.error('simulateError ì˜¤ë¥˜:', error);
                addLog('error', 'ì˜¤ë¥˜ ì‹œë®¬ë ˆì´ì…˜ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ì„¸ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getSessionInfo() {
            console.log('getSessionInfo() í˜¸ì¶œë¨');
            try {
                const currentDuration = startTime ? Math.floor((new Date() - startTime) / 1000) : sessionDuration;
                const info = {
                    sessionId: sessionId,
                    isRecording: isRecording,
                    startTime: startTime,
                    duration: currentDuration,
                    eventCount: eventCount,
                    interactionCount: interactionCount,
                    url: window.location.href,
                    userAgent: navigator.userAgent.substring(0, 50) + '...'
                };
                
                addLog('info', 'ğŸ“Š ì„¸ì…˜ ì •ë³´ ì¡°íšŒë¨');
                addLog('info', `ğŸ“ ì„¸ì…˜ ID: ${info.sessionId}`);
                addLog('info', `ğŸ“… ì‹œì‘ ì‹œê°„: ${info.startTime ? info.startTime.toLocaleString() : 'N/A'}`);
                addLog('info', `â±ï¸ ì§€ì† ì‹œê°„: ${info.duration}ì´ˆ`);
                addLog('info', `ğŸ“ˆ ì´ ì´ë²¤íŠ¸: ${info.eventCount}ê°œ`);
                addLog('info', `ğŸ‘† ìƒí˜¸ì‘ìš©: ${info.interactionCount}ê°œ`);
                addLog('info', `ğŸ”„ ìƒíƒœ: ${info.isRecording ? 'ê¸°ë¡ ì¤‘' : 'ì¤‘ì§€ë¨'}`);
                
                console.log('ì„¸ì…˜ ì •ë³´:', info);
            } catch (error) {
                console.error('getSessionInfo ì˜¤ë¥˜:', error);
                addLog('error', 'ì„¸ì…˜ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
        function loadSessions() {
            console.log('loadSessions() í˜¸ì¶œë¨');
            addLog('info', 'ğŸ“‹ ì„¸ì…˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            try {
                fetch('http://localhost:3004/api/sessions')
                    .then(response => {
                        console.log('ì„¸ì…˜ ëª©ë¡ API ì‘ë‹µ:', response);
                        addLog('info', `ğŸ“¡ API ì‘ë‹µ ìƒíƒœ: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        console.log('ë°›ì€ ì„¸ì…˜ ë°ì´í„°:', data);
                        const listContainer = document.getElementById('sessionList');
                        
                        if (!listContainer) {
                            console.error('sessionList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                            addLog('error', 'âŒ ì„¸ì…˜ ëª©ë¡ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                            alert('ì„¸ì…˜ ëª©ë¡ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }
                        
                        if (data.sessions && data.sessions.length > 0) {
                            console.log(`${data.sessions.length}ê°œì˜ ì„¸ì…˜ì„ ì°¾ìŒ`);
                            addLog('success', `âœ… ${data.sessions.length}ê°œì˜ ì„¸ì…˜ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤`);
                            
                            listContainer.innerHTML = '<h3>ì„¸ì…˜ ëª©ë¡:</h3>' + 
                                data.sessions.map(session => 
                                    `<div style="background: #f7fafc; padding: 1rem; margin: 0.5rem 0; border-radius: 6px;">
                                        <strong>ì„¸ì…˜ ID:</strong> ${session.id || 'N/A'}<br>
                                        <strong>ì‹œì‘ ì‹œê°„:</strong> ${session.startTime || 'N/A'}<br>
                                        <strong>ì´ë²¤íŠ¸ ìˆ˜:</strong> ${session.eventCount || 0}
                                    </div>`
                                ).join('');
                        } else {
                            console.log('ì €ì¥ëœ ì„¸ì…˜ì´ ì—†ìŒ');
                            addLog('info', 'ğŸ“ ì €ì¥ëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤');
                            listContainer.innerHTML = '<p>ì €ì¥ëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        }
                        addLog('success', 'âœ… ì„¸ì…˜ ëª©ë¡ì„ ë¡œë“œí–ˆìŠµë‹ˆë‹¤');
                    })
                    .catch(error => {
                        console.error('ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                        addLog('error', 'âŒ ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                        
                        const listContainer = document.getElementById('sessionList');
                        if (listContainer) {
                            listContainer.innerHTML = '<p>ì„¸ì…˜ ëª©ë¡ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message + '</p>';
                        }
                        alert('ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    });
            } catch (error) {
                console.error('loadSessions í•¨ìˆ˜ ì˜¤ë¥˜:', error);
                addLog('error', 'âŒ loadSessions ì‹¤í–‰ ì˜¤ë¥˜: ' + error.message);
                alert('ì„¸ì…˜ ëª©ë¡ í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ì„¸ì…˜ ë‚´ë³´ë‚´ê¸°
        function exportSession() {
            console.log('exportSession() í˜¸ì¶œë¨');
            addLog('info', 'ğŸ“¤ ì„¸ì…˜ ë°ì´í„°ë¥¼ ë‚´ë³´ë‚´ëŠ” ì¤‘...');
            
            try {
                const sessionData = {
                    sessionId: sessionId,
                    startTime: startTime,
                    duration: sessionDuration,
                    eventCount: eventCount,
                    interactionCount: interactionCount,
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    viewport: {
                        width: window.innerWidth,
                        height: window.innerHeight
                    },
                    exportTime: new Date().toISOString()
                };
                
                console.log('ì„¸ì…˜ ë°ì´í„° ìƒì„±ë¨:', sessionData);
                addLog('info', 'ğŸ“Š ì„¸ì…˜ ë°ì´í„° ìƒì„± ì™„ë£Œ');
                
                const dataStr = JSON.stringify(sessionData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `session_${sessionId}_${new Date().toISOString().split('T')[0]}.json`;
                console.log('ë‚´ë³´ë‚¼ íŒŒì¼ëª…:', exportFileDefaultName);
                
                const linkElement = document.createElement('a');
                if (!linkElement) {
                    throw new Error('ë§í¬ ìš”ì†Œ ìƒì„± ì‹¤íŒ¨');
                }
                
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                console.log('ì„¸ì…˜ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
                addLog('success', 'âœ… ì„¸ì…˜ ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤: ' + exportFileDefaultName);
            } catch (error) {
                console.error('exportSession ì˜¤ë¥˜:', error);
                addLog('error', 'âŒ ì„¸ì…˜ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + error.message);
                alert('ì„¸ì…˜ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ì„¸ì…˜ ì¬ìƒ
        function playSession() {
            console.log('playSession() í˜¸ì¶œë¨');
            addLog('info', 'â–¶ï¸ ì„¸ì…˜ ì¬ìƒì„ ì‹œì‘í•˜ëŠ” ì¤‘...');
            
            try {
                // ë‚´ì¥ëœ session-player ì‚¬ìš© (OpenReplay 3030 ì„œë¹„ìŠ¤ ëŒ€ì‹ )
                const sessionPlayerUrl = `http://localhost:3004/session-player.html?sessionId=${sessionId}`;
                const newWindow = window.open(sessionPlayerUrl, '_blank');
                
                if (newWindow) {
                    addLog('success', 'âœ… ì„¸ì…˜ í”Œë ˆì´ì–´ë¥¼ ìƒˆ íƒ­ì—ì„œ ì—´ì—ˆìŠµë‹ˆë‹¤');
                    addLog('info', 'ğŸ¬ rrweb í”Œë ˆì´ì–´ì—ì„œ ì„¸ì…˜ ì¬ìƒì´ ì‹œì‘ë©ë‹ˆë‹¤');
                    console.log('ì„¸ì…˜ í”Œë ˆì´ì–´ ì—´ê¸° ì„±ê³µ:', sessionPlayerUrl);
                } else {
                    addLog('warning', 'âš ï¸ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”');
                    console.warn('íŒì—… ì°¨ë‹¨ë¨');
                    
                    // í´ë°±: ì§ì ‘ ì´ë™
                    addLog('info', 'ğŸ”— ì„¸ì…˜ í”Œë ˆì´ì–´ë¡œ ì§ì ‘ ì´ë™í•©ë‹ˆë‹¤');
                    window.location.href = sessionPlayerUrl;
                }
            } catch (error) {
                console.error('playSession ì˜¤ë¥˜:', error);
                addLog('error', 'âŒ ì„¸ì…˜ ì¬ìƒ ì‹¤íŒ¨: ' + error.message);
                
                // ì˜¤ë¥˜ ë°œìƒì‹œ í´ë°±: ê¸°ì¡´ ëª¨ë‹¬
                try {
                    const replayModal = document.getElementById('replayModal');
                    if (replayModal) {
                        replayModal.style.display = 'block';
                        addLog('info', 'ğŸ“± ì˜¤ë¥˜ ë°œìƒìœ¼ë¡œ ë¡œì»¬ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤');
                    }
                } catch (fallbackError) {
                    alert('ì„¸ì…˜ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        }
        
        // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì—´ê¸°
        function openDashboard() {
            console.log('openDashboard() í˜¸ì¶œë¨');
            try {
                const dashboardUrl = 'http://localhost:3004/';
                const newWindow = window.open(dashboardUrl, '_blank');
                
                if (newWindow) {
                    addLog('info', 'ğŸ›ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œë¥¼ ìƒˆ íƒ­ì—ì„œ ì—´ì—ˆìŠµë‹ˆë‹¤');
                    console.log('ëŒ€ì‹œë³´ë“œ ì—´ê¸° ì„±ê³µ:', dashboardUrl);
                } else {
                    addLog('warning', 'âš ï¸ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”');
                    console.warn('íŒì—… ì°¨ë‹¨ë¨');
                }
            } catch (error) {
                console.error('openDashboard ì˜¤ë¥˜:', error);
                addLog('error', 'ëŒ€ì‹œë³´ë“œ ì—´ê¸° ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            try {
                const eventCountElement = document.getElementById('eventCount');
                const interactionsElement = document.getElementById('interactions');
                
                if (eventCountElement) eventCountElement.textContent = eventCount;
                if (interactionsElement) interactionsElement.textContent = interactionCount;
            } catch (error) {
                console.error('í†µê³„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
        function updateTimer() {
            try {
                if (isRecording && startTime) {
                    sessionDuration = Math.floor((new Date() - startTime) / 1000);
                    const minutes = Math.floor(sessionDuration / 60);
                    const seconds = sessionDuration % 60;
                    const durationElement = document.getElementById('sessionDuration');
                    if (durationElement) {
                        durationElement.textContent = 
                            minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
                    }
                }
            } catch (error) {
                console.error('íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
            setTimeout(updateTimer, 1000);
        }
        
        // ë¡œê·¸ ì¶”ê°€
        function addLog(type, message) {
            try {
                const logContainer = document.getElementById('activityLog');
                if (logContainer) {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry ' + type;
                    logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                    logContainer.appendChild(logEntry);
                    logContainer.scrollTop = logContainer.scrollHeight;
                } else {
                    console.log(`[${new Date().toLocaleTimeString()}] ${type}: ${message}`);
                }
            } catch (error) {
                console.error('ë¡œê·¸ ì¶”ê°€ ì˜¤ë¥˜:', error);
                console.log(`[${new Date().toLocaleTimeString()}] ${type}: ${message}`);
            }
        }
        
        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLog() {
            console.log('clearLog() í˜¸ì¶œë¨');
            try {
                const logContainer = document.getElementById('activityLog');
                if (logContainer) {
                    logContainer.innerHTML = 
                        '<div class="log-entry info">ğŸ—‘ï¸ [ì‹œìŠ¤í…œ] ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.</div>';
                    console.log('ë¡œê·¸ ì§€ìš°ê¸° ì™„ë£Œ');
                } else {
                    console.error('activityLog ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    alert('ë¡œê·¸ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('clearLog ì˜¤ë¥˜:', error);
                alert('ë¡œê·¸ ì§€ìš°ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function closeReplayModal() {
            document.getElementById('replayModal').style.display = 'none';
        }
        
        function replayPlay() {
            addLog('info', 'ì¬ìƒ ì‹œì‘');
        }
        
        function replayPause() {
            addLog('info', 'ì¬ìƒ ì¼ì‹œì •ì§€');
        }
        
        function replayRestart() {
            addLog('info', 'ì¬ìƒ ë‹¤ì‹œì‹œì‘');
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('replayModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ í…ŒìŠ¤íŠ¸
        function testFunctions() {
            console.log('=== í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ í…ŒìŠ¤íŠ¸ ===');
            console.log('startRecording í•¨ìˆ˜ ì¡´ì¬:', typeof startRecording === 'function');
            console.log('pauseRecording í•¨ìˆ˜ ì¡´ì¬:', typeof pauseRecording === 'function');
            console.log('stopRecording í•¨ìˆ˜ ì¡´ì¬:', typeof stopRecording === 'function');
            console.log('simulateClick í•¨ìˆ˜ ì¡´ì¬:', typeof simulateClick === 'function');
            console.log('addLog í•¨ìˆ˜ ì¡´ì¬:', typeof addLog === 'function');
            console.log('updateStats í•¨ìˆ˜ ì¡´ì¬:', typeof updateStats === 'function');
            console.log('--- ì„¸ì…˜ ë°ì´í„° í•¨ìˆ˜ë“¤ ---');
            console.log('loadSessions í•¨ìˆ˜ ì¡´ì¬:', typeof loadSessions === 'function');
            console.log('exportSession í•¨ìˆ˜ ì¡´ì¬:', typeof exportSession === 'function');
            console.log('playSession í•¨ìˆ˜ ì¡´ì¬:', typeof playSession === 'function');
            console.log('=== í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
        }
        
        // ìˆ˜ë™ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function manualTest() {
            console.log('=== ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
            try {
                startRecording();
                console.log('startRecording í˜¸ì¶œ ì„±ê³µ');
            } catch (e) {
                console.error('startRecording í˜¸ì¶œ ì‹¤íŒ¨:', e);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            console.log('=== ì„¸ì…˜ ë¦¬í”Œë ˆì´ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ===');
            
            // í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ ë¨¼ì € í…ŒìŠ¤íŠ¸
            testFunctions();
            
            try {
                // ì„¸ì…˜ ì •ë³´ í‘œì‹œ
                const sessionIdElement = document.getElementById('sessionId');
                if (sessionIdElement) {
                    sessionIdElement.textContent = sessionId;
                    console.log('âœ… ì„¸ì…˜ ID ì„¤ì • ì™„ë£Œ:', sessionId);
                } else {
                    console.warn('âš ï¸ sessionId ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                // ë²„íŠ¼ë“¤ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (onclick ë³´ì™„)
                setupEventListeners();
                
                // WebSocket ì—°ê²°
                connectWebSocket();
                
                // OpenReplay ì„œë¹„ìŠ¤ ì—°ê²°
                connectOpenReplay();
                
                // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
                setInterval(updateTimer, 1000);
                
                // ì´ˆê¸° ë¡œê·¸
                addLog('info', 'ğŸš€ ì„¸ì…˜ ë¦¬í”Œë ˆì´ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
                addLog('info', 'ğŸ†” ì„¸ì…˜ ID: ' + sessionId);
                addLog('info', 'ğŸ“ ì½˜ì†”ì—ì„œ manualTest() ì‹¤í–‰ìœ¼ë¡œ ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥');
                
                // ìˆ˜ë™ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
                window.manualTest = manualTest;
                window.testFunctions = testFunctions;
                
                console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ');
                console.log('ğŸ“ ìˆ˜ë™ í…ŒìŠ¤íŠ¸: ì½˜ì†”ì—ì„œ manualTest() ë˜ëŠ” testFunctions() ì‹¤í–‰');
            } catch (error) {
                console.error('âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                addLog('error', 'ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error.message);
                alert('í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • í•¨ìˆ˜
        function setupEventListeners() {
            console.log('=== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘ ===');
            
            try {
                // ê¸°ë¡ ì œì–´ ë²„íŠ¼ë“¤
                const startBtn = document.querySelector('button[onclick="startRecording()"]');
                const pauseBtn = document.querySelector('button[onclick="pauseRecording()"]');
                const stopBtn = document.querySelector('button[onclick="stopRecording()"]');
                const infoBtn = document.querySelector('button[onclick="getSessionInfo()"]');
                
                // ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ë“¤
                const clickBtn = document.querySelector('button[onclick="simulateClick()"]');
                const scrollBtn = document.querySelector('button[onclick="simulateScroll()"]');
                const navBtn = document.querySelector('button[onclick="simulateNavigation()"]');
                const errorBtn = document.querySelector('button[onclick="simulateError()"]');
                
                // ì„¸ì…˜ ë°ì´í„° ë²„íŠ¼ë“¤
                const loadSessionsBtn = document.querySelector('button[onclick="loadSessions()"]');
                const exportSessionBtn = document.querySelector('button[onclick="exportSession()"]');
                const playSessionBtn = document.querySelector('button[onclick="playSession()"]');
                
                // ê´€ë¦¬ ë²„íŠ¼ë“¤
                const dashboardBtn = document.querySelector('button[onclick="openDashboard()"]');
                const clearBtn = document.querySelector('button[onclick="clearLog()"]');
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                if (startBtn) {
                    startBtn.addEventListener('click', startRecording);
                    console.log('âœ… ê¸°ë¡ ì‹œì‘ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                if (pauseBtn) {
                    pauseBtn.addEventListener('click', pauseRecording);
                    console.log('âœ… ê¸°ë¡ ì¼ì‹œì •ì§€ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                if (stopBtn) {
                    stopBtn.addEventListener('click', stopRecording);
                    console.log('âœ… ê¸°ë¡ ì¤‘ì§€ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                if (infoBtn) {
                    infoBtn.addEventListener('click', getSessionInfo);
                    console.log('âœ… ì„¸ì…˜ ì •ë³´ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                if (clickBtn) {
                    clickBtn.addEventListener('click', simulateClick);
                    console.log('âœ… í´ë¦­ ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                if (scrollBtn) {
                    scrollBtn.addEventListener('click', simulateScroll);
                    console.log('âœ… ìŠ¤í¬ë¡¤ ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                if (navBtn) {
                    navBtn.addEventListener('click', simulateNavigation);
                    console.log('âœ… ë„¤ë¹„ê²Œì´ì…˜ ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                if (errorBtn) {
                    errorBtn.addEventListener('click', simulateError);
                    console.log('âœ… ì˜¤ë¥˜ ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                if (dashboardBtn) {
                    dashboardBtn.addEventListener('click', openDashboard);
                    console.log('âœ… ëŒ€ì‹œë³´ë“œ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                if (clearBtn) {
                    clearBtn.addEventListener('click', clearLog);
                    console.log('âœ… ë¡œê·¸ ì§€ìš°ê¸° ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                
                // ì„¸ì…˜ ë°ì´í„° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                if (loadSessionsBtn) {
                    loadSessionsBtn.addEventListener('click', loadSessions);
                    console.log('âœ… ì„¸ì…˜ ëª©ë¡ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                if (exportSessionBtn) {
                    exportSessionBtn.addEventListener('click', exportSession);
                    console.log('âœ… ì„¸ì…˜ ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                if (playSessionBtn) {
                    playSessionBtn.addEventListener('click', playSession);
                    console.log('âœ… ì„¸ì…˜ ì¬ìƒ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                }
                
                console.log('=== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ ===');
            } catch (error) {
                console.error('âŒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì˜¤ë¥˜:', error);
                addLog('error', 'ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì˜¤ë¥˜: ' + error.message);
            }
        }
    </script>
</body>
</html>