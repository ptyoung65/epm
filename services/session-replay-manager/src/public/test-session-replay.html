<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRIS EPM 세션 리플레이 테스트</title>
    <!-- Socket.IO 라이브러리 -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- rrweb 라이브러리 (OpenReplay 호환) -->
    <script src="https://cdn.jsdelivr.net/npm/rrweb@latest/dist/rrweb.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: #2d3748;
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .status-indicator {
            display: inline-block;
            background: #48bb78;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .content {
            padding: 2rem;
        }
        
        .test-section {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .test-section h2 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #3182ce;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-success { background: #48bb78; }
        .btn-success:hover { background: #38a169; }
        
        .btn-warning { background: #ed8936; }
        .btn-warning:hover { background: #dd6b20; }
        
        .btn-danger { background: #e53e3e; }
        .btn-danger:hover { background: #c53030; }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .log-container {
            background: #1a202c;
            color: #a0aec0;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .log-entry {
            margin-bottom: 0.25rem;
            padding: 0.25rem;
            border-radius: 3px;
        }
        
        .log-entry.info { background: rgba(66, 153, 225, 0.1); }
        .log-entry.success { background: rgba(72, 187, 120, 0.1); }
        .log-entry.warning { background: rgba(237, 137, 54, 0.1); }
        .log-entry.error { background: rgba(229, 62, 62, 0.1); }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4299e1;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .recording-indicator {
            animation: pulse 1s infinite;
            color: #e53e3e;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 AIRIS EPM 세션 리플레이 테스트</h1>
            <p>OpenReplay 통합 세션 기록 및 재생 테스트 환경</p>
            <div class="status-indicator">
                ✅ Session Recording: <span id="recordingStatus">준비됨</span>
            </div>
            <div class="status-indicator">
                🆔 Session ID: <span id="sessionId">생성중...</span>
            </div>
        </div>
        
        <div class="content">
            <!-- 1. 세션 기록 테스트 -->
            <div class="test-section">
                <h2>1. 세션 기록 테스트</h2>
                <p>사용자 행동을 기록하여 세션 리플레이 데이터를 생성합니다.</p>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="startRecording()">🔴 기록 시작</button>
                    <button class="btn btn-warning" onclick="pauseRecording()">⏸️ 기록 일시정지</button>
                    <button class="btn btn-danger" onclick="stopRecording()">⏹️ 기록 중지</button>
                    <button class="btn" onclick="getSessionInfo()">📊 세션 정보</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="eventCount">0</div>
                        <div class="stat-label">기록된 이벤트</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sessionDuration">00:00</div>
                        <div class="stat-label">세션 시간</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pageViews">1</div>
                        <div class="stat-label">페이지 뷰</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="interactions">0</div>
                        <div class="stat-label">상호작용</div>
                    </div>
                </div>
            </div>
            
            <!-- 2. 사용자 행동 시뮬레이션 -->
            <div class="test-section">
                <h2>2. 사용자 행동 시뮬레이션</h2>
                <p>다양한 사용자 행동을 시뮬레이션하여 풍부한 세션 데이터를 생성합니다.</p>
                
                <div class="input-group">
                    <label>사용자 이름</label>
                    <input type="text" id="userName" placeholder="테스트 사용자" onchange="logInteraction('input', 'username')">
                </div>
                
                <div class="input-group">
                    <label>이메일</label>
                    <input type="email" id="userEmail" placeholder="test@example.com" onchange="logInteraction('input', 'email')">
                </div>
                
                <div class="input-group">
                    <label>선호 카테고리</label>
                    <select id="category" onchange="logInteraction('select', 'category')">
                        <option value="">선택하세요</option>
                        <option value="j2ee">J2EE 모니터링</option>
                        <option value="was">WAS 모니터링</option>
                        <option value="session">세션 리플레이</option>
                        <option value="analytics">분석 도구</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>피드백</label>
                    <textarea id="feedback" rows="3" placeholder="시스템에 대한 피드백을 입력하세요..." onchange="logInteraction('textarea', 'feedback')"></textarea>
                </div>
                
                <div class="button-group">
                    <button class="btn" onclick="simulateClick()">👆 클릭 시뮬레이션</button>
                    <button class="btn" onclick="simulateScroll()">📜 스크롤 시뮬레이션</button>
                    <button class="btn" onclick="simulateNavigation()">🔗 페이지 이동</button>
                    <button class="btn btn-warning" onclick="simulateError()">⚠️ 오류 발생</button>
                </div>
            </div>
            
            <!-- 3. 세션 데이터 확인 -->
            <div class="test-section">
                <h2>3. 세션 데이터 확인</h2>
                <p>수집된 세션 데이터를 확인하고 분석합니다.</p>
                
                <div class="button-group">
                    <button class="btn" onclick="loadSessions()">📋 세션 목록</button>
                    <button class="btn" onclick="exportSession()">💾 세션 내보내기</button>
                    <button class="btn" onclick="playSession()" id="playBtn" disabled>▶️ 세션 재생</button>
                    <button class="btn btn-success" onclick="openDashboard()">🎛️ 관리자 대시보드</button>
                </div>
                
                <div id="sessionList" style="margin-top: 1rem;"></div>
            </div>
            
            <!-- 4. 실시간 로그 -->
            <div class="test-section">
                <h2>4. 실시간 활동 로그</h2>
                <div class="log-container" id="activityLog">
                    <div class="log-entry info">[시스템] 세션 리플레이 테스트 환경이 준비되었습니다.</div>
                </div>
                <button class="btn" onclick="clearLog()" style="margin-top: 0.5rem;">🗑️ 로그 지우기</button>
            </div>
        </div>
    </div>
    
    <!-- 세션 재생 모달 -->
    <div id="replayModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReplayModal()">&times;</span>
            <h2>📹 세션 리플레이</h2>
            <div id="replayContainer" style="border: 1px solid #e2e8f0; border-radius: 6px; height: 400px; margin: 1rem 0;">
                <p style="text-align: center; padding: 2rem; color: #718096;">
                    세션 재생이 여기에 표시됩니다.
                </p>
            </div>
            <div class="button-group">
                <button class="btn" onclick="replayPlay()">▶️ 재생</button>
                <button class="btn" onclick="replayPause()">⏸️ 일시정지</button>
                <button class="btn" onclick="replayRestart()">🔄 다시보기</button>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수 및 세션 관리
        let sessionId = getOrCreateSessionId();
        let isRecording = checkRecordingState();
        let startTime = getSessionStartTime();
        let eventCount = 0;
        let interactionCount = 0;
        let sessionDuration = 0;
        
        // 세션 ID 관리 (브라우저 세션 간 유지)
        function getOrCreateSessionId() {
            // 1. URL 파라미터에서 확인
            const urlParams = new URLSearchParams(window.location.search);
            const urlSessionId = urlParams.get('sessionId');
            if (urlSessionId) {
                sessionStorage.setItem('airis_session_id', urlSessionId);
                return urlSessionId;
            }
            
            // 2. 세션 스토리지에서 확인
            const storedSessionId = sessionStorage.getItem('airis_session_id');
            if (storedSessionId) {
                return storedSessionId;
            }
            
            // 3. 새로운 세션 ID 생성
            const newSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('airis_session_id', newSessionId);
            return newSessionId;
        }
        
        // 기록 상태 확인
        function checkRecordingState() {
            return sessionStorage.getItem('airis_recording') === 'true';
        }
        
        // 세션 시작 시간 확인
        function getSessionStartTime() {
            const storedStartTime = sessionStorage.getItem('airis_start_time');
            if (storedStartTime && checkRecordingState()) {
                return new Date(storedStartTime);
            }
            return null;
        }
        
        // 세션 상태 저장
        function saveSessionState() {
            sessionStorage.setItem('airis_session_id', sessionId);
            sessionStorage.setItem('airis_recording', isRecording ? 'true' : 'false');
            if (startTime) {
                sessionStorage.setItem('airis_start_time', startTime.toISOString());
            }
        }
        
        // rrweb 관련 변수
        let rrwebEvents = [];
        let rrwebStopFn = null;
        let openReplaySocket = null;
        
        // WebSocket 연결
        let socket = null;
        
        function connectWebSocket() {
            try {
                socket = io('http://localhost:3004');
                socket.on('connect', () => {
                    addLog('success', 'WebSocket 연결 성공');
                    socket.emit('join_session', sessionId);
                });
                
                socket.on('disconnect', () => {
                    addLog('warning', 'WebSocket 연결 끊어짐');
                });
                
                socket.on('session_update', (data) => {
                    addLog('info', '세션 업데이트: ' + JSON.stringify(data));
                });
                
                // 세션 저장 완료 이벤트
                socket.on('session_saved', (data) => {
                    console.log('세션 저장 완료:', data);
                    addLog('success', `✅ 세션 저장 완료: ${data.sessionId}`);
                });
                
                // 세션 저장 오류 이벤트
                socket.on('session_save_error', (data) => {
                    console.error('세션 저장 오류:', data);
                    addLog('error', `❌ 세션 저장 오류: ${data.error}`);
                });
            } catch (error) {
                addLog('error', 'WebSocket 연결 실패: ' + error.message);
            }
        }

        // OpenReplay 통합 서비스 연결 (일시적으로 비활성화)
        function connectOpenReplay() {
            console.log('OpenReplay 서비스 연결 건너뜀 (현재 session-replay-manager만 사용)');
            addLog('info', '📝 OpenReplay 서비스 비활성화 - session-replay-manager 사용');
            return;
            /*
            try {
                openReplaySocket = io('http://localhost:3030');
                openReplaySocket.on('connect', () => {
                    addLog('success', '🎬 OpenReplay 서비스 연결 성공');
                    console.log('OpenReplay 연결됨:', openReplaySocket.id);
                });
                
                openReplaySocket.on('disconnect', () => {
                    addLog('warning', '🎬 OpenReplay 서비스 연결 끊어짐');
                });

                openReplaySocket.on('session_events_ack', (data) => {
                    console.log('OpenReplay 이벤트 수신 확인:', data);
                    addLog('info', `📡 OpenReplay: ${data.eventCount}개 이벤트 수신됨`);
                });

                openReplaySocket.on('session_events_error', (data) => {
                    console.error('OpenReplay 이벤트 오류:', data);
                    addLog('error', `❌ OpenReplay 오류: ${data.error}`);
                });
            } catch (error) {
                addLog('error', '🎬 OpenReplay 연결 실패: ' + error.message);
            }
            */
        }

        // OpenReplay 서비스로 이벤트 전송 (일시적으로 비활성화)
        function sendEventsToOpenReplay() {
            console.log('OpenReplay 이벤트 전송 건너뜀');
            return;
            /*
            if (!openReplaySocket || !openReplaySocket.connected) {
                console.warn('OpenReplay 소켓이 연결되지 않음');
                return;
            }

            if (rrwebEvents.length === 0) {
                console.warn('전송할 rrweb 이벤트가 없음');
                return;
            }

            try {
                openReplaySocket.emit('session_events', {
                    sessionId: sessionId,
                    events: [...rrwebEvents] // 복사본 전송
                });
                
                console.log(`📡 OpenReplay로 ${rrwebEvents.length}개 이벤트 전송됨`);
                addLog('info', `📤 OpenReplay: ${rrwebEvents.length}개 이벤트 전송`);
            } catch (error) {
                console.error('OpenReplay 이벤트 전송 오류:', error);
                addLog('error', '📤 OpenReplay 전송 실패: ' + error.message);
            }
            */
        }
        
        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            addLog('info', '세션 ID: ' + sessionId);
            connectWebSocket();
            updateTimer();
            
            // 사용자 행동 추적
            document.addEventListener('click', trackClick);
            document.addEventListener('scroll', trackScroll);
            window.addEventListener('beforeunload', stopRecording);
        });
        
        // 세션 기록 시작
        function startRecording() {
            console.log('🔴 startRecording() 호출됨 - 함수 실행 시작');
            
            if (isRecording) {
                addLog('warning', '⚠️ 이미 기록 중입니다');
                console.log('⚠️ 이미 기록 중인 상태');
                return;
            }
            
            try {
                isRecording = true;
                startTime = new Date();
                eventCount = 0;
                interactionCount = 0;
                rrwebEvents = []; // rrweb 이벤트 배열 초기화
                
                console.log('📊 변수 설정 완료:', {isRecording, startTime, eventCount, interactionCount});
                
                const statusElement = document.getElementById('recordingStatus');
                if (statusElement) {
                    statusElement.textContent = '기록 중';
                    statusElement.className = 'recording-indicator';
                    console.log('✅ 상태 요소 업데이트 성공');
                } else {
                    console.error('❌ recordingStatus 요소를 찾을 수 없음');
                }
                
                // rrweb 이벤트 수집 시작 (성능 최적화 버전)
                if (typeof rrweb !== 'undefined' && rrweb.record) {
                    let updateCounter = 0;
                    rrwebStopFn = rrweb.record({
                        emit: function(event) {
                            // 메모리 보호를 위한 이벤트 수집 제한 (최대 10000개)
                            if (rrwebEvents.length >= 10000) {
                                console.warn('⚠️ rrweb 이벤트 수집 제한 도달 (10000개)');
                                return;
                            }
                            
                            // 이벤트를 배열에 저장
                            rrwebEvents.push(event);
                            eventCount = rrwebEvents.length;
                            
                            // 100개 이벤트마다 통계 업데이트 (성능 최적화)
                            updateCounter++;
                            if (updateCounter % 100 === 0) {
                                updateStats();
                                
                                // 콘솔 로그도 100개마다만 출력
                                console.log(`📹 rrweb 이벤트 수집 중... (${eventCount}개)`);
                            }
                            
                            // OpenReplay 전송은 비활성화됨
                        },
                        // 성능 최적화 설정
                        recordCanvas: false, // 캔버스 기록 비활성화로 성능 향상
                        collectFonts: false, // 폰트 수집 비활성화
                        inlineStylesheet: false, // 인라인 스타일 수집 최소화
                        maskInputOptions: {
                            password: true
                        },
                        slimDOMOptions: {
                            script: false, // script 태그 제외
                            comment: false, // 주석 제외
                            headFavicon: false,
                            headWhitespace: false,
                            headMetaSocial: false,
                            headMetaRobots: false,
                            headMetaHttpEquiv: false,
                            headMetaVerification: false
                        },
                        plugins: []
                    });
                    
                    addLog('success', '🎬 rrweb 세션 기록을 시작했습니다!');
                    console.log('✅ rrweb 기록 시작됨');
                } else {
                    addLog('warning', '⚠️ rrweb 라이브러리를 찾을 수 없습니다. 기본 기록 모드를 사용합니다.');
                    console.warn('rrweb 라이브러리 없음');
                }
                
                addLog('info', `📅 시작 시간: ${startTime.toLocaleString()}`);
                console.log('✅ 세션 기록 시작 완료:', {sessionId, startTime});
                
                // 세션 상태 저장 (브라우저 간 유지)
                saveSessionState();
                addLog('info', '💾 세션 상태가 브라우저에 저장되었습니다 (다른 페이지에서도 계속 기록됨)');
                
                // 통계 업데이트
                updateStats();
                
            } catch (error) {
                console.error('❌ startRecording 오류:', error);
                addLog('error', '기록 시작 중 오류 발생: ' + error.message);
            }
            
            // 서버에 기록 시작 알림
            fetch('http://localhost:3004/api/sessions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sessionId: sessionId,
                    action: 'start',
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    viewport: {
                        width: window.innerWidth,
                        height: window.innerHeight
                    }
                })
            }).then(response => response.json())
              .then(data => {
                  addLog('info', '서버 응답: ' + JSON.stringify(data));
              })
              .catch(error => {
                  addLog('error', '서버 통신 오류: ' + error.message);
              });
        }
        
        // 세션 기록 일시정지
        function pauseRecording() {
            console.log('pauseRecording() 호출됨');
            
            if (!isRecording) {
                addLog('warning', '⚠️ 기록이 진행 중이지 않습니다');
                return;
            }
            
            try {
                isRecording = false;
                
                const statusElement = document.getElementById('recordingStatus');
                if (statusElement) {
                    statusElement.textContent = '일시정지';
                    statusElement.className = '';
                } else {
                    console.error('recordingStatus 요소를 찾을 수 없음');
                }
                
                addLog('warning', '⏸️ 세션 기록을 일시정지했습니다');
                console.log('세션 기록 일시정지');
            } catch (error) {
                console.error('pauseRecording 오류:', error);
                addLog('error', '일시정지 중 오류 발생: ' + error.message);
            }
        }
        
        // 세션 기록 중지
        function stopRecording() {
            console.log('stopRecording() 호출됨');
            
            if (!isRecording && startTime === null) {
                addLog('warning', '⚠️ 기록할 세션이 없습니다');
                return;
            }
            
            try {
                isRecording = false;
                
                // rrweb 기록 중지
                if (rrwebStopFn) {
                    rrwebStopFn();
                    rrwebStopFn = null;
                    addLog('info', '📹 rrweb 기록 중지됨');
                    console.log('✅ rrweb 기록 중지');
                }
                
                const statusElement = document.getElementById('recordingStatus');
                if (statusElement) {
                    statusElement.textContent = '중지됨';
                    statusElement.className = '';
                } else {
                    console.error('recordingStatus 요소를 찾을 수 없음');
                }
                
                const duration = startTime ? Math.floor((new Date() - startTime) / 1000) : 0;
                eventCount = rrwebEvents.length; // 최종 이벤트 카운트 업데이트
                addLog('success', `⏹️ 세션 기록을 중지했습니다 (${duration}초, 이벤트: ${eventCount}개)`);
                console.log('세션 기록 중지:', {sessionId, duration, eventCount, rrwebEventCount: rrwebEvents.length});
                
                // 최종 이벤트를 OpenReplay로 전송
                if (rrwebEvents.length > 0) {
                    sendEventsToOpenReplay();
                    
                    // OpenReplay 서비스에 세션 완료 알림
                    if (openReplaySocket && openReplaySocket.connected) {
                        const openReplaySessionData = {
                            sessionId: sessionId,
                            events: rrwebEvents,
                            startTime: startTime ? startTime.toISOString() : new Date().toISOString(),
                            endTime: new Date().toISOString(),
                            duration: duration,
                            eventCount: rrwebEvents.length,
                            userAgent: navigator.userAgent,
                            url: window.location.href,
                            viewport: {
                                width: window.innerWidth,
                                height: window.innerHeight
                            }
                        };
                        
                        // REST API로 OpenReplay 서비스에 세션 저장
                        fetch('http://localhost:3030/api/sessions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(openReplaySessionData)
                        }).then(response => response.json())
                          .then(data => {
                              console.log('OpenReplay 세션 저장 응답:', data);
                              addLog('success', '🎬 OpenReplay에 세션 저장 완료');
                          })
                          .catch(error => {
                              console.error('OpenReplay 세션 저장 오류:', error);
                              addLog('error', '❌ OpenReplay 저장 실패: ' + error.message);
                          });
                    }
                }
                
            } catch (error) {
                console.error('stopRecording 오류:', error);
                addLog('error', '기록 중지 중 오류 발생: ' + error.message);
            }
            
            // 서버에 기록 종료 알림 (WebSocket + REST API)
            const calculatedDuration = startTime ? Math.floor((new Date() - startTime) / 1000) : 0;
            const sessionStopData = {
                sessionId: sessionId,
                action: 'stop',
                startTime: startTime ? startTime.toISOString() : new Date().toISOString(),
                duration: calculatedDuration,
                eventCount: rrwebEvents.length, // rrweb 이벤트 카운트 사용
                interactionCount: interactionCount,
                userAgent: navigator.userAgent,
                url: window.location.href,
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                timestamp: new Date().toISOString(),
                rrwebEvents: [...rrwebEvents] // rrweb 이벤트 포함
            };
            
            // WebSocket으로 실시간 전송
            if (socket && socket.connected) {
                console.log('WebSocket으로 전송할 데이터:', sessionStopData);
                console.log('rrwebEvents 수:', sessionStopData.rrwebEvents ? sessionStopData.rrwebEvents.length : 0);
                socket.emit('session_stop', sessionStopData);
                addLog('info', `📡 WebSocket으로 세션 데이터 전송 완료 (rrweb: ${sessionStopData.rrwebEvents ? sessionStopData.rrwebEvents.length : 0}개)`);
            } else {
                console.warn('WebSocket 연결 안됨:', socket ? socket.connected : 'socket null');
                addLog('warning', '⚠️ WebSocket 연결 실패 - REST API만 사용');
            }
            
            // REST API로도 전송 (백업)
            console.log('REST API로 전송할 데이터:', sessionStopData);
            fetch('http://localhost:3004/api/sessions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(sessionStopData)
            }).then(response => {
                console.log('REST API 응답 상태:', response.status, response.statusText);
                return response.json();
            }).then(data => {
                console.log('세션 저장 응답:', data);
                addLog('success', `💾 REST API 세션 저장 완료 (rrweb: ${sessionStopData.rrwebEvents ? sessionStopData.rrwebEvents.length : 0}개)`);
            }).catch(error => {
                console.error('세션 저장 오류:', error);
                addLog('error', '❌ 세션 저장 실패: ' + error.message);
            });
            
            // 세션 상태 클리어
            sessionStorage.removeItem('airis_recording');
            sessionStorage.removeItem('airis_start_time');
            // 세션 ID는 유지 (같은 브라우저 세션에서 재사용 가능)
            
            document.getElementById('playBtn').disabled = false;
        }
        
        // 클릭 추적
        function trackClick(event) {
            if (!isRecording) return;
            
            eventCount++;
            interactionCount++;
            updateStats();
            
            const clickData = {
                type: 'click',
                target: event.target.tagName,
                x: event.clientX,
                y: event.clientY,
                timestamp: new Date().toISOString()
            };
            
            addLog('info', '클릭 이벤트: ' + clickData.target + ' (' + clickData.x + ', ' + clickData.y + ')');
        }
        
        // 스크롤 추적
        function trackScroll() {
            if (!isRecording) return;
            
            eventCount++;
            updateStats();
        }
        
        // 상호작용 로그
        function logInteraction(type, element) {
            if (!isRecording) return;
            
            eventCount++;
            interactionCount++;
            updateStats();
            
            addLog('info', type.toUpperCase() + ' 상호작용: ' + element);
        }
        
        // 클릭 시뮬레이션
        function simulateClick() {
            console.log('👆 simulateClick() 호출됨 - 클릭 시뮬레이션 시작');
            try {
                interactionCount++;
                eventCount++;
                
                // 실제 클릭 이벤트 시뮬레이션
                const x = Math.floor(Math.random() * window.innerWidth);
                const y = Math.floor(Math.random() * window.innerHeight);
                
                const event = new MouseEvent('click', {
                    bubbles: true,
                    cancelable: true,
                    clientX: x,
                    clientY: y
                });
                document.body.dispatchEvent(event);
                
                addLog('info', `👆 클릭 이벤트 생성됨 (좌표: ${x}, ${y})`);
                console.log('📍 클릭 좌표:', {x, y});
                console.log('📊 현재 통계:', {eventCount, interactionCount});
                
                updateStats();
                console.log('✅ 클릭 시뮬레이션 완료');
                
            } catch (error) {
                console.error('❌ simulateClick 오류:', error);
                addLog('error', '클릭 시뮬레이션 오류: ' + error.message);
            }
        }
        
        // 스크롤 시뮬레이션
        function simulateScroll() {
            console.log('simulateScroll() 호출됨');
            try {
                const scrollAmount = 100;
                window.scrollBy(0, scrollAmount);
                eventCount++;
                addLog('info', `📜 스크롤 이벤트 생성됨 (${scrollAmount}px)`);
                updateStats();
                console.log('스크롤 시뮬레이션 완료');
            } catch (error) {
                console.error('simulateScroll 오류:', error);
                addLog('error', '스크롤 시뮬레이션 오류: ' + error.message);
            }
        }
        
        // 네비게이션 시뮬레이션
        function simulateNavigation() {
            console.log('simulateNavigation() 호출됨');
            try {
                const testUrl = '?page=test&time=' + Date.now();
                window.history.pushState({}, '', testUrl);
                eventCount++;
                addLog('info', '🔗 페이지 이동 시뮬레이션: ' + testUrl);
                updateStats();
                console.log('네비게이션 시뮬레이션 완료');
            } catch (error) {
                console.error('simulateNavigation 오류:', error);
                addLog('error', '네비게이션 시뮬레이션 오류: ' + error.message);
            }
        }
        
        // 오류 시뮬레이션
        function simulateError() {
            console.log('simulateError() 호출됨');
            try {
                eventCount++;
                addLog('error', '⚠️ JavaScript 오류 시뮬레이션');
                console.error('시뮬레이션된 테스트 오류 - 정상 동작입니다');
                updateStats();
                console.log('오류 시뮬레이션 완료');
            } catch (error) {
                console.error('simulateError 오류:', error);
                addLog('error', '오류 시뮬레이션 실패: ' + error.message);
            }
        }
        
        // 세션 정보 가져오기
        function getSessionInfo() {
            console.log('getSessionInfo() 호출됨');
            try {
                const currentDuration = startTime ? Math.floor((new Date() - startTime) / 1000) : sessionDuration;
                const info = {
                    sessionId: sessionId,
                    isRecording: isRecording,
                    startTime: startTime,
                    duration: currentDuration,
                    eventCount: eventCount,
                    interactionCount: interactionCount,
                    url: window.location.href,
                    userAgent: navigator.userAgent.substring(0, 50) + '...'
                };
                
                addLog('info', '📊 세션 정보 조회됨');
                addLog('info', `📍 세션 ID: ${info.sessionId}`);
                addLog('info', `📅 시작 시간: ${info.startTime ? info.startTime.toLocaleString() : 'N/A'}`);
                addLog('info', `⏱️ 지속 시간: ${info.duration}초`);
                addLog('info', `📈 총 이벤트: ${info.eventCount}개`);
                addLog('info', `👆 상호작용: ${info.interactionCount}개`);
                addLog('info', `🔄 상태: ${info.isRecording ? '기록 중' : '중지됨'}`);
                
                console.log('세션 정보:', info);
            } catch (error) {
                console.error('getSessionInfo 오류:', error);
                addLog('error', '세션 정보 조회 오류: ' + error.message);
            }
        }
        
        // 세션 목록 로드
        function loadSessions() {
            console.log('loadSessions() 호출됨');
            addLog('info', '📋 세션 목록을 불러오는 중...');
            
            try {
                fetch('http://localhost:3004/api/sessions')
                    .then(response => {
                        console.log('세션 목록 API 응답:', response);
                        addLog('info', `📡 API 응답 상태: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        console.log('받은 세션 데이터:', data);
                        const listContainer = document.getElementById('sessionList');
                        
                        if (!listContainer) {
                            console.error('sessionList 요소를 찾을 수 없음');
                            addLog('error', '❌ 세션 목록 컨테이너를 찾을 수 없습니다');
                            alert('세션 목록 컨테이너를 찾을 수 없습니다.');
                            return;
                        }
                        
                        if (data.sessions && data.sessions.length > 0) {
                            console.log(`${data.sessions.length}개의 세션을 찾음`);
                            addLog('success', `✅ ${data.sessions.length}개의 세션을 발견했습니다`);
                            
                            listContainer.innerHTML = '<h3>세션 목록:</h3>' + 
                                data.sessions.map(session => 
                                    `<div style="background: #f7fafc; padding: 1rem; margin: 0.5rem 0; border-radius: 6px;">
                                        <strong>세션 ID:</strong> ${session.id || 'N/A'}<br>
                                        <strong>시작 시간:</strong> ${session.startTime || 'N/A'}<br>
                                        <strong>이벤트 수:</strong> ${session.eventCount || 0}
                                    </div>`
                                ).join('');
                        } else {
                            console.log('저장된 세션이 없음');
                            addLog('info', '📝 저장된 세션이 없습니다');
                            listContainer.innerHTML = '<p>저장된 세션이 없습니다.</p>';
                        }
                        addLog('success', '✅ 세션 목록을 로드했습니다');
                    })
                    .catch(error => {
                        console.error('세션 목록 로드 오류:', error);
                        addLog('error', '❌ 세션 목록 로드 실패: ' + error.message);
                        
                        const listContainer = document.getElementById('sessionList');
                        if (listContainer) {
                            listContainer.innerHTML = '<p>세션 목록을 로드할 수 없습니다: ' + error.message + '</p>';
                        }
                        alert('세션 목록 로드 중 오류가 발생했습니다: ' + error.message);
                    });
            } catch (error) {
                console.error('loadSessions 함수 오류:', error);
                addLog('error', '❌ loadSessions 실행 오류: ' + error.message);
                alert('세션 목록 함수 실행 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 세션 내보내기
        function exportSession() {
            console.log('exportSession() 호출됨');
            addLog('info', '📤 세션 데이터를 내보내는 중...');
            
            try {
                const sessionData = {
                    sessionId: sessionId,
                    startTime: startTime,
                    duration: sessionDuration,
                    eventCount: eventCount,
                    interactionCount: interactionCount,
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    viewport: {
                        width: window.innerWidth,
                        height: window.innerHeight
                    },
                    exportTime: new Date().toISOString()
                };
                
                console.log('세션 데이터 생성됨:', sessionData);
                addLog('info', '📊 세션 데이터 생성 완료');
                
                const dataStr = JSON.stringify(sessionData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `session_${sessionId}_${new Date().toISOString().split('T')[0]}.json`;
                console.log('내보낼 파일명:', exportFileDefaultName);
                
                const linkElement = document.createElement('a');
                if (!linkElement) {
                    throw new Error('링크 요소 생성 실패');
                }
                
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                console.log('세션 데이터 내보내기 완료');
                addLog('success', '✅ 세션 데이터를 내보냈습니다: ' + exportFileDefaultName);
            } catch (error) {
                console.error('exportSession 오류:', error);
                addLog('error', '❌ 세션 내보내기 실패: ' + error.message);
                alert('세션 내보내기 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 세션 재생
        function playSession() {
            console.log('playSession() 호출됨');
            addLog('info', '▶️ 세션 재생을 시작하는 중...');
            
            try {
                // 내장된 session-player 사용 (OpenReplay 3030 서비스 대신)
                const sessionPlayerUrl = `http://localhost:3004/session-player.html?sessionId=${sessionId}`;
                const newWindow = window.open(sessionPlayerUrl, '_blank');
                
                if (newWindow) {
                    addLog('success', '✅ 세션 플레이어를 새 탭에서 열었습니다');
                    addLog('info', '🎬 rrweb 플레이어에서 세션 재생이 시작됩니다');
                    console.log('세션 플레이어 열기 성공:', sessionPlayerUrl);
                } else {
                    addLog('warning', '⚠️ 팝업이 차단되었습니다. 브라우저 설정을 확인하세요');
                    console.warn('팝업 차단됨');
                    
                    // 폴백: 직접 이동
                    addLog('info', '🔗 세션 플레이어로 직접 이동합니다');
                    window.location.href = sessionPlayerUrl;
                }
            } catch (error) {
                console.error('playSession 오류:', error);
                addLog('error', '❌ 세션 재생 실패: ' + error.message);
                
                // 오류 발생시 폴백: 기존 모달
                try {
                    const replayModal = document.getElementById('replayModal');
                    if (replayModal) {
                        replayModal.style.display = 'block';
                        addLog('info', '📱 오류 발생으로 로컬 모달을 표시합니다');
                    }
                } catch (fallbackError) {
                    alert('세션 재생 중 오류가 발생했습니다: ' + error.message);
                }
            }
        }
        
        // 관리자 대시보드 열기
        function openDashboard() {
            console.log('openDashboard() 호출됨');
            try {
                const dashboardUrl = 'http://localhost:3004/';
                const newWindow = window.open(dashboardUrl, '_blank');
                
                if (newWindow) {
                    addLog('info', '🎛️ 관리자 대시보드를 새 탭에서 열었습니다');
                    console.log('대시보드 열기 성공:', dashboardUrl);
                } else {
                    addLog('warning', '⚠️ 팝업이 차단되었습니다. 브라우저 설정을 확인하세요');
                    console.warn('팝업 차단됨');
                }
            } catch (error) {
                console.error('openDashboard 오류:', error);
                addLog('error', '대시보드 열기 오류: ' + error.message);
            }
        }
        
        // 통계 업데이트
        function updateStats() {
            try {
                const eventCountElement = document.getElementById('eventCount');
                const interactionsElement = document.getElementById('interactions');
                
                if (eventCountElement) eventCountElement.textContent = eventCount;
                if (interactionsElement) interactionsElement.textContent = interactionCount;
            } catch (error) {
                console.error('통계 업데이트 오류:', error);
            }
        }
        
        // 타이머 업데이트
        function updateTimer() {
            try {
                if (isRecording && startTime) {
                    sessionDuration = Math.floor((new Date() - startTime) / 1000);
                    const minutes = Math.floor(sessionDuration / 60);
                    const seconds = sessionDuration % 60;
                    const durationElement = document.getElementById('sessionDuration');
                    if (durationElement) {
                        durationElement.textContent = 
                            minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
                    }
                }
            } catch (error) {
                console.error('타이머 업데이트 오류:', error);
            }
            setTimeout(updateTimer, 1000);
        }
        
        // 로그 추가
        function addLog(type, message) {
            try {
                const logContainer = document.getElementById('activityLog');
                if (logContainer) {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry ' + type;
                    logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                    logContainer.appendChild(logEntry);
                    logContainer.scrollTop = logContainer.scrollHeight;
                } else {
                    console.log(`[${new Date().toLocaleTimeString()}] ${type}: ${message}`);
                }
            } catch (error) {
                console.error('로그 추가 오류:', error);
                console.log(`[${new Date().toLocaleTimeString()}] ${type}: ${message}`);
            }
        }
        
        // 로그 지우기
        function clearLog() {
            console.log('clearLog() 호출됨');
            try {
                const logContainer = document.getElementById('activityLog');
                if (logContainer) {
                    logContainer.innerHTML = 
                        '<div class="log-entry info">🗑️ [시스템] 로그가 지워졌습니다.</div>';
                    console.log('로그 지우기 완료');
                } else {
                    console.error('activityLog 요소를 찾을 수 없음');
                    alert('로그 컨테이너를 찾을 수 없습니다.');
                }
            } catch (error) {
                console.error('clearLog 오류:', error);
                alert('로그 지우기 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 모달 관련 함수들
        function closeReplayModal() {
            document.getElementById('replayModal').style.display = 'none';
        }
        
        function replayPlay() {
            addLog('info', '재생 시작');
        }
        
        function replayPause() {
            addLog('info', '재생 일시정지');
        }
        
        function replayRestart() {
            addLog('info', '재생 다시시작');
        }
        
        // 모달 외부 클릭시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('replayModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // 함수 존재 여부 테스트
        function testFunctions() {
            console.log('=== 함수 존재 여부 테스트 ===');
            console.log('startRecording 함수 존재:', typeof startRecording === 'function');
            console.log('pauseRecording 함수 존재:', typeof pauseRecording === 'function');
            console.log('stopRecording 함수 존재:', typeof stopRecording === 'function');
            console.log('simulateClick 함수 존재:', typeof simulateClick === 'function');
            console.log('addLog 함수 존재:', typeof addLog === 'function');
            console.log('updateStats 함수 존재:', typeof updateStats === 'function');
            console.log('--- 세션 데이터 함수들 ---');
            console.log('loadSessions 함수 존재:', typeof loadSessions === 'function');
            console.log('exportSession 함수 존재:', typeof exportSession === 'function');
            console.log('playSession 함수 존재:', typeof playSession === 'function');
            console.log('=== 테스트 완료 ===');
        }
        
        // 수동 테스트 함수
        function manualTest() {
            console.log('=== 수동 테스트 시작 ===');
            try {
                startRecording();
                console.log('startRecording 호출 성공');
            } catch (e) {
                console.error('startRecording 호출 실패:', e);
            }
        }
        
        // 페이지 로드 시 초기화
        window.onload = function() {
            console.log('=== 세션 리플레이 페이지 로드 완료 ===');
            
            // 함수 존재 여부 먼저 테스트
            testFunctions();
            
            try {
                // 세션 정보 표시
                const sessionIdElement = document.getElementById('sessionId');
                if (sessionIdElement) {
                    sessionIdElement.textContent = sessionId;
                    console.log('✅ 세션 ID 설정 완료:', sessionId);
                } else {
                    console.warn('⚠️ sessionId 요소를 찾을 수 없습니다');
                }
                
                // 버튼들에 이벤트 리스너 추가 (onclick 보완)
                setupEventListeners();
                
                // WebSocket 연결
                connectWebSocket();
                
                // OpenReplay 서비스 연결
                connectOpenReplay();
                
                // 타이머 업데이트
                setInterval(updateTimer, 1000);
                
                // 초기 로그
                addLog('info', '🚀 세션 리플레이 테스트 페이지가 로드되었습니다');
                addLog('info', '🆔 세션 ID: ' + sessionId);
                addLog('info', '📝 콘솔에서 manualTest() 실행으로 수동 테스트 가능');
                
                // 수동 테스트 함수를 전역으로 노출
                window.manualTest = manualTest;
                window.testFunctions = testFunctions;
                
                console.log('✅ 초기화 완료');
                console.log('📝 수동 테스트: 콘솔에서 manualTest() 또는 testFunctions() 실행');
            } catch (error) {
                console.error('❌ 초기화 중 오류 발생:', error);
                addLog('error', '초기화 오류: ' + error.message);
                alert('페이지 초기화 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 이벤트 리스너 설정 함수
        function setupEventListeners() {
            console.log('=== 이벤트 리스너 설정 시작 ===');
            
            try {
                // 기록 제어 버튼들
                const startBtn = document.querySelector('button[onclick="startRecording()"]');
                const pauseBtn = document.querySelector('button[onclick="pauseRecording()"]');
                const stopBtn = document.querySelector('button[onclick="stopRecording()"]');
                const infoBtn = document.querySelector('button[onclick="getSessionInfo()"]');
                
                // 시뮬레이션 버튼들
                const clickBtn = document.querySelector('button[onclick="simulateClick()"]');
                const scrollBtn = document.querySelector('button[onclick="simulateScroll()"]');
                const navBtn = document.querySelector('button[onclick="simulateNavigation()"]');
                const errorBtn = document.querySelector('button[onclick="simulateError()"]');
                
                // 세션 데이터 버튼들
                const loadSessionsBtn = document.querySelector('button[onclick="loadSessions()"]');
                const exportSessionBtn = document.querySelector('button[onclick="exportSession()"]');
                const playSessionBtn = document.querySelector('button[onclick="playSession()"]');
                
                // 관리 버튼들
                const dashboardBtn = document.querySelector('button[onclick="openDashboard()"]');
                const clearBtn = document.querySelector('button[onclick="clearLog()"]');
                
                // 이벤트 리스너 추가
                if (startBtn) {
                    startBtn.addEventListener('click', startRecording);
                    console.log('✅ 기록 시작 버튼 리스너 추가');
                }
                if (pauseBtn) {
                    pauseBtn.addEventListener('click', pauseRecording);
                    console.log('✅ 기록 일시정지 버튼 리스너 추가');
                }
                if (stopBtn) {
                    stopBtn.addEventListener('click', stopRecording);
                    console.log('✅ 기록 중지 버튼 리스너 추가');
                }
                if (infoBtn) {
                    infoBtn.addEventListener('click', getSessionInfo);
                    console.log('✅ 세션 정보 버튼 리스너 추가');
                }
                if (clickBtn) {
                    clickBtn.addEventListener('click', simulateClick);
                    console.log('✅ 클릭 시뮬레이션 버튼 리스너 추가');
                }
                if (scrollBtn) {
                    scrollBtn.addEventListener('click', simulateScroll);
                    console.log('✅ 스크롤 시뮬레이션 버튼 리스너 추가');
                }
                if (navBtn) {
                    navBtn.addEventListener('click', simulateNavigation);
                    console.log('✅ 네비게이션 시뮬레이션 버튼 리스너 추가');
                }
                if (errorBtn) {
                    errorBtn.addEventListener('click', simulateError);
                    console.log('✅ 오류 시뮬레이션 버튼 리스너 추가');
                }
                if (dashboardBtn) {
                    dashboardBtn.addEventListener('click', openDashboard);
                    console.log('✅ 대시보드 버튼 리스너 추가');
                }
                if (clearBtn) {
                    clearBtn.addEventListener('click', clearLog);
                    console.log('✅ 로그 지우기 버튼 리스너 추가');
                }
                
                // 세션 데이터 버튼 이벤트 리스너
                if (loadSessionsBtn) {
                    loadSessionsBtn.addEventListener('click', loadSessions);
                    console.log('✅ 세션 목록 버튼 리스너 추가');
                }
                if (exportSessionBtn) {
                    exportSessionBtn.addEventListener('click', exportSession);
                    console.log('✅ 세션 내보내기 버튼 리스너 추가');
                }
                if (playSessionBtn) {
                    playSessionBtn.addEventListener('click', playSession);
                    console.log('✅ 세션 재생 버튼 리스너 추가');
                }
                
                console.log('=== 이벤트 리스너 설정 완료 ===');
            } catch (error) {
                console.error('❌ 이벤트 리스너 설정 오류:', error);
                addLog('error', '이벤트 리스너 설정 오류: ' + error.message);
            }
        }
    </script>
</body>
</html>