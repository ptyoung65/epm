<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenReplay Session Player - AIRIS EPM</title>
    <!-- rrweb ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/rrweb@latest/dist/rrweb.min.js"></script>
    <!-- rrweb í”Œë ˆì´ì–´ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/index.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: #2d3748;
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .controls {
            padding: 2rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .control-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .btn:hover { background: #2563eb; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        
        select {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            min-width: 300px;
        }
        
        .session-info {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }
        
        .session-info h3 {
            margin-bottom: 0.5rem;
            color: #1e293b;
        }
        
        .player-container {
            padding: 2rem;
            min-height: 600px;
        }
        
        #player {
            width: 100%;
            min-height: 500px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .status.loading { background: #fef3c7; color: #92400e; }
        .status.ready { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.playing { background: #dbeafe; color: #1d4ed8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ OpenReplay Session Player</h1>
            <p>AIRIS EPM ì„¸ì…˜ ë¦¬í”Œë ˆì´ í”Œë ˆì´ì–´</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <select id="sessionSelect">
                    <option value="">ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”...</option>
                </select>
                <button id="loadBtn" class="btn">ì„¸ì…˜ ë¡œë“œ</button>
                <span id="status" class="status loading">ì„¸ì…˜ ëª©ë¡ ë¡œë”© ì¤‘...</span>
            </div>
            
            <div id="sessionInfo" class="session-info">
                <h3>ì„¸ì…˜ ì •ë³´</h3>
                <div id="sessionDetails"></div>
            </div>
        </div>
        
        <div class="player-container">
            <div id="player"></div>
        </div>
    </div>

    <script>
        let currentSession = null;
        let playerInstance = null;
        
        // DOM ìš”ì†Œë“¤
        const sessionSelect = document.getElementById('sessionSelect');
        const loadBtn = document.getElementById('loadBtn');
        const statusEl = document.getElementById('status');
        const sessionInfo = document.getElementById('sessionInfo');
        const sessionDetails = document.getElementById('sessionDetails');
        const playerEl = document.getElementById('player');
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStatus(message, type = 'loading') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        // ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const data = await response.json();
                
                sessionSelect.innerHTML = '<option value="">ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”...</option>';
                
                if (data.sessions && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        // ëª¨ë“  ì„¸ì…˜ì„ í‘œì‹œ (eventCount ì¡°ê±´ ì œê±°)
                        const option = document.createElement('option');
                        option.value = session.sessionId;
                        
                        // ì„¸ì…˜ ì •ë³´ í‘œì‹œ
                        let displayText = `${session.sessionId}`;
                        if (session.eventCount) displayText += ` (${session.eventCount} ì´ë²¤íŠ¸)`;
                        if (session.duration) displayText += ` ${session.duration}ì´ˆ`;
                        if (session.createdAt) {
                            const date = new Date(session.createdAt).toLocaleString();
                            displayText += ` - ${date}`;
                        }
                        
                        option.textContent = displayText;
                        sessionSelect.appendChild(option);
                    });
                    updateStatus(`${data.sessions.length}ê°œ ì„¸ì…˜ ë¡œë“œ ì™„ë£Œ`, 'ready');
                } else {
                    updateStatus('ì €ì¥ëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                }
            } catch (error) {
                console.error('ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                updateStatus('ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
        }
        
        // ì„¸ì…˜ ë¡œë“œ
        async function loadSession(sessionId) {
            try {
                console.log('ğŸ” ì„¸ì…˜ ë¡œë“œ ì‹œì‘:', sessionId);
                updateStatus('ì„¸ì…˜ ë¡œë”© ì¤‘...', 'loading');
                
                const apiUrl = `/api/sessions/${sessionId}`;
                console.log('ğŸ“¡ API í˜¸ì¶œ:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('ğŸ“¥ API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (${response.status}: ${response.statusText})`);
                }
                
                currentSession = await response.json();
                console.log('âœ… ë¡œë“œëœ ì„¸ì…˜:', currentSession);
                console.log('ğŸ“Š ì„¸ì…˜ ë°ì´í„° êµ¬ì¡°:', {
                    sessionId: currentSession.sessionId,
                    hasRrwebEvents: !!currentSession.rrwebEvents,
                    rrwebEventsCount: currentSession.rrwebEvents ? currentSession.rrwebEvents.length : 0,
                    eventCount: currentSession.eventCount,
                    duration: currentSession.duration
                });
                
                // ì„¸ì…˜ ì •ë³´ í‘œì‹œ
                displaySessionInfo(currentSession);
                
                // rrweb ì´ë²¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
                if (currentSession.rrwebEvents && currentSession.rrwebEvents.length > 0) {
                    console.log('ğŸ¬ rrweb ì´ë²¤íŠ¸ ë°œê²¬:', currentSession.rrwebEvents.length, 'ê°œ');
                    console.log('ğŸ” ì²« ë²ˆì§¸ ì´ë²¤íŠ¸ ìƒ˜í”Œ:', currentSession.rrwebEvents[0]);
                    
                    // rrweb í”Œë ˆì´ì–´ë¡œ ì¬ìƒ
                    playWithRrweb(currentSession.rrwebEvents);
                } else {
                    console.warn('âš ï¸ rrweb ì´ë²¤íŠ¸ê°€ ì—†ìŒ');
                    updateStatus('ì´ ì„¸ì…˜ì—ëŠ” ì¬ìƒ ê°€ëŠ¥í•œ rrweb ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ì„¸ì…˜ì„ ë…¹í™”í•´ì£¼ì„¸ìš”.', 'error');
                    
                    // ì„¸ì…˜ ì •ë³´ëŠ” ì—¬ì „íˆ í‘œì‹œ
                    playerEl.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #ef4444;">
                            <h3>ğŸ¬ ì¬ìƒí•  ìˆ˜ ì—†ëŠ” ì„¸ì…˜</h3>
                            <p style="margin: 1rem 0;">ì´ ì„¸ì…˜ì—ëŠ” rrweb ì´ë²¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p style="color: #6b7280;">ìƒˆë¡œìš´ ì„¸ì…˜ì„ ë…¹í™”í•˜ë ¤ë©´ <a href="/test-session-replay.html" style="color: #3b82f6;">í…ŒìŠ¤íŠ¸ í˜ì´ì§€</a>ë¡œ ì´ë™í•˜ì„¸ìš”.</p>
                            <div style="margin-top: 2rem; padding: 1rem; background: #f3f4f6; border-radius: 8px;">
                                <h4>ğŸ ë””ë²„ê·¸ ì •ë³´:</h4>
                                <p><strong>ì„¸ì…˜ ID:</strong> ${currentSession.sessionId || 'N/A'}</p>
                                <p><strong>ì´ë²¤íŠ¸ ìˆ˜:</strong> ${currentSession.eventCount || 0}</p>
                                <p><strong>rrweb ì´ë²¤íŠ¸:</strong> ${currentSession.rrwebEvents ? currentSession.rrwebEvents.length : 0}ê°œ</p>
                                <p><strong>ì§€ì† ì‹œê°„:</strong> ${currentSession.duration || 0}ì´ˆ</p>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('âŒ ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', error);
                updateStatus(`ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                
                // ì˜¤ë¥˜ ì •ë³´ í‘œì‹œ
                playerEl.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #ef4444;">
                        <h3>âŒ ì„¸ì…˜ ë¡œë“œ ì˜¤ë¥˜</h3>
                        <p style="margin: 1rem 0;">ì„¸ì…˜ì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        <div style="margin-top: 2rem; padding: 1rem; background: #fef2f2; border-radius: 8px; text-align: left;">
                            <h4>ğŸ ì˜¤ë¥˜ ì •ë³´:</h4>
                            <p><strong>ì„¸ì…˜ ID:</strong> ${sessionId}</p>
                            <p><strong>ì˜¤ë¥˜ ë©”ì‹œì§€:</strong> ${error.message}</p>
                            <p><strong>API URL:</strong> /api/sessions/${sessionId}</p>
                        </div>
                        <p style="margin-top: 1rem; color: #6b7280;">
                            <a href="/test-session-replay.html" style="color: #3b82f6;">ìƒˆë¡œìš´ ì„¸ì…˜ì„ ë…¹í™”</a>í•˜ê±°ë‚˜ 
                            <a href="/session-player.html" style="color: #3b82f6;">ì„¸ì…˜ ëª©ë¡</a>ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.
                        </p>
                    </div>
                `;
            }
        }
        
        // rrweb í”Œë ˆì´ì–´ë¡œ ì¬ìƒ
        function playWithRrweb(events) {
            try {
                // ê¸°ì¡´ í”Œë ˆì´ì–´ ì •ë¦¬
                if (playerInstance) {
                    playerInstance.destroy?.();
                }
                
                // í”Œë ˆì´ì–´ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
                playerEl.innerHTML = '';
                
                console.log('rrweb ì´ë²¤íŠ¸ ìˆ˜:', events.length);
                console.log('ì²« ë²ˆì§¸ ì´ë²¤íŠ¸:', events[0]);
                
                // rrweb-player ìƒì„±
                if (typeof rrwebPlayer !== 'undefined') {
                    playerInstance = new rrwebPlayer({
                        target: playerEl,
                        props: {
                            events: events,
                            width: playerEl.offsetWidth,
                            height: 600,
                            autoPlay: false,
                            speedOption: [0.5, 1, 2, 4],
                            showController: true,
                            tags: {
                                'session-id': currentSession.sessionId
                            }
                        }
                    });
                    
                    updateStatus('ì¬ìƒ ì¤€ë¹„ ì™„ë£Œ', 'playing');
                    console.log('rrweb í”Œë ˆì´ì–´ ìƒì„± ì™„ë£Œ');
                } else {
                    throw new Error('rrweb-player ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                console.error('í”Œë ˆì´ì–´ ìƒì„± ì‹¤íŒ¨:', error);
                updateStatus(`í”Œë ˆì´ì–´ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                
                // ëŒ€ì²´: rrweb.Replayer ì‚¬ìš©
                tryAlternativePlayer(events);
            }
        }
        
        // ëŒ€ì²´ í”Œë ˆì´ì–´ (rrweb.Replayer)
        function tryAlternativePlayer(events) {
            try {
                playerEl.innerHTML = '<div id="replayer-container" style="width: 100%; height: 600px; border: 1px solid #ddd;"></div>';
                
                const replayer = new rrweb.Replayer(events, {
                    target: document.getElementById('replayer-container'),
                    props: {
                        width: playerEl.offsetWidth,
                        height: 600,
                    }
                });
                
                // ì¬ìƒ ì»¨íŠ¸ë¡¤ ì¶”ê°€
                const controls = document.createElement('div');
                controls.style.cssText = 'padding: 1rem; background: #f8f9fa; border-top: 1px solid #ddd; text-align: center;';
                controls.innerHTML = `
                    <button onclick="replayer.play()" class="btn">ì¬ìƒ</button>
                    <button onclick="replayer.pause()" class="btn">ì¼ì‹œì •ì§€</button>
                    <button onclick="replayer.goto(0)" class="btn">ì²˜ìŒìœ¼ë¡œ</button>
                `;
                
                playerEl.appendChild(controls);
                window.currentReplayer = replayer; // ì „ì—­ ì ‘ê·¼ì„ ìœ„í•´
                
                updateStatus('ëŒ€ì²´ í”Œë ˆì´ì–´ ì¤€ë¹„ ì™„ë£Œ', 'playing');
                console.log('rrweb.Replayer ìƒì„± ì™„ë£Œ');
                
            } catch (error) {
                console.error('ëŒ€ì²´ í”Œë ˆì´ì–´ë„ ì‹¤íŒ¨:', error);
                updateStatus('í”Œë ˆì´ì–´ ìƒì„± ì™„ì „ ì‹¤íŒ¨', 'error');
                playerEl.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;"><h3>í”Œë ˆì´ì–´ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3><p>' + error.message + '</p></div>';
            }
        }
        
        // ì„¸ì…˜ ì •ë³´ í‘œì‹œ
        function displaySessionInfo(session) {
            const details = [];
            details.push(`<strong>ì„¸ì…˜ ID:</strong> ${session.sessionId}`);
            details.push(`<strong>ìƒì„± ì‹œê°„:</strong> ${new Date(session.createdAt).toLocaleString()}`);
            if (session.duration) details.push(`<strong>ì§€ì† ì‹œê°„:</strong> ${session.duration}ì´ˆ`);
            if (session.eventCount) details.push(`<strong>ì´ë²¤íŠ¸ ìˆ˜:</strong> ${session.eventCount}ê°œ`);
            if (session.rrwebEvents) details.push(`<strong>rrweb ì´ë²¤íŠ¸:</strong> ${session.rrwebEvents.length}ê°œ`);
            if (session.userAgent) details.push(`<strong>ë¸Œë¼ìš°ì €:</strong> ${session.userAgent}`);
            if (session.viewport) details.push(`<strong>í™”ë©´ í¬ê¸°:</strong> ${session.viewport.width}x${session.viewport.height}`);
            
            sessionDetails.innerHTML = details.join('<br>');
            sessionInfo.style.display = 'block';
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        loadBtn.addEventListener('click', () => {
            const selectedSession = sessionSelect.value;
            if (selectedSession) {
                loadSession(selectedSession);
            } else {
                updateStatus('ì„¸ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
            }
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ë˜ëŠ” íŠ¹ì • ì„¸ì…˜ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', () => {
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ sessionId í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            const sessionIdFromUrl = urlParams.get('sessionId');
            
            if (sessionIdFromUrl) {
                // íŠ¹ì • ì„¸ì…˜ì„ ì§ì ‘ ë¡œë“œ
                updateStatus('íŠ¹ì • ì„¸ì…˜ ë¡œë“œ ì¤‘...', 'loading');
                console.log('URLì—ì„œ ì„¸ì…˜ ID ë°œê²¬:', sessionIdFromUrl);
                
                // ì„¸ì…˜ ì„ íƒ ì˜µì…˜ ì¶”ê°€ í›„ ìë™ ë¡œë“œ
                const option = document.createElement('option');
                option.value = sessionIdFromUrl;
                option.textContent = `${sessionIdFromUrl} (URLì—ì„œ)`;
                sessionSelect.appendChild(option);
                sessionSelect.value = sessionIdFromUrl;
                
                // ìë™ìœ¼ë¡œ ì„¸ì…˜ ë¡œë“œ
                setTimeout(() => {
                    loadSession(sessionIdFromUrl);
                }, 1000);
            } else {
                // ì¼ë°˜ì ì¸ ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
                loadSessions();
            }
        });
        
        // ë””ë²„ê·¸ ì •ë³´
        console.log('OpenReplay Session Player ì´ˆê¸°í™” ì™„ë£Œ');
        console.log('rrweb ì‚¬ìš© ê°€ëŠ¥:', typeof rrweb !== 'undefined');
        console.log('rrweb-player ì‚¬ìš© ê°€ëŠ¥:', typeof rrwebPlayer !== 'undefined');
    </script>
</body>
</html>