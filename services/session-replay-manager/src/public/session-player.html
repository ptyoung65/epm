<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenReplay Session Player - AIRIS EPM</title>
    <!-- rrweb 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/rrweb@latest/dist/rrweb.min.js"></script>
    <!-- rrweb 플레이어 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/index.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: #2d3748;
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .controls {
            padding: 2rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .control-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .btn:hover { background: #2563eb; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        
        select {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            min-width: 300px;
        }
        
        .session-info {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }
        
        .session-info h3 {
            margin-bottom: 0.5rem;
            color: #1e293b;
        }
        
        .player-container {
            padding: 2rem;
            min-height: 600px;
        }
        
        #player {
            width: 100%;
            min-height: 500px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .status.loading { background: #fef3c7; color: #92400e; }
        .status.ready { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.playing { background: #dbeafe; color: #1d4ed8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 OpenReplay Session Player</h1>
            <p>AIRIS EPM 세션 리플레이 플레이어</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <select id="sessionSelect">
                    <option value="">세션을 선택하세요...</option>
                </select>
                <button id="loadBtn" class="btn">세션 로드</button>
                <span id="status" class="status loading">세션 목록 로딩 중...</span>
            </div>
            
            <div id="sessionInfo" class="session-info">
                <h3>세션 정보</h3>
                <div id="sessionDetails"></div>
            </div>
        </div>
        
        <div class="player-container">
            <div id="player"></div>
        </div>
    </div>

    <script>
        let currentSession = null;
        let playerInstance = null;
        
        // DOM 요소들
        const sessionSelect = document.getElementById('sessionSelect');
        const loadBtn = document.getElementById('loadBtn');
        const statusEl = document.getElementById('status');
        const sessionInfo = document.getElementById('sessionInfo');
        const sessionDetails = document.getElementById('sessionDetails');
        const playerEl = document.getElementById('player');
        
        // 상태 업데이트 함수
        function updateStatus(message, type = 'loading') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        // 세션 목록 로드
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const data = await response.json();
                
                sessionSelect.innerHTML = '<option value="">세션을 선택하세요...</option>';
                
                if (data.sessions && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        // 모든 세션을 표시 (eventCount 조건 제거)
                        const option = document.createElement('option');
                        option.value = session.sessionId;
                        
                        // 세션 정보 표시
                        let displayText = `${session.sessionId}`;
                        if (session.eventCount) displayText += ` (${session.eventCount} 이벤트)`;
                        if (session.duration) displayText += ` ${session.duration}초`;
                        if (session.createdAt) {
                            const date = new Date(session.createdAt).toLocaleString();
                            displayText += ` - ${date}`;
                        }
                        
                        option.textContent = displayText;
                        sessionSelect.appendChild(option);
                    });
                    updateStatus(`${data.sessions.length}개 세션 로드 완료`, 'ready');
                } else {
                    updateStatus('저장된 세션이 없습니다', 'error');
                }
            } catch (error) {
                console.error('세션 목록 로드 실패:', error);
                updateStatus('세션 목록 로드 실패', 'error');
            }
        }
        
        // 세션 로드
        async function loadSession(sessionId) {
            try {
                console.log('🔍 세션 로드 시작:', sessionId);
                updateStatus('세션 로딩 중...', 'loading');
                
                const apiUrl = `/api/sessions/${sessionId}`;
                console.log('📡 API 호출:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('📥 API 응답 상태:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`세션을 찾을 수 없습니다 (${response.status}: ${response.statusText})`);
                }
                
                currentSession = await response.json();
                console.log('✅ 로드된 세션:', currentSession);
                console.log('📊 세션 데이터 구조:', {
                    sessionId: currentSession.sessionId,
                    hasRrwebEvents: !!currentSession.rrwebEvents,
                    rrwebEventsCount: currentSession.rrwebEvents ? currentSession.rrwebEvents.length : 0,
                    eventCount: currentSession.eventCount,
                    duration: currentSession.duration
                });
                
                // 세션 정보 표시
                displaySessionInfo(currentSession);
                
                // rrweb 이벤트가 있는지 확인
                if (currentSession.rrwebEvents && currentSession.rrwebEvents.length > 0) {
                    console.log('🎬 rrweb 이벤트 발견:', currentSession.rrwebEvents.length, '개');
                    console.log('🔍 첫 번째 이벤트 샘플:', currentSession.rrwebEvents[0]);
                    
                    // rrweb 플레이어로 재생
                    playWithRrweb(currentSession.rrwebEvents);
                } else {
                    console.warn('⚠️ rrweb 이벤트가 없음');
                    updateStatus('이 세션에는 재생 가능한 rrweb 이벤트가 없습니다. 새 세션을 녹화해주세요.', 'error');
                    
                    // 세션 정보는 여전히 표시
                    playerEl.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #ef4444;">
                            <h3>🎬 재생할 수 없는 세션</h3>
                            <p style="margin: 1rem 0;">이 세션에는 rrweb 이벤트 데이터가 없습니다.</p>
                            <p style="color: #6b7280;">새로운 세션을 녹화하려면 <a href="/test-session-replay.html" style="color: #3b82f6;">테스트 페이지</a>로 이동하세요.</p>
                            <div style="margin-top: 2rem; padding: 1rem; background: #f3f4f6; border-radius: 8px;">
                                <h4>🐞 디버그 정보:</h4>
                                <p><strong>세션 ID:</strong> ${currentSession.sessionId || 'N/A'}</p>
                                <p><strong>이벤트 수:</strong> ${currentSession.eventCount || 0}</p>
                                <p><strong>rrweb 이벤트:</strong> ${currentSession.rrwebEvents ? currentSession.rrwebEvents.length : 0}개</p>
                                <p><strong>지속 시간:</strong> ${currentSession.duration || 0}초</p>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('❌ 세션 로드 실패:', error);
                updateStatus(`세션 로드 실패: ${error.message}`, 'error');
                
                // 오류 정보 표시
                playerEl.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #ef4444;">
                        <h3>❌ 세션 로드 오류</h3>
                        <p style="margin: 1rem 0;">세션을 로드하는 중 오류가 발생했습니다.</p>
                        <div style="margin-top: 2rem; padding: 1rem; background: #fef2f2; border-radius: 8px; text-align: left;">
                            <h4>🐞 오류 정보:</h4>
                            <p><strong>세션 ID:</strong> ${sessionId}</p>
                            <p><strong>오류 메시지:</strong> ${error.message}</p>
                            <p><strong>API URL:</strong> /api/sessions/${sessionId}</p>
                        </div>
                        <p style="margin-top: 1rem; color: #6b7280;">
                            <a href="/test-session-replay.html" style="color: #3b82f6;">새로운 세션을 녹화</a>하거나 
                            <a href="/session-player.html" style="color: #3b82f6;">세션 목록</a>으로 이동하세요.
                        </p>
                    </div>
                `;
            }
        }
        
        // rrweb 플레이어로 재생
        function playWithRrweb(events) {
            try {
                // 기존 플레이어 정리
                if (playerInstance) {
                    playerInstance.destroy?.();
                }
                
                // 플레이어 컨테이너 초기화
                playerEl.innerHTML = '';
                
                console.log('rrweb 이벤트 수:', events.length);
                console.log('첫 번째 이벤트:', events[0]);
                
                // rrweb-player 생성
                if (typeof rrwebPlayer !== 'undefined') {
                    playerInstance = new rrwebPlayer({
                        target: playerEl,
                        props: {
                            events: events,
                            width: playerEl.offsetWidth,
                            height: 600,
                            autoPlay: false,
                            speedOption: [0.5, 1, 2, 4],
                            showController: true,
                            tags: {
                                'session-id': currentSession.sessionId
                            }
                        }
                    });
                    
                    updateStatus('재생 준비 완료', 'playing');
                    console.log('rrweb 플레이어 생성 완료');
                } else {
                    throw new Error('rrweb-player 라이브러리를 사용할 수 없습니다');
                }
                
            } catch (error) {
                console.error('플레이어 생성 실패:', error);
                updateStatus(`플레이어 생성 실패: ${error.message}`, 'error');
                
                // 대체: rrweb.Replayer 사용
                tryAlternativePlayer(events);
            }
        }
        
        // 대체 플레이어 (rrweb.Replayer)
        function tryAlternativePlayer(events) {
            try {
                playerEl.innerHTML = '<div id="replayer-container" style="width: 100%; height: 600px; border: 1px solid #ddd;"></div>';
                
                const replayer = new rrweb.Replayer(events, {
                    target: document.getElementById('replayer-container'),
                    props: {
                        width: playerEl.offsetWidth,
                        height: 600,
                    }
                });
                
                // 재생 컨트롤 추가
                const controls = document.createElement('div');
                controls.style.cssText = 'padding: 1rem; background: #f8f9fa; border-top: 1px solid #ddd; text-align: center;';
                controls.innerHTML = `
                    <button onclick="replayer.play()" class="btn">재생</button>
                    <button onclick="replayer.pause()" class="btn">일시정지</button>
                    <button onclick="replayer.goto(0)" class="btn">처음으로</button>
                `;
                
                playerEl.appendChild(controls);
                window.currentReplayer = replayer; // 전역 접근을 위해
                
                updateStatus('대체 플레이어 준비 완료', 'playing');
                console.log('rrweb.Replayer 생성 완료');
                
            } catch (error) {
                console.error('대체 플레이어도 실패:', error);
                updateStatus('플레이어 생성 완전 실패', 'error');
                playerEl.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;"><h3>플레이어를 생성할 수 없습니다</h3><p>' + error.message + '</p></div>';
            }
        }
        
        // 세션 정보 표시
        function displaySessionInfo(session) {
            const details = [];
            details.push(`<strong>세션 ID:</strong> ${session.sessionId}`);
            details.push(`<strong>생성 시간:</strong> ${new Date(session.createdAt).toLocaleString()}`);
            if (session.duration) details.push(`<strong>지속 시간:</strong> ${session.duration}초`);
            if (session.eventCount) details.push(`<strong>이벤트 수:</strong> ${session.eventCount}개`);
            if (session.rrwebEvents) details.push(`<strong>rrweb 이벤트:</strong> ${session.rrwebEvents.length}개`);
            if (session.userAgent) details.push(`<strong>브라우저:</strong> ${session.userAgent}`);
            if (session.viewport) details.push(`<strong>화면 크기:</strong> ${session.viewport.width}x${session.viewport.height}`);
            
            sessionDetails.innerHTML = details.join('<br>');
            sessionInfo.style.display = 'block';
        }
        
        // 이벤트 리스너
        loadBtn.addEventListener('click', () => {
            const selectedSession = sessionSelect.value;
            if (selectedSession) {
                loadSession(selectedSession);
            } else {
                updateStatus('세션을 선택해주세요', 'error');
            }
        });
        
        // 페이지 로드 시 세션 목록 로드 또는 특정 세션 로드
        document.addEventListener('DOMContentLoaded', () => {
            // URL 파라미터에서 sessionId 확인
            const urlParams = new URLSearchParams(window.location.search);
            const sessionIdFromUrl = urlParams.get('sessionId');
            
            if (sessionIdFromUrl) {
                // 특정 세션을 직접 로드
                updateStatus('특정 세션 로드 중...', 'loading');
                console.log('URL에서 세션 ID 발견:', sessionIdFromUrl);
                
                // 세션 선택 옵션 추가 후 자동 로드
                const option = document.createElement('option');
                option.value = sessionIdFromUrl;
                option.textContent = `${sessionIdFromUrl} (URL에서)`;
                sessionSelect.appendChild(option);
                sessionSelect.value = sessionIdFromUrl;
                
                // 자동으로 세션 로드
                setTimeout(() => {
                    loadSession(sessionIdFromUrl);
                }, 1000);
            } else {
                // 일반적인 세션 목록 로드
                loadSessions();
            }
        });
        
        // 디버그 정보
        console.log('OpenReplay Session Player 초기화 완료');
        console.log('rrweb 사용 가능:', typeof rrweb !== 'undefined');
        console.log('rrweb-player 사용 가능:', typeof rrwebPlayer !== 'undefined');
    </script>
</body>
</html>